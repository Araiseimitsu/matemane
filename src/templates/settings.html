{% extends "base.html" %}

{% block title %}設定 - 材料管理システム{% endblock %}

{% block extra_head %}
<style>
    /* グラスモーフィズム効果 */
    .glass-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    /* グラデーション背景 */
    @keyframes gradient-shift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .gradient-bg {
        background: linear-gradient(-45deg, #f0f9ff, #dbeafe, #e0e7ff, #f5f3ff);
        background-size: 400% 400%;
        animation: gradient-shift 15s ease infinite;
    }

    .tab-button.active {
        @apply bg-gradient-to-r from-purple-500 to-violet-600 text-white shadow-lg;
    }
    .tab-button:not(.active) {
        @apply bg-white text-gray-700 hover:bg-gray-50;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen gradient-bg">
    <div class="max-w-[1600px] mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- ページヘッダー -->
        <div class="mb-10">
            <div class="flex items-center justify-between">
                <div class="space-y-2">
                    <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 via-violet-600 to-indigo-600">
                        <i class="fas fa-cog mr-3"></i>システム設定
                    </h1>
                    <p class="text-lg text-gray-600 font-medium">システムの各種設定を管理</p>
                </div>
            </div>
        </div>

        <!-- 設定メニュー -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- サイドバー -->
            <div class="lg:col-span-1">
                <div class="glass-card rounded-3xl shadow-xl p-6">
                    <nav class="space-y-3">
                        <button class="tab-button w-full text-left px-5 py-4 rounded-2xl font-bold transition-all duration-300 active"
                                onclick="showTab('density-presets')">
                            <i class="fas fa-list mr-3"></i>比重プリセット管理
                        </button>
                        <button class="tab-button w-full text-left px-5 py-4 rounded-2xl font-bold transition-all duration-300"
                                onclick="showTab('system-info')">
                            <i class="fas fa-info-circle mr-3"></i>システム情報
                        </button>
                    </nav>
                </div>
            </div>

            <!-- メインコンテンツ -->
            <div class="lg:col-span-3">
                <!-- 比重プリセット管理 -->
                <div id="density-presets-tab" class="tab-content">
                    <div class="glass-card rounded-3xl shadow-xl overflow-hidden">
                        <div class="px-6 py-5 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-purple-50 to-indigo-50">
                            <h3 class="text-xl font-black text-gray-900">比重プリセット管理</h3>
                            <button type="button" class="bg-gradient-to-r from-purple-500 to-violet-600 hover:from-purple-600 hover:to-violet-700 text-white px-6 py-3 rounded-2xl font-bold transition-all duration-300 hover:scale-110 shadow-lg"
                                    onclick="openDensityPresetModal()">
                                <i class="fas fa-plus mr-2"></i>新規追加
                            </button>
                        </div>
                        <div class="p-6">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">材質名</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">比重 (g/cm³)</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">説明</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">作成日</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="density-presets-table" class="bg-white divide-y divide-gray-200">
                                        <!-- 動的に生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- システム情報 -->
                <div id="system-info-tab" class="tab-content hidden">
                    <div class="glass-card rounded-3xl shadow-xl overflow-hidden">
                        <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                            <h3 class="text-xl font-black text-gray-900">システム情報</h3>
                        </div>
                        <div class="p-8">
                            <dl class="grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-2">
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-2xl shadow-sm">
                                    <dt class="text-sm font-bold text-gray-600 uppercase tracking-wider">システム名</dt>
                                    <dd class="mt-2 text-lg font-black text-gray-900">材料管理システム (matemane)</dd>
                                </div>
                                <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-2xl shadow-sm">
                                    <dt class="text-sm font-bold text-gray-600 uppercase tracking-wider">バージョン</dt>
                                    <dd class="mt-2 text-lg font-black text-gray-900">1.0.0</dd>
                                </div>
                                <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-2xl shadow-sm">
                                    <dt class="text-sm font-bold text-gray-600 uppercase tracking-wider">データベース</dt>
                                    <dd class="mt-2 text-lg font-black text-gray-900">MySQL</dd>
                                </div>
                                <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-6 rounded-2xl shadow-sm">
                                    <dt class="text-sm font-bold text-gray-600 uppercase tracking-wider">最終更新</dt>
                                    <dd class="mt-2 text-lg font-black text-gray-900" id="last-updated">-</dd>
                                </div>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 比重プリセット登録・編集モーダル -->
<div id="densityPresetModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50" onclick="handleModalBackgroundClick(event, 'densityPresetModal')">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white" onclick="event.stopPropagation()">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="densityPresetModalTitle">比重プリセット登録</h3>
                <button type="button" class="text-gray-400 hover:text-gray-600" onclick="closeDensityPresetModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="densityPresetForm" class="space-y-4">
                <input type="hidden" id="preset_id" name="preset_id">
                
                <div>
                    <label for="preset_name" class="block text-sm font-medium text-gray-700">
                        材質名 <span class="text-red-500">*</span>
                    </label>
                    <input type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                           id="preset_name" name="name" required placeholder="例：S45C、SUS304、A5056">
                </div>
                
                <div>
                    <label for="preset_density" class="block text-sm font-medium text-gray-700">
                        比重 (g/cm³) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                           id="preset_density" name="density" step="0.01" min="0.01" required placeholder="例：7.85">
                </div>
                
                <div>
                    <label for="preset_description" class="block text-sm font-medium text-gray-700">説明</label>
                    <textarea class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                              id="preset_description" name="description" rows="3" placeholder="材質の詳細説明（任意）"></textarea>
                </div>
            </form>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors duration-200" 
                        onclick="closeDensityPresetModal()">キャンセル</button>
                <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200" 
                        id="saveDensityPreset">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 削除確認モーダル -->
<div id="deleteConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50" onclick="handleModalBackgroundClick(event, 'deleteConfirmModal')">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white" onclick="event.stopPropagation()">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">削除確認</h3>
                <button type="button" class="text-gray-400 hover:text-gray-600" onclick="closeDeleteConfirmModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <p class="text-gray-700">この比重プリセットを削除してもよろしいですか？</p>
                <p class="text-gray-500 text-sm mt-2">削除後は元に戻すことができません。</p>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors duration-200" 
                        onclick="closeDeleteConfirmModal()">キャンセル</button>
                <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200" 
                        id="confirmDelete">削除</button>
            </div>
        </div>
    </div>
</div>

<script>
// タブ切り替え機能
function showTab(tabName) {
    // すべてのタブコンテンツを非表示
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // すべてのタブボタンを非アクティブ
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-50');
        btn.classList.remove('bg-blue-600', 'text-white');
    });
    
    // 選択されたタブを表示
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    
    // 選択されたタブボタンをアクティブ
    event.target.classList.add('active');
    event.target.classList.add('bg-blue-600', 'text-white');
    event.target.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-50');
}

// モーダル制御関数
function openDensityPresetModal() {
    if (window.settingsManager) {
        window.settingsManager.resetForm();
    }
    const modal = document.getElementById('densityPresetModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeDensityPresetModal() {
    const modal = document.getElementById('densityPresetModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

function closeDeleteConfirmModal() {
    const modal = document.getElementById('deleteConfirmModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// モーダル背景クリックで閉じる
function handleModalBackgroundClick(event, modalId) {
    if (event.target.id === modalId) {
        if (modalId === 'densityPresetModal') {
            closeDensityPresetModal();
        } else if (modalId === 'deleteConfirmModal') {
            closeDeleteConfirmModal();
        }
    }
}

// ESCキーでモーダルを閉じる
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const densityModal = document.getElementById('densityPresetModal');
        const deleteModal = document.getElementById('deleteConfirmModal');

        if (!densityModal.classList.contains('hidden')) {
            closeDensityPresetModal();
        } else if (!deleteModal.classList.contains('hidden')) {
            closeDeleteConfirmModal();
        }
    }
});

document.addEventListener('DOMContentLoaded', function() {
    if (typeof window.APIClient === 'undefined') {
        console.error('APIClient is not available');
        return;
    }

    // SettingsManagerを初期化
    window.settingsManager = new SettingsManager();

    // イベントリスナーを設定
    document.getElementById('saveDensityPreset').addEventListener('click', function() {
        window.settingsManager.saveDensityPreset();
    });

    document.getElementById('confirmDelete').addEventListener('click', function() {
        window.settingsManager.deleteDensityPreset();
    });
});
</script>

<script src="{{ url_for('static', path='/js/settings.js') }}"></script>
{% endblock %}