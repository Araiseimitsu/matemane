{% extends "base.html" %}

{% block title %}在庫管理 - 同等品ビュー{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="mb-8">
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">在庫管理（同等品ビュー）</h1>
                <p class="mt-2 text-gray-600">材料マスターに登録された情報をもとに、汎用・専用の同等品単位で在庫を把握します。</p>
            </div>
            <div class="flex items-center space-x-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-700">材料マスター連携</span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-emerald-100 text-emerald-700">ロット在庫追跡</span>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between flex-wrap gap-3 mb-4">
            <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wider">絞り込み</h2>
            <button id="resetFilters" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                <i class="fas fa-undo mr-2"></i>リセット
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div>
                <label for="filterName" class="block text-sm font-medium text-gray-700 mb-2">材料名</label>
                <input type="text" id="filterName" placeholder="例: SUS303" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hover:border-gray-400">
            </div>
            <div>
                <label for="filterUsage" class="block text-sm font-medium text-gray-700 mb-2">用途区分</label>
                <select id="filterUsage" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-900 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hover:border-gray-400">
                    <option value="">すべて</option>
                    <option value="general">汎用</option>
                    <option value="dedicated">専用</option>
                </select>
            </div>
            <div>
                <label for="filterShape" class="block text-sm font-medium text-gray-700 mb-2">形状</label>
                <select id="filterShape" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-900 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hover:border-gray-400">
                    <option value="">すべて</option>
                    <option value="round">丸棒</option>
                    <option value="hexagon">六角</option>
                    <option value="square">平角</option>
                </select>
            </div>
            <div>
                <label for="filterDiameter" class="block text-sm font-medium text-gray-700 mb-2">寸法（mm）</label>
                <input type="text" id="filterDiameter" placeholder="例: 10 / 12.7" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hover:border-gray-400">
            </div>
            <div>
                <label for="filterDedicated" class="block text-sm font-medium text-gray-700 mb-2">専用品番・追加情報</label>
                <input type="text" id="filterDedicated" placeholder="例: CM-001" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hover:border-gray-400">
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
                <p class="text-sm text-gray-500">対象材料（ユニーク）</p>
                <p id="summaryMaterialCount" class="mt-1 text-2xl font-semibold text-gray-900">-</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">汎用同等品グループ</p>
                <p id="summaryGeneralGroupCount" class="mt-1 text-2xl font-semibold text-gray-900">-</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">専用同等品グループ</p>
                <p id="summaryDedicatedGroupCount" class="mt-1 text-2xl font-semibold text-gray-900">-</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">在庫ありロット</p>
                <p id="summaryLotCount" class="mt-1 text-2xl font-semibold text-gray-900">-</p>
            </div>
        </div>
        <p class="mt-4 text-sm text-gray-500 leading-6">
            汎用品は「材料名 × 形状 × 寸法」、専用品は「材料名 × 寸法 × 専用品番・追加情報」で同等品グループを構成します。
            グループを開くと在庫中のロット番号が一覧表示されます。
        </p>
    </div>

    <div id="groupLoading" class="bg-white border border-gray-200 rounded-lg py-16 flex flex-col items-center justify-center text-gray-500">
        <div class="mb-4">
            <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0116 0h-2a6 6 0 00-12 0H4z"></path>
            </svg>
        </div>
        <p>同等品グループを読み込んでいます...</p>
    </div>

    <div id="groupEmpty" class="hidden bg-white border border-gray-200 rounded-lg p-10 text-center text-gray-500">
        <p class="text-lg font-medium mb-2">条件に合致する同等品グループがありません</p>
        <p class="text-sm">絞り込み条件を緩めるか、材料マスターの登録内容をご確認ください。</p>
    </div>

        <div id="groupPaginationTop" class="bg-white border border-gray-200 rounded-lg mb-4 px-4 py-3 flex items-center justify-between text-sm text-gray-600 hidden">
        <div id="groupPaginationTopStatus">表示件数: -</div>
        <div class="flex items-center space-x-2">
            <button type="button" id="groupPaginationTopPrev" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-md bg-white hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed">前へ</button>
            <span id="groupPaginationTopIndicator" class="min-w-[80px] text-center">- / -</span>
            <button type="button" id="groupPaginationTopNext" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-md bg-white hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed">次へ</button>
        </div>
    </div>

    <div id="groupTableWrapper" class="bg-white rounded-lg shadow-sm border border-gray-200 hidden">
        <div class="overflow-x-auto">
            <table id="groupTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr class="text-xs font-semibold uppercase tracking-wider text-gray-500">
                        <th scope="col" class="px-4 py-3 text-left">用途区分</th>
                        <th scope="col" class="px-4 py-3 text-left">材料情報</th>
                        <th scope="col" class="px-4 py-3 text-left">長さバリエーション</th>
                        <th scope="col" class="px-4 py-3 text-left">専用品番・追加情報</th>
                        <th scope="col" class="px-4 py-3 text-right">登録材料数</th>
                        <th scope="col" class="px-4 py-3 text-right">在庫ロット数</th>
                        <th scope="col" class="px-4 py-3 text-right">在庫合計（本）</th>
                        <th scope="col" class="px-4 py-3 text-right">在庫重量（kg）</th>
                        <th scope="col" class="px-4 py-3 text-right">管理コード数</th>
                        <th scope="col" class="px-4 py-3 text-center">詳細</th>
                    </tr>
                </thead>
                <tbody id="groupTableBody" class="bg-white divide-y divide-gray-100"></tbody>
            </table>
        </div>
    </div>
    <div id="groupPagination" class="bg-white border border-gray-200 rounded-lg mt-4 px-4 py-3 flex items-center justify-between text-sm text-gray-600 hidden">
        <div id="groupPaginationStatus">表示件数: -</div>
        <div class="flex items-center space-x-2">
            <button type="button" id="groupPaginationPrev" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-md bg-white hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed">前へ</button>
            <span id="groupPaginationIndicator" class="min-w-[80px] text-center">- / -</span>
            <button type="button" id="groupPaginationNext" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-md bg-white hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed">次へ</button>
        </div>
    </div>
</div>


    </div>
<!-- 同等品詳細モーダル -->
<div id="groupDetailModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                    <p id="groupDetailTag" class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full mr-3"></p>
                    <h3 id="groupDetailTitle" class="text-xl font-semibold text-gray-900"></h3>
                    <p id="groupDetailSubtitle" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <button id="closeGroupDetail" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <section>
                    <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-3">概要</h4>
                    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <div>
                            <dt class="text-gray-500">登録材料数</dt>
                            <dd id="detailMaterialCount" class="text-gray-900 font-medium">-</dd>
                        </div>
                        <div>
                            <dt class="text-gray-500">在庫ありロット数</dt>
                            <dd id="detailLotCount" class="text-gray-900 font-medium">-</dd>
                        </div>
                        <div>
                            <dt class="text-gray-500">合計在庫数</dt>
                            <dd id="detailTotalQuantity" class="text-gray-900 font-medium">-</dd>
                        </div>
                        <div>
                            <dt class="text-gray-500">合計在庫重量</dt>
                            <dd id="detailTotalWeight" class="text-gray-900 font-medium">-</dd>
                        </div>
                        <div>
                            <dt class="text-gray-500">長さバリエーション</dt>
                            <dd id="detailLengthVariations" class="text-gray-900 font-medium">-</dd>
                        </div>
                        <div>
                            <dt class="text-gray-500">専用品番・追加情報</dt>
                            <dd id="detailDedicatedInfo" class="text-gray-900 font-medium">-</dd>
                        </div>
                        <div>
                            <dt class="text-gray-500">詳細情報</dt>
                            <dd id="detailInfo" class="text-gray-900 font-medium">-</dd>
                        </div>
                    </dl>
                </section>

                <section>
                    <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-3">材料マスター登録</h4>
                    <div id="detailMaterials" class="border border-gray-200 rounded-lg divide-y divide-gray-200">
                    </div>
                </section>

                <section>
                    <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-3">在庫ロット</h4>
                    <div id="detailLots" class="border border-gray-200 rounded-lg overflow-hidden">
                    </div>
                </section>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
                <button class="bg-white hover:bg-gray-100 text-gray-700 font-medium py-2.5 px-6 rounded-lg border border-gray-300 transition-colors" onclick="Utils.modal.close('groupDetailModal')">閉じる</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const shapeLabels = {
    round: '丸棒',
    hexagon: '六角',
    square: '平角'
};

const shapeDimensionPrefixes = {
    round: 'φ',
    hexagon: 'HEX',
    square: '□'
};

const usageLabels = {
    general: '汎用同等品',
    dedicated: '専用同等品'
};

const ROWS_PER_PAGE = 100;
const PAGINATION_CONFIGS = [
    {
        containerId: 'groupPaginationTop',
        statusId: 'groupPaginationTopStatus',
        indicatorId: 'groupPaginationTopIndicator',
        prevId: 'groupPaginationTopPrev',
        nextId: 'groupPaginationTopNext'
    },
    {
        containerId: 'groupPagination',
        statusId: 'groupPaginationStatus',
        indicatorId: 'groupPaginationIndicator',
        prevId: 'groupPaginationPrev',
        nextId: 'groupPaginationNext'
    }
];

let materialMaster = [];
let inventoryItems = [];
let groupStore = new Map();
let filteredGroupsCache = [];
let currentPage = 1;

document.addEventListener('DOMContentLoaded', () => {
    initializeEquivalenceView();
});

async function initializeEquivalenceView() {
    try {
        toggleLoading(true);
        await loadMasterAndInventory();
        buildGroupStore();
        registerFilterHandlers();
        registerPaginationHandlers();
        applyFiltersAndRender();
    } catch (error) {
        console.error('同等品ビュー初期化エラー:', error);
        Utils.showToast('同等品ビューの読み込みに失敗しました', 'error');
        showEmptyState();
    } finally {
        toggleLoading(false);
    }
}

function registerPaginationHandlers() {
    PAGINATION_CONFIGS.forEach(config => {
        const prev = document.getElementById(config.prevId);
        const next = document.getElementById(config.nextId);

        if (prev) {
            prev.addEventListener('click', () => changePage(-1));
        }

        if (next) {
            next.addEventListener('click', () => changePage(1));
        }
    });
}

function changePage(delta) {
    const totalPages = Math.max(1, Math.ceil(filteredGroupsCache.length / ROWS_PER_PAGE));
    const newPage = Math.min(totalPages, Math.max(1, currentPage + delta));

    if (newPage !== currentPage) {
        currentPage = newPage;
        renderCurrentPage();
        updatePaginationControls();
    }
}

function toggleLoading(isLoading) {
    const loading = document.getElementById('groupLoading');
    if (loading) {
        loading.classList.toggle('hidden', !isLoading);
    }

    if (isLoading) {
        const wrapper = document.getElementById('groupTableWrapper');
        if (wrapper) {
            wrapper.classList.add('hidden');
        }

        PAGINATION_CONFIGS.forEach(config => {
            const container = document.getElementById(config.containerId);
            if (container) {
                container.classList.add('hidden');
            }
        });

        hideEmptyState();
    }
}

async function loadMasterAndInventory() {
    const [materials, inventory] = await Promise.all([
        fetchAllMaterials(),
        fetchAllInventory()
    ]);

    materialMaster = materials.map(material => ({
        ...material,
        detail_info: sanitizeDetail(material.detail_info),
        display_name: sanitizeDetail(material.display_name),
        dedicated_part_number: sanitizeDetail(material.dedicated_part_number)
    }));
    inventoryItems = inventory.map(item => ({
        ...item,
        material: item.material ? {
            ...item.material,
            detail_info: sanitizeDetail(item.material.detail_info),
            display_name: sanitizeDetail(item.material.display_name),
            dedicated_part_number: sanitizeDetail(item.material.dedicated_part_number)
        } : item.material
    }));
}

async function fetchAllMaterials() {
    const limit = 500;
    let skip = 0;
    const results = [];

    while (true) {
        const chunk = await APIClient.getMaterials({ skip, limit, is_active: true });
        if (!Array.isArray(chunk) || chunk.length === 0) {
            break;
        }

        results.push(...chunk);

        if (chunk.length < limit) {
            break;
        }

        skip += limit;
    }

    return results;
}

async function fetchAllInventory() {
    const limit = 1000;
    let skip = 0;
    const results = [];

    while (true) {
        const chunk = await APIClient.getInventory({ skip, limit, is_active: true, include_zero_stock: false });
        if (!Array.isArray(chunk) || chunk.length === 0) {
            break;
        }

        results.push(...chunk);

        if (chunk.length < limit) {
            break;
        }

        skip += limit;
    }

    return results;
}

function buildGroupStore() {
    groupStore = new Map();
    const materialById = new Map(materialMaster.map(material => [material.id, material]));

    const getGroupKey = (material) => {
        const usageType = material.usage_type === 'dedicated' ? 'dedicated' : 'general';
        const detailKey = normalizeDetail(material.detail_info);
        if (usageType === 'dedicated') {
            const dedicated = (material.dedicated_part_number || '').trim().toUpperCase();
            return `${usageType}|${material.name.toUpperCase()}|${normalizeNumber(material.diameter_mm)}|${dedicated}|${detailKey}`;
        }
        return `${usageType}|${material.name.toUpperCase()}|${material.shape}|${normalizeNumber(material.diameter_mm)}|${detailKey}`;
    };

    materialMaster.forEach(material => {
        const key = getGroupKey(material);
        if (!groupStore.has(key)) {
            groupStore.set(key, createEmptyGroup(key, material));
        }
        const group = groupStore.get(key);
        group.materials.push(material);
        group._materialIdSet.add(material.id);
        const candidateLabel = selectOriginalLabel(material);
        const baseName = sanitizeDetail(material.name);
        if (!group.base_label || group.base_label === '―' || group.base_label === baseName) {
            group.base_label = candidateLabel;
        }
    });

    inventoryItems.forEach(item => {
        const baseMaterial = materialById.get(item.material.id);
        if (!baseMaterial) {
            return;
        }

        const key = getGroupKey(baseMaterial);
        if (!groupStore.has(key)) {
            groupStore.set(key, createEmptyGroup(key, baseMaterial));
        }
        const group = groupStore.get(key);

        if (!group._lotsMap) {
            group._lotsMap = new Map();
        }

        const lotKey = item.lot.id;
        const locationName = item.location ? item.location.name : '未割当';
        if (!group._lotsMap.has(lotKey)) {
            group._lotsMap.set(lotKey, {
                lot_id: lotKey,
                lot_number: item.lot.lot_number,
                length_mm: item.lot.length_mm,
                total_quantity: 0,
                total_weight_kg: 0,
                locations: new Set(),
                management_codes: []
            });
        }

        const lotEntry = group._lotsMap.get(lotKey);
        lotEntry.total_quantity += item.current_quantity;
        lotEntry.locations.add(locationName);
        lotEntry.management_codes.push(item.management_code);

        const weightPerPiece = Number(item.weight_per_piece_kg ?? 0);
        const totalWeight = Number(item.total_weight_kg ?? (weightPerPiece * item.current_quantity));
        if (!Number.isNaN(totalWeight)) {
            lotEntry.total_weight_kg += totalWeight;
        }

        group._lengthSet.add(item.lot.length_mm);
    });

    groupStore.forEach(group => finalizeGroup(group));
}

function createEmptyGroup(key, material) {
    const usageType = material.usage_type === 'dedicated' ? 'dedicated' : 'general';
    const originalLabel = selectOriginalLabel(material);
    return {
        key,
        usage_type: usageType,
        material_name: material.name,
        base_label: originalLabel,
        display_label: originalLabel,
        shape: material.shape,
        diameter_mm: material.diameter_mm,
        detail_info: sanitizeDetail(material.detail_info),
        dedicated_part_number: sanitizeDetail(material.dedicated_part_number),
        materials: [],
        lots: [],
        total_quantity: 0,
        total_weight_kg: 0,
        lot_count: 0,
        management_code_count: 0,
        length_variations: [],
        material_count: 0,
        _lotsMap: new Map(),
        _lengthSet: new Set(),
        _materialIdSet: new Set()
    };
}

function finalizeGroup(group) {
    if (group._lotsMap && group._lotsMap.size > 0) {
        group.lots = Array.from(group._lotsMap.values()).map(lot => ({
            lot_id: lot.lot_id,
            lot_number: lot.lot_number,
            length_mm: lot.length_mm,
            total_quantity: lot.total_quantity,
            total_weight_kg: lot.total_weight_kg,
            locations: Array.from(lot.locations),
            management_codes: lot.management_codes
        })).sort((a, b) => a.lot_number.localeCompare(b.lot_number, 'ja'));

        group.total_quantity = group.lots.reduce((sum, lot) => sum + lot.total_quantity, 0);
        group.total_weight_kg = group.lots.reduce((sum, lot) => sum + lot.total_weight_kg, 0);
        group.lot_count = group.lots.length;
        group.management_code_count = group.lots.reduce((sum, lot) => sum + lot.management_codes.length, 0);
    } else {
        group.lots = [];
        group.total_quantity = 0;
        group.total_weight_kg = 0;
        group.lot_count = 0;
        group.management_code_count = 0;
    }

    group.length_variations = Array.from(group._lengthSet)
        .filter(length => length !== null && length !== undefined)
        .sort((a, b) => Number(a) - Number(b));
    group.material_count = group._materialIdSet.size || group.materials.length;

    delete group._lotsMap;
    delete group._lengthSet;
    delete group._materialIdSet;

    group.subtitle = buildGroupSubtitle(group);
    group.display_label = buildGroupDisplayLabel(group);
    group.label = group.display_label;
}

function buildGroupSubtitle(group) {
    const dimension = formatDimension(group.shape, group.diameter_mm);
    const detailSuffix = group.detail_info ? ` / ${group.detail_info}` : '';
    if (group.usage_type === 'dedicated') {
        const dedicated = group.dedicated_part_number ? `専用品番 ${group.dedicated_part_number}` : '専用品目未設定';
        return `専用 ${dimension} / ${dedicated}${detailSuffix}`;
    }
    const shapeLabel = shapeLabels[group.shape] || group.shape;
    return `${shapeLabel} / 径 ${dimension}${detailSuffix}`;
}

function buildGroupDisplayLabel(group) {
    const baseLabel = group.base_label || group.material_name;
    const dimension = formatDimensionCompact(group.shape, group.diameter_mm);

    const details = [];
    const detailInfo = sanitizeDetail(group.detail_info);
    if (group.usage_type === 'dedicated' && group.dedicated_part_number) {
        details.push(group.dedicated_part_number);
    }
    if (detailInfo) {
        details.push(detailInfo);
    }

    let detailText = '';
    if (details.length) {
        const joined = details.join(' / ');
        detailText = /^\(.*\)$/.test(joined) ? joined : `(${joined})`;
    }

    const mainParts = [baseLabel];
    if (dimension) {
        mainParts.push(dimension);
    }

    return `${mainParts.filter(Boolean).join(' ')}${detailText ? ` ${detailText}` : ''}`.trim();
}

function buildMaterialDisplayLabel(material) {
    const baseLabel = selectOriginalLabel(material);
    const dimension = formatDimensionCompact(material.shape, material.diameter_mm);

    const details = [];
    const detailInfo = sanitizeDetail(material.detail_info);
    if (material.usage_type === 'dedicated' && material.dedicated_part_number) {
        details.push(material.dedicated_part_number);
    }
    if (detailInfo) {
        details.push(detailInfo);
    }

    let detailText = '';
    if (details.length) {
        const joined = details.join(' / ');
        detailText = /^\(.*\)$/.test(joined) ? joined : `(${joined})`;
    }

    const mainParts = [baseLabel];
    if (dimension) {
        mainParts.push(dimension);
    }

    return `${mainParts.filter(Boolean).join(' ')}${detailText ? ` ${detailText}` : ''}`.trim();
}

function normalizeNumber(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return Number(value).toFixed(4);
}

function sanitizeDetail(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return String(value).trim();
}

function normalizeDetail(value) {
    return sanitizeDetail(value).toUpperCase();
}

function selectOriginalLabel(material) {
    const displayName = sanitizeDetail(material.display_name);
    if (displayName) {
        return displayName;
    }
    return sanitizeDetail(material.name) || '―';
}

function formatDimension(shape, diameter) {
    if (diameter === null || diameter === undefined || diameter === '') {
        return '―';
    }
    const numeric = Number(diameter);
    if (Number.isNaN(numeric)) {
        return String(diameter);
    }
    const formatted = Number.isInteger(numeric) ? numeric.toString() : numeric.toFixed(2);
    const prefix = shapeDimensionPrefixes[shape] || '';
    return `${prefix}${formatted}mm`;
}

function formatDimensionCompact(shape, diameter) {
    if (diameter === null || diameter === undefined || diameter === '') {
        return '';
    }
    const numeric = Number(diameter);
    if (Number.isNaN(numeric)) {
        return String(diameter);
    }
    const normalized = Number.isInteger(numeric) ? numeric : Number(numeric.toFixed(3));
    const prefix = shapeDimensionPrefixes[shape] || '';
    return `${prefix}${normalized}`;
}

function registerFilterHandlers() {
    const filterIds = ['filterName', 'filterUsage', 'filterShape', 'filterDiameter', 'filterDedicated'];
    filterIds.forEach(id => {
        const element = document.getElementById(id);
        if (!element) return;
        const eventName = element.tagName === 'SELECT' ? 'change' : 'input';
        element.addEventListener(eventName, debounce(() => {
            currentPage = 1;
            applyFiltersAndRender();
        }, 200));
    });

    const resetButton = document.getElementById('resetFilters');
    if (resetButton) {
        resetButton.addEventListener('click', () => {
            filterIds.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.value = '';
            });
            currentPage = 1;
            applyFiltersAndRender();
        });
    }
}

function applyFiltersAndRender() {
    const filters = {
        name: document.getElementById('filterName')?.value.trim().toLowerCase() || '',
        usage: document.getElementById('filterUsage')?.value || '',
        shape: document.getElementById('filterShape')?.value || '',
        diameter: document.getElementById('filterDiameter')?.value.trim().toLowerCase() || '',
        dedicated: document.getElementById('filterDedicated')?.value.trim().toLowerCase() || ''
    };

    const groups = Array.from(groupStore.values()).filter(group => {
        if (filters.usage && group.usage_type !== filters.usage) {
            return false;
        }

        if (filters.shape && (group.shape || '').toLowerCase() !== filters.shape) {
            return false;
        }

        if (filters.name) {
            const matchName = group.material_name.toLowerCase().includes(filters.name);
            const detailMatch = (group.detail_info || '').toLowerCase().includes(filters.name);
            const matchMaterials = group.materials.some(material =>
                (material.display_name || '').toLowerCase().includes(filters.name) ||
                material.name.toLowerCase().includes(filters.name) ||
                (material.part_number || '').toLowerCase().includes(filters.name) ||
                (material.detail_info || '').toLowerCase().includes(filters.name)
            );
            if (!matchName && !detailMatch && !matchMaterials) {
                return false;
            }
        }

        if (filters.diameter) {
            const dimensionText = formatDimension(group.shape, group.diameter_mm).toLowerCase();
            if (!dimensionText.includes(filters.diameter)) {
                return false;
            }
        }

        if (filters.dedicated) {
            const dedicatedText = (group.dedicated_part_number || '').toLowerCase();
            const materialsDedicated = group.materials.some(material => (material.dedicated_part_number || '').toLowerCase().includes(filters.dedicated));
            if (!dedicatedText.includes(filters.dedicated) && !materialsDedicated) {
                return false;
            }
        }

        return true;
    });

    filteredGroupsCache = groups.sort((a, b) => {
        if (a.usage_type === b.usage_type) {
            return a.material_name.localeCompare(b.material_name, 'ja');
        }
        return a.usage_type === 'general' ? -1 : 1;
    });

    currentPage = 1;
    updateSummaryTiles(filteredGroupsCache);
    renderCurrentPage();
    updatePaginationControls();
}

function renderCurrentPage() {
    const pageGroups = filteredGroupsCache.slice((currentPage - 1) * ROWS_PER_PAGE, currentPage * ROWS_PER_PAGE);
    renderGroupTable(pageGroups);
}

function renderGroupTable(groups) {
    const wrapper = document.getElementById('groupTableWrapper');
    const tbody = document.getElementById('groupTableBody');
    if (!wrapper || !tbody) {
        return;
    }

    if (!groups.length) {
        tbody.innerHTML = '';
        wrapper.classList.add('hidden');
        showEmptyState();
        return;
    }

    hideEmptyState();
    wrapper.classList.remove('hidden');

    tbody.innerHTML = groups.map(group => createGroupRow(group)).join('');

    tbody.querySelectorAll('[data-group-key]').forEach(button => {
        button.addEventListener('click', () => {
            const key = button.getAttribute('data-group-key');
            const targetGroup = groupStore.get(key);
            if (targetGroup) {
                openGroupDetailModal(targetGroup);
            }
        });
    });
}

function createGroupRow(group) {
    const badgeClasses = group.usage_type === 'general'
        ? 'bg-blue-50 text-blue-700'
        : 'bg-purple-50 text-purple-700';

    const usageLabel = usageLabels[group.usage_type] || group.usage_type;
    const lengthText = formatLengthList(group.length_variations);
    const dedicatedDisplay = group.usage_type === 'dedicated'
        ? (group.dedicated_part_number ? escapeHtml(group.dedicated_part_number) : '未設定')
        : '汎用品（共通使用）';

    const materialCount = group.material_count.toLocaleString('ja-JP');
    const lotCount = group.lot_count.toLocaleString('ja-JP');
    const totalQuantity = group.total_quantity.toLocaleString('ja-JP');
    const totalWeight = formatWeight(group.total_weight_kg);
    const managementCount = group.management_code_count.toLocaleString('ja-JP');

    return `
        <tr>
            <td class="px-4 py-3">
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold ${badgeClasses}">
                    ${usageLabel}
                </span>
            </td>
            <td class="px-4 py-3">
                <p class="text-sm font-medium text-gray-900">${escapeHtml(group.display_label)}</p>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(lengthText)}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${dedicatedDisplay}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-900">${materialCount}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-900">${lotCount}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-900">${totalQuantity}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-900">${totalWeight}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-900">${managementCount}</td>
            <td class="px-4 py-3 text-center">
                <button type="button" data-group-key="${group.key}" class="inline-flex items-center px-3 py-2 text-sm font-medium text-blue-600 hover:text-blue-700">
                    詳細
                </button>
            </td>
        </tr>
    `;
}

function formatLengthList(lengths) {
    if (!Array.isArray(lengths) || lengths.length === 0) {
        return '―';
    }
    const formatted = lengths.map(length => formatLengthValue(length));
    if (formatted.length <= 3) {
        return formatted.join(' / ');
    }
    return `${formatted.slice(0, 3).join(' / ')} ほか${formatted.length - 3}種類`;
}

function formatLengthValue(value) {
    if (value === null || value === undefined || value === '') {
        return '―';
    }
    const numeric = Number(value);
    if (Number.isNaN(numeric)) {
        return String(value);
    }
    return `${numeric.toLocaleString('ja-JP')}mm`;
}

function formatWeight(value) {
    const numeric = Number(value ?? 0);
    if (Number.isNaN(numeric)) {
        return '0.00';
    }
    return numeric.toLocaleString('ja-JP', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function updateSummaryTiles(groups) {
    const materialIds = new Set();
    let generalCount = 0;
    let dedicatedCount = 0;
    let totalLots = 0;

    groups.forEach(group => {
        group.materials.forEach(material => materialIds.add(material.id));
        totalLots += group.lot_count;
        if (group.usage_type === 'general') {
            generalCount += 1;
        } else if (group.usage_type === 'dedicated') {
            dedicatedCount += 1;
        }
    });

    document.getElementById('summaryMaterialCount').textContent = materialIds.size.toLocaleString('ja-JP');
    document.getElementById('summaryGeneralGroupCount').textContent = generalCount.toLocaleString('ja-JP');
    document.getElementById('summaryDedicatedGroupCount').textContent = dedicatedCount.toLocaleString('ja-JP');
    document.getElementById('summaryLotCount').textContent = totalLots.toLocaleString('ja-JP');
}

function updatePaginationControls() {
    const totalItems = filteredGroupsCache.length;
    const totalPages = Math.max(1, Math.ceil(totalItems / ROWS_PER_PAGE));
    const pageStart = totalItems ? (currentPage - 1) * ROWS_PER_PAGE + 1 : 0;
    const pageEnd = totalItems ? Math.min(totalItems, currentPage * ROWS_PER_PAGE) : 0;

    PAGINATION_CONFIGS.forEach(config => {
        const container = document.getElementById(config.containerId);
        const status = document.getElementById(config.statusId);
        const indicator = document.getElementById(config.indicatorId);
        const prev = document.getElementById(config.prevId);
        const next = document.getElementById(config.nextId);

        if (!container || !status || !indicator) {
            return;
        }

        if (!totalItems) {
            container.classList.add('hidden');
            if (prev) prev.disabled = true;
            if (next) next.disabled = true;
            status.textContent = '表示件数: 0件';
            indicator.textContent = '0 / 0';
            return;
        }

        status.textContent = `表示件数: ${totalItems.toLocaleString('ja-JP')}件中 ${pageStart.toLocaleString('ja-JP')}件目〜${pageEnd.toLocaleString('ja-JP')}件目`;
        indicator.textContent = `${currentPage} / ${totalPages}`;

        if (prev) {
            prev.disabled = currentPage <= 1;
        }
        if (next) {
            next.disabled = currentPage >= totalPages;
        }

        container.classList.remove('hidden');
    });
}

function showEmptyState() {
    const empty = document.getElementById('groupEmpty');
    if (empty) {
        empty.classList.remove('hidden');
    }

    PAGINATION_CONFIGS.forEach(config => {
        const container = document.getElementById(config.containerId);
        if (container) {
            container.classList.add('hidden');
        }
    });
}

function hideEmptyState() {
    const empty = document.getElementById('groupEmpty');
    if (empty) {
        empty.classList.add('hidden');
    }
}

function debounce(fn, delay) {
    let timerId;
    return (...args) => {
        clearTimeout(timerId);
        timerId = setTimeout(() => fn(...args), delay);
    };
}

function escapeHtml(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

const detailModal = document.getElementById('groupDetailModal');

function closeGroupDetailModal() {
    Utils.modal.close('groupDetailModal');
}

document.getElementById('closeGroupDetail')?.addEventListener('click', closeGroupDetailModal);

detailModal?.addEventListener('click', (event) => {
    if (event.target === detailModal) {
        closeGroupDetailModal();
    }
});

document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && detailModal && !detailModal.classList.contains('hidden')) {
        closeGroupDetailModal();
    }
});

function openGroupDetailModal(group) {
    document.getElementById('groupDetailTitle').textContent = group.label;
    document.getElementById('groupDetailSubtitle').textContent = '';
    document.getElementById('detailMaterialCount').textContent = `${group.materials.length} 件`;
    document.getElementById('detailLotCount').textContent = `${group.lot_count} 件`;
    document.getElementById('detailTotalQuantity').textContent = `${group.total_quantity.toLocaleString('ja-JP')} 本`;
    document.getElementById('detailTotalWeight').textContent = `${formatWeight(group.total_weight_kg)} kg`;
    document.getElementById('detailLengthVariations').textContent = formatLengthList(group.length_variations);
    document.getElementById('detailDedicatedInfo').textContent = group.usage_type === 'dedicated'
        ? (group.dedicated_part_number || '未設定')
        : '汎用品（共通使用）';
    document.getElementById('detailInfo').textContent = group.detail_info || '詳細情報なし';

    const badge = document.getElementById('groupDetailTag');
    badge.textContent = usageLabels[group.usage_type] || group.usage_type;
    badge.className = `inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full ${
        group.usage_type === 'general' ? 'bg-blue-50 text-blue-700' : 'bg-purple-50 text-purple-700'
    }`;

    renderDetailMaterials(group);
    renderDetailLots(group);

    Utils.modal.open('groupDetailModal');
}

function renderDetailMaterials(group) {
    const container = document.getElementById('detailMaterials');
    if (!container) return;

    if (!group.materials.length) {
        container.innerHTML = `
            <div class="p-6 text-center text-sm text-gray-500">
                登録されている材料はありません。
            </div>
        `;
        return;
    }

    container.innerHTML = group.materials
        .slice()
        .sort((a, b) => (a.part_number || '').localeCompare(b.part_number || '', 'ja'))
        .map(material => {
            const usageLabel = material.usage_type === 'dedicated' ? '専用' : '汎用';
            const dedicatedInfo = material.dedicated_part_number ? escapeHtml(material.dedicated_part_number) : '―';
            const displayLabel = escapeHtml(buildMaterialDisplayLabel(material));
            const updated = material.updated_at ? new Date(material.updated_at).toLocaleString('ja-JP') : '―';
            const detailText = material.detail_info ? `<p class="text-xs text-gray-500">詳細: ${escapeHtml(material.detail_info)}</p>` : '';

            return `
                <div class="p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <p class="text-sm font-medium text-gray-900">${displayLabel}</p>
                        ${detailText}
                    </div>
                    <div class="flex flex-col items-start md:items-end text-xs text-gray-500 space-y-1">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-gray-700">${usageLabel}</span>
                        <span>専用品番・追加情報: ${dedicatedInfo}</span>
                        <span>最終更新: ${updated}</span>
                    </div>
                </div>
            `;
        }).join('');
}

function renderDetailLots(group) {
    const container = document.getElementById('detailLots');
    if (!container) return;

    if (!group.lots.length) {
        container.innerHTML = `
            <div class="p-6 text-center text-sm text-gray-500">
                現在在庫があるロットはありません。
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">ロット番号</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">長さ</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">在庫数</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">在庫重量</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">保管場所</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">管理コード数</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                ${group.lots.map(lot => `
                    <tr>
                        <td class="px-4 py-3 text-gray-900 font-medium">${escapeHtml(lot.lot_number)}</td>
                        <td class="px-4 py-3 text-gray-600">${formatLengthValue(lot.length_mm)}</td>
                        <td class="px-4 py-3 text-gray-900">${lot.total_quantity.toLocaleString('ja-JP')} 本</td>
                        <td class="px-4 py-3 text-gray-900">${formatWeight(lot.total_weight_kg)} kg</td>
                        <td class="px-4 py-3 text-gray-600">${lot.locations.length ? lot.locations.map(loc => escapeHtml(loc)).join('<br>') : '―'}</td>
                        <td class="px-4 py-3 text-gray-600">${lot.management_codes.length}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}
</script>

{% endblock %}
