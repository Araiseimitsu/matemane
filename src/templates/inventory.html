{% extends "base.html" %}

{% block title %}在庫管理 - 同等品ビュー{% endblock %}

{% block extra_head %}
<style>
    /* CSS変数 */
    :root {
        --primary-navy: #1e3a5f;
        --primary-blue: #2563eb;
        --accent-blue: #3b82f6;
        --success-green: #10b981;
        --warning-amber: #f59e0b;
        --danger-red: #ef4444;
        --neutral-50: #f8fafc;
        --neutral-100: #f1f5f9;
        --neutral-200: #e2e8f0;
        --neutral-700: #334155;
        --neutral-800: #1e293b;
    }

    /* サマリーカード */
    .summary-card {
        transition: all 0.2s ease;
    }

    .summary-card:hover {
        transform: translateY(-2px);
    }

    /* テーブルホバー効果 */
    #groupTableBody tr {
        transition: all 0.2s ease;
    }

    #groupTableBody tr:hover {
        background: var(--neutral-50);
    }

    /* ボタンホバーエフェクト */
    .btn-primary {
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-neutral-50">
    <div class="max-w-[1600px] mx-auto py-4 px-4 sm:px-6 lg:px-8">
        <!-- ヘッダーセクション -->
        <div class="mb-4">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="space-y-1">
                    <h1 class="text-2xl font-bold text-neutral-800">
                        在庫管理
                    </h1>
                    <p class="text-sm text-neutral-700">材料マスターに登録された情報をもとに、同等品単位で在庫を把握します</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-primary-blue bg-opacity-10 text-primary-blue">
                        <i class="fas fa-link mr-2"></i>材料マスター連携
                    </span>
                    <span class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-success-green bg-opacity-10 text-success-green">
                        <i class="fas fa-barcode mr-2"></i>ロット追跡
                    </span>
                    <button id="openGroupManager" class="btn-primary inline-flex items-center px-4 py-2 text-sm font-semibold bg-primary-blue text-white rounded-lg shadow-sm hover:shadow-md transition-all">
                        <i class="fas fa-object-group mr-2"></i>
                        <span>グループ管理</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- フィルターセクション -->
        <div class="bg-white border border-neutral-200 rounded-lg p-4 mb-4 shadow-sm">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-4">
                <div class="flex items-center">
                    <div class="p-3 bg-primary-blue bg-opacity-10 rounded-lg mr-3">
                        <i class="fas fa-filter text-xl text-primary-blue"></i>
                    </div>
                    <h2 class="text-lg font-bold text-neutral-800">絞り込み検索</h2>
                </div>
                <button id="resetFilters" class="inline-flex items-center px-4 py-2 text-sm font-semibold text-neutral-700 bg-white border border-neutral-200 rounded-lg hover:bg-neutral-50 transition-all">
                    <i class="fas fa-undo mr-2"></i>リセット
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div>
                    <label for="filterName" class="block text-sm font-semibold text-neutral-700 mb-2">材料仕様</label>
                    <input type="text" id="filterName" placeholder="例: SUS303 φ10.0D" class="w-full px-3 py-2 border border-neutral-200 rounded-lg bg-white text-neutral-800 placeholder-neutral-400 transition-all focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-primary-blue">
                </div>
                <div>
                    <label for="filterShape" class="block text-sm font-semibold text-neutral-700 mb-2">形状</label>
                    <select id="filterShape" class="w-full px-3 py-2 border border-neutral-200 rounded-lg bg-white text-neutral-800 transition-all focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-primary-blue">
                        <option value="">すべて</option>
                        <option value="round">丸棒</option>
                        <option value="hexagon">六角</option>
                        <option value="square">平角</option>
                    </select>
                </div>
                <div>
                    <label for="filterDiameter" class="block text-sm font-semibold text-neutral-700 mb-2">寸法（mm）</label>
                    <input type="text" id="filterDiameter" placeholder="例: 10 / 12.7" class="w-full px-3 py-2 border border-neutral-200 rounded-lg bg-white text-neutral-800 placeholder-neutral-400 transition-all focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-primary-blue">
                </div>
                <div>
                    <label for="filterLotNumber" class="block text-sm font-semibold text-neutral-700 mb-2">ロット番号</label>
                    <input type="text" id="filterLotNumber" placeholder="例: 2401-001" class="w-full px-3 py-2 border border-neutral-200 rounded-lg bg-white text-neutral-800 placeholder-neutral-400 transition-all focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-primary-blue">
                </div>
                <div>
                    <label for="filterGroupName" class="block text-sm font-semibold text-neutral-700 mb-2">グループ名</label>
                    <input type="text" id="filterGroupName" placeholder="例: SUS303 汎用グループ" class="w-full px-3 py-2 border border-neutral-200 rounded-lg bg-white text-neutral-800 placeholder-neutral-400 transition-all focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-primary-blue">
                </div>
            </div>
        </div>

        <!-- サマリーカード -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
            <div class="summary-card bg-white border border-neutral-200 rounded-lg p-4 shadow-sm">
                <div class="flex items-start justify-between mb-3">
                    <div class="p-3 bg-neutral-100 rounded-lg">
                        <i class="fas fa-cubes text-2xl text-neutral-800"></i>
                    </div>
                    <div class="text-right flex-1 ml-3">
                        <div class="text-xs font-semibold text-neutral-600 uppercase tracking-wider mb-1">対象材料（ユニーク）</div>
                        <div id="summaryMaterialCount" class="text-3xl font-bold text-neutral-800">-</div>
                        <div class="text-sm font-semibold text-neutral-800 mt-1">種類</div>
                    </div>
                </div>
            </div>

            <div class="summary-card bg-white border border-neutral-200 rounded-lg p-4 shadow-sm">
                <div class="flex items-start justify-between mb-3">
                    <div class="p-3 bg-neutral-100 rounded-lg">
                        <i class="fas fa-layer-group text-2xl text-neutral-800"></i>
                    </div>
                    <div class="text-right flex-1 ml-3">
                        <div class="text-xs font-semibold text-neutral-600 uppercase tracking-wider mb-1">同等品グループ数</div>
                        <div id="summaryGroupCount" class="text-3xl font-bold text-neutral-800">-</div>
                        <div class="text-sm font-semibold text-neutral-800 mt-1">グループ</div>
                    </div>
                </div>
            </div>

            <div class="summary-card bg-white border border-neutral-200 rounded-lg p-4 shadow-sm">
                <div class="flex items-start justify-between mb-3">
                    <div class="p-3 bg-neutral-100 rounded-lg">
                        <i class="fas fa-box text-2xl text-neutral-800"></i>
                    </div>
                    <div class="text-right flex-1 ml-3">
                        <div class="text-xs font-semibold text-neutral-600 uppercase tracking-wider mb-1">在庫ありロット</div>
                        <div id="summaryLotCount" class="text-3xl font-bold text-neutral-800">-</div>
                        <div class="text-sm font-semibold text-neutral-800 mt-1">ロット</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 説明カード -->
        <div class="bg-white border border-neutral-200 rounded-lg p-4 mb-4 shadow-sm border-l-4 border-l-primary-blue">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-xl text-primary-blue mt-0.5"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-neutral-700 leading-relaxed">
                        同等品グループは材料の表示名（display_name）をキーに構成します。形状・寸法は表示・絞り込みに利用できます。
                        グループを開くと在庫中のロット番号が一覧表示されます。
                    </p>
                </div>
            </div>
        </div>

        <!-- ローディング表示 -->
        <div id="groupLoading" class="bg-white border border-neutral-200 rounded-lg py-16 flex flex-col items-center justify-center shadow-sm">
            <div class="mb-4">
                <div class="relative w-16 h-16">
                    <div class="absolute inset-0 rounded-full border-4 border-neutral-200"></div>
                    <div class="absolute inset-0 rounded-full border-4 border-t-primary-blue border-r-transparent border-b-transparent border-l-transparent animate-spin"></div>
                </div>
            </div>
            <p class="text-base font-semibold text-neutral-700">同等品グループを読み込んでいます...</p>
            <p class="text-sm text-neutral-600 mt-1">データを処理中です</p>
        </div>

        <!-- 空状態表示 -->
        <div id="groupEmpty" class="hidden bg-white border border-neutral-200 rounded-lg p-12 shadow-sm text-center">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-neutral-100 rounded-full mb-4">
                <i class="fas fa-inbox text-3xl text-neutral-400"></i>
            </div>
            <p class="text-lg font-bold text-neutral-800 mb-2">条件に合致する同等品グループがありません</p>
            <p class="text-sm text-neutral-600">絞り込み条件を緩めるか、材料マスターの登録内容をご確認ください</p>
        </div>

        <!-- ページネーション（上部） -->
        <div id="groupPaginationTop" class="mb-4"></div>

        <!-- データテーブル -->
        <div id="groupTableWrapper" class="bg-white border border-neutral-200 rounded-lg shadow-sm hidden overflow-hidden">
            <div class="overflow-x-auto">
                <table id="groupTable" class="min-w-full">
                    <thead class="bg-neutral-50">
                        <tr class="text-xs font-semibold uppercase tracking-wider text-neutral-700">
                            <th scope="col" class="px-6 py-3 text-left">材料情報</th>
                            <th scope="col" class="px-6 py-3 text-left">グループ名</th>
                            <th scope="col" class="px-6 py-3 text-left">長さバリエーション</th>
                            <th scope="col" class="px-6 py-3 text-right">登録材料数</th>
                            <th scope="col" class="px-6 py-3 text-right">在庫ロット数</th>
                            <th scope="col" class="px-6 py-3 text-right">在庫合計（本）</th>
                            <th scope="col" class="px-6 py-3 text-right">在庫重量（kg）</th>
                            <th scope="col" class="px-6 py-3 text-center">詳細</th>
                        </tr>
                    </thead>
                    <tbody id="groupTableBody" class="bg-white divide-y divide-neutral-200"></tbody>
                </table>
            </div>
        </div>

        <!-- ページネーション（下部） -->
        <div id="groupPaginationBottom" class="mt-4"></div>
    </div>
</div>
<!-- 同等品詳細モーダル -->
<div id="groupDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="closeGroupDetailModal()">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white border border-neutral-200 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="px-6 py-4 bg-neutral-50 flex items-center justify-between rounded-t-lg border-b border-neutral-200">
                <div>
                    <p id="groupDetailTag" class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full mr-3"></p>
                    <h3 id="groupDetailTitle" class="text-xl font-bold text-neutral-800"></h3>
                    <p id="groupDetailSubtitle" class="text-sm text-neutral-600 mt-1"></p>
                </div>
                <button id="closeGroupDetail" class="p-2 rounded-lg hover:bg-white hover:shadow-sm transition-all text-neutral-600 hover:text-neutral-800">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- 概要セクション -->
                <section class="bg-white border border-neutral-200 rounded-lg p-4 shadow-sm">
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-primary-blue bg-opacity-10 rounded-lg mr-3">
                            <i class="fas fa-info-circle text-primary-blue"></i>
                        </div>
                        <h4 class="text-base font-bold text-neutral-800">概要</h4>
                    </div>
                    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-neutral-50 rounded-lg p-3">
                            <dt class="text-xs font-semibold text-neutral-600 uppercase tracking-wider mb-1">登録材料数</dt>
                            <dd id="detailMaterialCount" class="text-xl font-bold text-neutral-800">-</dd>
                        </div>
                        <div class="bg-neutral-50 rounded-lg p-3">
                            <dt class="text-xs font-semibold text-neutral-600 uppercase tracking-wider mb-1">在庫ありロット数</dt>
                            <dd id="detailLotCount" class="text-xl font-bold text-neutral-800">-</dd>
                        </div>
                        <div class="bg-neutral-50 rounded-lg p-3">
                            <dt class="text-xs font-semibold text-neutral-600 uppercase tracking-wider mb-1">合計在庫数</dt>
                            <dd id="detailTotalQuantity" class="text-xl font-bold text-neutral-800">-</dd>
                        </div>
                        <div class="bg-neutral-50 rounded-lg p-3">
                            <dt class="text-xs font-semibold text-neutral-600 uppercase tracking-wider mb-1">合計在庫重量</dt>
                            <dd id="detailTotalWeight" class="text-xl font-bold text-neutral-800">-</dd>
                        </div>
                        <div class="bg-neutral-50 rounded-lg p-3">
                            <dt class="text-xs font-semibold text-neutral-600 uppercase tracking-wider mb-1">長さバリエーション</dt>
                            <dd id="detailLengthVariations" class="text-base font-bold text-neutral-800">-</dd>
                        </div>
                        <div class="bg-neutral-50 rounded-lg p-3">
                            <dt class="text-xs font-semibold text-neutral-600 uppercase tracking-wider mb-1">材料グループ</dt>
                            <dd id="detailGroupNames" class="text-base font-bold text-neutral-800">-</dd>
                        </div>
                    </dl>
                </section>

                <!-- 材料マスター登録 -->
                <section class="bg-white border border-neutral-200 rounded-lg p-4 shadow-sm">
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-success-green bg-opacity-10 rounded-lg mr-3">
                            <i class="fas fa-database text-success-green"></i>
                        </div>
                        <h4 class="text-base font-bold text-neutral-800">材料マスター登録</h4>
                    </div>
                    <div id="detailMaterials" class="border border-neutral-200 rounded-lg divide-y divide-neutral-200 overflow-hidden">
                    </div>
                </section>

                <!-- 在庫ロット -->
                <section class="bg-white border border-neutral-200 rounded-lg p-4 shadow-sm">
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-warning-amber bg-opacity-10 rounded-lg mr-3">
                            <i class="fas fa-boxes text-warning-amber"></i>
                        </div>
                        <h4 class="text-base font-bold text-neutral-800">在庫ロット</h4>
                    </div>
                    <div id="detailLots" class="border border-neutral-200 rounded-lg overflow-hidden">
                    </div>
                </section>
            </div>

            <!-- フッター -->
            <div class="px-6 py-4 bg-neutral-50 flex justify-end rounded-b-lg border-t border-neutral-200">
                <button class="bg-white hover:bg-neutral-50 border border-neutral-200 text-neutral-700 font-semibold py-2 px-6 rounded-lg transition-all" onclick="Utils.modal.close('groupDetailModal')">
                    <i class="fas fa-times mr-2"></i>閉じる
                </button>
            </div>
        </div>
    </div>
</div>
<!-- グループ管理モーダル -->
<div id="groupManagerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="Utils.modal.close('groupManagerModal')">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white border border-neutral-200 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="px-6 py-4 bg-neutral-50 flex items-center justify-between rounded-t-lg border-b border-neutral-200">
                <div>
                    <h3 class="text-xl font-bold text-neutral-800">グループ管理</h3>
                    <p class="text-sm text-neutral-600 mt-1">材料グループの作成・名称変更・削除を在庫ページから行えます</p>
                </div>
                <button id="closeGroupManager" class="p-2 rounded-lg hover:bg-white hover:shadow-sm transition-all text-neutral-600 hover:text-neutral-800">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- 新規グループ作成 -->
                <section class="bg-white border border-neutral-200 rounded-lg p-4 shadow-sm">
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-success-green bg-opacity-10 rounded-lg mr-3">
                            <i class="fas fa-plus-circle text-success-green"></i>
                        </div>
                        <h4 class="text-base font-bold text-neutral-800">新規グループ作成</h4>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <input type="text" id="groupManagerName" placeholder="グループ名" class="md:col-span-1 w-full px-3 py-2 border border-neutral-200 rounded-lg bg-white text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-primary-blue" />
                        <input type="text" id="groupManagerDescription" placeholder="説明（任意）" class="md:col-span-2 w-full px-3 py-2 border border-neutral-200 rounded-lg bg-white text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-primary-blue" />
                    </div>
                    <div class="flex justify-end mt-3">
                        <button id="createGroupBtn" class="btn-primary inline-flex items-center px-5 py-2 text-sm font-semibold bg-primary-blue text-white rounded-lg shadow-sm hover:shadow-md transition-all">
                            <i class="fas fa-plus mr-2"></i>
                            <span>作成</span>
                        </button>
                    </div>
                </section>

                <!-- グループ一覧 -->
                <section class="bg-white border border-neutral-200 rounded-lg p-4 shadow-sm">
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-primary-blue bg-opacity-10 rounded-lg mr-3">
                            <i class="fas fa-list text-primary-blue"></i>
                        </div>
                        <h4 class="text-base font-bold text-neutral-800">グループ一覧</h4>
                    </div>
                    <div id="groupManagerList" class="border border-neutral-200 rounded-lg divide-y divide-neutral-200 overflow-hidden"></div>
                </section>

                <!-- 所属材料管理 -->
                <section id="groupMembershipSection" class="bg-white border border-neutral-200 rounded-lg p-4 shadow-sm hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-accent-blue bg-opacity-10 rounded-lg mr-3">
                                <i class="fas fa-users text-accent-blue"></i>
                            </div>
                            <h4 class="text-base font-bold text-neutral-800">所属材料管理</h4>
                        </div>
                        <div class="text-xs font-semibold text-neutral-600">
                            対象グループ: <span id="groupMembershipTargetName" class="text-neutral-800 font-bold">-</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <input type="text" id="groupMemberSearchInput" placeholder="材料名・品番・詳細などで検索" class="md:col-span-2 w-full px-3 py-2 border border-neutral-200 rounded-lg bg-white text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-primary-blue" />
                        <button id="groupMemberSearchBtn" class="px-3 py-2 text-sm font-semibold bg-neutral-800 hover:bg-neutral-900 text-white rounded-lg transition-all">
                            <i class="fas fa-search mr-2"></i>検索
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <div class="flex items-center mb-2">
                                <i class="fas fa-search text-primary-blue mr-2"></i>
                                <p class="text-sm font-bold text-neutral-700">検索結果</p>
                            </div>
                            <div id="groupMemberSearchResults" class="border border-neutral-200 rounded-lg divide-y divide-neutral-200 overflow-hidden max-h-80 overflow-y-auto"></div>
                        </div>
                        <div>
                            <div class="flex items-center mb-2">
                                <i class="fas fa-check-circle text-success-green mr-2"></i>
                                <p class="text-sm font-bold text-neutral-700">現在の所属</p>
                            </div>
                            <div id="groupMemberList" class="border border-neutral-200 rounded-lg divide-y divide-neutral-200 overflow-hidden max-h-80 overflow-y-auto"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- フッター -->
            <div class="px-6 py-4 bg-neutral-50 flex justify-end rounded-b-lg border-t border-neutral-200">
                <button class="bg-white hover:bg-neutral-50 border border-neutral-200 text-neutral-700 font-semibold py-2 px-6 rounded-lg transition-all" onclick="Utils.modal.close('groupManagerModal')">
                    <i class="fas fa-times mr-2"></i>閉じる
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', path='js/pagination.js') }}"></script>
<script>
const shapeLabels = {
    round: '丸棒',
    hexagon: '六角',
    square: '平角'
};

const shapeDimensionPrefixes = {
    round: 'φ',
    hexagon: 'HEX',
    square: '□'
};

// 用途区分は廃止（汎用／専用バッジを表示しない）

const ROWS_PER_PAGE = 25;

let materialMaster = [];
let inventoryItems = [];
let groupStore = new Map();
let filteredGroupsCache = [];
let currentPage = 1;
let materialGroupMap = new Map(); // material_id -> Set(group_name)

document.addEventListener('DOMContentLoaded', () => {
    initializeEquivalenceView();
});

async function initializeEquivalenceView() {
    try {
        toggleLoading(true);
        await loadMasterAndInventory();
        await loadMaterialGroupRelations();
        buildGroupStore();
        registerFilterHandlers();
        applyFiltersAndRender();
    } catch (error) {
        console.error('同等品ビュー初期化エラー:', error);
        Utils.showToast('同等品ビューの読み込みに失敗しました', 'error');
        showEmptyState();
    } finally {
        toggleLoading(false);
    }
}

async function loadMaterialGroupRelations() {
    try {
        const groups = await APIClient.getMaterialGroups({ limit: 1000 });
        const map = new Map();
        for (const g of groups) {
            try {
                const members = await APIClient.getGroupMembers(g.id);
                for (const m of members) {
                    const set = map.get(m.material_id) || new Set();
                    set.add(g.group_name);
                    map.set(m.material_id, set);
                }
            } catch (e) {
                console.warn('グループ所属取得失敗:', g.id, e);
            }
        }
        materialGroupMap = map;
    } catch (e) {
        console.warn('材料グループ一覧取得失敗:', e);
        materialGroupMap = new Map();
    }
}

function gotoPage(page) {
    const totalPages = Math.max(1, Math.ceil(filteredGroupsCache.length / ROWS_PER_PAGE));
    const newPage = Math.min(totalPages, Math.max(1, page));

    if (newPage !== currentPage) {
        currentPage = newPage;
        renderCurrentPage();
        updatePaginationControls();
    }
}

function toggleLoading(isLoading) {
    const loading = document.getElementById('groupLoading');
    if (loading) {
        loading.classList.toggle('hidden', !isLoading);
    }

    if (isLoading) {
        const wrapper = document.getElementById('groupTableWrapper');
        if (wrapper) {
            wrapper.classList.add('hidden');
        }

        // ページネーションを非表示
        const topContainer = document.getElementById('groupPaginationTop');
        const bottomContainer = document.getElementById('groupPaginationBottom');
        if (topContainer) topContainer.innerHTML = '';
        if (bottomContainer) bottomContainer.innerHTML = '';

        hideEmptyState();
    }
}

async function loadMasterAndInventory() {
    const [materials, inventory] = await Promise.all([
        fetchAllMaterials(),
        fetchAllInventory()
    ]);

    materialMaster = materials.map(material => ({
        ...material,
        detail_info: sanitizeDetail(material.detail_info),
        display_name: sanitizeDetail(material.display_name)
    }));
    inventoryItems = inventory.map(item => ({
        ...item,
        material: item.material ? {
            ...item.material,
            detail_info: sanitizeDetail(item.material.detail_info),
            display_name: sanitizeDetail(item.material.display_name)
        } : item.material
    }));
}

async function fetchAllMaterials() {
    const limit = 500;
    let skip = 0;
    const results = [];

    while (true) {
        const chunk = await APIClient.getMaterials({ skip, limit, is_active: true });
        if (!Array.isArray(chunk) || chunk.length === 0) {
            break;
        }

        results.push(...chunk);

        if (chunk.length < limit) {
            break;
        }

        skip += limit;
    }

    return results;
}

async function fetchAllInventory() {
    const limit = 1000;
    let skip = 0;
    const results = [];

    while (true) {
        const chunk = await APIClient.getInventory({ skip, limit, is_active: true, include_zero_stock: false });
        if (!Array.isArray(chunk) || chunk.length === 0) {
            break;
        }

        results.push(...chunk);

        if (chunk.length < limit) {
            break;
        }

        skip += limit;
    }

    return results;
}

function buildGroupStore() {
    groupStore = new Map();
    const materialById = new Map(materialMaster.map(material => [material.id, material]));

    const getGroupKey = (material) => {
        // フルネーム（display_name）で一意にグルーピング
        const label = (material.display_name || material.name || '').toUpperCase().trim();
        return `full|${label}`;
    };

    materialMaster.forEach(material => {
        const key = getGroupKey(material);
        if (!groupStore.has(key)) {
            groupStore.set(key, createEmptyGroup(key, material));
        }
        const group = groupStore.get(key);
        group.materials.push(material);
        group._materialIdSet.add(material.id);
        const candidateLabel = selectOriginalLabel(material);
        const baseName = sanitizeDetail(material.name);
        if (!group.base_label || group.base_label === '―' || group.base_label === baseName) {
            group.base_label = candidateLabel;
        }
    });

    inventoryItems.forEach(item => {
        const baseMaterial = materialById.get(item.material.id);
        if (!baseMaterial) {
            return;
        }

        const key = getGroupKey(baseMaterial);
        if (!groupStore.has(key)) {
            groupStore.set(key, createEmptyGroup(key, baseMaterial));
        }
        const group = groupStore.get(key);

        if (!group._lotsMap) {
            group._lotsMap = new Map();
        }

        const lotKey = item.lot.id;
        const locationName = item.location ? item.location.name : '未割当';
        if (!group._lotsMap.has(lotKey)) {
            group._lotsMap.set(lotKey, {
                lot_id: lotKey,
                lot_number: item.lot.lot_number,
                length_mm: item.lot.length_mm,
                total_quantity: 0,
                total_weight_kg: 0,
                locations: new Set(),
                lot_numbers: [],
                order_number: item.lot.order_number || null,
                purchase_month: item.lot.purchase_month || null,
                notes: item.lot.notes || ''
            });
        }

        const lotEntry = group._lotsMap.get(lotKey);
        lotEntry.total_quantity += item.current_quantity;
        lotEntry.locations.add(locationName);
        lotEntry.lot_numbers.push(item.lot.lot_number);

        const weightPerPiece = Number(item.weight_per_piece_kg ?? 0);
        const totalWeight = Number(item.total_weight_kg ?? (weightPerPiece * item.current_quantity));
        if (!Number.isNaN(totalWeight)) {
            lotEntry.total_weight_kg += totalWeight;
        }

        group._lengthSet.add(item.lot.length_mm);
    });

    groupStore.forEach(group => finalizeGroup(group));
}

function createEmptyGroup(key, material) {
    const originalLabel = selectOriginalLabel(material);
    return {
        key,
        material_name: material.name,
        base_label: originalLabel,
        display_label: originalLabel,
        shape: material.shape,
        diameter_mm: material.diameter_mm,
        detail_info: sanitizeDetail(material.detail_info),
        materials: [],
        lots: [],
        total_quantity: 0,
        total_weight_kg: 0,
        lot_count: 0,
        length_variations: [],
        material_count: 0,
        _lotsMap: new Map(),
        _lengthSet: new Set(),
        _materialIdSet: new Set()
    };
}

function finalizeGroup(group) {
    if (group._lotsMap && group._lotsMap.size > 0) {
        group.lots = Array.from(group._lotsMap.values()).map(lot => ({
            lot_id: lot.lot_id,
            lot_number: lot.lot_number,
            length_mm: lot.length_mm,
            total_quantity: lot.total_quantity,
            total_weight_kg: lot.total_weight_kg,
            locations: Array.from(lot.locations),
            lot_numbers: lot.lot_numbers,
            order_number: lot.order_number || null,
            purchase_month: lot.purchase_month || null,
            notes: lot.notes || ''
        })).sort((a, b) => {
            const lotA = a.lot_number || '';
            const lotB = b.lot_number || '';
            return lotA.localeCompare(lotB, 'ja');
        });

        group.total_quantity = group.lots.reduce((sum, lot) => sum + lot.total_quantity, 0);
        group.total_weight_kg = group.lots.reduce((sum, lot) => sum + lot.total_weight_kg, 0);
        group.lot_count = group.lots.length;
    } else {
        group.lots = [];
        group.total_quantity = 0;
        group.total_weight_kg = 0;
        group.lot_count = 0;
    }

    group.length_variations = Array.from(group._lengthSet)
        .filter(length => length !== null && length !== undefined)
        .sort((a, b) => Number(a) - Number(b));

    // Fallback: derive from lots if set is empty
    if (!Array.isArray(group.length_variations) || group.length_variations.length === 0) {
        const fromLots = Array.from(new Set(
            (group.lots || [])
                .map(l => l.length_mm)
                .filter(v => v !== null && v !== undefined)
        ));
        group.length_variations = fromLots.sort((a, b) => Number(a) - Number(b));
    }

    group.material_count = group._materialIdSet.size || group.materials.length;

    // 材料グループ名の集約（material_id -> Set(group_name) から集計）
    const namesSet = new Set();
    if (typeof materialGroupMap !== 'undefined' && materialGroupMap && group._materialIdSet && group._materialIdSet.size > 0) {
        group._materialIdSet.forEach(id => {
            const s = materialGroupMap.get(id);
            if (s) {
                s.forEach(n => namesSet.add(n));
            }
        });
    }
    group.material_group_names = Array.from(namesSet).sort((a, b) => {
        const nameA = a || '';
        const nameB = b || '';
        return nameA.localeCompare(nameB, 'ja');
    });

    delete group._lotsMap;
    delete group._lengthSet;
    delete group._materialIdSet;

    group.subtitle = buildGroupSubtitle(group);
    group.display_label = buildGroupDisplayLabel(group);
    group.label = group.display_label;
}

function buildGroupSubtitle(group) {
    const dimension = formatDimension(group.shape, group.diameter_mm);
    const shapeLabel = shapeLabels[group.shape] || group.shape;
    const dimLabel = group.shape === 'round' ? '径' : (group.shape === 'hexagon' ? '対辺距離' : (group.shape === 'square' ? '一辺' : '寸法'));
    return `${shapeLabel} / ${dimLabel} ${dimension}`;
}

function buildGroupDisplayLabel(group) {
    const baseLabel = group.base_label || group.material_name;
    // original（display_name）を純粋に表示するため、寸法や詳細の付加は行わない
    return String(baseLabel || '').trim();
}

function buildMaterialDisplayLabel(material) {
    const baseLabel = selectOriginalLabel(material);
    // original（display_name）を純粋に表示するため、寸法や詳細の付加は行わない
    return String(baseLabel || '').trim();
}

function normalizeNumber(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return Number(value).toFixed(4);
}

function sanitizeDetail(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return String(value).trim();
}

function normalizeDetail(value) {
    return sanitizeDetail(value).toUpperCase();
}

function selectOriginalLabel(material) {
    const displayName = sanitizeDetail(material.display_name);
    if (displayName) {
        return displayName;
    }
    return sanitizeDetail(material.name) || '―';
}

function formatDimension(shape, diameter) {
    if (diameter === null || diameter === undefined || diameter === '') {
        return '―';
    }
    const numeric = Number(diameter);
    if (Number.isNaN(numeric)) {
        return String(diameter);
    }
    const formatted = Number.isInteger(numeric) ? numeric.toString() : numeric.toFixed(2);
    const prefix = shapeDimensionPrefixes[shape] || '';
    return `${prefix}${formatted}mm`;
}

function formatDimensionCompact(shape, diameter) {
    if (diameter === null || diameter === undefined || diameter === '') {
        return '';
    }
    const numeric = Number(diameter);
    if (Number.isNaN(numeric)) {
        return String(diameter);
    }
    const normalized = Number.isInteger(numeric) ? numeric : Number(numeric.toFixed(3));
    const prefix = shapeDimensionPrefixes[shape] || '';
    return `${prefix}${normalized}`;
}

function registerFilterHandlers() {
    const filterIds = ['filterName', 'filterShape', 'filterDiameter', 'filterLotNumber', 'filterGroupName'];
    filterIds.forEach(id => {
        const element = document.getElementById(id);
        if (!element) return;
        const eventName = element.tagName === 'SELECT' ? 'change' : 'input';
        element.addEventListener(eventName, debounce(() => {
            currentPage = 1;
            applyFiltersAndRender();
        }, 200));
    });

    const resetButton = document.getElementById('resetFilters');
    if (resetButton) {
        resetButton.addEventListener('click', () => {
            filterIds.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.value = '';
            });
            currentPage = 1;
            applyFiltersAndRender();
        });
    }
}

function applyFiltersAndRender() {
    const filters = {
        name: document.getElementById('filterName')?.value.trim().toLowerCase() || '',
        shape: document.getElementById('filterShape')?.value || '',
        diameter: document.getElementById('filterDiameter')?.value.trim().toLowerCase() || '',
        lotNumber: document.getElementById('filterLotNumber')?.value.trim().toLowerCase() || '',
        groupName: document.getElementById('filterGroupName')?.value.trim().toLowerCase() || ''
    };

    const groups = Array.from(groupStore.values()).filter(group => {

        if (filters.shape && (group.shape || '').toLowerCase() !== filters.shape) {
            return false;
        }

        if (filters.name) {
            const nameMatch = (group.display_label || '').toLowerCase().includes(filters.name) ||
                group.materials.some(material => (material.display_name || '').toLowerCase().includes(filters.name));
            if (!nameMatch) {
                return false;
            }
        }

        if (filters.diameter) {
            const dimensionText = formatDimension(group.shape, group.diameter_mm).toLowerCase();
            if (!dimensionText.includes(filters.diameter)) {
                return false;
            }
        }

        if (filters.lotNumber) {
            const lotMatch = Array.isArray(group.lots) && group.lots.some(lot => (lot.lot_number || '').toLowerCase().includes(filters.lotNumber));
            if (!lotMatch) {
                return false;
            }
        }

        if (filters.groupName) {
            const names = (group.material_group_names || []).map(n => (n || '').toLowerCase());
            const match = names.some(n => n.includes(filters.groupName));
            if (!match) {
                return false;
            }
        }

        return true;
    });

    filteredGroupsCache = groups.sort((a, b) => {
        const nameA = a.material_name || '';
        const nameB = b.material_name || '';
        return nameA.localeCompare(nameB, 'ja');
    });

    currentPage = 1;
    updateSummaryTiles(filteredGroupsCache);
    renderCurrentPage();
    updatePaginationControls();
}

function renderCurrentPage() {
    const pageGroups = filteredGroupsCache.slice((currentPage - 1) * ROWS_PER_PAGE, currentPage * ROWS_PER_PAGE);
    renderGroupTable(pageGroups);
}

function renderGroupTable(groups) {
    const wrapper = document.getElementById('groupTableWrapper');
    const tbody = document.getElementById('groupTableBody');
    if (!wrapper || !tbody) {
        return;
    }

    if (!groups.length) {
        tbody.innerHTML = '';
        wrapper.classList.add('hidden');
        showEmptyState();
        return;
    }

    hideEmptyState();
    wrapper.classList.remove('hidden');

    tbody.innerHTML = groups.map(group => createGroupRow(group)).join('');

    tbody.querySelectorAll('[data-group-key]').forEach(button => {
        button.addEventListener('click', () => {
            const key = button.getAttribute('data-group-key');
            const targetGroup = groupStore.get(key);
            if (targetGroup) {
                openGroupDetailModal(targetGroup);
            }
        });
    });
}

function createGroupRow(group) {
    const lengthText = formatLengthList(group.length_variations);

    const materialCount = group.material_count.toLocaleString('ja-JP');
    const lotCount = group.lot_count.toLocaleString('ja-JP');
    const totalQuantity = group.total_quantity.toLocaleString('ja-JP');
    const totalWeight = formatWeight(group.total_weight_kg);
    const groupNamesText = formatGroupNamesList(group.material_group_names);

    return `
        <tr class="hover:bg-neutral-50 transition-all duration-200">
            <td class="px-6 py-4">
                <p class="text-sm font-semibold text-neutral-800">${escapeHtml(group.display_label)}</p>
            </td>
            <td class="px-6 py-4 text-sm text-neutral-600">${groupNamesText}</td>
            <td class="px-6 py-4 text-sm text-neutral-600">${escapeHtml(lengthText)}</td>
            <td class="px-6 py-4 text-sm text-right font-semibold text-neutral-800">${materialCount}</td>
            <td class="px-6 py-4 text-sm text-right font-semibold text-neutral-800">${lotCount}</td>
            <td class="px-6 py-4 text-sm text-right font-semibold text-neutral-800">${totalQuantity}</td>
            <td class="px-6 py-4 text-sm text-right font-semibold text-neutral-800">${totalWeight}</td>
            <td class="px-6 py-4 text-center">
                <button type="button" data-group-key="${group.key}" class="inline-flex items-center px-3 py-2 text-sm font-semibold text-white bg-primary-blue hover:bg-opacity-90 rounded-lg shadow-sm transition-all">
                    <i class="fas fa-eye mr-2"></i>詳細
                </button>
            </td>
        </tr>
    `;
}

function formatLengthList(lengths) {
    if (!Array.isArray(lengths) || lengths.length === 0) {
        return '―';
    }
    const formatted = lengths.map(length => formatLengthValue(length));
    if (formatted.length <= 3) {
        return formatted.join(' / ');
    }
    return `${formatted.slice(0, 3).join(' / ')} ほか${formatted.length - 3}種類`;
}

function formatLengthValue(value) {
    if (value === null || value === undefined || value === '') {
        return '―';
    }
    const numeric = Number(value);
    if (Number.isNaN(numeric)) {
        return String(value);
    }
    return `${numeric.toLocaleString('ja-JP')}mm`;
}

function formatWeight(value) {
    const numeric = Number(value ?? 0);
    if (Number.isNaN(numeric)) {
        return '0.00';
    }
    return numeric.toLocaleString('ja-JP', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatGroupNamesList(names) {
    const arr = Array.isArray(names) ? names.filter(Boolean) : [];
    if (arr.length === 0) return '―';
    const display = arr.slice(0, 3).join(' / ');
    return arr.length > 3 ? `${display} ほか${arr.length - 3}件` : display;
}

function updateSummaryTiles(groups) {
    const materialIds = new Set();
    let totalLots = 0;

    groups.forEach(group => {
        group.materials.forEach(material => materialIds.add(material.id));
        totalLots += group.lot_count;
    });

    document.getElementById('summaryMaterialCount').textContent = materialIds.size.toLocaleString('ja-JP');
    const groupCountEl = document.getElementById('summaryGroupCount');
    if (groupCountEl) {
        groupCountEl.textContent = groups.length.toLocaleString('ja-JP');
    }
    document.getElementById('summaryLotCount').textContent = totalLots.toLocaleString('ja-JP');
}

function updatePaginationControls() {
    const totalItems = filteredGroupsCache.length;
    const totalPages = Math.max(1, Math.ceil(totalItems / ROWS_PER_PAGE));

    // 新しいページネーション関数を使用
    if (totalItems > 0) {
        renderPagination('group', currentPage, totalPages, gotoPage);
    } else {
        // データがない場合はページネーションを非表示
        const topContainer = document.getElementById('groupPaginationTop');
        const bottomContainer = document.getElementById('groupPaginationBottom');
        if (topContainer) topContainer.innerHTML = '';
        if (bottomContainer) bottomContainer.innerHTML = '';
    }
}

function showEmptyState() {
    const empty = document.getElementById('groupEmpty');
    if (empty) {
        empty.classList.remove('hidden');
    }

    // ページネーションを非表示
    const topContainer = document.getElementById('groupPaginationTop');
    const bottomContainer = document.getElementById('groupPaginationBottom');
    if (topContainer) topContainer.innerHTML = '';
    if (bottomContainer) bottomContainer.innerHTML = '';
}

function hideEmptyState() {
    const empty = document.getElementById('groupEmpty');
    if (empty) {
        empty.classList.add('hidden');
    }
}

function debounce(fn, delay) {
    let timerId;
    return (...args) => {
        clearTimeout(timerId);
        timerId = setTimeout(() => fn(...args), delay);
    };
}

function escapeHtml(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

const detailModal = document.getElementById('groupDetailModal');
const managerModal = document.getElementById('groupManagerModal');

function closeGroupDetailModal() {
    Utils.modal.close('groupDetailModal');
}

document.getElementById('closeGroupDetail')?.addEventListener('click', closeGroupDetailModal);


document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
        if (detailModal && !detailModal.classList.contains('hidden')) {
            closeGroupDetailModal();
        } else if (managerModal && !managerModal.classList.contains('hidden')) {
            Utils.modal.close('groupManagerModal');
        }
    }
});

function openGroupDetailModal(group) {
    document.getElementById('groupDetailTitle').textContent = group.label;
    document.getElementById('groupDetailSubtitle').textContent = '';
    document.getElementById('detailMaterialCount').textContent = `${group.materials.length} 件`;
    document.getElementById('detailLotCount').textContent = `${group.lot_count} 件`;
    document.getElementById('detailTotalQuantity').textContent = `${group.total_quantity.toLocaleString('ja-JP')} 本`;
    document.getElementById('detailTotalWeight').textContent = `${formatWeight(group.total_weight_kg)} kg`;
    document.getElementById('detailLengthVariations').textContent = formatLengthList(group.length_variations);
    const groupNamesEl = document.getElementById('detailGroupNames');
    if (groupNamesEl) {
        const names = Array.isArray(group.material_group_names) ? group.material_group_names : [];
        groupNamesEl.textContent = names.length ? names.join(' / ') : '―';
    }

    const badge = document.getElementById('groupDetailTag');
    if (badge) {
        badge.textContent = '';
        badge.className = 'hidden';
    }

    renderDetailMaterials(group);
    renderDetailLots(group);

    Utils.modal.open('groupDetailModal');
}

function renderDetailMaterials(group) {
    const container = document.getElementById('detailMaterials');
    if (!container) return;

    if (!group.materials.length) {
        container.innerHTML = `
            <div class="p-4 text-center text-sm text-neutral-600">
                登録されている材料はありません。
            </div>
        `;
        return;
    }

    container.innerHTML = group.materials
        .slice()
        .sort((a, b) => (a.part_number || '').localeCompare(b.part_number || '', 'ja'))
        .map(material => {
            const displayLabel = escapeHtml(buildMaterialDisplayLabel(material));
            const updated = material.updated_at ? new Date(material.updated_at).toLocaleString('ja-JP') : '―';

            return `
                <div class="p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div>
                        <p class="text-sm font-semibold text-neutral-800">${displayLabel}</p>
                    </div>
                    <div class="flex flex-col items-start md:items-end text-xs text-neutral-600 space-y-1">
                        <span>最終更新: ${updated}</span>
                    </div>
                </div>
            `;
        }).join('');
}

function renderDetailLots(group) {
    const container = document.getElementById('detailLots');
    if (!container) return;

    if (!group.lots.length) {
        container.innerHTML = `
            <div class="p-4 text-center text-sm text-neutral-600">
                現在在庫があるロットはありません。
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <table class="min-w-full divide-y divide-neutral-200 text-sm">
            <thead class="bg-neutral-50">
                <tr>
                    <th class="px-4 py-3 text-left font-semibold text-neutral-700 uppercase tracking-wider">ロット番号</th>
                    <th class="px-4 py-3 text-left font-semibold text-neutral-700 uppercase tracking-wider">長さ</th>
                    <th class="px-4 py-3 text-left font-semibold text-neutral-700 uppercase tracking-wider">在庫数</th>
                    <th class="px-4 py-3 text-left font-semibold text-neutral-700 uppercase tracking-wider">在庫重量</th>
                    <th class="px-4 py-3 text-left font-semibold text-neutral-700 uppercase tracking-wider">保管場所</th>
                    <th class="px-4 py-3 text-left font-semibold text-neutral-700 uppercase tracking-wider">発注番号</th>
                    <th class="px-4 py-3 text-left font-semibold text-neutral-700 uppercase tracking-wider">購入月</th>
                    <th class="px-4 py-3 text-left font-semibold text-neutral-700 uppercase tracking-wider">備考</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-neutral-200">
                ${group.lots.map(lot => `
                    <tr>
                        <td class="px-4 py-3 text-neutral-800 font-semibold">${escapeHtml(lot.lot_number)}</td>
                        <td class="px-4 py-3 text-neutral-600">${formatLengthValue(lot.length_mm)}</td>
                        <td class="px-4 py-3 text-neutral-800">${lot.total_quantity.toLocaleString('ja-JP')} 本</td>
                        <td class="px-4 py-3 text-neutral-800">${formatWeight(lot.total_weight_kg)} kg</td>
                        <td class="px-4 py-3 text-neutral-600">${lot.locations.length ? lot.locations.map(loc => escapeHtml(loc)).join('<br>') : '―'}</td>
                        <td class="px-4 py-3 text-neutral-600">${lot.order_number ? escapeHtml(lot.order_number) : '―'}</td>
                        <td class="px-4 py-3 text-neutral-600">${lot.purchase_month ? escapeHtml(lot.purchase_month) : '―'}</td>
                        <td class="px-4 py-3 text-neutral-600">${lot.notes ? escapeHtml(lot.notes) : '―'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function renderDetailGroupRelations(group) {
    const container = document.getElementById('detailGroupRelations');
    if (!container) return;

    const names = Array.isArray(group.material_group_names) ? group.material_group_names : [];
    if (names.length === 0) {
        container.innerHTML = `<div class="p-4 text-center text-sm text-neutral-600">この同等品に紐づく材料グループはありません。</div>`;
        return;
    }

    container.innerHTML = names.map(name => `
        <div class="p-3 flex items-center justify-between">
            <span class="text-sm font-semibold text-neutral-800">${escapeHtml(name)}</span>
        </div>
    `).join('');
}

// =============================
// グループ管理モーダル用ロジック
// =============================

document.getElementById('openGroupManager')?.addEventListener('click', () => {
    Utils.modal.open('groupManagerModal');
    loadGroupsForManager();
});

document.getElementById('closeGroupManager')?.addEventListener('click', () => {
    Utils.modal.close('groupManagerModal');
});

document.getElementById('createGroupBtn')?.addEventListener('click', async () => {
    const nameInput = document.getElementById('groupManagerName');
    const descInput = document.getElementById('groupManagerDescription');
    const group_name = nameInput?.value?.trim();
    const description = descInput?.value?.trim() || null;

    if (!group_name) {
        alert('グループ名を入力してください');
        return;
    }
    try {
        await APIClient.createMaterialGroup({ group_name, description, is_active: true });
        nameInput.value = '';
        descInput.value = '';
        await loadGroupsForManager();
    } catch (e) {
        alert(`作成に失敗しました: ${e.message}`);
    }
});

async function loadGroupsForManager() {
    try {
        const groups = await APIClient.getMaterialGroups({ limit: 1000 });
        window._groupIdToName = new Map(groups.map(g => [g.id, g.group_name]));
        renderGroupManagerList(groups);
    } catch (e) {
        const container = document.getElementById('groupManagerList');
        if (container) {
            container.innerHTML = `<div class="p-4 text-sm text-danger-red">グループ一覧の取得に失敗しました: ${escapeHtml(e.message)}</div>`;
        }
    }
}

function renderGroupManagerList(groups) {
    const container = document.getElementById('groupManagerList');
    if (!container) return;

    if (!groups || groups.length === 0) {
        container.innerHTML = `<div class="p-4 text-center text-sm text-neutral-600">登録済みのグループはありません。</div>`;
        return;
    }

    container.innerHTML = groups
        .slice()
        .sort((a, b) => (a.group_name || '').localeCompare(b.group_name || '', 'ja'))
        .map(group => `
            <div class="p-3 flex items-center justify-between gap-3">
                <div>
                    <p class="text-sm font-semibold text-neutral-800">${escapeHtml(group.group_name)}</p>
                    ${group.description ? `<p class="text-xs text-neutral-600">${escapeHtml(group.description)}</p>` : ''}
                    <p class="text-xs text-neutral-600 mt-1">状態: ${group.is_active ? '有効' : '無効'}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button class="px-3 py-1.5 text-sm rounded-lg border border-neutral-200 bg-white hover:bg-neutral-50" onclick="renameGroup(${group.id}, '${escapeHtml(group.group_name)}')">
                        <i class="fas fa-pen mr-1"></i>名称変更
                    </button>
                    <button class="px-3 py-1.5 text-sm rounded-lg border border-primary-blue bg-white hover:bg-primary-blue hover:bg-opacity-10 text-primary-blue" onclick="openMembershipManager(${group.id})">
                        <i class="fas fa-users mr-1"></i>所属管理
                    </button>
                    <button class="px-3 py-1.5 text-sm rounded-lg border border-danger-red bg-white hover:bg-danger-red hover:bg-opacity-10 text-danger-red" onclick="deleteGroup(${group.id})">
                        <i class="fas fa-trash mr-1"></i>削除
                    </button>
                </div>
            </div>
        `).join('');
}

async function renameGroup(groupId, currentName) {
    const newName = prompt('新しいグループ名を入力してください', currentName || '');
    if (newName === null) return;
    const trimmed = newName.trim();
    if (!trimmed) {
        alert('グループ名は空にできません');
        return;
    }
    try {
        await APIClient.updateMaterialGroup(groupId, { group_name: trimmed });
        await loadGroupsForManager();
    } catch (e) {
        alert(`名称変更に失敗しました: ${e.message}`);
    }
}

async function deleteGroup(groupId) {
    if (!confirm('このグループを削除します。よろしいですか？')) return;
    try {
        await APIClient.deleteMaterialGroup(groupId);
        await loadGroupsForManager();
    } catch (e) {
        alert(`削除に失敗しました: ${e.message}`);
    }
}

// =============================
// 所属材料管理
// =============================

let selectedGroupForMembers = null;

function openMembershipManager(groupId) {
    selectedGroupForMembers = groupId;
    const section = document.getElementById('groupMembershipSection');
    const targetNameEl = document.getElementById('groupMembershipTargetName');
    if (section) section.classList.remove('hidden');
    if (targetNameEl) targetNameEl.textContent = window._groupIdToName?.get(groupId) || `#${groupId}`;
    // 初期化
    const results = document.getElementById('groupMemberSearchResults');
    if (results) results.innerHTML = '<div class="p-3 text-sm text-neutral-600">検索キーワードを入力して「検索」を押してください。</div>';
    loadGroupMembersForManager(groupId);
}

async function loadGroupMembersForManager(groupId) {
    const container = document.getElementById('groupMemberList');
    if (!container) return;
    container.innerHTML = '<div class="p-3 text-sm text-neutral-600">読み込み中...</div>';
    try {
        const members = await APIClient.getGroupMembers(groupId);
        renderGroupMemberList(members);
    } catch (e) {
        container.innerHTML = `<div class="p-3 text-sm text-danger-red">所属の取得に失敗しました: ${escapeHtml(e.message)}</div>`;
    }
}

function renderGroupMemberList(members) {
    const container = document.getElementById('groupMemberList');
    if (!container) return;
    if (!members || members.length === 0) {
        container.innerHTML = '<div class="p-3 text-center text-sm text-neutral-600">現在、このグループに所属している材料はありません。</div>';
        return;
    }
    container.innerHTML = members.map(m => `
        <div class="p-2 flex items-center justify-between">
            <span class="text-sm text-neutral-800">材料ID: ${m.material_id}</span>
            <button class="px-2 py-1 text-xs rounded-lg border border-danger-red bg-white hover:bg-danger-red hover:bg-opacity-10 text-danger-red" onclick="removeMaterialFromGroup(${m.group_id}, ${m.id})">
                <i class="fas fa-times mr-1"></i>所属解除
            </button>
        </div>
    `).join('');
}

document.getElementById('groupMemberSearchBtn')?.addEventListener('click', async () => {
    const q = document.getElementById('groupMemberSearchInput')?.value?.trim();
    const groupId = selectedGroupForMembers;
    if (!groupId) {
        alert('先に所属管理したいグループを選択してください');
        return;
    }
    if (!q) return;
    const container = document.getElementById('groupMemberSearchResults');
    if (!container) return;
    container.innerHTML = '<div class="p-3 text-sm text-neutral-600">検索中...</div>';
    try {
        const results = await APIClient.searchMaterials(q);
        if (!Array.isArray(results) || results.length === 0) {
            container.innerHTML = '<div class="p-3 text-center text-sm text-neutral-600">該当する材料が見つかりませんでした。</div>';
            return;
        }
        container.innerHTML = results.map(r => `
            <div class="p-2 flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-neutral-800">${escapeHtml(r.display_name || r.name || '（名称未設定）')}</p>
                    <p class="text-xs text-neutral-600">ID: ${r.material_id} / 径: ${r.diameter_mm ?? '―'}</p>
                </div>
                <button class="px-2 py-1 text-xs rounded-lg border border-primary-blue bg-white hover:bg-primary-blue hover:bg-opacity-10 text-primary-blue" onclick="addMaterialToGroup(${groupId}, ${r.material_id})">
                    <i class="fas fa-plus mr-1"></i>追加
                </button>
            </div>
        `).join('');
    } catch (e) {
        container.innerHTML = `<div class="p-3 text-sm text-danger-red">検索に失敗しました: ${escapeHtml(e.message)}</div>`;
    }
});

async function addMaterialToGroup(groupId, materialId) {
    try {
        await APIClient.addGroupMember(groupId, materialId);
        // materialGroupMap を更新（安全のため再取得）
        await loadMaterialGroupRelations();
        applyFiltersAndRender();
        // 所属一覧を更新
        await loadGroupMembersForManager(groupId);
    } catch (e) {
        alert(`追加に失敗しました: ${e.message}`);
    }
}

async function removeMaterialFromGroup(groupId, memberId) {
    try {
        await APIClient.removeGroupMember(groupId, memberId);
        await loadMaterialGroupRelations();
        applyFiltersAndRender();
        await loadGroupMembersForManager(groupId);
    } catch (e) {
        alert(`所属解除に失敗しました: ${e.message}`);
    }
}
</script>

{% endblock %}
