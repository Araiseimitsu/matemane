{% extends "base.html" %}

{% block title %}入庫確認 - 材料管理システム{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- ヘッダー -->
    <div class="bg-white shadow-sm border-b">
        <div class="px-4 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">入庫確認</h1>
                    <p class="text-gray-600 mt-1">発注済み材料の入庫処理を行います</p>
                </div>
                <div class="flex space-x-4">
                    <button id="refreshBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        更新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- コンテンツエリア -->
    <div class="px-4 py-6">
        <!-- フィルター -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">仕入先</label>
                    <input type="text" id="supplierFilter" placeholder="仕入先名で絞り込み"
                           class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">材料名</label>
                    <input type="text" id="materialFilter" placeholder="材料名で絞り込み"
                           class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">発注番号</label>
                    <input type="text" id="orderNumberFilter" placeholder="発注番号で絞り込み"
                           class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">径 (mm)</label>
                    <input type="number" id="diameterFilter" placeholder="例: 20" step="0.1" min="0"
                           class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex items-end space-x-2">
                    <button id="searchBtn" class="flex-1 bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition-colors">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        検索
                    </button>
                    <button id="resetFiltersBtn" class="flex-1 bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition-colors">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        リセット
                    </button>
                </div>
            </div>
        </div>

        <!-- 入庫待ちアイテム一覧 -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-900">入庫待ちアイテム</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">発注番号</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">仕入先</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">発注品名</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">発注数量/重量</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">操作</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody" class="divide-y divide-gray-200">
                        <!-- 動的に生成 -->
                    </tbody>
                </table>
            </div>
            <div id="itemsLoading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">読み込み中...</p>
            </div>
            <div id="itemsEmpty" class="text-center py-8 hidden">
                <p class="text-gray-500">入庫待ちのアイテムがありません</p>
            </div>
        </div>
    </div>
</div>

<!-- 入庫確認モーダル -->
<div id="receiveModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4 modal-overlay">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">入庫確認</h2>
                    <button id="closeReceiveModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <form id="receiveForm" class="p-6">
                <input type="hidden" id="receiveItemId" name="item_id">

                <!-- 発注アイテム情報表示 -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-3">発注アイテム情報</h3>
                    <div id="itemInfo" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <!-- 動的に生成 -->
                    </div>
                </div>

                <!-- 材料情報入力 -->
                <div class="bg-blue-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-blue-900 mb-3">材料情報入力</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">材質名 *</label>
                            <input type="text" name="material_name" required
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: SUS303">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">径入力 *</label>
                            <input type="text" name="diameter_input" required
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: φ10.0 / H12 / □20">
                            <p class="text-xs text-gray-500 mt-1">先頭にφ・H・□などの記号を付けて入力してください。</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">詳細情報</label>
                            <input type="text" name="detail_info"
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: 研磨 / 端面R付 / 面取りなど">
                            <p class="text-xs text-gray-500 mt-1">材質・寸法以降の仕上げや特記事項を入力してください。</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">区分 *</label>
                            <select name="usage_type" required
                                    class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="general">汎用</option>
                                <option value="dedicated">専用</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">比重（g/cm³）*</label>
                            <input type="number" name="density" step="0.001" min="0" required
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: 7.93">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">長さ（mm）*</label>
                            <input type="number" name="length_mm" step="1" min="1" required
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: 2500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">使用材料情報（任意）</label>
                            <textarea name="material_usage_info" rows="3"
                                      class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="例: 切断後3m→2m使用、端材利用、用途の補足など"></textarea>
                            <p class="text-xs text-gray-500 mt-1">ここに記入した内容は備考に統合されます。</p>
                        </div>
                    </div>
                </div>

                <!-- 入庫情報入力 -->
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ロット番号 *</label>
                        <input type="text" name="lot_number" required
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="例: L202501001">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">入荷日 *</label>
                        <input type="datetime-local" name="received_date" required
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- 入庫数量・重量（両方対応、相互換算） -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- 本数入力 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">入庫数量（本）</label>
                            <input type="number" id="quantityInput" name="received_quantity" min="1" step="1"
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="本数を入力">
                            <p class="text-sm text-gray-500 mt-1">本数で指定する場合</p>
                        </div>

                        <!-- 重量入力 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">入庫重量（kg）</label>
                            <input type="number" id="weightInput" name="received_weight" step="0.001" min="0.001"
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="重量を入力">
                            <p class="text-sm text-gray-500 mt-1">重量で指定する場合</p>
                        </div>
                    </div>

                    <!-- 換算結果表示 -->
                    <div id="conversionDisplay" class="bg-blue-50 rounded-lg p-4 mt-3">
                        <h4 class="text-sm font-medium text-blue-900 mb-2">換算結果</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="bg-white rounded p-3">
                                <span class="font-medium text-gray-700">本数:</span>
                                <span id="displayQuantity" class="text-blue-600 font-mono">-</span>本
                            </div>
                            <div class="bg-white rounded p-3">
                                <span class="font-medium text-gray-700">重量:</span>
                                <span id="displayWeight" class="text-blue-600 font-mono">-</span>kg
                            </div>
                        </div>
                        <div class="mt-2 bg-white rounded p-3">
                            <span class="font-medium text-gray-700">1本あたりの重量:</span>
                            <span id="displayUnitWeight" class="text-green-600 font-mono">-</span>kg
                        </div>
                    </div>

                    <!-- 入力方式選択 -->
                    <div class="mt-4">
                        <p class="text-sm text-gray-600 mb-2">入力方式を選択してください</p>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="input_method" value="quantity" checked
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">本数で入力</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="input_method" value="weight"
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">重量で入力</span>
                            </label>
                        </div>
                    </div>

                    <!-- 単価・金額 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">単価</label>
                            <input type="number" id="unitPriceInput" name="unit_price" step="0.01" min="0"
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: 1500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">金額</label>
                            <input type="number" id="amountInput" name="amount" step="0.01" min="0"
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: 150000">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">置き場（複数選択可）</label>
                        <select name="location_ids" multiple
                                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <!-- 動的に生成 -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Ctrl/Shiftキーで複数選択できます。未選択でも登録可能です。</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">備考</label>
                        <textarea name="notes" rows="3"
                                  class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="入庫時の特記事項があれば記入してください"></textarea>
                    </div>
                </div>

                <!-- 送信ボタン -->
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelReceive" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                        キャンセル
                    </button>
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        入庫確定
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 入庫完了モーダル -->
<div id="receiveCompleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4 modal-overlay">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                </div>
                <div class="text-center">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">入庫完了</h3>
                    <p class="text-sm text-gray-600 mb-4">入庫処理が正常に完了しました</p>

                    <div id="completeInfo" class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
                        <!-- 動的に生成 -->
                    </div>

                    <div class="flex space-x-3">
                        <button id="printLabelBtn" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                            現品票印刷
                        </button>
                        <button id="closeCompleteModal" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                            閉じる
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 入庫確認の主要機能
const SHAPE_SYMBOL_MAP = {
    round: ['φ', 'Φ', '⌀', 'Ø', 'ø', 'ϕ', '￠'],
    hexagon: ['H', 'h', 'Ｈ', 'ｈ'],
    square: ['□', '■', '口', '▢']
};

const SHAPE_WORD_PREFIXES = [
    { prefix: 'hex', shape: 'hexagon' },
    { prefix: '六角', shape: 'hexagon' },
    { prefix: 'square', shape: 'square' },
    { prefix: '角', shape: 'square' },
    { prefix: 'round', shape: 'round' }
];

function normalizeDiameterDigits(value) {
    if (typeof value !== 'string') return '';
    return value
        .replace(/[０-９]/g, char => String.fromCharCode(char.charCodeAt(0) - 0xFEE0))
        .replace(/．/g, '.')
        .replace(/，/g, ',');
}

function parseDiameterInputValue(raw) {
    if (!raw || !raw.trim()) {
        return { error: '径を入力してください' };
    }
    let text = raw.normalize('NFKC').trim();
    let shape = null;

    const lower = text.toLowerCase();
    const wordPrefix = SHAPE_WORD_PREFIXES.find(entry => lower.startsWith(entry.prefix));
    if (wordPrefix) {
        shape = wordPrefix.shape;
        text = text.slice(wordPrefix.prefix.length).trim();
    } else {
        const firstChar = text.charAt(0);
        for (const [key, symbols] of Object.entries(SHAPE_SYMBOL_MAP)) {
            if (symbols.includes(firstChar)) {
                shape = key;
                text = text.slice(1).trimStart();
                break;
            }
        }
    }

    if (!shape) {
        return { error: '先頭に形状記号（φ・H・□など）を付けてください' };
    }

    text = text.replace(/(mm|㎜)/gi, ' ');
    const numberMatch = text.match(/(\d+(?:[.,]\d+)?)/);
    if (!numberMatch) {
        return { error: '径の数値が確認できません' };
    }

    const diameter = parseFloat(numberMatch[1].replace(',', '.'));
    if (!(diameter > 0)) {
        return { error: '径は正の数で入力してください' };
    }

    return { shape, diameter_mm: diameter };
}

function roundTo3(value) {
    return Math.round(value * 1000) / 1000;
}

function calculateUnitWeightKg(shape, diameterMm, lengthMm, density) {
    const lengthCm = lengthMm / 10;
    const base = diameterMm / 10;
    let volumeCm3;
    if (shape === 'round') {
        const radiusCm = base / 2;
        volumeCm3 = Math.PI * radiusCm * radiusCm * lengthCm;
    } else if (shape === 'hexagon') {
        volumeCm3 = (3 * Math.sqrt(3) / 2) * Math.pow(base, 2) * lengthCm;
    } else if (shape === 'square') {
        volumeCm3 = Math.pow(base, 2) * lengthCm;
    } else {
        throw new Error('未対応の形状です');
    }
    return volumeCm3 * density / 1000;
}

function updateConversionDisplays(quantity, weight, unitWeight) {
    const quantityEl = document.getElementById('displayQuantity');
    const weightEl = document.getElementById('displayWeight');
    const unitWeightEl = document.getElementById('displayUnitWeight');

    quantityEl.textContent = Number.isFinite(quantity) && quantity > 0 ? String(quantity) : '-';
    weightEl.textContent = typeof weight === 'number' && Number.isFinite(weight) ? weight.toFixed(3) : '-';
    unitWeightEl.textContent = typeof unitWeight === 'number' && Number.isFinite(unitWeight) ? unitWeight.toFixed(3) : '-';
}

function clearConversionDisplays() {
    updateConversionDisplays(null, null, null);
}

document.addEventListener('DOMContentLoaded', function() {
    // 初期化
    loadPendingItems();
    loadLocations();
    setupEventListeners();

    // フィルターのリアルタイム更新設定
    setupFilterListeners();
    updateConversion();
});

// 入庫待ちアイテム読み込み
async function loadPendingItems() {
    const tableBody = document.getElementById('itemsTableBody');
    const loading = document.getElementById('itemsLoading');
    const empty = document.getElementById('itemsEmpty');

    loading.classList.remove('hidden');
    tableBody.innerHTML = '';
    empty.classList.add('hidden');

    try {
        const response = await fetch('/api/purchase-orders/pending/items/');
        const items = await response.json();

        loading.classList.add('hidden');

        if (items.length === 0) {
            empty.classList.remove('hidden');
            return;
        }

        // 発注情報も取得するために、各アイテムに対して詳細を取得
        const itemsWithOrders = await Promise.all(
            items.map(async (item) => {
                try {
                    const orderResponse = await fetch(`/api/purchase-orders/${item.purchase_order_id}`);
                    const order = await orderResponse.json();
                    return { ...item, purchase_order: order };
                } catch (error) {
                    console.error('発注情報取得エラー:', error);
                    return item;
                }
            })
        );

        itemsWithOrders.forEach(item => {
            const row = createItemRow(item);
            tableBody.appendChild(row);
        });

        // 初期表示時のフィルター状況を設定
        updateFilterStatus(itemsWithOrders.length, itemsWithOrders.length);
    } catch (error) {
        loading.classList.add('hidden');
        console.error('入庫待ちアイテム読み込みエラー:', error);
        showToast('入庫待ちアイテムの読み込みに失敗しました', 'error');
    }
}

// 置き場一覧読み込み（1〜300で固定）
async function loadLocations() {
    try {
        const select = document.querySelector('select[name="location_ids"]');
        if (!select) return;
        // 既存のオプションを全てクリア
        select.innerHTML = '';

        for (let i = 1; i <= 300; i++) {
            const option = document.createElement('option');
            option.value = String(i);
            option.textContent = String(i);
            select.appendChild(option);
        }
    } catch (error) {
        console.error('置き場読み込みエラー:', error);
    }
}

// アイテム行作成
function createItemRow(item) {
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50';

    const orderNumber = item.purchase_order ? item.purchase_order.order_number : '-';
    const supplier = item.purchase_order ? item.purchase_order.supplier : '-';

    row.innerHTML = `
        <td class="px-4 py-3 text-sm font-medium text-gray-900">${orderNumber}</td>
        <td class="px-4 py-3 text-sm text-gray-600">${supplier}</td>
        <td class="px-4 py-3 text-sm text-gray-600">${item.item_name}</td>
        <td class="px-4 py-3 text-sm text-gray-600">${getOrderDisplayText(item)}</td>
        <td class="px-4 py-3">
            <button onclick="showReceiveModal(${item.id})"
                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">
                入庫確認
            </button>
        </td>
    `;

    return row;
}

// 形状テキスト取得
function getShapeText(shape) {
    const shapeMap = {
        'round': '丸棒',
        'hexagon': '六角棒',
        'square': '角棒'
    };
    return shapeMap[shape] || shape;
}

// 汎用/専用区分のバッジを取得
function getUsageTypeBadge(usageType) {
    if (!usageType || usageType === 'general') {
        return '<span class="px-2 py-0.5 text-xs font-medium rounded-full bg-blue-100 text-blue-800">汎用</span>';
    } else if (usageType === 'dedicated') {
        return '<span class="px-2 py-0.5 text-xs font-medium rounded-full bg-purple-100 text-purple-800">専用</span>';
    }
    return '';
}

// 発注方式テキスト取得
function getOrderTypeText(orderType) {
    const typeMap = {
        'quantity': '本数指定',
        'weight': '重量指定'
    };
    return typeMap[orderType] || orderType;
}

// 発注表示テキスト取得
function getOrderDisplayText(item) {
    if (item.order_type === 'weight') {
        return `${item.ordered_weight_kg}kg`;
    } else {
        return `${item.ordered_quantity}本`;
    }
}

// 本数・重量の相互換算と表示更新
function updateConversion() {
    try {
        const quantityInput = document.getElementById('quantityInput');
        const weightInput = document.getElementById('weightInput');
        const diameterInput = document.querySelector('input[name="diameter_input"]');
        const densityInput = document.querySelector('input[name="density"]');
        const lengthInput = document.querySelector('input[name="length_mm"]');

        if (!diameterInput || !densityInput || !lengthInput) {
            clearConversionDisplays();
            return;
        }

        const parsedDiameter = parseDiameterInputValue(normalizeDiameterDigits(diameterInput.value || ''));
        if (parsedDiameter.error) {
            diameterInput.setCustomValidity(parsedDiameter.error);
            clearConversionDisplays();
            return;
        }
        diameterInput.setCustomValidity('');

        const density = parseFloat(densityInput.value);
        const lengthMm = parseInt(lengthInput.value, 10);

        if (!(density > 0) || !(lengthMm > 0)) {
            clearConversionDisplays();
            return;
        }

        const unitWeight = roundTo3(calculateUnitWeightKg(parsedDiameter.shape, parsedDiameter.diameter_mm, lengthMm, density));

        const selectedMethod = document.querySelector('input[name="input_method"]:checked');
        const method = selectedMethod ? selectedMethod.value : 'quantity';

        const quantity = parseInt(quantityInput.value, 10);
        const weight = parseFloat(weightInput.value);

        let displayQuantity = null;
        let displayWeight = null;

        if (method === 'quantity' && Number.isFinite(quantity) && quantity > 0) {
            displayQuantity = quantity;
            displayWeight = roundTo3(unitWeight * quantity);
        } else if (method === 'weight' && Number.isFinite(weight) && weight > 0) {
            displayWeight = roundTo3(weight);
            const computedQuantity = Math.max(1, Math.round(weight / unitWeight));
            displayQuantity = computedQuantity;
        } else if (Number.isFinite(quantity) && quantity > 0) {
            displayQuantity = quantity;
            displayWeight = roundTo3(unitWeight * quantity);
        } else if (Number.isFinite(weight) && weight > 0) {
            displayWeight = roundTo3(weight);
            const computedQuantity = Math.max(1, Math.round(weight / unitWeight));
            displayQuantity = computedQuantity;
        }

        updateConversionDisplays(displayQuantity, displayWeight, unitWeight);
    } catch (error) {
        console.error('換算計算エラー:', error);
        const diameterInput = document.querySelector('input[name="diameter_input"]');
        if (diameterInput) {
            diameterInput.setCustomValidity('径の換算に失敗しました');
        }
        clearConversionDisplays();
    }
}

// イベントリスナー設定
function setupEventListeners() {
    // 更新ボタン
    document.getElementById('refreshBtn').addEventListener('click', loadPendingItems);

    // モーダル閉じる
    document.getElementById('closeReceiveModal').addEventListener('click', hideReceiveModal);
    document.getElementById('cancelReceive').addEventListener('click', hideReceiveModal);
    document.getElementById('closeCompleteModal').addEventListener('click', hideCompleteModal);

    // モーダル外クリック閉じ
    document.getElementById('receiveModal').addEventListener('click', function(e) {
        if (e.target === this || e.target.classList.contains('modal-overlay')) {
            hideReceiveModal();
        }
    });
    document.getElementById('receiveCompleteModal').addEventListener('click', function(e) {
        if (e.target === this || e.target.classList.contains('modal-overlay')) {
            hideCompleteModal();
        }
    });

    // ESCキー処理
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const receiveModal = document.getElementById('receiveModal');
            const completeModal = document.getElementById('receiveCompleteModal');

            if (!receiveModal.classList.contains('hidden')) {
                hideReceiveModal();
            } else if (!completeModal.classList.contains('hidden')) {
                hideCompleteModal();
            }
        }
    });

    // フォーム送信
    document.getElementById('receiveForm').addEventListener('submit', handleReceive);

    // 検索・フィルター
    document.getElementById('searchBtn').addEventListener('click', searchItems);
    document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);

    // 現品票印刷
    document.getElementById('printLabelBtn').addEventListener('click', printLabel);

    const diameterInput = document.querySelector('input[name="diameter_input"]');
    if (diameterInput) {
        diameterInput.addEventListener('input', updateConversion);
    }

    const densityInput = document.querySelector('input[name="density"]');
    if (densityInput) {
        densityInput.addEventListener('input', updateConversion);
    }

    const lengthInput = document.querySelector('input[name="length_mm"]');
    if (lengthInput) {
        lengthInput.addEventListener('input', updateConversion);
    }
}

// フィルターリスナー設定
function setupFilterListeners() {
    const filters = ['supplierFilter', 'materialFilter', 'orderNumberFilter', 'diameterFilter'];

    filters.forEach(filterId => {
        const element = document.getElementById(filterId);
        // テキストフィールドは入力停止後に検索
        let timeoutId;
        element.addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(searchItems, 500); // 500ms待機
        });
    });
}

// フィルターリセット
function resetFilters() {
    document.getElementById('supplierFilter').value = '';
    document.getElementById('materialFilter').value = '';
    document.getElementById('orderNumberFilter').value = '';
    document.getElementById('diameterFilter').value = '';

    // リセット後に全件読み込み
    loadPendingItems();
}

// 発注品名などのテキストをコピー
function copyFromElement(elementId) {
    try {
        const el = document.getElementById(elementId);
        if (!el) {
            showToast('コピー対象が見つかりません', 'error');
            return;
        }
        const text = el.textContent.trim();
        navigator.clipboard.writeText(text).then(() => {
            showToast('発注品名をコピーしました', 'success');
        }).catch((err) => {
            console.error('コピー失敗:', err);
            showToast('コピーに失敗しました', 'error');
        });
    } catch (error) {
        console.error('コピー処理エラー:', error);
        showToast('コピー処理でエラーが発生しました', 'error');
    }
}


// 入庫確認モーダル表示
async function showReceiveModal(itemId) {
    try {
        // アイテム詳細取得
        const response = await fetch(`/api/purchase-orders/pending/items/`);
        const items = await response.json();
        const item = items.find(i => i.id === itemId);

        if (!item) {
            showToast('アイテムが見つかりません', 'error');
            return;
        }

        // 発注情報取得
        const orderResponse = await fetch(`/api/purchase-orders/${item.purchase_order_id}`);
        const order = await orderResponse.json();

        // モーダル内容設定
        document.getElementById('receiveItemId').value = itemId;

        const itemInfo = document.getElementById('itemInfo');
        itemInfo.innerHTML = `
            <div>
                <dt class="font-medium text-gray-500">発注番号</dt>
                <dd class="text-gray-900">${order.order_number}</dd>
            </div>
            <div>
                <dt class="font-medium text-gray-500">仕入先</dt>
                <dd class="text-gray-900">${order.supplier}</dd>
            </div>
            <div>
                <dt class="font-medium text-gray-500">発注品名</dt>
                <dd class="text-gray-900">
                    <div class="mt-2">
                        <textarea id="purchaseItemNameTextarea" class="w-full mt-1 p-2 text-sm border rounded bg-white" rows="2" readonly>${item.item_name}</textarea>
                        <div class="mt-1">
                            <button type="button" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300"
                                onclick="copySelectionFromTextarea('purchaseItemNameTextarea')">
                                選択範囲をコピー
                            </button>
                        </div>
                    </div>
                </dd>
            </div>
            <div>
                <dt class="font-medium text-gray-500">発注方式</dt>
                <dd class="text-gray-900">${getOrderTypeText(item.order_type)}</dd>
            </div>
            <div>
                <dt class="font-medium text-gray-500">${item.order_type === 'quantity' ? '発注数量' : '発注重量'}</dt>
                <dd class="text-gray-900">${item.order_type === 'quantity' ? item.ordered_quantity + '本' : item.ordered_weight_kg + 'kg'}</dd>
            </div>
            <div>
                <dt class="font-medium text-gray-500">管理コード</dt>
                <dd class="text-gray-900 font-mono text-xs">${item.management_code}</dd>
            </div>
        `;

        // 入荷日のデフォルト値を現在時刻に設定
        const now = new Date();
        const localDateTime = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0') + 'T' +
            String(now.getHours()).padStart(2, '0') + ':' +
            String(now.getMinutes()).padStart(2, '0');
        document.querySelector('input[name="received_date"]').value = localDateTime;

        // 長さ（mm）のデフォルト値を設定
        const lengthInput = document.querySelector('input[name="length_mm"]');
        if (lengthInput) {
            lengthInput.value = 2500;
        }

        // 入力フィールドの参照を取得
        const quantityInput = document.getElementById('quantityInput');
        const weightInput = document.getElementById('weightInput');
        const inputMethodRadios = document.querySelectorAll('input[name="input_method"]');

        // 発注方式に応じてデフォルト値を設定
        if (item.order_type === 'weight') {
            // 重量指定発注の場合は重量をデフォルトに
            weightInput.value = item.ordered_weight_kg;
            document.querySelector('input[name="input_method"][value="weight"]').checked = true;
        } else {
            // 本数指定発注の場合は本数をデフォルトに
            quantityInput.value = item.ordered_quantity;
            document.querySelector('input[name="input_method"][value="quantity"]').checked = true;
        }

        quantityInput.oninput = function() {
            if (this.value) {
                weightInput.value = '';
                document.querySelector('input[name="input_method"][value="quantity"]').checked = true;
            }
            updateConversion();
        };

        weightInput.oninput = function() {
            if (this.value) {
                quantityInput.value = '';
                document.querySelector('input[name="input_method"][value="weight"]').checked = true;
            }
            updateConversion();
        };

        inputMethodRadios.forEach(radio => {
            radio.onchange = function() {
                if (this.value === 'quantity') {
                    quantityInput.focus();
                    weightInput.value = '';
                } else {
                    weightInput.focus();
                    quantityInput.value = '';
                }
                updateConversion();
            };
        });

        updateConversion();
        document.getElementById('receiveModal').classList.remove('hidden');
    } catch (error) {
        console.error('入庫確認モーダル表示エラー:', error);
        showToast('入庫確認画面の表示に失敗しました', 'error');
    }
}

// 入庫確認モーダル非表示
function hideReceiveModal() {
    document.getElementById('receiveModal').classList.add('hidden');
    document.getElementById('receiveForm').reset();

    // 新しいフィールドもリセット
    document.getElementById('quantityInput').value = '';
    document.getElementById('weightInput').value = '';
    document.querySelector('input[name="input_method"][value="quantity"]').checked = true;
    clearConversionDisplays();
    // 置き場選択のリセット（複数選択）
    const locSelect = document.querySelector('select[name="location_ids"]');
    if (locSelect) {
        Array.from(locSelect.options).forEach(opt => opt.selected = false);
    }
}

// 入庫完了モーダル非表示
function hideCompleteModal() {
    document.getElementById('receiveCompleteModal').classList.add('hidden');
}

// 入庫処理
async function handleReceive(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const itemId = formData.get('item_id');
    // 入力方式を判定
    const inputMethod = document.querySelector('input[name="input_method"]:checked').value;
    const quantityInput = document.getElementById('quantityInput');
    const weightInput = document.getElementById('weightInput');

    const selectedLocationOptions = Array.from(document.querySelector('select[name="location_ids"]').selectedOptions);
    const selectedLocationIds = selectedLocationOptions.map(opt => parseInt(opt.value, 10)).filter(id => !isNaN(id));

    const diameterInputField = document.querySelector('input[name="diameter_input"]');
    const rawDiameterInput = formData.get('diameter_input') || '';
    const normalizedDiameterInput = normalizeDiameterDigits(rawDiameterInput);
    if (diameterInputField && normalizedDiameterInput !== rawDiameterInput) {
        diameterInputField.value = normalizedDiameterInput;
        updateConversion();
    }
    formData.set('diameter_input', normalizedDiameterInput);

    const parsedDiameter = parseDiameterInputValue(normalizedDiameterInput);
    if (parsedDiameter.error) {
        if (diameterInputField) {
            diameterInputField.setCustomValidity(parsedDiameter.error);
            diameterInputField.reportValidity();
        }
        showToast(parsedDiameter.error, 'error');
        return;
    }
    if (diameterInputField) {
        diameterInputField.setCustomValidity('');
    }

    const densityValue = parseFloat(formData.get('density'));
    if (!(densityValue > 0)) {
        showToast('比重を正しく入力してください', 'error');
        return;
    }

    const lengthValue = parseInt(formData.get('length_mm'), 10);
    if (!(lengthValue > 0)) {
        showToast('長さを正しく入力してください', 'error');
        return;
    }

    const materialData = {
        material_name: (formData.get('material_name') || '').trim(),
        detail_info: (formData.get('detail_info') || '').trim() || null,
        diameter_mm: parsedDiameter.diameter_mm,
        shape: parsedDiameter.shape,
        usage_type: formData.get('usage_type'),
        density: densityValue,
        length_mm: lengthValue
    };

    const receiveData = {
        lot_number: formData.get('lot_number'),
        received_date: formData.get('received_date'),
        notes: formData.get('notes') || null,
        ...materialData
    };

    // 単価・金額
    if (formData.get('unit_price')) {
        receiveData.unit_price = parseFloat(formData.get('unit_price'));
    }
    if (formData.get('amount')) {
        receiveData.amount = parseFloat(formData.get('amount'));
    }

    if (selectedLocationIds.length > 0) {
        receiveData.location_ids = selectedLocationIds;
    }

    // 使用材料情報は備考に統合して送信（API互換のため）
    const usageInfo = formData.get('material_usage_info');
    if (usageInfo && usageInfo.trim().length > 0) {
        const baseNotes = receiveData.notes ? String(receiveData.notes) : '';
        const prefix = baseNotes ? baseNotes + '\n' : '';
        receiveData.notes = (prefix + '使用材料情報: ' + usageInfo.trim());
    }

    // 入力された値を取得
    if (inputMethod === 'weight' && weightInput.value) {
        receiveData.received_weight_kg = parseFloat(weightInput.value);
    } else if (inputMethod === 'quantity' && quantityInput.value) {
        receiveData.received_quantity = parseInt(quantityInput.value);
    } else {
        showToast('入庫数量または重量を入力してください', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/purchase-orders/items/${itemId}/receive/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(receiveData)
        });

        if (response.ok) {
            const result = await response.json();

            // 完了モーダル表示
            showCompleteModal(result);

            // アイテム一覧更新
            hideReceiveModal();
            loadPendingItems();

        } else {
            const error = await response.json();
            showToast(error.detail || '入庫確認に失敗しました', 'error');
        }
    } catch (error) {
        console.error('入庫確認エラー:', error);
        showToast('入庫確認に失敗しました', 'error');
    }
}

// 入庫完了モーダル表示
function showCompleteModal(result) {
    const completeInfo = document.getElementById('completeInfo');
    completeInfo.innerHTML = `
        <div class="space-y-2 text-sm">
            <div class="flex justify-between">
                <span class="font-medium text-gray-500">ロットID:</span>
                <span class="text-gray-900">${result.lot_id}</span>
            </div>
            <div class="flex justify-between">
                <span class="font-medium text-gray-500">アイテムID:</span>
                <span class="text-gray-900">${result.item_id}</span>
            </div>
            <div class="flex justify-between">
                <span class="font-medium text-gray-500">管理コード:</span>
                <span class="text-gray-900 font-mono text-xs">${result.management_code}</span>
            </div>
        </div>
    `;

    // 現品票印刷用にデータを保存
    window.currentReceiveResult = result;

    document.getElementById('receiveCompleteModal').classList.remove('hidden');
}

// 現品票印刷
async function printLabel() {
    if (!window.currentReceiveResult) {
        showToast('印刷データが見つかりません', 'error');
        return;
    }

    try {
        const response = await fetch('/api/labels/print/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                item_id: window.currentReceiveResult.item_id,
                format: 'label' // または 'a4'
            })
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `label_${window.currentReceiveResult.management_code}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showToast('現品票を印刷しました', 'success');
        } else {
            showToast('現品票の印刷に失敗しました', 'error');
        }
    } catch (error) {
        console.error('現品票印刷エラー:', error);
        showToast('現品票の印刷に失敗しました', 'error');
    }
}

// 検索機能（改善版：フィルタリング後の表示件数を表示）
function searchItems() {
    const supplierFilter = document.getElementById('supplierFilter').value.toLowerCase();
    const materialFilter = document.getElementById('materialFilter').value.toLowerCase();
    const orderNumberFilter = document.getElementById('orderNumberFilter').value.toLowerCase();
    const diameterStr = document.getElementById('diameterFilter').value;
    const diameterFilter = diameterStr ? parseFloat(diameterStr) : null;

    const rows = document.querySelectorAll('#itemsTableBody tr');
    let visibleCount = 0;

    rows.forEach(row => {
        const orderNumber = row.cells[0].textContent.toLowerCase();
        const supplier = row.cells[1].textContent.toLowerCase();
        const material = row.cells[2].textContent.toLowerCase();
        const dimensionsText = row.cells[3].textContent;
        const match = dimensionsText.match(/([\d\.]+)\s*mm/i);
        const rowDiameter = match ? parseFloat(match[1]) : null;

        const matchOrder = !orderNumberFilter || orderNumber.includes(orderNumberFilter);
        const matchSupplier = !supplierFilter || supplier.includes(supplierFilter);
        const matchMaterial = !materialFilter || material.includes(materialFilter);
        const matchDiameter = diameterFilter === null || (rowDiameter !== null && rowDiameter === diameterFilter);

        if (matchOrder && matchSupplier && matchMaterial && matchDiameter) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // フィルタリング結果をヘッダーに表示
    updateFilterStatus(visibleCount, rows.length);
}

// フィルター状況表示
function updateFilterStatus(visibleCount, totalCount) {
    const headerElement = document.querySelector('.p-4.border-b h2');
    if (visibleCount === totalCount) {
        headerElement.textContent = `入庫待ちアイテム（${totalCount}件）`;
    } else {
        headerElement.textContent = `入庫待ちアイテム（${visibleCount}/${totalCount}件表示）`;
    }
}

// テキストエリアの選択範囲をクリップボードへコピー
function copySelectionFromTextarea(textareaId) {
    const ta = document.getElementById(textareaId);
    if (!ta) return;
    const start = ta.selectionStart ?? 0;
    const end = ta.selectionEnd ?? start;
    const s = Math.min(start, end);
    const e = Math.max(start, end);
    const text = ta.value.substring(s, e);
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text);
    } else {
        const tmp = document.createElement('textarea');
        tmp.value = text;
        document.body.appendChild(tmp);
        tmp.focus();
        tmp.select();
        try { document.execCommand('copy'); } catch (e) {}
        document.body.removeChild(tmp);
    }
}
</script>
{% endblock %}
