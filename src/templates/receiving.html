{% extends "base.html" %}

{% block title %}入庫確認 - 材料管理システム{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- ヘッダー -->
    <div class="bg-white shadow-sm border-b">
        <div class="px-4 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">入庫確認</h1>
                    <p class="text-gray-600 mt-1">発注済み材料の入庫処理を行います</p>
                </div>
                <div class="flex space-x-4">
                    <button id="refreshBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        更新
                    </button>
                    <button id="openInspectionBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V4a2 2 0 10-4 0v1.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5"/>
                        </svg>
                        検品
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- コンテンツエリア -->
    <div class="px-4 py-6">
        <!-- フィルター -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">仕入先</label>
                    <input type="text" id="supplierFilter" placeholder="仕入先名で絞り込み"
                           class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">材料名</label>
                    <input type="text" id="materialFilter" placeholder="材料名で絞り込み"
                           class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">発注番号</label>
                    <input type="text" id="orderNumberFilter" placeholder="発注番号で絞り込み"
                           class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">径 (mm)</label>
                    <input type="number" id="diameterFilter" placeholder="例: 20" step="0.1" min="0"
                           class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex items-end space-x-2">
                    <button id="searchBtn" class="flex-1 bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition-colors">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        検索
                    </button>
                    <button id="resetFiltersBtn" class="flex-1 bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition-colors">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        リセット
                    </button>
                </div>
            </div>
        </div>

        <!-- 入庫待ちアイテム一覧 -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-900">入庫待ちアイテム</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">発注番号</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">仕入先</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">発注品名</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">発注数量/重量</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">操作</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody" class="divide-y divide-gray-200">
                        <!-- 動的に生成 -->
                    </tbody>
                </table>
            </div>
            <div id="itemsLoading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">読み込み中...</p>
            </div>
            <div id="itemsEmpty" class="text-center py-8 hidden">
                <p class="text-gray-500">入庫待ちのアイテムがありません</p>
            </div>
        </div>
    </div>
</div>

<!-- 入庫確認モーダル -->
<div id="receiveModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4 modal-overlay">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">入庫確認</h2>
                    <button id="closeReceiveModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <form id="receiveForm" class="p-6">
                <input type="hidden" id="receiveItemId" name="item_id">

                <!-- 発注アイテム情報表示 -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-3">発注アイテム情報</h3>
                    <div id="itemInfo" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <!-- 動的に生成 -->
                    </div>
                </div>

                <!-- 材料情報入力 -->
                <div class="bg-blue-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-blue-900 mb-3">材料情報入力</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">材質名 *</label>
                            <input type="text" name="material_name" required
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: SUS303">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">径入力 *</label>
                            <input type="text" name="diameter_input" required
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: φ10.0 / H12 / □20">
                            <p class="text-xs text-gray-500 mt-1">先頭にφ・H・□などの記号を付けて入力してください。</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">詳細情報</label>
                            <input type="text" name="detail_info"
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: 研磨 / 端面R付 / 面取りなど">
                            <p class="text-xs text-gray-500 mt-1">材質・寸法以降の仕上げや特記事項を入力してください。</p>
                        </div>
                        <!-- 区分選択は廃止 -->
                        <!--
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">区分 *</label>
                            <select name="usage_type" required
                                    class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="general">汎用</option>
                                <option value="dedicated">専用</option>
                            </select>
                        </div>
                        -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">材料グループ（任意）</label>
                            <select id="groupSelect" name="group_id"
                                    class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">未指定</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">同等材料の在庫集計用グループを選択できます。</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">比重（g/cm³）*</label>
                            <input type="number" name="density" step="0.001" min="0" required
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: 7.93">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">長さ（mm）*</label>
                            <input type="number" name="length_mm" step="1" min="1" required
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: 2500">
                        </div>
                        
                    </div>
                </div>

                <!-- 入庫情報入力 -->
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ロット番号 *</label>
                        <input type="text" name="lot_number" required
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="例: L202501001">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">入荷日 *</label>
                        <input type="date" name="received_date" required
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- 入庫数量・重量（両方対応、相互換算） -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- 本数入力 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">入庫数量（本）</label>
                            <input type="number" id="quantityInput" name="received_quantity" min="1" step="1"
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="本数を入力">
                            <p class="text-sm text-gray-500 mt-1">本数で指定する場合</p>
                        </div>

                        <!-- 重量入力 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">入庫重量（kg）</label>
                            <input type="number" id="weightInput" name="received_weight" step="0.001" min="0.001"
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="重量を入力">
                            <p class="text-sm text-gray-500 mt-1">重量で指定する場合</p>
                        </div>
                    </div>

                    <!-- 換算結果表示 -->
                    <div id="conversionDisplay" class="bg-blue-50 rounded-lg p-4 mt-3">
                        <h4 class="text-sm font-medium text-blue-900 mb-2">換算結果</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="bg-white rounded p-3">
                                <span class="font-medium text-gray-700">本数:</span>
                                <span id="displayQuantity" class="text-blue-600 font-mono">-</span>本
                            </div>
                            <div class="bg-white rounded p-3">
                                <span class="font-medium text-gray-700">重量:</span>
                                <span id="displayWeight" class="text-blue-600 font-mono">-</span>kg
                            </div>
                        </div>
                        <div class="mt-2 bg-white rounded p-3">
                            <span class="font-medium text-gray-700">1本あたりの重量:</span>
                            <span id="displayUnitWeight" class="text-green-600 font-mono">-</span>kg
                        </div>
                    </div>

                    <!-- 入力方式選択 -->
                    <div class="mt-4">
                        <p class="text-sm text-gray-600 mb-2">入力方式を選択してください</p>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="input_method" value="quantity" checked
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">本数で入力</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="input_method" value="weight"
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">重量で入力</span>
                            </label>
                        </div>
                    </div>

                    <!-- 単価・金額 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">単価</label>
                            <input type="number" id="unitPriceInput" name="unit_price" step="0.01" min="0"
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: 1500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">金額</label>
                            <input type="number" id="amountInput" name="amount" step="0.01" min="0"
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="例: 150000">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">置き場（複数可）</label>
                        <input type="text" name="location_ids"
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="例: 12, 23, 45">
                        <p class="text-xs text-gray-500 mt-1">カンマ区切りで複数指定可能です。未入力でも登録可能です。複数指定時でも数量は分けず、第一置き場に登録します。</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">備考</label>
                        <textarea name="notes" rows="3"
                                  class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="入庫時の特記事項があれば記入してください"></textarea>
                    </div>
                </div>

                <!-- 送信ボタン -->
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelReceive" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                        キャンセル
                    </button>
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        入庫確定
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 入庫完了モーダル -->
<div id="receiveCompleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4 modal-overlay">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                </div>
                <div class="text-center">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">入庫完了</h3>
                    <p class="text-sm text-gray-600 mb-4">入庫処理が正常に完了しました</p>

                    <div id="completeInfo" class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
                        <!-- 動的に生成 -->
                    </div>

                    <div class="flex space-x-3">
                        <button id="goToInspectionBtn" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors">
                            検品へ
                        </button>
                        <button id="printLabelBtn" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                            現品票印刷
                        </button>
                        <button id="closeCompleteModal" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                            閉じる
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 検品モーダル -->
<div id="inspectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4 modal-overlay">
        <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">検品</h2>
                    <button id="closeInspectionModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <form id="inspectionForm" class="p-6 space-y-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-900 mb-2">対象選択</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-700">管理コード（UUID）</label>
                            <input type="text" id="inspectionCodeInput" class="mt-1 w-full rounded-md border-gray-300 shadow-sm" placeholder="例: 123e4567-e89b-12d3-a456-426614174000">
                        </div>
                        <div>
                            <button type="button" id="loadInspectionTargetBtn" class="w-full px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">読み込み</button>
                        </div>
                    </div>
                    <p id="inspectionTargetInfo" class="text-xs text-gray-600 mt-2">管理コードを入力して読み込んでください。</p>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">確認日時</label>
                        <input type="datetime-local" id="inspectedAtInput" name="inspected_at"
                               class="mt-1 w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">実測値</label>
                        <input type="number" step="0.001" id="measuredValueInput" name="measured_value"
                               class="mt-1 w-full rounded-md border-gray-300 shadow-sm" placeholder="例: 7.985">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="appearanceOkInput" name="appearance_ok" class="rounded">
                            <label for="appearanceOkInput" class="text-sm text-gray-700">外観OK</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="bendingOkInput" name="bending_ok" class="rounded">
                            <label for="bendingOkInput" class="text-sm text-gray-700">曲がりOK</label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">作業者</label>
                        <input type="text" id="inspectedByInput" name="inspected_by_name" list="inspectorNameList"
                               class="mt-1 w-full rounded-md border-gray-300 shadow-sm" placeholder="氏名を入力">
                        <datalist id="inspectorNameList"></datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">備考</label>
                        <textarea id="inspectionNotesInput" name="inspection_notes" rows="3"
                                  class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50"
                            onclick="hideInspectionModal()">キャンセル</button>
                    <button type="submit" id="submitInspectionBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        検品登録
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// 入庫確認の主要機能
const SHAPE_SYMBOL_MAP = {
    round: ['φ', 'Φ', '⌀', 'Ø', 'ø', 'ϕ', '￠'],
    hexagon: ['H', 'h', 'Ｈ', 'ｈ'],
    square: ['□', '■', '口', '▢']
};

const SHAPE_WORD_PREFIXES = [
    { prefix: 'hex', shape: 'hexagon' },
    { prefix: '六角', shape: 'hexagon' },
    { prefix: 'square', shape: 'square' },
    { prefix: '角', shape: 'square' },
    { prefix: 'round', shape: 'round' }
];

function normalizeDiameterDigits(value) {
    if (typeof value !== 'string') return '';
    return value
        .replace(/[０-９]/g, char => String.fromCharCode(char.charCodeAt(0) - 0xFEE0))
        .replace(/．/g, '.')
        .replace(/，/g, ',');
}

function parseDiameterInputValue(raw) {
    if (!raw || !raw.trim()) {
        return { error: '径を入力してください' };
    }
    let text = raw.normalize('NFKC').trim();
    let shape = null;

    const lower = text.toLowerCase();
    const wordPrefix = SHAPE_WORD_PREFIXES.find(entry => lower.startsWith(entry.prefix));
    if (wordPrefix) {
        shape = wordPrefix.shape;
        text = text.slice(wordPrefix.prefix.length).trim();
    } else {
        const firstChar = text.charAt(0);
        for (const [key, symbols] of Object.entries(SHAPE_SYMBOL_MAP)) {
            if (symbols.includes(firstChar)) {
                shape = key;
                text = text.slice(1).trimStart();
                break;
            }
        }
    }

    if (!shape) {
        return { error: '先頭に形状記号（φ・H・□など）を付けてください' };
    }

    text = text.replace(/(mm|㎜)/gi, ' ');
    const numberMatch = text.match(/(\d+(?:[.,]\d+)?)/);
    if (!numberMatch) {
        return { error: '径の数値が確認できません' };
    }

    const diameter = parseFloat(numberMatch[1].replace(',', '.'));
    if (!(diameter > 0)) {
        return { error: '径は正の数で入力してください' };
    }

    return { shape, diameter_mm: diameter };
}

function roundTo3(value) {
    return Math.round(value * 1000) / 1000;
}

function calculateUnitWeightKg(shape, diameterMm, lengthMm, density) {
    const lengthCm = lengthMm / 10;
    const base = diameterMm / 10;
    let volumeCm3;
    if (shape === 'round') {
        const radiusCm = base / 2;
        volumeCm3 = Math.PI * radiusCm * radiusCm * lengthCm;
    } else if (shape === 'hexagon') {
        volumeCm3 = (3 * Math.sqrt(3) / 2) * Math.pow(base, 2) * lengthCm;
    } else if (shape === 'square') {
        volumeCm3 = Math.pow(base, 2) * lengthCm;
    } else {
        throw new Error('未対応の形状です');
    }
    return volumeCm3 * density / 1000;
}

function updateConversionDisplays(quantity, weight, unitWeight) {
    const quantityEl = document.getElementById('displayQuantity');
    const weightEl = document.getElementById('displayWeight');
    const unitWeightEl = document.getElementById('displayUnitWeight');

    quantityEl.textContent = Number.isFinite(quantity) && quantity > 0 ? String(quantity) : '-';
    weightEl.textContent = typeof weight === 'number' && Number.isFinite(weight) ? weight.toFixed(3) : '-';
    unitWeightEl.textContent = typeof unitWeight === 'number' && Number.isFinite(unitWeight) ? unitWeight.toFixed(3) : '-';
}

function clearConversionDisplays() {
    updateConversionDisplays(null, null, null);
}

document.addEventListener('DOMContentLoaded', function() {
    // 初期化
    loadPendingItems();
    setupEventListeners();

    // フィルターのリアルタイム更新設定
    setupFilterListeners();
    updateConversion();
});

// 入庫待ちアイテム読み込み
async function loadPendingItems() {
    const tableBody = document.getElementById('itemsTableBody');
    const loading = document.getElementById('itemsLoading');
    const empty = document.getElementById('itemsEmpty');

    loading.classList.remove('hidden');
    tableBody.innerHTML = '';
    empty.classList.add('hidden');

    try {
        const response = await fetch('/api/purchase-orders/pending-or-inspection/items/');
        const items = await response.json();

        loading.classList.add('hidden');

        if (items.length === 0) {
            empty.classList.remove('hidden');
            return;
        }

        // 発注情報も取得するために、各アイテムに対して詳細を取得
        const itemsWithOrders = await Promise.all(
            items.map(async (item) => {
                try {
                    const orderResponse = await fetch(`/api/purchase-orders/${item.purchase_order_id}`);
                    const order = await orderResponse.json();
                    return { ...item, purchase_order: order };
                } catch (error) {
                    console.error('発注情報取得エラー:', error);
                    return item;
                }
            })
        );

        itemsWithOrders.forEach(item => {
            const row = createItemRow(item);
            tableBody.appendChild(row);
        });

        // 初期表示時のフィルター状況を設定
        updateFilterStatus(itemsWithOrders.length, itemsWithOrders.length);
    } catch (error) {
        loading.classList.add('hidden');
        console.error('入庫待ちアイテム読み込みエラー:', error);
        showToast('入庫待ちアイテムの読み込みに失敗しました', 'error');
    }
}

// 置き場入力は数値入力に変更済みのため、一覧読み込みは不要です

// アイテム行作成
function createItemRow(item) {
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50';

    const orderNumber = item.purchase_order ? item.purchase_order.order_number : '-';
    const supplier = item.purchase_order ? item.purchase_order.supplier : '-';

    // 操作ボタン（入庫確認 + 検品）
    const isReceived = String(item.status).toUpperCase() === 'RECEIVED';
    const receivingDisabledAttr = isReceived ? 'disabled' : '';
    const receivingBtnClasses = isReceived
        ? 'bg-gray-300 text-gray-500 px-3 py-1 rounded text-sm cursor-not-allowed'
        : 'bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors';
    const receivingBtnLabel = isReceived ? '入庫済み' : '入庫確認';
    const inspectionDisabledAttr = isReceived ? '' : 'disabled';
    const inspectionBtnClasses = isReceived
        ? 'ml-2 bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700 transition-colors'
        : 'ml-2 bg-gray-300 text-gray-500 px-3 py-1 rounded text-sm cursor-not-allowed';

    const actionButtonsHtml = `
            <button onclick="showReceiveModal(${item.id})" ${receivingDisabledAttr}
                    class="${receivingBtnClasses}" title="${isReceived ? '既に入庫済みです' : '入庫確認'}">
                ${receivingBtnLabel}
            </button>
            <button onclick="openInspectionFromRowByItemId(${item.id})" ${inspectionDisabledAttr}
                    class="${inspectionBtnClasses}" title="${isReceived ? '検品を開始' : '入庫後に検品可能'}">
                検品
            </button>
    `;

    row.innerHTML = `
        <td class="px-4 py-3 text-sm font-medium text-gray-900">${orderNumber}</td>
        <td class="px-4 py-3 text-sm text-gray-600">${supplier}</td>
        <td class="px-4 py-3 text-sm text-gray-600">${item.item_name}</td>
        <td class="px-4 py-3 text-sm text-gray-600">${getOrderDisplayText(item)}</td>
        <td class="px-4 py-3">${actionButtonsHtml}</td>
    `;

    return row;
}

// 形状テキスト取得
function getShapeText(shape) {
    const shapeMap = {
        'round': '丸棒',
        'hexagon': '六角棒',
        'square': '角棒'
    };
    return shapeMap[shape] || shape;
}

// 汎用/専用区分のバッジを取得
// 区分バッジ機能は廃止

// 発注方式テキスト取得
function getOrderTypeText(orderType) {
    const typeMap = {
        'quantity': '本数指定',
        'weight': '重量指定'
    };
    return typeMap[orderType] || orderType;
}

// テーブル行から検品モーダルを開く（item_idを基に検品対象取得）
async function openInspectionFromRowByItemId(itemId) {
    try {
        // モーダルを開く（lotIdは後で設定）
        showInspectionModal();

        const res = await fetch(`/api/purchase-orders/items/${itemId}/inspection-target/`);
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            showToast(err.detail || '検品対象の取得に失敗しました', 'error');
            return;
        }
        const data = await res.json();

        // ロットIDと管理コードを設定
        currentInspectionLotId = data.lot_id || null;
        const codeInput = document.getElementById('inspectionCodeInput');
        const infoEl = document.getElementById('inspectionTargetInfo');
        if (codeInput) codeInput.value = data.management_code || '';
        if (infoEl) {
            infoEl.textContent = `管理コード ${data.management_code} / ロットID ${data.lot_id}`;
        }

        showToast('検品対象を読み込みました', 'success');
    } catch (e) {
        console.error('検品対象取得エラー:', e);
        showToast('検品対象の取得に失敗しました', 'error');
    }
}

// 発注表示テキスト取得
function getOrderDisplayText(item) {
    if (item.order_type === 'weight') {
        return `${item.ordered_weight_kg}kg`;
    } else {
        return `${item.ordered_quantity}本`;
    }
}

// 本数・重量の相互換算と表示更新
function updateConversion() {
    try {
        const quantityInput = document.getElementById('quantityInput');
        const weightInput = document.getElementById('weightInput');
        const diameterInput = document.querySelector('input[name="diameter_input"]');
        const densityInput = document.querySelector('input[name="density"]');
        const lengthInput = document.querySelector('input[name="length_mm"]');

        if (!diameterInput || !densityInput || !lengthInput) {
            clearConversionDisplays();
            return;
        }

        const parsedDiameter = parseDiameterInputValue(normalizeDiameterDigits(diameterInput.value || ''));
        if (parsedDiameter.error) {
            diameterInput.setCustomValidity(parsedDiameter.error);
            clearConversionDisplays();
            return;
        }
        diameterInput.setCustomValidity('');

        const density = parseFloat(densityInput.value);
        const lengthMm = parseInt(lengthInput.value, 10);

        if (!(density > 0) || !(lengthMm > 0)) {
            clearConversionDisplays();
            return;
        }

        const unitWeight = roundTo3(calculateUnitWeightKg(parsedDiameter.shape, parsedDiameter.diameter_mm, lengthMm, density));

        const selectedMethod = document.querySelector('input[name="input_method"]:checked');
        const method = selectedMethod ? selectedMethod.value : 'quantity';

        const quantity = parseInt(quantityInput.value, 10);
        const weight = parseFloat(weightInput.value);

        let displayQuantity = null;
        let displayWeight = null;

        if (method === 'quantity' && Number.isFinite(quantity) && quantity > 0) {
            displayQuantity = quantity;
            displayWeight = roundTo3(unitWeight * quantity);
        } else if (method === 'weight' && Number.isFinite(weight) && weight > 0) {
            displayWeight = roundTo3(weight);
            const computedQuantity = Math.max(1, Math.round(weight / unitWeight));
            displayQuantity = computedQuantity;
        } else if (Number.isFinite(quantity) && quantity > 0) {
            displayQuantity = quantity;
            displayWeight = roundTo3(unitWeight * quantity);
        } else if (Number.isFinite(weight) && weight > 0) {
            displayWeight = roundTo3(weight);
            const computedQuantity = Math.max(1, Math.round(weight / unitWeight));
            displayQuantity = computedQuantity;
        }

        updateConversionDisplays(displayQuantity, displayWeight, unitWeight);
    } catch (error) {
        console.error('換算計算エラー:', error);
        const diameterInput = document.querySelector('input[name="diameter_input"]');
        if (diameterInput) {
            diameterInput.setCustomValidity('径の換算に失敗しました');
        }
        clearConversionDisplays();
    }
}

// イベントリスナー設定
function setupEventListeners() {
    // 更新ボタン
    document.getElementById('refreshBtn').addEventListener('click', loadPendingItems);

    // モーダル閉じる
    document.getElementById('closeReceiveModal').addEventListener('click', hideReceiveModal);
    document.getElementById('cancelReceive').addEventListener('click', hideReceiveModal);
    document.getElementById('closeCompleteModal').addEventListener('click', hideCompleteModal);
    document.getElementById('closeInspectionModal').addEventListener('click', hideInspectionModal);

    // モーダル外クリック閉じ
    document.getElementById('receiveModal').addEventListener('click', function(e) {
        if (e.target === this || e.target.classList.contains('modal-overlay')) {
            hideReceiveModal();
        }
    });
    document.getElementById('receiveCompleteModal').addEventListener('click', function(e) {
        if (e.target === this || e.target.classList.contains('modal-overlay')) {
            hideCompleteModal();
        }
    });
    document.getElementById('inspectionModal').addEventListener('click', function(e) {
        if (e.target === this || e.target.classList.contains('modal-overlay')) {
            hideInspectionModal();
        }
    });

    // ESCキー処理
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const receiveModal = document.getElementById('receiveModal');
            const completeModal = document.getElementById('receiveCompleteModal');

            if (!receiveModal.classList.contains('hidden')) {
                hideReceiveModal();
            } else if (!completeModal.classList.contains('hidden')) {
                hideCompleteModal();
            } else {
                const inspectionModal = document.getElementById('inspectionModal');
                if (inspectionModal && !inspectionModal.classList.contains('hidden')) {
                    hideInspectionModal();
                }
            }
        }
    });

    // フォーム送信
    document.getElementById('receiveForm').addEventListener('submit', handleReceive);

    // 検索・フィルター
    document.getElementById('searchBtn').addEventListener('click', searchItems);
    document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);

    // 現品票印刷
    document.getElementById('printLabelBtn').addEventListener('click', printLabel);

    // 検品モーダル（独立ボタン）
    const openInspectionBtn = document.getElementById('openInspectionBtn');
    if (openInspectionBtn) {
        openInspectionBtn.addEventListener('click', () => showInspectionModal());
    }
    const loadInspectionTargetBtn = document.getElementById('loadInspectionTargetBtn');
    if (loadInspectionTargetBtn) {
        loadInspectionTargetBtn.addEventListener('click', loadInspectionTargetByCode);
    }
    // 既存の「検品へ」ボタン（入庫完了モーダル内）も継続対応
    const goInspectBtn = document.getElementById('goToInspectionBtn');
    if (goInspectBtn) {
        goInspectBtn.addEventListener('click', () => showInspectionModal(window.currentReceiveResult?.lot_id));
    }
    const closeInspectionBtn = document.getElementById('closeInspectionModal');
    if (closeInspectionBtn) {
        closeInspectionBtn.addEventListener('click', hideInspectionModal);
    }
    const inspectionForm = document.getElementById('inspectionForm');
    if (inspectionForm) {
        inspectionForm.addEventListener('submit', submitInspection);
    }

    const diameterInput = document.querySelector('input[name="diameter_input"]');
    if (diameterInput) {
        diameterInput.addEventListener('input', updateConversion);
    }

    const densityInput = document.querySelector('input[name="density"]');
    if (densityInput) {
        densityInput.addEventListener('input', updateConversion);
    }

    const lengthInput = document.querySelector('input[name="length_mm"]');
    if (lengthInput) {
        lengthInput.addEventListener('input', updateConversion);
    }
}

// フィルターリスナー設定
function setupFilterListeners() {
    const filters = ['supplierFilter', 'materialFilter', 'orderNumberFilter', 'diameterFilter'];

    filters.forEach(filterId => {
        const element = document.getElementById(filterId);
        // テキストフィールドは入力停止後に検索
        let timeoutId;
        element.addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(searchItems, 500); // 500ms待機
        });
    });
}

// フィルターリセット
function resetFilters() {
    document.getElementById('supplierFilter').value = '';
    document.getElementById('materialFilter').value = '';
    document.getElementById('orderNumberFilter').value = '';
    document.getElementById('diameterFilter').value = '';

    // リセット後に全件読み込み
    loadPendingItems();
}

// 発注品名などのテキストをコピー
function copyFromElement(elementId) {
    try {
        const el = document.getElementById(elementId);
        if (!el) {
            showToast('コピー対象が見つかりません', 'error');
            return;
        }
        const text = el.textContent.trim();
        navigator.clipboard.writeText(text).then(() => {
            showToast('発注品名をコピーしました', 'success');
        }).catch((err) => {
            console.error('コピー失敗:', err);
            showToast('コピーに失敗しました', 'error');
        });
    } catch (error) {
        console.error('コピー処理エラー:', error);
        showToast('コピー処理でエラーが発生しました', 'error');
    }
}


// 入庫確認モーダル表示
async function showReceiveModal(itemId) {
    try {
        // アイテム詳細取得
        const response = await fetch(`/api/purchase-orders/pending/items/`);
        const items = await response.json();
        const item = items.find(i => i.id === itemId);

        if (!item) {
            showToast('アイテムが見つかりません', 'error');
            return;
        }

        // 発注情報取得
        const orderResponse = await fetch(`/api/purchase-orders/${item.purchase_order_id}`);
        const order = await orderResponse.json();

        // モーダル内容設定
        document.getElementById('receiveItemId').value = itemId;

        const itemInfo = document.getElementById('itemInfo');
        itemInfo.innerHTML = `
            <div>
                <dt class="font-medium text-gray-500">発注番号</dt>
                <dd class="text-gray-900">${order.order_number}</dd>
            </div>
            <div>
                <dt class="font-medium text-gray-500">仕入先</dt>
                <dd class="text-gray-900">${order.supplier}</dd>
            </div>
            <div>
                <dt class="font-medium text-gray-500">発注品名</dt>
                <dd class="text-gray-900">
                    <div class="mt-2">
                        <textarea id="purchaseItemNameTextarea" class="w-full mt-1 p-2 text-sm border rounded bg-white" rows="2" readonly>${item.item_name}</textarea>
                        <div class="mt-1">
                            <button type="button" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300"
                                onclick="copySelectionFromTextarea('purchaseItemNameTextarea')">
                                選択範囲をコピー
                            </button>
                        </div>
                    </div>
                </dd>
            </div>
            <div>
                <dt class="font-medium text-gray-500">発注方式</dt>
                <dd class="text-gray-900">${getOrderTypeText(item.order_type)}</dd>
            </div>
            <div>
                <dt class="font-medium text-gray-500">${item.order_type === 'quantity' ? '発注数量' : '発注重量'}</dt>
                <dd class="text-gray-900">${item.order_type === 'quantity' ? item.ordered_quantity + '本' : item.ordered_weight_kg + 'kg'}</dd>
            </div>
        `;

        // 入荷日のデフォルト値を本日の日付に設定
        const now = new Date();
        const localDate = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0');
        document.querySelector('input[name="received_date"]').value = localDate;

        // 長さ（mm）のデフォルト値を設定
        const lengthInput = document.querySelector('input[name="length_mm"]');
        if (lengthInput) {
            lengthInput.value = 2500;
        }

        // 入力フィールドの参照を取得
        const quantityInput = document.getElementById('quantityInput');
        const weightInput = document.getElementById('weightInput');
        const inputMethodRadios = document.querySelectorAll('input[name="input_method"]');

        // 発注方式に応じてデフォルト値を設定
        if (item.order_type === 'weight') {
            // 重量指定発注の場合は重量をデフォルトに
            weightInput.value = item.ordered_weight_kg;
            document.querySelector('input[name="input_method"][value="weight"]').checked = true;
        } else {
            // 本数指定発注の場合は本数をデフォルトに
            quantityInput.value = item.ordered_quantity;
            document.querySelector('input[name="input_method"][value="quantity"]').checked = true;
        }

        quantityInput.oninput = function() {
            if (this.value) {
                weightInput.value = '';
                document.querySelector('input[name="input_method"][value="quantity"]').checked = true;
            }
            updateConversion();
        };

        weightInput.oninput = function() {
            if (this.value) {
                quantityInput.value = '';
                document.querySelector('input[name="input_method"][value="weight"]').checked = true;
            }
            updateConversion();
        };

        // 材料マスター照合（発注品名の全文）
        try {
            const sugRes = await fetch(`/api/purchase-orders/items/${item.id}/suggest-material`);
            if (sugRes.ok) {
                const sug = await sugRes.json();
                if (sug) {
                    const matNameEl = document.querySelector('input[name="material_name"]');
                    const diaEl = document.querySelector('input[name="diameter_input"]');
                    const detailEl = document.querySelector('input[name="detail_info"]');
                    const densityEl = document.querySelector('input[name="density"]');

                    const shapeVal = (sug.shape || '').toString().toLowerCase();
                    const symbol = shapeVal === 'round' ? 'φ' : (shapeVal === 'hexagon' ? 'H' : (shapeVal === 'square' ? '□' : ''));
                    // 解析項目を事前入力
                    if (matNameEl && (sug.name || matNameEl.value === '')) matNameEl.value = sug.name || matNameEl.value || '';
                    if (diaEl && sug.diameter_mm && symbol) diaEl.value = `${symbol}${sug.diameter_mm}`;
                    if (detailEl && sug.detail_info) detailEl.value = sug.detail_info;
                    if (densityEl && typeof sug.density === 'number') densityEl.value = sug.density;

                    showToast(`材料マスターに一致: ${sug.display_name}`, 'success');
                    updateConversion();
                }
            }
        } catch (e) {
            console.warn('材料マスター照合エラー:', e);
        }

        inputMethodRadios.forEach(radio => {
            radio.onchange = function() {
                if (this.value === 'quantity') {
                    quantityInput.focus();
                    weightInput.value = '';
                } else {
                    weightInput.focus();
                    quantityInput.value = '';
                }
                updateConversion();
            };
        });

        // グループ一覧を読み込み
        await loadMaterialGroups();

        updateConversion();
        document.getElementById('receiveModal').classList.remove('hidden');
    } catch (error) {
        console.error('入庫確認モーダル表示エラー:', error);
        showToast('入庫確認画面の表示に失敗しました', 'error');
    }
}

// 入庫確認モーダル非表示
function hideReceiveModal() {
    document.getElementById('receiveModal').classList.add('hidden');
    document.getElementById('receiveForm').reset();

    // 新しいフィールドもリセット
    document.getElementById('quantityInput').value = '';
    document.getElementById('weightInput').value = '';
    document.querySelector('input[name="input_method"][value="quantity"]').checked = true;
    clearConversionDisplays();
    // 置き場入力のリセット（複数対応）
    const locInput = document.querySelector('input[name="location_ids"]');
    if (locInput) {
        locInput.value = '';
    }
    const groupSelect = document.getElementById('groupSelect');
    if (groupSelect) {
        groupSelect.value = '';
    }
}

// 入庫完了モーダル非表示
function hideCompleteModal() {
    document.getElementById('receiveCompleteModal').classList.add('hidden');
}

// 入庫処理
async function handleReceive(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const itemId = formData.get('item_id');
    // 入力方式を判定
    const inputMethod = document.querySelector('input[name="input_method"]:checked').value;
    const quantityInput = document.getElementById('quantityInput');
    const weightInput = document.getElementById('weightInput');

    // 置き場（複数）入力の処理
    const locInputEl = document.querySelector('input[name="location_ids"]');
    let parsedLocationIds = [];
    if (locInputEl && locInputEl.value) {
        const tokens = locInputEl.value.split(/[，,\s]+/).map(t => t.trim()).filter(Boolean);
        const invalid = [];
        const nums = [];
        tokens.forEach(t => {
            const n = parseInt(t, 10);
            if (isNaN(n) || n <= 0) {
                invalid.push(t);
            } else {
                nums.push(n);
            }
        });
        if (invalid.length > 0) {
            showToast(`置き場は正の整数で入力してください: ${invalid.join(', ')}`, 'error');
            return;
        }
        parsedLocationIds = [...new Set(nums)];
    }

    const diameterInputField = document.querySelector('input[name="diameter_input"]');
    const rawDiameterInput = formData.get('diameter_input') || '';
    const normalizedDiameterInput = normalizeDiameterDigits(rawDiameterInput);
    if (diameterInputField && normalizedDiameterInput !== rawDiameterInput) {
        diameterInputField.value = normalizedDiameterInput;
        updateConversion();
    }
    formData.set('diameter_input', normalizedDiameterInput);

    const parsedDiameter = parseDiameterInputValue(normalizedDiameterInput);
    if (parsedDiameter.error) {
        if (diameterInputField) {
            diameterInputField.setCustomValidity(parsedDiameter.error);
            diameterInputField.reportValidity();
        }
        showToast(parsedDiameter.error, 'error');
        return;
    }
    if (diameterInputField) {
        diameterInputField.setCustomValidity('');
    }

    const densityValue = parseFloat(formData.get('density'));
    if (!(densityValue > 0)) {
        showToast('比重を正しく入力してください', 'error');
        return;
    }

    const lengthValue = parseInt(formData.get('length_mm'), 10);
    if (!(lengthValue > 0)) {
        showToast('長さを正しく入力してください', 'error');
        return;
    }

    const materialData = {
        material_name: (formData.get('material_name') || '').trim(),
        detail_info: (formData.get('detail_info') || '').trim() || null,
        diameter_mm: parsedDiameter.diameter_mm,
        shape: parsedDiameter.shape,
        // usage_typeは廃止
        density: densityValue,
        length_mm: lengthValue
    };

    const dateOnly = formData.get('received_date');
    const receivedDateIso = dateOnly ? `${dateOnly}T00:00:00` : null;

    const receiveData = {
        lot_number: formData.get('lot_number'),
        received_date: receivedDateIso,
        notes: formData.get('notes') || null,
        ...materialData
    };

    // 単価・金額
    if (formData.get('unit_price')) {
        receiveData.unit_price = parseFloat(formData.get('unit_price'));
    }
    if (formData.get('amount')) {
        receiveData.amount = parseFloat(formData.get('amount'));
    }

    if (parsedLocationIds.length === 1) {
        receiveData.location_id = parsedLocationIds[0];
    } else if (parsedLocationIds.length > 1) {
        receiveData.location_ids = parsedLocationIds;
    }

    // 使用材料情報は備考に統合して送信（API互換のため）
    const usageInfo = formData.get('material_usage_info');
    if (usageInfo && usageInfo.trim().length > 0) {
        const baseNotes = receiveData.notes ? String(receiveData.notes) : '';
        const prefix = baseNotes ? baseNotes + '\n' : '';
        receiveData.notes = (prefix + '使用材料情報: ' + usageInfo.trim());
    }

    // 入力された値を取得
    if (inputMethod === 'weight' && weightInput.value) {
        receiveData.received_weight_kg = parseFloat(weightInput.value);
    } else if (inputMethod === 'quantity' && quantityInput.value) {
        receiveData.received_quantity = parseInt(quantityInput.value);
    } else {
        showToast('入庫数量または重量を入力してください', 'error');
        return;
    }

    // 材料グループ選択の反映
    const groupSelectEl = document.getElementById('groupSelect');
    if (groupSelectEl && groupSelectEl.value) {
        const gid = parseInt(groupSelectEl.value, 10);
        if (!isNaN(gid)) {
            receiveData.group_id = gid;
        }
    }

    try {
        const response = await fetch(`/api/purchase-orders/items/${itemId}/receive/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(receiveData)
        });

        if (response.ok) {
            const result = await response.json();

            // 完了モーダル表示
            showCompleteModal(result);

            // アイテム一覧更新
            hideReceiveModal();
            loadPendingItems();

        } else {
            // サーバーがJSON以外（例: Tracebackテキスト）を返す場合でも安全に扱う
            let message = '入庫確認に失敗しました';
            try {
                const contentType = (response.headers.get('content-type') || '').toLowerCase();
                if (contentType.includes('application/json')) {
                    const errorJson = await response.json();
                    message = errorJson.detail || message;
                } else {
                    const text = await response.text();
                    try {
                        const maybeJson = JSON.parse(text);
                        message = maybeJson.detail || message;
                    } catch {
                        // テキストの先頭をそのままメッセージとして表示（Traceback抑止）
                        const trimmed = (text || '').trim();
                        if (trimmed) {
                            // 長すぎる場合は先頭200文字に切り詰め
                            message = trimmed.length > 200 ? trimmed.slice(0, 200) + '…' : trimmed;
                        }
                    }
                }
            } catch (e) {
                // レスポンス本文の取得自体に失敗した場合はHTTPステータスを表示
                message = `HTTP ${response.status}: ${response.statusText}`;
            }
            showToast(message, 'error');
        }
    } catch (error) {
        console.error('入庫確認エラー:', error);
        showToast('入庫確認に失敗しました', 'error');
    }
}

// 材料グループ一覧の読み込み
async function loadMaterialGroups() {
    try {
        const res = await fetch('/api/material-groups/?is_active=true&limit=1000');
        if (!res.ok) return;
        const groups = await res.json();
        const select = document.getElementById('groupSelect');
        if (!select) return;
        // 初期化
        select.innerHTML = '<option value="">未指定</option>';
        const list = Array.isArray(groups) ? groups : (Array.isArray(groups?.items) ? groups.items : []);
        list.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = g.group_name;
            select.appendChild(opt);
        });
    } catch (e) {
        console.error('グループ一覧の取得に失敗:', e);
        showToast('グループ一覧の取得に失敗しました', 'error');
    }
}

// 入庫完了モーダル表示
function showCompleteModal(result) {
    const completeInfo = document.getElementById('completeInfo');
    completeInfo.innerHTML = `
        <div class="space-y-2 text-sm">
            <div class="flex justify-between">
                <span class="font-medium text-gray-500">ロットID:</span>
                <span class="text-gray-900">${result.lot_id}</span>
            </div>
            <div class="flex justify-between">
                <span class="font-medium text-gray-500">アイテムID:</span>
                <span class="text-gray-900">${result.item_id}</span>
            </div>
            <div class="flex justify-between">
                <span class="font-medium text-gray-500">管理コード:</span>
                <span class="text-gray-900 font-mono text-xs">${result.management_code}</span>
            </div>
        </div>
    `;

    // 現品票印刷用にデータを保存
    window.currentReceiveResult = result;

    document.getElementById('receiveCompleteModal').classList.remove('hidden');
}

// 検品モーダル表示
let currentInspectionLotId = null;
async function showInspectionModal(lotId) {
    currentInspectionLotId = lotId || null;

    // 検品者履歴を読み込み
    try {
        const res = await fetch('/api/inspections/inspectors/');
        if (res.ok) {
            const names = await res.json();
            const listEl = document.getElementById('inspectorNameList');
            if (listEl) {
                listEl.innerHTML = '';
                names.forEach(n => {
                    const opt = document.createElement('option');
                    opt.value = n;
                    listEl.appendChild(opt);
                });
            }
        }
    } catch (e) {
        console.error('検品者履歴取得エラー:', e);
    }

    // デフォルト日時は現在
    const now = new Date();
    const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
        .toISOString().slice(0,16); // YYYY-MM-DDTHH:mm
    const dtEl = document.getElementById('inspectedAtInput');
    if (dtEl) dtEl.value = local;

    // 対象表示
    const infoEl = document.getElementById('inspectionTargetInfo');
    if (currentInspectionLotId && infoEl) {
        infoEl.textContent = `ロットID ${currentInspectionLotId} が選択されています。管理コードを変更する場合は再読み込みしてください。`;
    } else if (infoEl) {
        infoEl.textContent = '管理コードを入力して読み込んでください。';
    }

    document.getElementById('inspectionModal').classList.remove('hidden');
}

function hideInspectionModal() {
    document.getElementById('inspectionModal').classList.add('hidden');
}

// 検品登録
async function submitInspection(event) {
    event.preventDefault();
    const lotId = currentInspectionLotId || (window.currentReceiveResult ? window.currentReceiveResult.lot_id : null);
    if (!lotId) {
        showToast('検品対象の管理コードを読み込んでください', 'error');
        return;
    }
    const inspectedAtStr = document.getElementById('inspectedAtInput').value;
    const measuredValStr = document.getElementById('measuredValueInput').value;
    const appearanceOk = document.getElementById('appearanceOkInput').checked;
    const bendingOk = document.getElementById('bendingOkInput').checked;
    const inspectedBy = document.getElementById('inspectedByInput').value.trim();
    const notes = document.getElementById('inspectionNotesInput').value.trim();

    const payload = {
        inspection_date: inspectedAtStr ? new Date(inspectedAtStr).toISOString() : new Date().toISOString(),
        measured_value: measuredValStr ? parseFloat(measuredValStr) : null,
        appearance_ok: appearanceOk,
        bending_ok: bendingOk,
        inspector_name: inspectedBy || "",
        notes: notes || null
    };

    try {
        const res = await fetch(`/api/inspections/lots/${lotId}/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (res.ok) {
            showToast('検品結果を登録しました', 'success');
            hideInspectionModal();
        } else {
            const err = await res.json().catch(() => ({}));
            showToast(err.detail || '検品登録に失敗しました', 'error');
        }
    } catch (e) {
        console.error('検品登録エラー:', e);
        showToast('検品登録に失敗しました', 'error');
    }
}

// 管理コードから検品対象読み込み
async function loadInspectionTargetByCode() {
    const codeInput = document.getElementById('inspectionCodeInput');
    const infoEl = document.getElementById('inspectionTargetInfo');
    const code = (codeInput?.value || '').trim();
    if (!code) {
        showToast('管理コードを入力してください', 'error');
        return;
    }
    try {
        const res = await fetch(`/api/inventory/search/${encodeURIComponent(code)}`);
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || '管理コードの読み込みに失敗しました');
        }
        const item = await res.json();
        currentInspectionLotId = item?.lot?.id || null;
        if (!currentInspectionLotId) {
            showToast('該当ロットが見つかりません', 'error');
            return;
        }
        if (infoEl) {
            const lotNum = item?.lot?.lot_number || '-';
            const qty = item?.current_quantity ?? '-';
            infoEl.textContent = `管理コード ${item.management_code} / ロット番号 ${lotNum} / 現在本数 ${qty}本`;
        }
        showToast('検品対象を読み込みました', 'success');
    } catch (e) {
        console.error('管理コード読み込みエラー:', e);
        showToast(e.message || '管理コードの読み込みに失敗しました', 'error');
        if (infoEl) {
            infoEl.textContent = '管理コードを入力して読み込んでください。';
        }
    }
}

// 現品票印刷
async function printLabel() {
    if (!window.currentReceiveResult) {
        showToast('印刷データが見つかりません', 'error');
        return;
    }

    try {
        const response = await fetch('/api/labels/print/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                item_id: window.currentReceiveResult.item_id,
                format: 'label' // または 'a4'
            })
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `label_${window.currentReceiveResult.management_code}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showToast('現品票を印刷しました', 'success');
        } else {
            showToast('現品票の印刷に失敗しました', 'error');
        }
    } catch (error) {
        console.error('現品票印刷エラー:', error);
        showToast('現品票の印刷に失敗しました', 'error');
    }
}

// 検索機能（改善版：フィルタリング後の表示件数を表示）
function searchItems() {
    const supplierFilter = document.getElementById('supplierFilter').value.toLowerCase();
    const materialFilter = document.getElementById('materialFilter').value.toLowerCase();
    const orderNumberFilter = document.getElementById('orderNumberFilter').value.toLowerCase();
    const diameterStr = document.getElementById('diameterFilter').value;
    const diameterFilter = diameterStr ? parseFloat(diameterStr) : null;

    const rows = document.querySelectorAll('#itemsTableBody tr');
    let visibleCount = 0;

    rows.forEach(row => {
        const orderNumber = row.cells[0].textContent.toLowerCase();
        const supplier = row.cells[1].textContent.toLowerCase();
        const material = row.cells[2].textContent.toLowerCase();
        const dimensionsText = row.cells[3].textContent;
        const match = dimensionsText.match(/([\d\.]+)\s*mm/i);
        const rowDiameter = match ? parseFloat(match[1]) : null;

        const matchOrder = !orderNumberFilter || orderNumber.includes(orderNumberFilter);
        const matchSupplier = !supplierFilter || supplier.includes(supplierFilter);
        const matchMaterial = !materialFilter || material.includes(materialFilter);
        const matchDiameter = diameterFilter === null || (rowDiameter !== null && rowDiameter === diameterFilter);

        if (matchOrder && matchSupplier && matchMaterial && matchDiameter) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // フィルタリング結果をヘッダーに表示
    updateFilterStatus(visibleCount, rows.length);
}

// フィルター状況表示
function updateFilterStatus(visibleCount, totalCount) {
    const headerElement = document.querySelector('.p-4.border-b h2');
    if (visibleCount === totalCount) {
        headerElement.textContent = `入庫待ちアイテム（${totalCount}件）`;
    } else {
        headerElement.textContent = `入庫待ちアイテム（${visibleCount}/${totalCount}件表示）`;
    }
}

// テキストエリアの選択範囲をクリップボードへコピー
function copySelectionFromTextarea(textareaId) {
    const ta = document.getElementById(textareaId);
    if (!ta) return;
    const start = ta.selectionStart ?? 0;
    const end = ta.selectionEnd ?? start;
    const s = Math.min(start, end);
    const e = Math.max(start, end);
    const text = ta.value.substring(s, e);
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text);
    } else {
        const tmp = document.createElement('textarea');
        tmp.value = text;
        document.body.appendChild(tmp);
        tmp.focus();
        tmp.select();
        try { document.execCommand('copy'); } catch (e) {}
        document.body.removeChild(tmp);
    }
}
</script>
{% endblock %}