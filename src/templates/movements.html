{% extends "base.html" %} {% block title %}å…¥å‡ºåº«ç®¡ç† - ææ–™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {%
endblock %} {% block extra_head %}
<style>
  :root {
    --primary-navy: #1e3a8a;
    --primary-blue: #3b82f6;
    --success-green: #10b981;
    --warning-amber: #f59e0b;
    --danger-red: #ef4444;
    --neutral-50: #f9fafb;
    --neutral-100: #f3f4f6;
    --neutral-200: #e5e7eb;
    --neutral-600: #4b5563;
    --neutral-700: #374151;
    --neutral-800: #1f2937;
  }

  /* å…¥åº«ãƒ»å‡ºåº«ãƒœã‚¿ãƒ³ç”¨ */
  .movement-in-gradient {
    background-color: var(--success-green);
  }

  .movement-out-gradient {
    background-color: var(--danger-red);
  }

  .movement-in-gradient:hover,
  .movement-out-gradient:hover {
    opacity: 0.9;
  }

  /* ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
  .table-row-hover:hover {
    background: var(--neutral-50);
  }

  /* å±¥æ­´ã‚«ãƒ¼ãƒ‰ã®ãƒœãƒ¼ãƒ€ãƒ¼ */
  .history-card-in {
    border-left: 3px solid var(--success-green);
  }

  .history-card-out {
    border-left: 3px solid var(--danger-red);
  }
</style>
{% endblock %} {% block content %}
<div class="min-h-screen bg-neutral-50">
  <div class="max-w-[1600px] mx-auto py-4 px-4">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="mb-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="p-3 bg-primary-blue bg-opacity-10 rounded-lg">
            <i class="fas fa-exchange-alt text-xl text-primary-blue"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-neutral-800">å…¥å‡ºåº«ç®¡ç†</h1>
            <p class="text-sm text-neutral-600 mt-1">åœ¨åº«ã®æŒã¡å‡ºã—ãƒ»æˆ»ã—ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç®¡ç†</p>
          </div>
        </div>
        <div class="hidden md:flex items-center space-x-2">
          <button
            id="qrScanBtn"
            class="bg-white border border-neutral-200 text-neutral-700 hover:bg-neutral-50 flex items-center px-4 py-2 rounded-lg font-semibold transition-colors"
          >
            <i class="fas fa-qrcode text-primary-blue mr-2"></i>
            <span>QRã‚¹ã‚­ãƒ£ãƒ³</span>
          </button>
          <button
            id="refreshBtn"
            class="bg-white border border-neutral-200 text-neutral-700 hover:bg-neutral-50 p-2 rounded-lg transition-colors"
            title="ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—"
          >
            <i class="fas fa-sync-alt text-neutral-600"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="space-y-4">
      <!-- çµ±åˆãƒ ãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="bg-white rounded-lg p-4 border border-neutral-200 shadow-sm">
        <div class="flex items-center mb-4">
          <div class="p-3 bg-primary-blue bg-opacity-10 rounded-lg mr-3">
            <i class="fas fa-exchange-alt text-xl text-primary-blue"></i>
          </div>
          <h3 class="text-lg font-bold text-neutral-800">å…¥å‡ºåº«ãƒ•ã‚©ãƒ¼ãƒ </h3>
        </div>

        <form id="movementForm" class="space-y-4">
          <input type="hidden" name="item_id" />

          <!-- ç¨®åˆ¥ãƒˆã‚°ãƒ« -->
          <div>
            <label class="block text-sm font-semibold text-neutral-700 mb-2"
              >å‡¦ç†ç¨®åˆ¥</label
            >
            <div class="flex space-x-3">
              <button
                type="button"
                id="typeOutBtn"
                class="flex-1 movement-out-gradient text-white px-4 py-3 rounded-lg font-semibold transition-opacity"
              >
                <i class="fas fa-arrow-right mr-2"></i>å‡ºåº«
              </button>
              <button
                type="button"
                id="typeInBtn"
                class="flex-1 bg-neutral-400 text-white px-4 py-3 rounded-lg font-semibold transition-opacity"
              >
                <i class="fas fa-arrow-left mr-2"></i>æˆ»ã—
              </button>
              <input
                type="hidden"
                id="movementTypeInput"
                name="movement_type"
                value="out"
              />
            </div>
          </div>

          <!-- ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ -->
          <div>
            <label class="block text-sm font-semibold text-neutral-700 mb-2"
              >å¯¾è±¡ã‚¢ã‚¤ãƒ†ãƒ </label
            >
            <div class="space-y-2">
              <div
                id="selectedItemSummary"
                class="bg-neutral-50 p-4 border border-dashed border-neutral-300 rounded-lg text-sm text-neutral-500"
              >
                ã‚¢ã‚¤ãƒ†ãƒ ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“
              </div>
              <div class="flex space-x-2">
                <button
                  type="button"
                  id="selectItemBtn"
                  class="flex-1 bg-primary-blue text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition-opacity flex items-center justify-center font-semibold"
                >
                  <i class="fas fa-search mr-2"></i>åœ¨åº«ä¸€è¦§ã§æ¤œç´¢
                </button>
                <button
                  type="button"
                  id="clearItemBtn"
                  class="bg-white border border-neutral-200 text-neutral-700 hover:bg-neutral-50 px-4 py-2 rounded-lg font-semibold transition-colors"
                >
                  <i class="fas fa-times mr-2"></i>ã‚¯ãƒªã‚¢
                </button>
              </div>
            </div>
          </div>

          <!-- å…¥åŠ›æ–¹æ³•ã¨å…¨é‡å‡ºåº« -->
          <div class="mb-2">
            <span class="block text-sm font-semibold text-neutral-700 mb-2">
              <i class="fas fa-sliders-h mr-1 text-neutral-600"></i>å…¥åŠ›æ–¹æ³•
            </span>
            <div class="flex items-center gap-4">
              <label class="inline-flex items-center">
                <input type="radio" name="input_mode" id="inputModeQuantity" value="quantity" class="mr-2" checked>
                <span>æ•°é‡ï¼ˆæœ¬ï¼‰</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="input_mode" id="inputModeWeight" value="weight" class="mr-2">
                <span>é‡é‡ï¼ˆkgï¼‰</span>
              </label>
              <label class="inline-flex items-center ml-auto">
                <input type="checkbox" id="fullOutAll" class="mr-2">
                <span>ã™ã¹ã¦æŒã¡å‡ºã™ï¼ˆåœ¨åº«å…¨é‡ã‚’å‡ºåº«ï¼‰</span>
              </label>
            </div>
          </div>

          <!-- æ•°é‡ãƒ»é‡é‡å…¥åŠ› -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-semibold text-neutral-700 mb-2">
                <i class="fas fa-list-ol mr-1 text-primary-blue"></i>æ•°é‡ï¼ˆæœ¬ï¼‰
              </label>
              <input
                type="number"
                id="movementQuantity"
                name="quantity"
                min="1"
                step="1"
                class="w-full p-3 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
                placeholder="æœ¬æ•°ã‚’å…¥åŠ›"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-neutral-700 mb-2">
                <i class="fas fa-weight mr-1 text-success-green"></i>é‡é‡ï¼ˆkgï¼‰
              </label>
              <input
                type="number"
                id="movementWeight"
                name="weight_kg"
                min="0.001"
                step="0.001"
                class="w-full p-3 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
                placeholder="é‡é‡ã‚’å…¥åŠ›"
                disabled
              />
            </div>
          </div>
          <div class="bg-neutral-50 p-3 rounded-lg border-l-3 border-primary-blue">
            <p class="text-sm text-neutral-700">
              <i class="fas fa-info-circle text-primary-blue mr-2"></i>
              æ•°é‡ã¾ãŸã¯é‡é‡ã®ã„ãšã‚Œã‹ä¸€æ–¹ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆè‡ªå‹•æ›ç®—ã¯è¡Œã„ã¾ã›ã‚“ï¼‰
            </p>
          </div>

          <!-- å‚™è€ƒ -->
          <div>
            <label class="block text-sm font-semibold text-neutral-700 mb-2">
              <i class="fas fa-comment mr-1 text-neutral-600"></i>å‚™è€ƒ
            </label>
            <textarea
              name="notes"
              rows="3"
              class="w-full p-3 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
              placeholder="å‚™è€ƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
            ></textarea>
          </div>

          <button
            type="submit"
            id="movementSubmitBtn"
            class="w-full movement-out-gradient text-white py-3 px-4 rounded-lg transition-opacity flex items-center justify-center font-semibold text-lg"
          >
            <i class="fas fa-arrow-right mr-2"></i>
            å‡ºåº«å®Ÿè¡Œ
          </button>
        </form>

        <div class="bg-neutral-50 p-3 rounded-lg border-l-3 border-primary-blue mt-4">
          <p class="text-xs text-neutral-600">
            <i class="fas fa-lightbulb text-primary-blue mr-2"></i>
            åœ¨åº«ä¸€è¦§ã‹ã‚‰ç›´æ¥ã€Œå‡ºåº«ã€ã¾ãŸã¯ã€Œæˆ»ã—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™
          </p>
        </div>
      </div>

      <!-- åœ¨åº«ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ -->
      <div id="inventorySection" class="bg-white rounded-lg p-4 border border-neutral-200 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center">
            <div class="p-3 bg-primary-blue bg-opacity-10 rounded-lg mr-3">
              <i class="fas fa-warehouse text-xl text-primary-blue"></i>
            </div>
            <h2 class="text-lg font-bold text-neutral-800">åœ¨åº«ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§</h2>
          </div>
        </div>

        <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ -->
        <div class="bg-neutral-50 p-4 rounded-lg mb-4 border border-neutral-200">
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3">
            <div>
              <label class="block text-xs font-semibold text-neutral-700 mb-2">
                <i class="fas fa-search mr-1 text-primary-blue"></i>ææ–™å
              </label>
              <input
                type="text"
                id="materialSearchInput"
                placeholder="ææ–™åã§æ¤œç´¢"
                class="w-full p-2 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
              />
            </div>
            <div>
              <label class="block text-xs font-semibold text-neutral-700 mb-2">
                <i class="fas fa-barcode mr-1 text-success-green"></i>ãƒ­ãƒƒãƒˆç•ªå·
              </label>
              <input
                type="text"
                id="lotSearchInput"
                placeholder="ãƒ­ãƒƒãƒˆç•ªå·ã§æ¤œç´¢"
                class="w-full p-2 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
              />
            </div>
            <div>
              <label class="block text-xs font-semibold text-neutral-700 mb-2">
                <i class="fas fa-map-marker-alt mr-1 text-neutral-600"></i>ç½®ãå ´
              </label>
              <input
                type="text"
                id="locationFilterInput"
                list="locationOptions"
                placeholder="ç½®ãå ´åã§æ¤œç´¢"
                class="w-full p-2 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
              />
              <datalist id="locationOptions">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
              </datalist>
            </div>
            <div>
              <label class="block text-xs font-semibold text-neutral-700 mb-2">
                <i class="fas fa-filter mr-1 text-neutral-600"></i>è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³
              </label>
              <label
                class="bg-white flex items-center space-x-2 p-2 rounded-lg cursor-pointer border border-neutral-200 hover:bg-neutral-50 transition-colors"
              >
                <input
                  type="checkbox"
                  id="includeZeroStock"
                  class="rounded border-neutral-300 w-4 h-4 text-primary-blue focus:ring-primary-blue"
                />
                <span class="text-sm text-neutral-700 font-semibold"
                  >åœ¨åº«åˆ‡ã‚Œã‚’å«ã‚€</span
                >
              </label>
            </div>
          </div>
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸Šéƒ¨ï¼‰ -->
        <div id="inventoryPaginationTop" class="mb-4"></div>

        <div class="overflow-x-auto rounded-lg border border-neutral-200">
          <table class="w-full">
            <thead class="bg-neutral-50">
              <tr>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-tag mr-1 text-primary-blue"></i>ææ–™ä»•æ§˜
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-shapes mr-1 text-success-green"></i>å½¢çŠ¶
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-ruler mr-1 text-neutral-600"></i>å¾„
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-barcode mr-1 text-warning-amber"></i>ãƒ­ãƒƒãƒˆç•ªå·
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-comment mr-1 text-neutral-600"></i>ãƒ­ãƒƒãƒˆå‚™è€ƒ
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-arrows-alt-h mr-1 text-neutral-600"></i>é•·ã•
                </th>
                <th
                  class="px-4 py-3 text-right text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-boxes mr-1 text-primary-blue"></i>ç¾åœ¨åº«
                </th>
                <th
                  class="px-4 py-3 text-right text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-weight mr-1 text-success-green"></i>é‡é‡
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-map-marker-alt mr-1 text-danger-red"></i>ç½®ãå ´
                </th>
                <th
                  class="px-4 py-3 text-center text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-cogs mr-1 text-neutral-600"></i>æ“ä½œ
                </th>
              </tr>
            </thead>
            <tbody
              id="inventoryTableBody"
              class="divide-y divide-gray-200 bg-white"
            >
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>

        <div id="inventoryLoading" class="text-center py-16 hidden">
          <div
            class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600 mb-4"
          ></div>
          <p class="text-lg text-gray-700 font-bold">
            åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
          </p>
          <p class="text-sm text-gray-500 mt-2">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
        </div>

        <div id="inventoryEmpty" class="text-center py-12 hidden">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-neutral-100 rounded-full mb-4">
            <i class="fas fa-inbox text-4xl text-neutral-400"></i>
          </div>
          <p class="text-lg text-neutral-700 font-bold">
            è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“
          </p>
          <p class="text-sm text-neutral-500 mt-2">æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„</p>
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹éƒ¨ï¼‰ -->
        <div id="inventoryPaginationBottom" class="mt-4"></div>
      </div>

      <!-- å…¥å‡ºåº«å±¥æ­´ -->
      <div class="bg-white rounded-lg p-4 border border-neutral-200 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center">
            <div class="p-3 bg-primary-blue bg-opacity-10 rounded-lg mr-3">
              <i class="fas fa-history text-xl text-primary-blue"></i>
            </div>
            <h2 class="text-lg font-bold text-neutral-800">å…¥å‡ºåº«å±¥æ­´</h2>
          </div>
          <div class="flex items-center space-x-2">
            <label class="block text-xs font-semibold text-neutral-700">
              <i class="fas fa-filter mr-1 text-primary-blue"></i>ç¨®åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            </label>
            <select
              id="typeFilter"
              class="p-2 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all font-semibold"
            >
              <option value="">ã™ã¹ã¦</option>
              <option value="in">ğŸŸ¢ æˆ»ã—ã®ã¿</option>
              <option value="out">ğŸ”´ å‡ºåº«ã®ã¿</option>
            </select>
          </div>
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸Šéƒ¨ï¼‰ -->
        <div id="movementsPaginationTop" class="mb-4"></div>

        <div class="overflow-x-auto rounded-lg border border-neutral-200">
          <table class="w-full">
            <thead class="bg-neutral-50">
              <tr>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-clock mr-1 text-primary-blue"></i>å‡¦ç†æ—¥æ™‚
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-tag mr-1 text-neutral-600"></i>ç¨®åˆ¥
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-barcode mr-1 text-success-green"></i>ç®¡ç†ã‚³ãƒ¼ãƒ‰
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-box mr-1 text-warning-amber"></i>ææ–™ãƒ»ãƒ­ãƒƒãƒˆ
                </th>
                <th
                  class="px-4 py-3 text-right text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-balance-scale mr-1 text-neutral-600"></i
                  >æ•°é‡ãƒ»é‡é‡ï¼ˆæ›ç®—ï¼‰
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-comment mr-1 text-neutral-600"></i>å‚™è€ƒ
                </th>
                <th
                  class="px-4 py-3 text-center text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-cog mr-1 text-neutral-600"></i>æ“ä½œ
                </th>
              </tr>
            </thead>
            <tbody
              id="movementsTableBody"
              class="divide-y divide-gray-200 bg-white"
            >
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>

        <div id="movementsLoading" class="text-center py-16 hidden">
          <div
            class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600 mb-4"
          ></div>
          <p class="text-lg text-gray-700 font-bold">
            å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
          </p>
          <p class="text-sm text-gray-500 mt-2">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
        </div>

        <div id="movementsEmpty" class="text-center py-12 hidden">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-neutral-100 rounded-full mb-4">
            <i class="fas fa-history text-4xl text-neutral-400"></i>
          </div>
          <p class="text-lg text-neutral-700 font-bold">å…¥å‡ºåº«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
          <p class="text-sm text-neutral-500 mt-2">
            å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã¨å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
          </p>
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹éƒ¨ï¼‰ -->
        <div id="movementsPaginationBottom" class="mt-4"></div>
      </div>
    </div>
  </div>
</div>

<!-- ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div
  id="itemSearchModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"
>
  <div class="flex items-center justify-center min-h-screen p-4 modal-backdrop">
    <div
      class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-hidden shadow-lg border border-neutral-200"
      onclick="event.stopPropagation()"
    >
      <div class="p-4 bg-neutral-50 border-b border-neutral-200">
        <div class="flex justify-between items-center">
          <div class="flex items-center">
            <div class="p-3 bg-primary-blue bg-opacity-10 rounded-lg mr-3">
              <i class="fas fa-search text-xl text-primary-blue"></i>
            </div>
            <h2
              id="itemSearchModalTitle"
              class="text-xl font-bold text-neutral-800"
            >
              ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢
            </h2>
          </div>
          <button
            id="closeItemSearchModal"
            class="p-2 rounded-lg hover:bg-neutral-100 text-neutral-400 hover:text-neutral-600 transition-colors"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>

      <div class="p-4">
        <!-- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <form
          id="itemSearchForm"
          class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4"
        >
          <div>
            <label class="block text-xs font-semibold text-neutral-700 mb-2">
              <i class="fas fa-tag mr-1 text-primary-blue"></i>ææ–™å
            </label>
            <input
              type="text"
              name="material_name"
              placeholder="ææ–™åã‚’å…¥åŠ›"
              class="w-full p-2 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
            />
          </div>
          <div>
            <label class="block text-xs font-semibold text-neutral-700 mb-2">
              <i class="fas fa-ruler mr-1 text-success-green"></i>å¾„ï¼ˆmmï¼‰
            </label>
            <input
              type="number"
              name="diameter_mm"
              placeholder="å¾„ã‚’å…¥åŠ›"
              class="w-full p-2 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
            />
          </div>
          <div>
            <label class="block text-xs font-semibold text-neutral-700 mb-2">
              <i class="fas fa-barcode mr-1 text-neutral-600"></i>ãƒ­ãƒƒãƒˆç•ªå·
            </label>
            <input
              type="text"
              name="lot_number"
              placeholder="ãƒ­ãƒƒãƒˆç•ªå·ã‚’å…¥åŠ›"
              class="w-full p-2 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
            />
          </div>
          <div class="flex items-end">
            <label
              class="bg-white flex items-center space-x-2 p-2 rounded-lg cursor-pointer border border-neutral-200 hover:bg-neutral-50 transition-colors w-full"
            >
              <input
                type="checkbox"
                name="include_zero_stock"
                class="rounded border-neutral-300 w-4 h-4 text-primary-blue focus:ring-primary-blue"
              />
              <span class="text-sm text-neutral-700 font-semibold"
                >åœ¨åº«åˆ‡ã‚Œã‚’å«ã‚€</span
              >
            </label>
          </div>
          <div class="flex items-end space-x-2 md:col-span-4">
            <button
              type="submit"
              class="flex-1 bg-primary-blue text-white p-3 rounded-lg hover:bg-opacity-90 transition-opacity font-semibold"
            >
              <i class="fas fa-search mr-2"></i>æ¤œç´¢
            </button>
            <button
              type="button"
              id="resetSearchBtn"
              class="bg-white border border-neutral-200 text-neutral-700 hover:bg-neutral-50 p-3 rounded-lg font-semibold transition-colors"
            >
              <i class="fas fa-redo mr-2"></i>ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
        </form>

        <!-- æ¤œç´¢çµæœ -->
        <div
          id="searchResultsContainer"
          class="border border-neutral-200 rounded-lg max-h-96 overflow-y-auto"
        >
          <table class="w-full">
            <thead class="bg-neutral-50 sticky top-0">
              <tr>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-info-circle mr-1 text-primary-blue"></i>ææ–™æƒ…å ±
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-barcode mr-1 text-success-green"></i>ãƒ­ãƒƒãƒˆ
                </th>
                <th
                  class="px-4 py-3 text-right text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-boxes mr-1 text-neutral-600"></i>æ®‹æ•°é‡
                </th>
                <th
                  class="px-4 py-3 text-right text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-weight mr-1 text-warning-amber"></i>é‡é‡
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-map-marker-alt mr-1 text-danger-red"></i>ç½®ãå ´
                </th>
                <th
                  class="px-4 py-3 text-center text-sm font-semibold text-neutral-700"
                >
                  <i class="fas fa-check-circle mr-1 text-primary-blue"></i>é¸æŠ
                </th>
              </tr>
            </thead>
            <tbody
              id="searchResultsBody"
              class="divide-y divide-gray-200 bg-white"
            >
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
        <div id="searchLoading" class="text-center py-16 hidden">
          <div
            class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600 mb-4"
          ></div>
          <p class="text-lg text-gray-700 font-bold">æ¤œç´¢ä¸­...</p>
          <p class="text-sm text-gray-500 mt-2">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
        </div>
        <div id="searchEmpty" class="text-center py-12 hidden">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-neutral-100 rounded-full mb-4">
            <i class="fas fa-search-minus text-4xl text-neutral-400"></i>
          </div>
          <p class="text-lg text-neutral-700 font-bold">
            æ¡ä»¶ã«åˆè‡´ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
          </p>
          <p class="text-sm text-neutral-500 mt-2">
            æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ç½®ãå ´å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div
  id="relocationModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"
>
  <div class="flex items-center justify-center min-h-screen p-4 modal-backdrop">
    <div
      class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-lg border border-neutral-200 flex flex-col"
      onclick="event.stopPropagation()"
    >
      <div class="p-4 bg-neutral-50 border-b border-neutral-200 flex-shrink-0">
        <div class="flex justify-between items-center">
          <div class="flex items-center">
            <div class="p-3 bg-primary-blue bg-opacity-10 rounded-lg mr-3">
              <i class="fas fa-map-marked-alt text-xl text-primary-blue"></i>
            </div>
            <h2 class="text-xl font-bold text-neutral-800">ç½®ãå ´ã‚’å¤‰æ›´</h2>
          </div>
          <button
            id="closeRelocationModal"
            class="p-2 rounded-lg hover:bg-neutral-100 text-neutral-400 hover:text-neutral-600 transition-colors"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>

      <div class="p-4 overflow-y-auto flex-1">
        <!-- ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ± -->
        <div
          id="relocationItemInfo"
          class="bg-neutral-50 p-4 border border-dashed border-neutral-300 rounded-lg mb-4"
        >
          <div class="text-sm text-neutral-700">
            ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„
          </div>
        </div>

        <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form id="relocationForm" class="space-y-4">
          <input type="hidden" id="relocationItemId" name="item_id" />

          <div>
            <label class="block text-sm font-semibold text-neutral-700 mb-2">
              <i class="fas fa-map-marker-alt mr-1 text-primary-blue"></i
              >æ–°ã—ã„ç½®ãå ´
            </label>
            <select
              id="relocationLocationSelect"
              name="location_id"
              required
              class="w-full p-3 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
            >
              <option value="">ç½®ãå ´ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-neutral-700 mb-2">
              <i class="fas fa-comment mr-1 text-neutral-600"></i>å‚™è€ƒï¼ˆä»»æ„ï¼‰
            </label>
            <textarea
              name="notes"
              rows="3"
              class="w-full p-3 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
              placeholder="å‚™è€ƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰"
            ></textarea>
          </div>

          <button
            type="submit"
            class="w-full bg-primary-blue text-white py-3 px-4 rounded-lg transition-opacity hover:bg-opacity-90 flex items-center justify-center font-semibold text-lg"
          >
            <i class="fas fa-map-marked-alt mr-2"></i>
            ç½®ãå ´ã‚’å¤‰æ›´
          </button>
        </form>

        <div class="bg-neutral-50 p-3 rounded-lg border-l-3 border-primary-blue mt-4">
          <p class="text-xs text-neutral-600">
            <i class="fas fa-info-circle text-primary-blue mr-2"></i>
            ã“ã®æ“ä½œã§ã¯åœ¨åº«æ•°ã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã€‚ç½®ãå ´ã®ã¿ãŒç§»å‹•ã•ã‚Œã¾ã™ã€‚
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å±¥æ­´ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div
  id="editMovementModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"
  onclick="closeEditMovementModal()"
>
  <div class="flex items-center justify-center min-h-screen p-4">
    <div
      class="bg-white rounded-lg max-w-2xl w-full shadow-lg border border-neutral-200"
      onclick="event.stopPropagation()"
    >
      <div class="p-4 bg-neutral-50 border-b border-neutral-200">
        <div class="flex justify-between items-center">
          <div class="flex items-center">
            <div class="p-3 bg-primary-blue bg-opacity-10 rounded-lg mr-3">
              <i class="fas fa-edit text-xl text-primary-blue"></i>
            </div>
            <h2 class="text-xl font-bold text-neutral-800">å…¥å‡ºåº«å±¥æ­´ã®ç·¨é›†</h2>
          </div>
          <button
            onclick="closeEditMovementModal()"
            class="p-2 rounded-lg hover:bg-neutral-100 text-neutral-400 hover:text-neutral-600 transition-colors"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>

      <form id="editMovementForm" class="p-4 space-y-4">
        <input type="hidden" id="editMovementId" />

        <div>
          <label class="block text-sm font-semibold text-neutral-700 mb-2">
            <i class="fas fa-hashtag mr-1 text-neutral-600"></i>æ•°é‡ï¼ˆæœ¬ï¼‰
          </label>
          <input
            type="number"
            id="editMovementQuantity"
            min="1"
            step="1"
            class="w-full p-3 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
            placeholder="æ•°é‡ã‚’å…¥åŠ›"
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-neutral-700 mb-2">
            <i class="fas fa-weight mr-1 text-neutral-600"></i
            >é‡é‡ï¼ˆkgï¼‰â€»æ•°é‡ã¾ãŸã¯é‡é‡ã©ã¡ã‚‰ã‹å…¥åŠ›
          </label>
          <input
            type="number"
            id="editMovementWeight"
            min="0"
            step="0.001"
            class="w-full p-3 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
            placeholder="é‡é‡ã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰"
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-neutral-700 mb-2">
            <i class="fas fa-comment mr-1 text-neutral-600"></i>å‚™è€ƒ
          </label>
          <textarea
            id="editMovementNotes"
            rows="3"
            class="w-full p-3 border border-neutral-200 rounded-lg focus:border-primary-blue focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 transition-all"
            placeholder="å‚™è€ƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰"
          ></textarea>
        </div>

        <button
          type="submit"
          class="w-full bg-primary-blue text-white py-3 px-4 rounded-lg transition-opacity hover:bg-opacity-90 flex items-center justify-center font-semibold text-lg"
        >
          <i class="fas fa-save mr-2"></i>
          å±¥æ­´ã‚’æ›´æ–°
        </button>
      </form>
    </div>
  </div>
</div>

<!-- QRã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ qr-scanner.js ã§å‹•çš„ã«ä½œæˆã•ã‚Œã¾ã™ -->

<script src="{{ url_for('static', path='js/pagination.js') }}"></script>
<script>
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let inventoryItems = [];
  let filteredInventoryItems = [];
  let movementHistory = [];
  let currentItemTarget = null;
  let selectedItem = null;
  let movementType = "out";
  // å±¥æ­´ãƒ•ã‚£ãƒ«ã‚¿çŠ¶æ…‹
  let movementsFilter = { type: "" };
  // QRScannerã¯qr-scanner.jsã§æ—¢ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§å‰Šé™¤

  // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨å¤‰æ•°
  let currentInventoryPage = 1;
  let currentMovementsPage = 1;
  const pageSize = 25;

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
  document.addEventListener("DOMContentLoaded", function () {
    initializePage();
    setupEventListeners();
  });

  // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
  async function initializePage() {
    try {
      // å‰å›ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ãƒšãƒ¼ã‚¸çŠ¶æ…‹ã‚’å¾©å…ƒ
      const savedType = localStorage.getItem("movements.filter.type") || "";
      const typeSelect = document.getElementById("typeFilter");
      if (typeSelect) typeSelect.value = savedType;
      movementsFilter.type = savedType;

      const savedPage = parseInt(
        localStorage.getItem("movements.page") || "1",
        10
      );
      currentMovementsPage = isNaN(savedPage) || savedPage < 1 ? 1 : savedPage;

      await loadInventory();
      await loadMovements();
      await loadLocations();
    } catch (error) {
      console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
      showToast("ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }
  }

  // åœ¨åº«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  async function loadInventory() {
    const loading = document.getElementById("inventoryLoading");
    const empty = document.getElementById("inventoryEmpty");
    const tableBody = document.getElementById("inventoryTableBody");

    loading.classList.remove("hidden");
    empty.classList.add("hidden");

    try {
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const includeZeroStock =
        document.getElementById("includeZeroStock").checked;
      inventoryItems = await APIClient.getInventory({
        include_zero_stock: includeZeroStock,
      });
      filteredInventoryItems = inventoryItems;
      renderInventoryTable();

      if (inventoryItems.length === 0) {
        empty.classList.remove("hidden");
      }
    } catch (error) {
      console.error("åœ¨åº«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
      showToast("åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    } finally {
      loading.classList.add("hidden");
    }
  }

  // åœ¨åº«ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»
  function renderInventoryTable() {
    const tableBody = document.getElementById("inventoryTableBody");

    const sourceItems = filteredInventoryItems && filteredInventoryItems.length ? filteredInventoryItems : inventoryItems;

    if (sourceItems.length === 0) {
      tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                    åœ¨åº«ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“
                </td>
            </tr>
        `;
      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
      const topContainer = document.getElementById("inventoryPaginationTop");
      const bottomContainer = document.getElementById(
        "inventoryPaginationBottom"
      );
      if (topContainer) topContainer.innerHTML = "";
      if (bottomContainer) bottomContainer.innerHTML = "";
      return;
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
    const totalPages = Math.ceil(sourceItems.length / pageSize);
    currentInventoryPage = Math.min(currentInventoryPage, totalPages);
    const startIndex = (currentInventoryPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageItems = sourceItems.slice(startIndex, endIndex);

    tableBody.innerHTML = pageItems
      .map((item) => {
        const shapeText = getShapeText(item.material.shape);
        const isOutOfStock = item.current_quantity === 0;
        const stockClass = isOutOfStock
          ? "text-danger-red font-bold"
          : item.current_quantity <= 5
          ? "text-warning-amber font-semibold"
          : "text-neutral-800 font-semibold";
        const rowClass = isOutOfStock
          ? "bg-gray-50"
          : "table-row-hover";

        return `
            <tr class="${rowClass}">
                <td class="px-4 py-3 text-sm font-semibold text-neutral-800">${
                  item.material.display_name || "-"
                }</td>
                <td class="px-4 py-3">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-success-green bg-opacity-10 text-success-green">
                        ${shapeText}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm font-semibold text-neutral-700">${
                  item.material.diameter_mm
                }mm</td>
                <td class="px-4 py-3">
                    <span class="inline-flex items-center font-mono text-xs font-semibold text-neutral-800 bg-warning-amber bg-opacity-10 px-2 py-1 rounded-lg">
                        ${item.lot.lot_number}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm text-neutral-600">${
                  item.lot.notes || "-"
                }</td>
                <td class="px-4 py-3">
                    <span class="inline-flex items-center text-sm font-semibold text-neutral-700">
                        ${item.lot.length_mm}mm
                    </span>
                </td>
                <td class="px-4 py-3 text-right text-base ${stockClass}">
                    ${item.current_quantity}æœ¬
                    ${
                      isOutOfStock
                        ? '<span class="block text-xs text-danger-red mt-1 font-semibold">åœ¨åº«åˆ‡ã‚Œ</span>'
                        : ""
                    }
                </td>
                <td class="px-4 py-3 text-right text-sm font-semibold text-success-green">${(
                  item.total_weight_kg || 0
                ).toFixed(3)}kg</td>
                <td class="px-4 py-3">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-danger-red bg-opacity-10 text-danger-red">
                        <i class="fas fa-map-marker-alt mr-1"></i>${
                          item.location ? item.location.name : "æœªé…ç½®"
                        }
                    </span>
                </td>
                <td class="px-4 py-3 text-center">
                    <div class="flex justify-center space-x-2">
                        <button onclick="selectItemForMovement(${
                          item.id
                        }, 'in')"
                                class="movement-in-gradient text-white text-xs px-3 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity"
                                title="åœ¨åº«ã¸æˆ»ã™">
                            <i class="fas fa-arrow-left mr-1"></i>æˆ»ã—
                        </button>
                        <button onclick="selectItemForMovement(${
                          item.id
                        }, 'out')"
                                class="${
                                  isOutOfStock
                                    ? "bg-neutral-400 cursor-not-allowed"
                                    : "movement-out-gradient hover:opacity-90"
                                } text-white text-xs px-3 py-2 rounded-lg font-semibold transition-opacity"
                                ${isOutOfStock ? "disabled" : ""}>
                            <i class="fas fa-arrow-right mr-1"></i>å‡ºåº«
                        </button>
                        <button onclick="openRelocationModal(${item.id})"
                                class="bg-primary-blue text-white text-xs px-3 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity"
                                title="ç½®ãå ´ã‚’ç§»å‹•">
                            <i class="fas fa-map-marked-alt mr-1"></i>ç§»å‹•
                        </button>
                    </div>
                </td>
            </tr>
        `;
      })
      .join("");

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
    renderPagination(
      "inventory",
      currentInventoryPage,
      totalPages,
      loadInventoryPage
    );
  }

  // åœ¨åº«ä¸€è¦§ã®ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
  function loadInventoryPage(page) {
    currentInventoryPage = page;
    renderInventoryTable();
  }

  // å…¥å‡ºåº«å±¥æ­´èª­ã¿è¾¼ã¿
  async function loadMovements() {
    const loading = document.getElementById("movementsLoading");
    const empty = document.getElementById("movementsEmpty");
    const tableBody = document.getElementById("movementsTableBody");

    loading.classList.remove("hidden");
    empty.classList.add("hidden");

    try {
      movementHistory = await APIClient.getMovements();
      renderMovementsTable();

      if (movementHistory.length === 0) {
        empty.classList.remove("hidden");
      }
    } catch (error) {
      console.error("å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
      showToast("å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    } finally {
      loading.classList.add("hidden");
    }
  }

  // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»
  function renderMovementsTable() {
    const tableBody = document.getElementById("movementsTableBody");
    // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
    const filteredHistory = movementsFilter.type
      ? movementHistory.filter((m) => m.movement_type === movementsFilter.type)
      : movementHistory;

    if (filteredHistory.length === 0) {
      tableBody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    è©²å½“ã™ã‚‹å…¥å‡ºåº«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
                </td>
            </tr>
        `;
      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
      const topContainer = document.getElementById("movementsPaginationTop");
      const bottomContainer = document.getElementById(
        "movementsPaginationBottom"
      );
      if (topContainer) topContainer.innerHTML = "";
      if (bottomContainer) bottomContainer.innerHTML = "";
      return;
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ï¼ˆãƒ•ã‚£ãƒ«ã‚¿å¾Œã®ä»¶æ•°ã§è¨ˆç®—ï¼‰
    const totalPages = Math.max(
      1,
      Math.ceil(filteredHistory.length / pageSize)
    );
    currentMovementsPage = Math.min(currentMovementsPage, totalPages);
    const startIndex = (currentMovementsPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageItems = filteredHistory.slice(startIndex, endIndex);

    tableBody.innerHTML = pageItems
      .map((movement) => {
        const isIn = movement.movement_type === "in";
        const typeClass = isIn ? "text-success-green" : "text-danger-red";
        const typeText = isIn ? "æˆ»ã—" : "å‡ºåº«";
        const typeIcon = isIn ? "fa-arrow-left" : "fa-arrow-right";
        const rowClass = isIn ? "history-card-in" : "history-card-out";
        const badgeClass = isIn
          ? "bg-success-green"
          : "bg-danger-red";

        return `
            <tr class="table-row-hover ${rowClass}">
                <td class="px-4 py-3">
                    <div class="flex items-center">
                        <i class="fas fa-clock text-primary-blue mr-2"></i>
                        <span class="text-sm font-semibold text-neutral-800">
                            ${new Date(movement.processed_at).toLocaleString(
                              "ja-JP"
                            )}
                        </span>
                    </div>
                </td>
                <td class="px-4 py-3">
                    <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-semibold text-white ${badgeClass}">
                        <i class="fas ${typeIcon} mr-2"></i>${typeText}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <span class="inline-flex items-center font-mono text-xs font-semibold text-neutral-800 bg-neutral-100 px-2 py-1 rounded-lg">
                        ${movement.lot_number || "-"}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <div class="font-semibold text-neutral-800 text-sm">${
                      movement.material_name || "-"
                    }</div>
                    <div class="text-neutral-600 text-xs mt-1">
                        <i class="fas fa-barcode mr-1"></i>${
                          movement.lot_number || "-"
                        }
                    </div>
                </td>
                <td class="px-4 py-3 text-right">
                    <div class="text-base font-bold ${typeClass}">
                        ${isIn ? "+" : "-"}${movement.quantity}æœ¬
                    </div>
                    <div class="text-xs text-neutral-600 font-semibold mt-1">
                        ${
                          movement.weight_kg
                            ? movement.weight_kg.toFixed(3) + "kgï¼ˆæ›ç®—ï¼‰"
                            : "-"
                        }
                    </div>
                </td>
                <td class="px-4 py-3">
                    <div class="text-sm text-neutral-700">
                        ${movement.notes || "-"}
                    </div>
                </td>
                <td class="px-4 py-3 text-center">
                    <div class="flex items-center justify-center space-x-2">
                        <button
                            onclick="openEditMovementModal(${movement.id})"
                            class="px-3 py-2 bg-primary-blue hover:bg-opacity-90 text-white text-xs font-semibold rounded-lg transition-opacity"
                            title="å±¥æ­´ã‚’ç·¨é›†"
                        >
                            <i class="fas fa-edit mr-1"></i>ç·¨é›†
                        </button>
                        <button
                            onclick="deleteMovement(${movement.id})"
                            class="px-3 py-2 bg-danger-red hover:bg-opacity-90 text-white text-xs font-semibold rounded-lg transition-opacity"
                            title="å±¥æ­´ã‚’å‰Šé™¤"
                        >
                            <i class="fas fa-trash mr-1"></i>å‰Šé™¤
                        </button>
                    </div>
                </td>
            </tr>
        `;
      })
      .join("");

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
    renderPagination(
      "movements",
      currentMovementsPage,
      totalPages,
      loadMovementsPage
    );
  }

  // å±¥æ­´ã®ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
  function loadMovementsPage(page) {
    currentMovementsPage = page;
    localStorage.setItem("movements.page", String(page));
    renderMovementsTable();
  }

  // ç½®ãå ´ä¸€è¦§èª­ã¿è¾¼ã¿
  async function loadLocations() {
    try {
      const locations = await APIClient.getLocations();
      const datalist = document.getElementById("locationOptions");
      if (!datalist) return;

      // ã‚¯ãƒªã‚¢
      datalist.innerHTML = "";
      locations.forEach((location) => {
        const option = document.createElement("option");
        option.value = location.name;
        datalist.appendChild(option);
      });
    } catch (error) {
      console.error("ç½®ãå ´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
    }
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  function setupEventListeners() {
    // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ 
    const movementForm = document.getElementById("movementForm");
    if (movementForm) {
      movementForm.addEventListener("submit", handleSubmitMovement);
      const outBtn = document.getElementById("typeOutBtn");
      const inBtn = document.getElementById("typeInBtn");
      if (outBtn)
        outBtn.addEventListener("click", () => setMovementType("out"));
      if (inBtn) inBtn.addEventListener("click", () => setMovementType("in"));
      const selectBtn = document.getElementById("selectItemBtn");
      const clearBtn = document.getElementById("clearItemBtn");
      if (selectBtn) selectBtn.addEventListener("click", focusInventorySearch);
      if (clearBtn)
        clearBtn.addEventListener("click", clearUnifiedSelectedItem);
      setupUnifiedConverters();
      setMovementType("out");
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«
    document
      .getElementById("closeItemSearchModal")
      .addEventListener("click", closeItemSearchModal);
    document
      .getElementById("itemSearchForm")
      .addEventListener("submit", handleItemSearch);
    document
      .getElementById("resetSearchBtn")
      .addEventListener("click", resetItemSearch);

    // ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    document
      .getElementById("itemSearchModal")
      .addEventListener("click", (e) => {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯éƒ¨åˆ†ï¼ˆitemSearchModalè‡ªä½“ï¼‰ã¾ãŸã¯flexã‚³ãƒ³ãƒ†ãƒŠéƒ¨åˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã«é–‰ã˜ã‚‹
        if (
          e.target.id === "itemSearchModal" ||
          e.target.classList.contains("modal-backdrop")
        ) {
          closeItemSearchModal();
        }
      });

    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹å‡¦ç†
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const itemSearchModal = document.getElementById("itemSearchModal");
        if (itemSearchModal && !itemSearchModal.classList.contains("hidden")) {
          closeItemSearchModal();
        }
        const relocationModal = document.getElementById("relocationModal");
        if (relocationModal && !relocationModal.classList.contains("hidden")) {
          closeRelocationModal();
        }
        const editMovementModal = document.getElementById("editMovementModal");
        if (
          editMovementModal &&
          !editMovementModal.classList.contains("hidden")
        ) {
          closeEditMovementModal();
        }
      }
    });

    // å±¥æ­´ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
    const editMovementForm = document.getElementById("editMovementForm");
    if (editMovementForm) {
      editMovementForm.addEventListener("submit", handleEditMovement);
    }

    // QRã‚¹ã‚­ãƒ£ãƒ³
    document
      .getElementById("qrScanBtn")
      .addEventListener("click", openQRScanner);

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    document
      .getElementById("materialSearchInput")
      .addEventListener("input", debounce(filterInventory, 300));
    document
      .getElementById("lotSearchInput")
      .addEventListener("input", debounce(filterInventory, 300));
    const locInput = document.getElementById("locationFilterInput");
    if (locInput) {
      locInput.addEventListener("input", debounce(filterInventory, 300));
    }
    document
      .getElementById("typeFilter")
      .addEventListener("change", filterMovements);

    // æ›´æ–°ãƒœã‚¿ãƒ³
    document
      .getElementById("refreshBtn")
      .addEventListener("click", refreshData);

    // åœ¨åº«åˆ‡ã‚Œè¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    document
      .getElementById("includeZeroStock")
      .addEventListener("change", loadInventory);

    // ç½®ãå ´å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«
    document
      .getElementById("closeRelocationModal")
      .addEventListener("click", closeRelocationModal);
    document
      .getElementById("relocationForm")
      .addEventListener("submit", handleRelocation);

    // ç½®ãå ´å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    document
      .getElementById("relocationModal")
      .addEventListener("click", (e) => {
        if (
          e.target.id === "relocationModal" ||
          e.target.classList.contains("modal-backdrop")
        ) {
          closeRelocationModal();
        }
      });
  }

  // åœ¨åº«ä¸€è¦§æ¤œç´¢ã¸èª˜å°
  function focusInventorySearch() {
    const section = document.getElementById("inventorySection");
    const input = document.getElementById("materialSearchInput");
    if (section) section.scrollIntoView({ behavior: "smooth", block: "start" });
    if (input) {
      input.focus();
      input.classList.add("ring-2", "ring-blue-500");
      setTimeout(() => input.classList.remove("ring-2", "ring-blue-500"), 1500);
    }
    showToast("ä¸‹ã®åœ¨åº«ä¸€è¦§ã§æ¤œç´¢ã—ã¦ãã ã•ã„", "success");
  }

  // å…¥å‡ºåº«ãƒ•ã‚©ãƒ¼ãƒ ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  function scrollToMovementForm() {
    const form = document.getElementById("movementForm");
    if (form) form.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  // ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  function openItemSearchModal(target) {
    currentItemTarget = target;
    document.getElementById("itemSearchModalTitle").textContent =
      "ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢";
    document.getElementById("itemSearchModal").classList.remove("hidden");

    // åˆæœŸæ¤œç´¢å®Ÿè¡Œ
    handleItemSearch({ preventDefault: () => {} });
  }

  // ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  function closeItemSearchModal() {
    document.getElementById("itemSearchModal").classList.add("hidden");
    currentItemTarget = null;
  }

  // ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢å‡¦ç†
  async function handleItemSearch(event) {
    event.preventDefault();

    const loading = document.getElementById("searchLoading");
    const empty = document.getElementById("searchEmpty");
    const container = document.getElementById("searchResultsContainer");

    loading.classList.remove("hidden");
    container.classList.add("hidden");
    empty.classList.add("hidden");

    try {
      const form = document.getElementById("itemSearchForm");
      const formData = new FormData(form);

      // å€‹åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰APIãŒè¦æ±‚ã™ã‚‹å˜ä¸€ã® 'query' ã‚’çµ„ã¿ç«‹ã¦
      const materialName = (formData.get("material_name") || "").trim();
      const diameter = ((formData.get("diameter_mm") || "") + "").trim();
      const lotNumber = (formData.get("lot_number") || "").trim();
      const includeZeroStock = !!formData.get("include_zero_stock");

      const queryParts = [materialName, diameter, lotNumber].filter(Boolean);
      const query = queryParts.join(" ");

      // ã‚¯ã‚¨ãƒªå¿…é ˆï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ /api/inventory/search ã¯ query ã‚’å¿…é ˆï¼‰
      if (!query || query.trim().length === 0) {
        loading.classList.add("hidden");
        showToast("æ¤œç´¢æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
        return;
      }

      const results = await APIClient.searchMovementItems({
        query,
        include_zero_stock: includeZeroStock,
      });
      renderSearchResults(results);

      if (results.length === 0) {
        empty.classList.remove("hidden");
      } else {
        container.classList.remove("hidden");
      }
    } catch (error) {
      console.error("æ¤œç´¢ã‚¨ãƒ©ãƒ¼:", error);
      showToast(error.message || "æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    } finally {
      loading.classList.add("hidden");
    }
  }

  // æ¤œç´¢çµæœã®æç”»
  function renderSearchResults(results) {
    const tableBody = document.getElementById("searchResultsBody");

    if (results.length === 0) {
      tableBody.innerHTML = "";
      return;
    }

    tableBody.innerHTML = results
      .map((item) => {
        const shapeText = getShapeText(item.material.shape);
        const isSelected = selectedItem && selectedItem.id === item.id;
        const isOutOfStock = item.current_quantity === 0;
        const rowClass = isOutOfStock
          ? isSelected
            ? "bg-blue-50 opacity-75"
            : "bg-gray-50 opacity-75"
          : isSelected
          ? "bg-blue-50"
          : "hover:bg-gray-50";
        const stockText = isOutOfStock
          ? `${item.current_quantity}æœ¬ (åœ¨åº«åˆ‡ã‚Œ)`
          : `${item.current_quantity}æœ¬`;

        return `
            <tr class="${rowClass}">
                <td class="px-4 py-3 text-sm">
                    <div class="text-gray-900">${
                      item.material.display_name || "-"
                    }</div>
                    <div class="text-gray-500 text-xs">${shapeText} Ï†${
          item.material.diameter_mm
        }mm Ã— ${item.lot.length_mm}mm</div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">${
                  item.lot.lot_number
                }</td>
                <td class="px-4 py-3 text-right text-sm ${
                  isOutOfStock ? "text-red-600" : "text-gray-900"
                }">${stockText}</td>
                <td class="px-4 py-3 text-right text-sm text-gray-600">${(
                  item.total_weight_kg || 0
                ).toFixed(3)}kg</td>
                <td class="px-4 py-3 text-sm text-gray-600">${
                  item.location ? item.location.name : "æœªé…ç½®"
                }</td>
                <td class="px-4 py-3 text-center">
                    <button onclick="selectSearchResult(${item.id})"
                            class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">
                        é¸æŠ
                    </button>
                </td>
            </tr>
        `;
      })
      .join("");
  }

  // æ¤œç´¢çµæœã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠ
  function selectSearchResult(itemId) {
    const item = inventoryItems.find((i) => i.id === itemId);
    if (!item) {
      showToast("ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error");
      return;
    }

    // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
    selectedItem = item;
    updateUnifiedSelectedItemDisplay();
    const mfItemId = document.querySelector(
      '#movementForm input[name="item_id"]'
    );
    if (mfItemId) mfItemId.value = item.id;
    closeItemSearchModal();
  }

  // å±¥æ­´ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  function openEditMovementModal(movementId) {
    const movement = movementHistory.find((m) => m.id === movementId);
    if (!movement) {
      showToast("å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error");
      return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
    document.getElementById("editMovementId").value = movement.id;
    document.getElementById("editMovementQuantity").value = movement.quantity;
    document.getElementById("editMovementWeight").value =
      movement.weight_kg || "";
    document.getElementById("editMovementNotes").value = movement.notes || "";

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById("editMovementModal").classList.remove("hidden");
  }

  // å±¥æ­´ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  function closeEditMovementModal() {
    document.getElementById("editMovementModal").classList.add("hidden");
    document.getElementById("editMovementForm").reset();
  }

  // å±¥æ­´ç·¨é›†å‡¦ç†
  async function handleEditMovement(e) {
    e.preventDefault();

    const movementId = document.getElementById("editMovementId").value;
    const quantity = document.getElementById("editMovementQuantity").value;
    const weight = document.getElementById("editMovementWeight").value;
    const notes = document.getElementById("editMovementNotes").value;

    if (!quantity && !weight) {
      showToast("æ•°é‡ã¾ãŸã¯é‡é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
      return;
    }

    try {
      const payload = {
        quantity: quantity ? parseInt(quantity) : null,
        weight_kg: weight ? parseFloat(weight) : null,
        notes: notes || null,
      };

      const response = await fetch(`/api/movements/${movementId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || "å±¥æ­´ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }

      const result = await response.json();
      showToast(result.message || "å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸ", "success");

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
      closeEditMovementModal();
      await loadMovements();
      await loadInventory();
    } catch (error) {
      console.error("å±¥æ­´æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
      showToast(error.message, "error");
    }
  }

  // å±¥æ­´å‰Šé™¤å‡¦ç†
  async function deleteMovement(movementId) {
    if (
      !confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nåœ¨åº«æ•°ãŒå·»ãæˆ»ã•ã‚Œã¾ã™ã€‚")
    ) {
      return;
    }

    try {
      const response = await fetch(`/api/movements/${movementId}`, {
        method: "DELETE",
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || "å±¥æ­´ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }

      const result = await response.json();
      showToast(result.message || "å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "success");

      // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
      await loadMovements();
      await loadInventory();
    } catch (error) {
      console.error("å±¥æ­´å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
      showToast(error.message, "error");
    }
  }

  // ç›´æ¥ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ï¼‰
  function selectItemForMovement(itemId, type) {
    const item = inventoryItems.find((i) => i.id === itemId);
    if (!item) {
      showToast("ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error");
      return;
    }

    // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
    selectedItem = item;
    setMovementType(type);
    updateUnifiedSelectedItemDisplay();
    const mfItemId = document.querySelector(
      '#movementForm input[name="item_id"]'
    );
    if (mfItemId) mfItemId.value = item.id;
    showToast(
      `${type === "in" ? "æˆ»ã—" : "å‡ºåº«"}ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¾ã—ãŸ`,
      "success"
    );
    // å…¥å‡ºåº«ãƒ•ã‚©ãƒ¼ãƒ ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    scrollToMovementForm();
  }

  // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ : é¸æŠè¡¨ç¤ºæ›´æ–°
  function updateUnifiedSelectedItemDisplay() {
    const summary = document.getElementById("selectedItemSummary");
    const itemIdInput = document.querySelector(
      '#movementForm input[name="item_id"]'
    );
    if (!summary) return;
    if (!selectedItem) {
      summary.textContent = "ã‚¢ã‚¤ãƒ†ãƒ ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“";
      if (itemIdInput) itemIdInput.value = "";
      return;
    }
    const shapeText = getShapeText(selectedItem.material.shape);
    summary.innerHTML = `
      <div class="text-gray-900 font-medium">${
        selectedItem.material.display_name || "-"
      }</div>
      <div class="text-gray-600 text-sm">${shapeText} Ï†${
      selectedItem.material.diameter_mm
    }mm Ã— ${selectedItem.lot.length_mm}mm</div>
      <div class="text-gray-600 text-sm">ãƒ­ãƒƒãƒˆ: ${
        selectedItem.lot.lot_number
      } ${
      selectedItem.lot.notes ? "(" + selectedItem.lot.notes + ")" : ""
    } / ç½®ãå ´: ${
      selectedItem.location ? selectedItem.location.name : "æœªé…ç½®"
    }</div>
      <div class="text-gray-600 text-sm">åœ¨åº«: ${
        selectedItem.current_quantity
      }æœ¬ / ${(selectedItem.total_weight_kg || 0).toFixed(3)}kg / 1æœ¬ã‚ãŸã‚Š ${(
      selectedItem.weight_per_piece_kg || 0
    ).toFixed(3)}kg</div>
    `;
    if (itemIdInput) itemIdInput.value = selectedItem.id;
  }

  // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ : é¸æŠã‚¯ãƒªã‚¢
  function clearUnifiedSelectedItem() {
    selectedItem = null;
    updateUnifiedSelectedItemDisplay();
    const q = document.getElementById("movementQuantity");
    const w = document.getElementById("movementWeight");
    if (q) q.value = "";
    if (w) w.value = "";
  }

  // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ : ç¨®åˆ¥åˆ‡æ›¿
  function setMovementType(type) {
    movementType = type;
    const typeInput = document.getElementById("movementTypeInput");
    const submitBtn = document.getElementById("movementSubmitBtn");
    const outBtn = document.getElementById("typeOutBtn");
    const inBtn = document.getElementById("typeInBtn");

    if (typeInput) typeInput.value = type;

    // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
    if (type === "out") {
      // å‡ºåº«ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      outBtn?.classList.remove("bg-neutral-400");
      outBtn?.classList.add("movement-out-gradient");
      // æˆ»ã—ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      inBtn?.classList.remove("movement-in-gradient");
      inBtn?.classList.add("bg-neutral-400");

      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’å‡ºåº«ç”¨ã«
      if (submitBtn) {
        submitBtn.classList.remove("movement-in-gradient");
        submitBtn.classList.add("movement-out-gradient");
        submitBtn.innerHTML =
          '<i class="fas fa-arrow-right mr-2"></i>å‡ºåº«å®Ÿè¡Œ';
      }
    } else {
      // æˆ»ã—ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      inBtn?.classList.remove("bg-neutral-400");
      inBtn?.classList.add("movement-in-gradient");
      // å‡ºåº«ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      outBtn?.classList.remove("movement-out-gradient");
      outBtn?.classList.add("bg-neutral-400");

      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æˆ»ã—ç”¨ã«
      if (submitBtn) {
        submitBtn.classList.remove("movement-out-gradient");
        submitBtn.classList.add("movement-in-gradient");
        submitBtn.innerHTML =
          '<i class="fas fa-arrow-left mr-2"></i>åœ¨åº«ã¸æˆ»ã™';
      }
    }

    // æˆ»ã—é¸æŠæ™‚ã¯ã€Œåœ¨åº«åˆ‡ã‚Œã‚’å«ã‚€ã€ã‚’è‡ªå‹•ONã«ã—ã¦ä¸€è¦§ã‚’æ›´æ–°
    const includeZeroStockChk = document.getElementById("includeZeroStock");
    if (includeZeroStockChk) {
      includeZeroStockChk.checked = (type === "in");
      // ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆæˆ»ã—å¯¾è±¡ãŒä¸€è¦§ã«å‡ºã‚‹ã‚ˆã†ã«ï¼‰
      loadInventory();
    }

    // æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œåœ¨åº«åˆ‡ã‚Œã‚’å«ã‚€ã€ã‚’åŒæœŸ
    const searchZeroChk = document.querySelector('#itemSearchForm input[name="include_zero_stock"]');
    if (searchZeroChk) {
      searchZeroChk.checked = (type === "in");
    }
  }

  // å…¥åŠ›æ–¹æ³•ã¨å…¨é‡å‡ºåº«ã®ãƒˆã‚°ãƒ«è¨­å®šï¼ˆç›¸äº’æ›ç®—ã¯è¡Œã‚ãªã„ï¼‰
  function setupUnifiedConverters() {
    const q = document.getElementById("movementQuantity");
    const w = document.getElementById("movementWeight");
    const modeQ = document.getElementById("inputModeQuantity");
    const modeW = document.getElementById("inputModeWeight");
    const fullOut = document.getElementById("fullOutAll");
    if (!q || !w || !modeQ || !modeW) return;

    function applyFullOut() {
      if (!fullOut || fullOut.disabled) return;
      if (fullOut.checked && currentMovementType === "out") {
        if (!selectedItem || typeof selectedItem.current_quantity !== "number") return;
        // å¼·åˆ¶çš„ã«æ•°é‡ãƒ¢ãƒ¼ãƒ‰ã«ã—ã¦æ•°é‡ã«åœ¨åº«å…¨é‡ã‚’è¨­å®šã€é‡é‡ã¯ã‚¯ãƒªã‚¢
        modeQ.checked = true;
        modeW.checked = false;
        q.disabled = false;
        w.disabled = true;
        w.value = "";
        q.value = String(selectedItem.current_quantity || 0);
      }
    }

    function applyMode() {
      const mode = modeQ.checked ? "quantity" : "weight";
      if (mode === "quantity") {
        q.disabled = false;
        w.disabled = true;
        w.value = "";
      } else {
        q.disabled = true;
        q.value = "";
        w.disabled = false;
      }
      // å‡ºåº«ä»¥å¤–ã§ã¯å…¨é‡å‡ºåº«ã¯ç„¡åŠ¹åŒ–
      const isOut = movementType === "out";
      if (fullOut) {
        fullOut.disabled = !isOut;
        if (!isOut) fullOut.checked = false;
      }
      applyFullOut();
    }

    modeQ.addEventListener("change", applyMode);
    modeW.addEventListener("change", applyMode);
    if (fullOut) fullOut.addEventListener("change", applyFullOut);

    // åˆæœŸé©ç”¨
    applyMode();
  }

  // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ : é€ä¿¡å‡¦ç†
  async function handleSubmitMovement(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const itemId = parseInt(formData.get("item_id"));
    if (!itemId) {
      showToast("å¯¾è±¡ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„", "error");
      return;
    }
    const quantity = formData.get("quantity")
      ? parseInt(formData.get("quantity"))
      : null;
    const weight = formData.get("weight_kg")
      ? parseFloat(formData.get("weight_kg"))
      : null;

    const modeQ = document.getElementById("inputModeQuantity");
    const modeW = document.getElementById("inputModeWeight");
    const fullOut = document.getElementById("fullOutAll");

    let data = { notes: formData.get("notes") || null };

    // å…¨é‡å‡ºåº«ï¼ˆå‡ºåº«ã®ã¿æœ‰åŠ¹ï¼‰
    if (movementType === "out" && fullOut && fullOut.checked) {
      if (!selectedItem || typeof selectedItem.current_quantity !== "number") {
        showToast("åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“", "error");
        return;
      }
      const qty = selectedItem.current_quantity;
      if (!qty || qty <= 0) {
        showToast("åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“", "error");
        return;
      }
      data.quantity = qty;
    } else {
      const hasQ = quantity !== null && !isNaN(quantity);
      const hasW = weight !== null && !isNaN(weight);
      if ((hasQ && hasW) || (!hasQ && !hasW)) {
        showToast("æ•°é‡ã‹é‡é‡ã®ã©ã¡ã‚‰ã‹ä¸€æ–¹ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
        return;
      }
      if (hasQ) data.quantity = quantity;
      if (hasW) data.weight_kg = weight;
    }

    try {
      const result =
        movementType === "out"
          ? await APIClient.outMovement(itemId, data)
          : await APIClient.inMovement(itemId, data);
      const msg =
        movementType === "out" ? "å‡ºåº«ãŒå®Œäº†ã—ã¾ã—ãŸ" : "å…¥åº«ãŒå®Œäº†ã—ã¾ã—ãŸ";
      showToast(
        `${msg} (${result.old_quantity}æœ¬ â†’ ${result.new_quantity}æœ¬)`,
        "success"
      );
      form.reset();
      clearUnifiedSelectedItem();
      await loadInventory();
      await loadMovements();
    } catch (error) {
      console.error("çµ±åˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
      showToast(error.message || "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }
  }

  // QRã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
  function openQRScanner() {
    if (window.qrScanner) {
      // QRScannerã‚¯ãƒ©ã‚¹ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      window.qrScanner.openScanModal();
      // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’è¨­å®š
      window.qrScanner.scanCallback = handleQRScan;
    } else {
      showToast("QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“", "error");
    }
  }

  // QRã‚¹ã‚­ãƒ£ãƒ³çµæœå‡¦ç†
  async function handleQRScan(code) {
    try {
      const result = await APIClient.searchByLotNumber(code);

      if (result && result.length > 0) {
        // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼ˆå¯¾è±¡ã‚¢ã‚¤ãƒ†ãƒ ã«å…¥ã‚‹ã®ã¿ï¼‰
        selectedItem = result[0];
        updateUnifiedSelectedItemDisplay();
        const mfItemId = document.querySelector(
          '#movementForm input[name="item_id"]'
        );
        if (mfItemId) mfItemId.value = result[0].id;

        showToast("QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¾ã—ãŸ", "success");
      } else {
        showToast("è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ", "error");
      }
    } catch (error) {
      console.error("QRã‚¹ã‚­ãƒ£ãƒ³çµæœå‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
      showToast("QRã‚³ãƒ¼ãƒ‰ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }
  }

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†
  function filterInventory() {
    const materialInput = document.getElementById("materialSearchInput");
    const lotInput = document.getElementById("lotSearchInput");
    const locationInput = document.getElementById("locationFilterInput");

    const materialQuery = (materialInput?.value || "").trim().toLowerCase();
    const lotQuery = (lotInput?.value || "").trim().toLowerCase();
    const locationQuery = (locationInput?.value || "").trim().toLowerCase();

    const baseItems = inventoryItems || [];

    filteredInventoryItems = baseItems.filter((item) => {
      let ok = true;

      if (materialQuery) {
        const name = (item.material?.display_name || "").toLowerCase();
        const diameter = String(item.material?.diameter_mm || "");
        const shapeText = (getShapeText(item.material?.shape) || "").toLowerCase();
        ok = ok && (name.includes(materialQuery) || diameter.includes(materialQuery) || shapeText.includes(materialQuery));
      }

      if (lotQuery) {
        const lotNumber = (item.lot?.lot_number || "").toLowerCase();
        ok = ok && lotNumber.includes(lotQuery);
      }

      if (locationQuery) {
        const locName = (item.location?.name || "").toLowerCase();
        ok = ok && locName.includes(locationQuery);
      }

      return ok;
    });

    currentInventoryPage = 1;
    renderInventoryTable();
  }

  function filterMovements() {
    const select = document.getElementById("typeFilter");
    const type = select ? select.value : "";
    movementsFilter.type = type;
    localStorage.setItem("movements.filter.type", type);
    currentMovementsPage = 1;
    renderMovementsTable();
  }

  // æ¤œç´¢ãƒªã‚»ãƒƒãƒˆ
  function resetItemSearch() {
    document.getElementById("itemSearchForm").reset();
    // åœ¨åº«åˆ‡ã‚Œã‚’å«ã‚€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã¿ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ï¼ˆä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãƒªã‚»ãƒƒãƒˆï¼‰
    document.querySelector('input[name="include_zero_stock"]').checked = false;
    // è‡ªå‹•æ¤œç´¢ã¯è¡Œã‚ãªã„ï¼ˆqueryå¿…é ˆã®ãŸã‚ï¼‰ã€‚çµæœã‚’ã‚¯ãƒªã‚¢ã—ã¦éè¡¨ç¤ºã¸ã€‚
    const tableBody = document.getElementById("searchResultsBody");
    const empty = document.getElementById("searchEmpty");
    const container = document.getElementById("searchResultsContainer");
    if (tableBody) tableBody.innerHTML = "";
    if (empty) empty.classList.add("hidden");
    if (container) container.classList.add("hidden");
    showToast("æ¤œç´¢æ¡ä»¶ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ", "success");
  }

  // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
  async function refreshData() {
    await Promise.all([loadInventory(), loadMovements()]);
    showToast("ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ", "success");
  }

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  function getShapeText(shape) {
    const shapeMap = {
      round: "ä¸¸æ£’",
      hexagon: "å…­è§’æ£’",
      square: "è§’æ£’",
    };
    return shapeMap[shape] || shape;
  }

  function copyToClipboard(text) {
    navigator.clipboard
      .writeText(text)
      .then(() => {
        showToast("ç®¡ç†ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ", "success");
      })
      .catch(() => {
        showToast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
      });
  }

  function showToast(message, type = "info") {
    // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã®å®Ÿè£…
    console.log(`${type.toUpperCase()}: ${message}`);

    // ç°¡æ˜“å®Ÿè£…
    const toast = document.createElement("div");
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
      type === "success"
        ? "bg-green-600"
        : type === "error"
        ? "bg-red-600"
        : "bg-blue-600"
    }`;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // ===== ç½®ãå ´å¤‰æ›´æ©Ÿèƒ½ =====

  /**
   * ç½®ãå ´å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
   */
  async function openRelocationModal(itemId) {
    const item = inventoryItems.find((i) => i.id === itemId);
    if (!item) {
      showToast("ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error");
      return;
    }

    // ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ±ã‚’è¡¨ç¤º
    const infoDiv = document.getElementById("relocationItemInfo");
    const shapeText = getShapeText(item.material.shape);
    infoDiv.innerHTML = `
      <div class="space-y-2">
        <div class="text-base font-bold text-gray-900">${
          item.material.display_name || "-"
        }</div>
        <div class="text-sm text-gray-700">
          <span class="font-semibold">å½¢çŠ¶:</span> ${shapeText} Ï†${
      item.material.diameter_mm
    }mm Ã— ${item.lot.length_mm}mm
        </div>
        <div class="text-sm text-gray-700">
          <span class="font-semibold">ãƒ­ãƒƒãƒˆ:</span> ${item.lot.lot_number}
        </div>
        <div class="text-sm text-gray-700">
          <span class="font-semibold">ç¾åœ¨ã®ç½®ãå ´:</span> ${
            item.location ? item.location.name : "æœªé…ç½®"
          }
        </div>
        <div class="text-sm text-gray-700">
          <span class="font-semibold">åœ¨åº«æ•°:</span> ${item.current_quantity}æœ¬
        </div>
      </div>
    `;

    // ãƒ•ã‚©ãƒ¼ãƒ ã« item_id ã‚’ã‚»ãƒƒãƒˆ
    document.getElementById("relocationItemId").value = itemId;

    // ç½®ãå ´ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    try {
      const locations = await APIClient.getLocations();
      const select = document.getElementById("relocationLocationSelect");
      select.innerHTML = '<option value="">ç½®ãå ´ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      locations.forEach((location) => {
        const option = document.createElement("option");
        option.value = location.id;
        option.textContent = location.name;
        // ç¾åœ¨ã®ç½®ãå ´ã‚’é¸æŠæ¸ˆã¿ã«ã™ã‚‹
        if (item.location && location.id === item.location.id) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    } catch (error) {
      console.error("ç½®ãå ´ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
      showToast("ç½®ãå ´ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById("relocationModal").classList.remove("hidden");
  }

  /**
   * ç½®ãå ´å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
   */
  function closeRelocationModal() {
    document.getElementById("relocationModal").classList.add("hidden");
    document.getElementById("relocationForm").reset();
    document.getElementById("relocationItemId").value = "";
  }

  /**
   * ç½®ãå ´å¤‰æ›´å‡¦ç†
   */
  async function handleRelocation(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const itemId = parseInt(formData.get("item_id"));
    const locationId = parseInt(formData.get("location_id"));
    const notes = formData.get("notes") || null;

    if (!itemId) {
      showToast("ã‚¢ã‚¤ãƒ†ãƒ ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“", "error");
      return;
    }

    if (!locationId) {
      showToast("ç½®ãå ´ã‚’é¸æŠã—ã¦ãã ã•ã„", "error");
      return;
    }

    try {
      const result = await APIClient.relocateItem(itemId, {
        location_id: locationId,
        notes: notes,
      });

      showToast(
        `${result.message}: ${result.old_location} â†’ ${result.new_location}`,
        "success"
      );

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      closeRelocationModal();

      // åœ¨åº«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
      await loadInventory();
    } catch (error) {
      console.error("ç½®ãå ´å¤‰æ›´ã‚¨ãƒ©ãƒ¼:", error);
      showToast(error.message || "ç½®ãå ´ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }
  }
</script>
{% endblock %}
