{% extends "base.html" %} {% block title %}å…¥å‡ºåº«ç®¡ç† - ææ–™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {%
endblock %} {% block extra_head %}
<style>
  /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes gradient-shift {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }

  /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes float {
    0%,
    100% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-10px);
    }
  }

  .icon-float {
    animation: float 3s ease-in-out infinite;
  }

  /* å…¥åº«ãƒ»å‡ºåº«ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
  .movement-in-gradient {
    background: linear-gradient(135deg, #10b981, #059669, #047857);
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
  }

  .movement-out-gradient {
    background: linear-gradient(135deg, #ef4444, #dc2626, #b91c1c);
    box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
  }

  /* ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
  .action-btn {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .action-btn::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.3),
      transparent
    );
    transition: left 0.5s;
  }

  .action-btn:hover::before {
    left: 100%;
  }

  .action-btn:hover {
    transform: translateY(-2px) scale(1.02);
  }

  /* ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
  .table-row-hover {
    transition: all 0.2s ease;
  }

  .table-row-hover:hover {
    background: linear-gradient(90deg, #f0f9ff, #dbeafe);
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
  }

  /* å±¥æ­´ã‚«ãƒ¼ãƒ‰ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
  .history-card-in {
    background: linear-gradient(
      135deg,
      rgba(16, 185, 129, 0.1),
      rgba(5, 150, 105, 0.05)
    );
    border-left: 4px solid #10b981;
  }

  .history-card-out {
    background: linear-gradient(
      135deg,
      rgba(239, 68, 68, 0.1),
      rgba(220, 38, 38, 0.05)
    );
    border-left: 4px solid #ef4444;
  }

  /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
  .progress-shimmer {
    height: 4px;
    border-radius: 10px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
    background-size: 200% 100%;
    animation: shimmer 2s linear infinite;
  }

  @keyframes shimmer {
    0% {
      background-position: -100% 0;
    }
    100% {
      background-position: 200% 0;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="min-h-screen gradient-bg">
  <div class="max-w-[1600px] mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="mb-10">
      <div class="flex items-center justify-between">
        <div class="space-y-2">
          <h1
            class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-600 via-orange-600 to-pink-600"
          >
            å…¥å‡ºåº«ç®¡ç†
          </h1>
          <p class="text-lg text-gray-600 font-medium">
            åœ¨åº«ã®æŒã¡å‡ºã—ãƒ»æˆ»ã—ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç®¡ç†
          </p>
        </div>
        <div class="hidden md:flex items-center space-x-4">
          <button
            id="qrScanBtn"
            class="action-btn glass-card flex items-center px-6 py-4 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300"
          >
            <i class="fas fa-qrcode text-2xl text-indigo-600 mr-3"></i>
            <span class="font-bold text-gray-700">QRã‚¹ã‚­ãƒ£ãƒ³</span>
          </button>
          <button
            id="refreshBtn"
            class="action-btn glass-card p-4 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 group"
            title="ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—"
          >
            <i
              class="fas fa-sync-alt text-2xl text-gray-600 group-hover:rotate-180 transition-transform duration-500"
            ></i>
          </button>
        </div>
      </div>
    </div>

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="space-y-8">
      <!-- çµ±åˆãƒ ãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="glass-card rounded-3xl p-8 shadow-xl">
        <div class="flex items-center mb-8">
          <div
            class="p-4 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl shadow-lg mr-4 icon-float"
          >
            <i class="fas fa-exchange-alt text-3xl text-white"></i>
          </div>
          <h3 class="text-2xl font-black text-gray-900">å…¥å‡ºåº«ãƒ•ã‚©ãƒ¼ãƒ </h3>
        </div>
        <div class="progress-shimmer mb-6"></div>

        <form id="movementForm" class="space-y-6">
          <input type="hidden" name="item_id" />

          <!-- ç¨®åˆ¥ãƒˆã‚°ãƒ« -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-3"
              >å‡¦ç†ç¨®åˆ¥</label
            >
            <div class="flex space-x-4">
              <button
                type="button"
                id="typeOutBtn"
                class="action-btn flex-1 movement-out-gradient text-white px-6 py-4 rounded-2xl font-bold text-lg transition-all duration-300"
              >
                <i class="fas fa-arrow-right mr-2"></i>å‡ºåº«
              </button>
              <button
                type="button"
                id="typeInBtn"
                class="action-btn flex-1 bg-gradient-to-br from-gray-400 to-gray-500 text-white px-6 py-4 rounded-2xl font-bold text-lg transition-all duration-300"
              >
                <i class="fas fa-arrow-left mr-2"></i>æˆ»ã—
              </button>
              <input
                type="hidden"
                id="movementTypeInput"
                name="movement_type"
                value="out"
              />
            </div>
          </div>

          <!-- ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-3"
              >å¯¾è±¡ã‚¢ã‚¤ãƒ†ãƒ </label
            >
            <div class="space-y-3">
              <div
                id="selectedItemSummary"
                class="glass-card p-5 border-2 border-dashed border-gray-300 rounded-2xl text-sm text-gray-500 font-medium"
              >
                ã‚¢ã‚¤ãƒ†ãƒ ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“
              </div>
              <div class="flex space-x-3">
                <button
                  type="button"
                  id="selectItemBtn"
                  class="action-btn flex-1 bg-gradient-to-br from-blue-500 to-indigo-600 text-white px-6 py-3 rounded-2xl hover:shadow-xl transition-all duration-300 flex items-center justify-center font-bold"
                >
                  <i class="fas fa-search mr-2"></i>åœ¨åº«ä¸€è¦§ã§æ¤œç´¢
                </button>
                <button
                  type="button"
                  id="clearItemBtn"
                  class="action-btn bg-gradient-to-br from-gray-500 to-gray-600 text-white px-6 py-3 rounded-2xl hover:shadow-xl transition-all duration-300 font-bold"
                >
                  <i class="fas fa-times mr-2"></i>ã‚¯ãƒªã‚¢
                </button>
              </div>
            </div>
          </div>

          <!-- æ•°é‡ãƒ»é‡é‡å…¥åŠ› -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-3">
                <i class="fas fa-list-ol mr-2 text-blue-500"></i>æ•°é‡ï¼ˆæœ¬ï¼‰
              </label>
              <input
                type="number"
                id="movementQuantity"
                name="quantity"
                min="1"
                step="1"
                class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-blue-300 focus:border-blue-500 transition-all duration-300 font-semibold text-lg"
                placeholder="æœ¬æ•°ã‚’å…¥åŠ›"
              />
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-3">
                <i class="fas fa-weight mr-2 text-green-500"></i>é‡é‡ï¼ˆkgï¼‰
              </label>
              <input
                type="number"
                id="movementWeight"
                name="weight_kg"
                min="0.001"
                step="0.001"
                class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-green-300 focus:border-green-500 transition-all duration-300 font-semibold text-lg"
                placeholder="é‡é‡ã‚’å…¥åŠ›"
              />
            </div>
          </div>
          <div class="glass-card p-4 rounded-2xl border-l-4 border-blue-500">
            <p class="text-sm text-gray-700 font-medium">
              <i class="fas fa-info-circle text-blue-500 mr-2"></i>
              æ•°é‡ã¾ãŸã¯é‡é‡ã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç›¸äº’æ›ç®—ã•ã‚Œã¾ã™ï¼‰
            </p>
          </div>

          <!-- å‚™è€ƒ -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-3">
              <i class="fas fa-comment mr-2 text-purple-500"></i>å‚™è€ƒ
            </label>
            <textarea
              name="notes"
              rows="3"
              class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-purple-300 focus:border-purple-500 transition-all duration-300 font-medium"
              placeholder="å‚™è€ƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
            ></textarea>
          </div>

          <button
            type="submit"
            id="movementSubmitBtn"
            class="action-btn w-full movement-out-gradient text-white py-5 px-6 rounded-2xl transition-all duration-300 flex items-center justify-center font-black text-xl shadow-2xl"
          >
            <i class="fas fa-arrow-right text-2xl mr-3"></i>
            å‡ºåº«å®Ÿè¡Œ
          </button>
        </form>

        <div
          class="glass-card p-4 rounded-2xl border-l-4 border-indigo-500 mt-6"
        >
          <p class="text-xs text-gray-600 font-medium">
            <i class="fas fa-lightbulb text-indigo-500 mr-2"></i>
            åœ¨åº«ä¸€è¦§ã‹ã‚‰ç›´æ¥ã€Œå‡ºåº«ã€ã¾ãŸã¯ã€Œæˆ»ã—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™
          </p>
        </div>
      </div>

      <!-- åœ¨åº«ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ -->
      <div id="inventorySection" class="glass-card rounded-3xl p-8 shadow-xl">
        <div class="flex items-center justify-between mb-8">
          <div class="flex items-center">
            <div
              class="p-4 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-2xl shadow-lg mr-4 icon-float"
              style="animation-delay: 0.2s"
            >
              <i class="fas fa-warehouse text-3xl text-white"></i>
            </div>
            <h2 class="text-2xl font-black text-gray-900">åœ¨åº«ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§</h2>
          </div>
        </div>
        <div
          class="progress-shimmer mb-6"
          style="background: linear-gradient(90deg, #f59e0b, #ea580c)"
        ></div>

        <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ -->
        <div class="glass-card p-6 rounded-2xl mb-6 border border-gray-200">
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
            <div>
              <label class="block text-xs font-bold text-gray-700 mb-2">
                <i class="fas fa-search mr-1 text-blue-500"></i>ææ–™å
              </label>
              <input
                type="text"
                id="materialSearchInput"
                placeholder="ææ–™åã§æ¤œç´¢"
                class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-300 focus:border-blue-500 transition-all duration-300 font-medium"
              />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-700 mb-2">
                <i class="fas fa-barcode mr-1 text-green-500"></i>ãƒ­ãƒƒãƒˆç•ªå·
              </label>
              <input
                type="text"
                id="lotSearchInput"
                placeholder="ãƒ­ãƒƒãƒˆç•ªå·ã§æ¤œç´¢"
                class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-green-300 focus:border-green-500 transition-all duration-300 font-medium"
              />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-700 mb-2">
                <i class="fas fa-map-marker-alt mr-1 text-purple-500"></i>ç½®ãå ´
              </label>
              <select
                id="locationFilter"
                class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-purple-300 focus:border-purple-500 transition-all duration-300 font-medium"
              >
                <option value="">ã™ã¹ã¦</option>
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
              </select>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-700 mb-2">
                <i class="fas fa-filter mr-1 text-gray-500"></i>è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³
              </label>
              <label
                class="glass-card flex items-center space-x-3 p-3 rounded-xl cursor-pointer hover:shadow-lg transition-all duration-300 border border-gray-200"
              >
                <input
                  type="checkbox"
                  id="includeZeroStock"
                  class="rounded border-gray-300 w-5 h-5 text-blue-600 focus:ring-blue-500"
                />
                <span class="text-sm text-gray-700 font-bold"
                  >åœ¨åº«åˆ‡ã‚Œã‚’å«ã‚€</span
                >
              </label>
            </div>
          </div>
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸Šéƒ¨ï¼‰ -->
        <div id="inventoryPaginationTop" class="mb-4"></div>

        <div class="overflow-x-auto rounded-2xl border-2 border-gray-200">
          <table class="w-full">
            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
              <tr>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-tag mr-2 text-blue-500"></i>ææ–™ä»•æ§˜
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-shapes mr-2 text-green-500"></i>å½¢çŠ¶
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-ruler mr-2 text-purple-500"></i>å¾„
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-barcode mr-2 text-yellow-500"></i>ãƒ­ãƒƒãƒˆç•ªå·
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-comment mr-2 text-gray-500"></i>ãƒ­ãƒƒãƒˆå‚™è€ƒ
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-arrows-alt-h mr-2 text-indigo-500"></i>é•·ã•
                </th>
                <th
                  class="px-6 py-4 text-right text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-boxes mr-2 text-blue-600"></i>ç¾åœ¨åº«
                </th>
                <th
                  class="px-6 py-4 text-right text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-weight mr-2 text-green-600"></i>é‡é‡
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>ç½®ãå ´
                </th>
                <th
                  class="px-6 py-4 text-center text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-cogs mr-2 text-gray-600"></i>æ“ä½œ
                </th>
              </tr>
            </thead>
            <tbody
              id="inventoryTableBody"
              class="divide-y divide-gray-200 bg-white"
            >
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>

        <div id="inventoryLoading" class="text-center py-16 hidden">
          <div
            class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600 mb-4"
          ></div>
          <p class="text-lg text-gray-700 font-bold">
            åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
          </p>
          <p class="text-sm text-gray-500 mt-2">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
        </div>

        <div id="inventoryEmpty" class="text-center py-16 hidden">
          <div
            class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full mb-6 shadow-inner"
          >
            <i class="fas fa-inbox text-5xl text-gray-400"></i>
          </div>
          <p class="text-xl text-gray-700 font-bold">
            è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“
          </p>
          <p class="text-sm text-gray-500 mt-2">æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„</p>
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹éƒ¨ï¼‰ -->
        <div id="inventoryPaginationBottom" class="mt-6"></div>
      </div>

      <!-- å…¥å‡ºåº«å±¥æ­´ -->
      <div class="glass-card rounded-3xl p-8 shadow-xl">
        <div class="flex items-center justify-between mb-8">
          <div class="flex items-center">
            <div
              class="p-4 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-2xl shadow-lg mr-4 icon-float"
              style="animation-delay: 0.4s"
            >
              <i class="fas fa-history text-3xl text-white"></i>
            </div>
            <h2 class="text-2xl font-black text-gray-900">å…¥å‡ºåº«å±¥æ­´</h2>
          </div>
          <div class="flex items-center space-x-4">
            <label class="block text-xs font-bold text-gray-700">
              <i class="fas fa-filter mr-1 text-blue-500"></i>ç¨®åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            </label>
            <select
              id="typeFilter"
              class="p-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-300 focus:border-blue-500 transition-all duration-300 font-bold"
            >
              <option value="">ã™ã¹ã¦</option>
              <option value="in">ğŸŸ¢ æˆ»ã—ã®ã¿</option>
              <option value="out">ğŸ”´ å‡ºåº«ã®ã¿</option>
            </select>
          </div>
        </div>
        <div
          class="progress-shimmer mb-6"
          style="background: linear-gradient(90deg, #3b82f6, #06b6d4)"
        ></div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸Šéƒ¨ï¼‰ -->
        <div id="movementsPaginationTop" class="mb-6"></div>

        <div class="overflow-x-auto rounded-2xl border-2 border-gray-200">
          <table class="w-full">
            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
              <tr>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-clock mr-2 text-blue-500"></i>å‡¦ç†æ—¥æ™‚
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-tag mr-2 text-purple-500"></i>ç¨®åˆ¥
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-barcode mr-2 text-green-500"></i>ç®¡ç†ã‚³ãƒ¼ãƒ‰
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-box mr-2 text-yellow-500"></i>ææ–™ãƒ»ãƒ­ãƒƒãƒˆ
                </th>
                <th
                  class="px-6 py-4 text-right text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-balance-scale mr-2 text-indigo-500"></i
                  >æ•°é‡ãƒ»é‡é‡
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-comment mr-2 text-gray-500"></i>å‚™è€ƒ
                </th>
                <th
                  class="px-6 py-4 text-center text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-cog mr-2 text-orange-500"></i>æ“ä½œ
                </th>
              </tr>
            </thead>
            <tbody
              id="movementsTableBody"
              class="divide-y divide-gray-200 bg-white"
            >
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>

        <div id="movementsLoading" class="text-center py-16 hidden">
          <div
            class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600 mb-4"
          ></div>
          <p class="text-lg text-gray-700 font-bold">
            å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
          </p>
          <p class="text-sm text-gray-500 mt-2">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
        </div>

        <div id="movementsEmpty" class="text-center py-16 hidden">
          <div
            class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full mb-6 shadow-inner"
          >
            <i class="fas fa-history text-5xl text-gray-400"></i>
          </div>
          <p class="text-xl text-gray-700 font-bold">å…¥å‡ºåº«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
          <p class="text-sm text-gray-500 mt-2">
            å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã¨å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
          </p>
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹éƒ¨ï¼‰ -->
        <div id="movementsPaginationBottom" class="mt-6"></div>
      </div>
    </div>
  </div>
</div>

<!-- ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div
  id="itemSearchModal"
  class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden z-50"
>
  <div class="flex items-center justify-center min-h-screen p-4 modal-backdrop">
    <div
      class="glass-card rounded-3xl max-w-6xl w-full max-h-[90vh] overflow-hidden shadow-2xl border-2 border-gray-200"
      onclick="event.stopPropagation()"
    >
      <div
        class="p-8 border-b-2 border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50"
      >
        <div class="flex justify-between items-center">
          <div class="flex items-center">
            <div
              class="p-3 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-lg mr-4"
            >
              <i class="fas fa-search text-2xl text-white"></i>
            </div>
            <h2
              id="itemSearchModalTitle"
              class="text-3xl font-black text-gray-900"
            >
              ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢
            </h2>
          </div>
          <button
            id="closeItemSearchModal"
            class="action-btn p-3 bg-white rounded-xl hover:bg-gray-100 text-gray-600 hover:text-gray-900 transition-all duration-300"
          >
            <i class="fas fa-times text-2xl"></i>
          </button>
        </div>
      </div>

      <div class="p-8">
        <!-- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <form
          id="itemSearchForm"
          class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"
        >
          <div>
            <label class="block text-xs font-bold text-gray-700 mb-2">
              <i class="fas fa-tag mr-1 text-blue-500"></i>ææ–™å
            </label>
            <input
              type="text"
              name="material_name"
              placeholder="ææ–™åã‚’å…¥åŠ›"
              class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-300 focus:border-blue-500 transition-all duration-300 font-medium"
            />
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-700 mb-2">
              <i class="fas fa-ruler mr-1 text-green-500"></i>å¾„ï¼ˆmmï¼‰
            </label>
            <input
              type="number"
              name="diameter_mm"
              placeholder="å¾„ã‚’å…¥åŠ›"
              class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-green-300 focus:border-green-500 transition-all duration-300 font-medium"
            />
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-700 mb-2">
              <i class="fas fa-barcode mr-1 text-purple-500"></i>ãƒ­ãƒƒãƒˆç•ªå·
            </label>
            <input
              type="text"
              name="lot_number"
              placeholder="ãƒ­ãƒƒãƒˆç•ªå·ã‚’å…¥åŠ›"
              class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-purple-300 focus:border-purple-500 transition-all duration-300 font-medium"
            />
          </div>
          <div class="flex items-end">
            <label
              class="glass-card flex items-center space-x-3 p-3 rounded-xl cursor-pointer hover:shadow-lg transition-all duration-300 border border-gray-200 w-full"
            >
              <input
                type="checkbox"
                name="include_zero_stock"
                class="rounded border-gray-300 w-5 h-5 text-blue-600 focus:ring-blue-500"
              />
              <span class="text-sm text-gray-700 font-bold"
                >åœ¨åº«åˆ‡ã‚Œã‚’å«ã‚€</span
              >
            </label>
          </div>
          <div class="flex items-end space-x-3 md:col-span-4">
            <button
              type="submit"
              class="action-btn flex-1 bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-4 rounded-2xl hover:shadow-xl transition-all duration-300 font-black text-lg"
            >
              <i class="fas fa-search mr-2"></i>æ¤œç´¢
            </button>
            <button
              type="button"
              id="resetSearchBtn"
              class="action-btn bg-gradient-to-br from-gray-500 to-gray-600 text-white p-4 rounded-2xl hover:shadow-xl transition-all duration-300 font-bold"
            >
              <i class="fas fa-redo mr-2"></i>ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
        </form>

        <!-- æ¤œç´¢çµæœ -->
        <div
          id="searchResultsContainer"
          class="border-2 border-gray-200 rounded-2xl max-h-96 overflow-y-auto"
        >
          <table class="w-full">
            <thead
              class="bg-gradient-to-r from-gray-50 to-gray-100 sticky top-0"
            >
              <tr>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-info-circle mr-2 text-blue-500"></i>ææ–™æƒ…å ±
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-barcode mr-2 text-green-500"></i>ãƒ­ãƒƒãƒˆ
                </th>
                <th
                  class="px-6 py-4 text-right text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-boxes mr-2 text-purple-500"></i>æ®‹æ•°é‡
                </th>
                <th
                  class="px-6 py-4 text-right text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-weight mr-2 text-yellow-500"></i>é‡é‡
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>ç½®ãå ´
                </th>
                <th
                  class="px-6 py-4 text-center text-xs font-black text-gray-700 uppercase tracking-wider"
                >
                  <i class="fas fa-check-circle mr-2 text-indigo-500"></i>é¸æŠ
                </th>
              </tr>
            </thead>
            <tbody
              id="searchResultsBody"
              class="divide-y divide-gray-200 bg-white"
            >
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
        <div id="searchLoading" class="text-center py-16 hidden">
          <div
            class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600 mb-4"
          ></div>
          <p class="text-lg text-gray-700 font-bold">æ¤œç´¢ä¸­...</p>
          <p class="text-sm text-gray-500 mt-2">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
        </div>
        <div id="searchEmpty" class="text-center py-16 hidden">
          <div
            class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full mb-6 shadow-inner"
          >
            <i class="fas fa-search-minus text-5xl text-gray-400"></i>
          </div>
          <p class="text-xl text-gray-700 font-bold">
            æ¡ä»¶ã«åˆè‡´ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
          </p>
          <p class="text-sm text-gray-500 mt-2">
            æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ç½®ãå ´å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div
  id="relocationModal"
  class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden z-50"
>
  <div class="flex items-center justify-center min-h-screen p-4 modal-backdrop">
    <div
      class="glass-card rounded-3xl max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-2xl border-2 border-gray-200 flex flex-col"
      onclick="event.stopPropagation()"
    >
      <div
        class="p-8 border-b-2 border-gray-200 bg-gradient-to-r from-purple-50 to-indigo-50 flex-shrink-0"
      >
        <div class="flex justify-between items-center">
          <div class="flex items-center">
            <div
              class="p-3 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl shadow-lg mr-4"
            >
              <i class="fas fa-map-marked-alt text-2xl text-white"></i>
            </div>
            <h2 class="text-3xl font-black text-gray-900">ç½®ãå ´ã‚’å¤‰æ›´</h2>
          </div>
          <button
            id="closeRelocationModal"
            class="action-btn p-3 bg-white rounded-xl hover:bg-gray-100 text-gray-600 hover:text-gray-900 transition-all duration-300"
          >
            <i class="fas fa-times text-2xl"></i>
          </button>
        </div>
      </div>

      <div class="p-8 overflow-y-auto flex-1">
        <!-- ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ± -->
        <div
          id="relocationItemInfo"
          class="glass-card p-5 border-2 border-dashed border-purple-300 rounded-2xl mb-6"
        >
          <div class="text-sm text-gray-700 font-medium">
            ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„
          </div>
        </div>

        <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form id="relocationForm" class="space-y-6">
          <input type="hidden" id="relocationItemId" name="item_id" />

          <div>
            <label class="block text-sm font-bold text-gray-700 mb-3">
              <i class="fas fa-map-marker-alt mr-2 text-purple-500"></i
              >æ–°ã—ã„ç½®ãå ´
            </label>
            <select
              id="relocationLocationSelect"
              name="location_id"
              required
              class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-purple-300 focus:border-purple-500 transition-all duration-300 font-semibold text-lg"
            >
              <option value="">ç½®ãå ´ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </select>
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 mb-3">
              <i class="fas fa-comment mr-2 text-gray-500"></i>å‚™è€ƒï¼ˆä»»æ„ï¼‰
            </label>
            <textarea
              name="notes"
              rows="3"
              class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-gray-300 focus:border-gray-500 transition-all duration-300 font-medium"
              placeholder="å‚™è€ƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰"
            ></textarea>
          </div>

          <button
            type="submit"
            class="action-btn w-full bg-gradient-to-br from-purple-500 to-indigo-600 text-white py-5 px-6 rounded-2xl transition-all duration-300 flex items-center justify-center font-black text-xl shadow-2xl hover:shadow-3xl"
          >
            <i class="fas fa-map-marked-alt text-2xl mr-3"></i>
            ç½®ãå ´ã‚’å¤‰æ›´
          </button>
        </form>

        <div
          class="glass-card p-4 rounded-2xl border-l-4 border-purple-500 mt-6"
        >
          <p class="text-xs text-gray-600 font-medium">
            <i class="fas fa-info-circle text-purple-500 mr-2"></i>
            ã“ã®æ“ä½œã§ã¯åœ¨åº«æ•°ã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã€‚ç½®ãå ´ã®ã¿ãŒç§»å‹•ã•ã‚Œã¾ã™ã€‚
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å±¥æ­´ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div
  id="editMovementModal"
  class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden z-50"
  onclick="closeEditMovementModal()"
>
  <div class="flex items-center justify-center min-h-screen p-4">
    <div
      class="glass-card rounded-3xl max-w-2xl w-full shadow-2xl border-2 border-gray-200"
      onclick="event.stopPropagation()"
    >
      <div
        class="p-8 border-b-2 border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50"
      >
        <div class="flex justify-between items-center">
          <div class="flex items-center">
            <div
              class="p-3 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-lg mr-4"
            >
              <i class="fas fa-edit text-2xl text-white"></i>
            </div>
            <h2 class="text-3xl font-black text-gray-900">å…¥å‡ºåº«å±¥æ­´ã®ç·¨é›†</h2>
          </div>
          <button
            onclick="closeEditMovementModal()"
            class="text-gray-500 hover:text-gray-700 transition-colors text-2xl"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <form id="editMovementForm" class="p-8 space-y-6">
        <input type="hidden" id="editMovementId" />

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-3">
            <i class="fas fa-hashtag mr-2 text-purple-500"></i>æ•°é‡ï¼ˆæœ¬ï¼‰
          </label>
          <input
            type="number"
            id="editMovementQuantity"
            min="1"
            step="1"
            class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-purple-300 focus:border-purple-500 transition-all duration-300 font-bold text-lg"
            placeholder="æ•°é‡ã‚’å…¥åŠ›"
          />
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-3">
            <i class="fas fa-weight mr-2 text-orange-500"></i
            >é‡é‡ï¼ˆkgï¼‰â€»æ•°é‡ã¾ãŸã¯é‡é‡ã©ã¡ã‚‰ã‹å…¥åŠ›
          </label>
          <input
            type="number"
            id="editMovementWeight"
            min="0"
            step="0.001"
            class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-orange-300 focus:border-orange-500 transition-all duration-300 font-bold text-lg"
            placeholder="é‡é‡ã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰"
          />
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-3">
            <i class="fas fa-comment mr-2 text-gray-500"></i>å‚™è€ƒ
          </label>
          <textarea
            id="editMovementNotes"
            rows="3"
            class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-gray-300 focus:border-gray-500 transition-all duration-300 font-medium"
            placeholder="å‚™è€ƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰"
          ></textarea>
        </div>

        <button
          type="submit"
          class="action-btn w-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white py-5 px-6 rounded-2xl transition-all duration-300 flex items-center justify-center font-black text-xl shadow-2xl hover:shadow-3xl"
        >
          <i class="fas fa-save text-2xl mr-3"></i>
          å±¥æ­´ã‚’æ›´æ–°
        </button>
      </form>
    </div>
  </div>
</div>

<!-- QRã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ qr-scanner.js ã§å‹•çš„ã«ä½œæˆã•ã‚Œã¾ã™ -->

<script src="{{ url_for('static', path='js/pagination.js') }}"></script>
<script>
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let inventoryItems = [];
  let movementHistory = [];
  let currentItemTarget = null;
  let selectedItem = null;
  let movementType = "out";
  // å±¥æ­´ãƒ•ã‚£ãƒ«ã‚¿çŠ¶æ…‹
  let movementsFilter = { type: "" };
  // QRScannerã¯qr-scanner.jsã§æ—¢ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§å‰Šé™¤

  // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨å¤‰æ•°
  let currentInventoryPage = 1;
  let currentMovementsPage = 1;
  const pageSize = 25;

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
  document.addEventListener("DOMContentLoaded", function () {
    initializePage();
    setupEventListeners();
  });

  // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
  async function initializePage() {
    try {
      // å‰å›ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ãƒšãƒ¼ã‚¸çŠ¶æ…‹ã‚’å¾©å…ƒ
      const savedType = localStorage.getItem("movements.filter.type") || "";
      const typeSelect = document.getElementById("typeFilter");
      if (typeSelect) typeSelect.value = savedType;
      movementsFilter.type = savedType;

      const savedPage = parseInt(
        localStorage.getItem("movements.page") || "1",
        10
      );
      currentMovementsPage = isNaN(savedPage) || savedPage < 1 ? 1 : savedPage;

      await loadInventory();
      await loadMovements();
      await loadLocations();
    } catch (error) {
      console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
      showToast("ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }
  }

  // åœ¨åº«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  async function loadInventory() {
    const loading = document.getElementById("inventoryLoading");
    const empty = document.getElementById("inventoryEmpty");
    const tableBody = document.getElementById("inventoryTableBody");

    loading.classList.remove("hidden");
    empty.classList.add("hidden");

    try {
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const includeZeroStock =
        document.getElementById("includeZeroStock").checked;
      inventoryItems = await APIClient.getInventory({
        include_zero_stock: includeZeroStock,
      });
      renderInventoryTable();

      if (inventoryItems.length === 0) {
        empty.classList.remove("hidden");
      }
    } catch (error) {
      console.error("åœ¨åº«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
      showToast("åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    } finally {
      loading.classList.add("hidden");
    }
  }

  // åœ¨åº«ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»
  function renderInventoryTable() {
    const tableBody = document.getElementById("inventoryTableBody");

    if (inventoryItems.length === 0) {
      tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                    åœ¨åº«ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“
                </td>
            </tr>
        `;
      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
      const topContainer = document.getElementById("inventoryPaginationTop");
      const bottomContainer = document.getElementById(
        "inventoryPaginationBottom"
      );
      if (topContainer) topContainer.innerHTML = "";
      if (bottomContainer) bottomContainer.innerHTML = "";
      return;
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
    const totalPages = Math.ceil(inventoryItems.length / pageSize);
    currentInventoryPage = Math.min(currentInventoryPage, totalPages);
    const startIndex = (currentInventoryPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageItems = inventoryItems.slice(startIndex, endIndex);

    tableBody.innerHTML = pageItems
      .map((item) => {
        const shapeText = getShapeText(item.material.shape);
        const isOutOfStock = item.current_quantity === 0;
        const stockClass = isOutOfStock
          ? "text-red-600 font-black"
          : item.current_quantity <= 5
          ? "text-yellow-600 font-bold"
          : "text-gray-900 font-semibold";
        const rowClass = isOutOfStock
          ? "bg-gray-50 opacity-75"
          : "table-row-hover";

        return `
            <tr class="${rowClass}">
                <td class="px-6 py-4 text-sm font-semibold text-gray-900">${
                  item.material.display_name || "-"
                }</td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800">
                        ${shapeText}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm font-bold text-purple-700">${
                  item.material.diameter_mm
                }mm</td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center font-mono text-xs font-bold text-gray-900 bg-yellow-100 px-3 py-1 rounded-lg">
                        ${item.lot.lot_number}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-600 font-medium">${
                  item.lot.notes || "-"
                }</td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center text-sm font-bold text-indigo-700">
                        ${item.lot.length_mm}mm
                    </span>
                </td>
                <td class="px-6 py-4 text-right text-base ${stockClass}">
                    ${item.current_quantity}æœ¬
                    ${
                      isOutOfStock
                        ? '<span class="block text-xs text-red-500 mt-1 font-bold">åœ¨åº«åˆ‡ã‚Œ</span>'
                        : ""
                    }
                </td>
                <td class="px-6 py-4 text-right text-sm font-bold text-green-700">${(
                  item.total_weight_kg || 0
                ).toFixed(3)}kg</td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800">
                        <i class="fas fa-map-marker-alt mr-1"></i>${
                          item.location ? item.location.name : "æœªé…ç½®"
                        }
                    </span>
                </td>
                <td class="px-6 py-4 text-center">
                    <div class="flex justify-center space-x-2">
                        <button onclick="selectItemForMovement(${
                          item.id
                        }, 'in')"
                                class="action-btn movement-in-gradient text-white text-xs px-4 py-2 rounded-xl font-bold transition-all duration-300 hover:shadow-lg"
                                title="åœ¨åº«ã¸æˆ»ã™">
                            <i class="fas fa-arrow-left mr-1"></i>æˆ»ã—
                        </button>
                        <button onclick="selectItemForMovement(${
                          item.id
                        }, 'out')"
                                class="action-btn ${
                                  isOutOfStock
                                    ? "bg-gray-400 cursor-not-allowed"
                                    : "movement-out-gradient"
                                } text-white text-xs px-4 py-2 rounded-xl font-bold transition-all duration-300 hover:shadow-lg"
                                ${isOutOfStock ? "disabled" : ""}>
                            <i class="fas fa-arrow-right mr-1"></i>å‡ºåº«
                        </button>
                        <button onclick="openRelocationModal(${item.id})"
                                class="action-btn bg-gradient-to-br from-purple-500 to-indigo-600 text-white text-xs px-4 py-2 rounded-xl font-bold transition-all duration-300 hover:shadow-lg"
                                title="ç½®ãå ´ã‚’ç§»å‹•">
                            <i class="fas fa-map-marked-alt mr-1"></i>ç§»å‹•
                        </button>
                    </div>
                </td>
            </tr>
        `;
      })
      .join("");

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
    renderPagination(
      "inventory",
      currentInventoryPage,
      totalPages,
      loadInventoryPage
    );
  }

  // åœ¨åº«ä¸€è¦§ã®ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
  function loadInventoryPage(page) {
    currentInventoryPage = page;
    renderInventoryTable();
  }

  // å…¥å‡ºåº«å±¥æ­´èª­ã¿è¾¼ã¿
  async function loadMovements() {
    const loading = document.getElementById("movementsLoading");
    const empty = document.getElementById("movementsEmpty");
    const tableBody = document.getElementById("movementsTableBody");

    loading.classList.remove("hidden");
    empty.classList.add("hidden");

    try {
      movementHistory = await APIClient.getMovements();
      renderMovementsTable();

      if (movementHistory.length === 0) {
        empty.classList.remove("hidden");
      }
    } catch (error) {
      console.error("å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
      showToast("å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    } finally {
      loading.classList.add("hidden");
    }
  }

  // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»
  function renderMovementsTable() {
    const tableBody = document.getElementById("movementsTableBody");
    // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
    const filteredHistory = movementsFilter.type
      ? movementHistory.filter((m) => m.movement_type === movementsFilter.type)
      : movementHistory;

    if (filteredHistory.length === 0) {
      tableBody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    è©²å½“ã™ã‚‹å…¥å‡ºåº«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
                </td>
            </tr>
        `;
      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
      const topContainer = document.getElementById("movementsPaginationTop");
      const bottomContainer = document.getElementById(
        "movementsPaginationBottom"
      );
      if (topContainer) topContainer.innerHTML = "";
      if (bottomContainer) bottomContainer.innerHTML = "";
      return;
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ï¼ˆãƒ•ã‚£ãƒ«ã‚¿å¾Œã®ä»¶æ•°ã§è¨ˆç®—ï¼‰
    const totalPages = Math.max(
      1,
      Math.ceil(filteredHistory.length / pageSize)
    );
    currentMovementsPage = Math.min(currentMovementsPage, totalPages);
    const startIndex = (currentMovementsPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageItems = filteredHistory.slice(startIndex, endIndex);

    tableBody.innerHTML = pageItems
      .map((movement) => {
        const isIn = movement.movement_type === "in";
        const typeClass = isIn ? "text-green-700" : "text-red-700";
        const typeText = isIn ? "æˆ»ã—" : "å‡ºåº«";
        const typeIcon = isIn ? "fa-arrow-left" : "fa-arrow-right";
        const rowClass = isIn ? "history-card-in" : "history-card-out";
        const badgeClass = isIn
          ? "bg-gradient-to-r from-green-500 to-emerald-600"
          : "bg-gradient-to-r from-red-500 to-rose-600";

        return `
            <tr class="table-row-hover ${rowClass}">
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <i class="fas fa-clock text-blue-500 mr-2"></i>
                        <span class="text-sm font-bold text-gray-900">
                            ${new Date(movement.processed_at).toLocaleString(
                              "ja-JP"
                            )}
                        </span>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-4 py-2 rounded-xl text-xs font-black text-white shadow-lg ${badgeClass}">
                        <i class="fas ${typeIcon} mr-2"></i>${typeText}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center font-mono text-xs font-bold text-gray-900 bg-gray-100 px-3 py-2 rounded-lg">
                        ${movement.lot_number || "-"}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <div class="font-semibold text-gray-900 text-sm">${
                      movement.material_name || "-"
                    }</div>
                    <div class="text-gray-500 text-xs font-medium mt-1">
                        <i class="fas fa-barcode mr-1"></i>${
                          movement.lot_number || "-"
                        }
                    </div>
                </td>
                <td class="px-6 py-4 text-right">
                    <div class="text-base font-black ${typeClass}">
                        ${isIn ? "+" : "-"}${movement.quantity}æœ¬
                    </div>
                    <div class="text-xs text-gray-600 font-semibold mt-1">
                        ${
                          movement.weight_kg
                            ? movement.weight_kg.toFixed(3) + "kg"
                            : "-"
                        }
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-700 font-medium">
                        ${movement.notes || "-"}
                    </div>
                </td>
                <td class="px-6 py-4 text-center">
                    <div class="flex items-center justify-center space-x-2">
                        <button
                            onclick="openEditMovementModal(${movement.id})"
                            class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg"
                            title="å±¥æ­´ã‚’ç·¨é›†"
                        >
                            <i class="fas fa-edit mr-1"></i>ç·¨é›†
                        </button>
                        <button
                            onclick="deleteMovement(${movement.id})"
                            class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white text-xs font-bold rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg"
                            title="å±¥æ­´ã‚’å‰Šé™¤"
                        >
                            <i class="fas fa-trash mr-1"></i>å‰Šé™¤
                        </button>
                    </div>
                </td>
            </tr>
        `;
      })
      .join("");

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
    renderPagination(
      "movements",
      currentMovementsPage,
      totalPages,
      loadMovementsPage
    );
  }

  // å±¥æ­´ã®ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
  function loadMovementsPage(page) {
    currentMovementsPage = page;
    localStorage.setItem("movements.page", String(page));
    renderMovementsTable();
  }

  // ç½®ãå ´ä¸€è¦§èª­ã¿è¾¼ã¿
  async function loadLocations() {
    try {
      const locations = await APIClient.getLocations();
      const select = document.getElementById("locationFilter");

      select.innerHTML = '<option value="">ã™ã¹ã¦</option>';
      locations.forEach((location) => {
        const option = document.createElement("option");
        option.value = location.id;
        option.textContent = location.name;
        select.appendChild(option);
      });
    } catch (error) {
      console.error("ç½®ãå ´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
    }
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  function setupEventListeners() {
    // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ 
    const movementForm = document.getElementById("movementForm");
    if (movementForm) {
      movementForm.addEventListener("submit", handleSubmitMovement);
      const outBtn = document.getElementById("typeOutBtn");
      const inBtn = document.getElementById("typeInBtn");
      if (outBtn)
        outBtn.addEventListener("click", () => setMovementType("out"));
      if (inBtn) inBtn.addEventListener("click", () => setMovementType("in"));
      const selectBtn = document.getElementById("selectItemBtn");
      const clearBtn = document.getElementById("clearItemBtn");
      if (selectBtn) selectBtn.addEventListener("click", focusInventorySearch);
      if (clearBtn)
        clearBtn.addEventListener("click", clearUnifiedSelectedItem);
      setupUnifiedConverters();
      setMovementType("out");
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«
    document
      .getElementById("closeItemSearchModal")
      .addEventListener("click", closeItemSearchModal);
    document
      .getElementById("itemSearchForm")
      .addEventListener("submit", handleItemSearch);
    document
      .getElementById("resetSearchBtn")
      .addEventListener("click", resetItemSearch);

    // ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    document
      .getElementById("itemSearchModal")
      .addEventListener("click", (e) => {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯éƒ¨åˆ†ï¼ˆitemSearchModalè‡ªä½“ï¼‰ã¾ãŸã¯flexã‚³ãƒ³ãƒ†ãƒŠéƒ¨åˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã«é–‰ã˜ã‚‹
        if (
          e.target.id === "itemSearchModal" ||
          e.target.classList.contains("modal-backdrop")
        ) {
          closeItemSearchModal();
        }
      });

    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹å‡¦ç†
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const itemSearchModal = document.getElementById("itemSearchModal");
        if (itemSearchModal && !itemSearchModal.classList.contains("hidden")) {
          closeItemSearchModal();
        }
        const relocationModal = document.getElementById("relocationModal");
        if (relocationModal && !relocationModal.classList.contains("hidden")) {
          closeRelocationModal();
        }
        const editMovementModal = document.getElementById("editMovementModal");
        if (
          editMovementModal &&
          !editMovementModal.classList.contains("hidden")
        ) {
          closeEditMovementModal();
        }
      }
    });

    // å±¥æ­´ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
    const editMovementForm = document.getElementById("editMovementForm");
    if (editMovementForm) {
      editMovementForm.addEventListener("submit", handleEditMovement);
    }

    // QRã‚¹ã‚­ãƒ£ãƒ³
    document
      .getElementById("qrScanBtn")
      .addEventListener("click", openQRScanner);

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    document
      .getElementById("materialSearchInput")
      .addEventListener("input", debounce(filterInventory, 300));
    document
      .getElementById("lotSearchInput")
      .addEventListener("input", debounce(filterInventory, 300));
    document
      .getElementById("locationFilter")
      .addEventListener("change", filterInventory);
    document
      .getElementById("typeFilter")
      .addEventListener("change", filterMovements);

    // æ›´æ–°ãƒœã‚¿ãƒ³
    document
      .getElementById("refreshBtn")
      .addEventListener("click", refreshData);

    // åœ¨åº«åˆ‡ã‚Œè¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    document
      .getElementById("includeZeroStock")
      .addEventListener("change", loadInventory);

    // ç½®ãå ´å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«
    document
      .getElementById("closeRelocationModal")
      .addEventListener("click", closeRelocationModal);
    document
      .getElementById("relocationForm")
      .addEventListener("submit", handleRelocation);

    // ç½®ãå ´å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    document
      .getElementById("relocationModal")
      .addEventListener("click", (e) => {
        if (
          e.target.id === "relocationModal" ||
          e.target.classList.contains("modal-backdrop")
        ) {
          closeRelocationModal();
        }
      });
  }

  // åœ¨åº«ä¸€è¦§æ¤œç´¢ã¸èª˜å°
  function focusInventorySearch() {
    const section = document.getElementById("inventorySection");
    const input = document.getElementById("materialSearchInput");
    if (section) section.scrollIntoView({ behavior: "smooth", block: "start" });
    if (input) {
      input.focus();
      input.classList.add("ring-2", "ring-blue-500");
      setTimeout(() => input.classList.remove("ring-2", "ring-blue-500"), 1500);
    }
    showToast("ä¸‹ã®åœ¨åº«ä¸€è¦§ã§æ¤œç´¢ã—ã¦ãã ã•ã„", "success");
  }

  // ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  function openItemSearchModal(target) {
    currentItemTarget = target;
    document.getElementById("itemSearchModalTitle").textContent =
      "ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢";
    document.getElementById("itemSearchModal").classList.remove("hidden");

    // åˆæœŸæ¤œç´¢å®Ÿè¡Œ
    handleItemSearch({ preventDefault: () => {} });
  }

  // ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  function closeItemSearchModal() {
    document.getElementById("itemSearchModal").classList.add("hidden");
    currentItemTarget = null;
  }

  // ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢å‡¦ç†
  async function handleItemSearch(event) {
    event.preventDefault();

    const loading = document.getElementById("searchLoading");
    const empty = document.getElementById("searchEmpty");
    const container = document.getElementById("searchResultsContainer");

    loading.classList.remove("hidden");
    container.classList.add("hidden");
    empty.classList.add("hidden");

    try {
      const form = document.getElementById("itemSearchForm");
      const formData = new FormData(form);

      // å€‹åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰APIãŒè¦æ±‚ã™ã‚‹å˜ä¸€ã® 'query' ã‚’çµ„ã¿ç«‹ã¦
      const materialName = (formData.get("material_name") || "").trim();
      const diameter = ((formData.get("diameter_mm") || "") + "").trim();
      const lotNumber = (formData.get("lot_number") || "").trim();
      const includeZeroStock = !!formData.get("include_zero_stock");

      const queryParts = [materialName, diameter, lotNumber].filter(Boolean);
      const query = queryParts.join(" ");

      // ã‚¯ã‚¨ãƒªå¿…é ˆï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ /api/inventory/search ã¯ query ã‚’å¿…é ˆï¼‰
      if (!query || query.trim().length === 0) {
        loading.classList.add("hidden");
        showToast("æ¤œç´¢æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
        return;
      }

      const results = await APIClient.searchMovementItems({
        query,
        include_zero_stock: includeZeroStock,
      });
      renderSearchResults(results);

      if (results.length === 0) {
        empty.classList.remove("hidden");
      } else {
        container.classList.remove("hidden");
      }
    } catch (error) {
      console.error("æ¤œç´¢ã‚¨ãƒ©ãƒ¼:", error);
      showToast(error.message || "æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    } finally {
      loading.classList.add("hidden");
    }
  }

  // æ¤œç´¢çµæœã®æç”»
  function renderSearchResults(results) {
    const tableBody = document.getElementById("searchResultsBody");

    if (results.length === 0) {
      tableBody.innerHTML = "";
      return;
    }

    tableBody.innerHTML = results
      .map((item) => {
        const shapeText = getShapeText(item.material.shape);
        const isSelected = selectedItem && selectedItem.id === item.id;
        const isOutOfStock = item.current_quantity === 0;
        const rowClass = isOutOfStock
          ? isSelected
            ? "bg-blue-50 opacity-75"
            : "bg-gray-50 opacity-75"
          : isSelected
          ? "bg-blue-50"
          : "hover:bg-gray-50";
        const stockText = isOutOfStock
          ? `${item.current_quantity}æœ¬ (åœ¨åº«åˆ‡ã‚Œ)`
          : `${item.current_quantity}æœ¬`;

        return `
            <tr class="${rowClass}">
                <td class="px-4 py-3 text-sm">
                    <div class="text-gray-900">${
                      item.material.display_name || "-"
                    }</div>
                    <div class="text-gray-500 text-xs">${shapeText} Ï†${
          item.material.diameter_mm
        }mm Ã— ${item.lot.length_mm}mm</div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">${
                  item.lot.lot_number
                }</td>
                <td class="px-4 py-3 text-right text-sm ${
                  isOutOfStock ? "text-red-600" : "text-gray-900"
                }">${stockText}</td>
                <td class="px-4 py-3 text-right text-sm text-gray-600">${(
                  item.total_weight_kg || 0
                ).toFixed(3)}kg</td>
                <td class="px-4 py-3 text-sm text-gray-600">${
                  item.location ? item.location.name : "æœªé…ç½®"
                }</td>
                <td class="px-4 py-3 text-center">
                    <button onclick="selectSearchResult(${item.id})"
                            class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">
                        é¸æŠ
                    </button>
                </td>
            </tr>
        `;
      })
      .join("");
  }

  // æ¤œç´¢çµæœã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠ
  function selectSearchResult(itemId) {
    const item = inventoryItems.find((i) => i.id === itemId);
    if (!item) {
      showToast("ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error");
      return;
    }

    // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
    selectedItem = item;
    updateUnifiedSelectedItemDisplay();
    const mfItemId = document.querySelector(
      '#movementForm input[name="item_id"]'
    );
    if (mfItemId) mfItemId.value = item.id;
    closeItemSearchModal();
  }

  // å±¥æ­´ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  function openEditMovementModal(movementId) {
    const movement = movementHistory.find((m) => m.id === movementId);
    if (!movement) {
      showToast("å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error");
      return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
    document.getElementById("editMovementId").value = movement.id;
    document.getElementById("editMovementQuantity").value = movement.quantity;
    document.getElementById("editMovementWeight").value =
      movement.weight_kg || "";
    document.getElementById("editMovementNotes").value = movement.notes || "";

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById("editMovementModal").classList.remove("hidden");
  }

  // å±¥æ­´ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  function closeEditMovementModal() {
    document.getElementById("editMovementModal").classList.add("hidden");
    document.getElementById("editMovementForm").reset();
  }

  // å±¥æ­´ç·¨é›†å‡¦ç†
  async function handleEditMovement(e) {
    e.preventDefault();

    const movementId = document.getElementById("editMovementId").value;
    const quantity = document.getElementById("editMovementQuantity").value;
    const weight = document.getElementById("editMovementWeight").value;
    const notes = document.getElementById("editMovementNotes").value;

    if (!quantity && !weight) {
      showToast("æ•°é‡ã¾ãŸã¯é‡é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
      return;
    }

    try {
      const payload = {
        quantity: quantity ? parseInt(quantity) : null,
        weight_kg: weight ? parseFloat(weight) : null,
        notes: notes || null,
      };

      const response = await fetch(`/api/movements/${movementId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || "å±¥æ­´ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }

      const result = await response.json();
      showToast(result.message || "å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸ", "success");

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
      closeEditMovementModal();
      await loadMovements();
      await loadInventory();
    } catch (error) {
      console.error("å±¥æ­´æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
      showToast(error.message, "error");
    }
  }

  // å±¥æ­´å‰Šé™¤å‡¦ç†
  async function deleteMovement(movementId) {
    if (
      !confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nåœ¨åº«æ•°ãŒå·»ãæˆ»ã•ã‚Œã¾ã™ã€‚")
    ) {
      return;
    }

    try {
      const response = await fetch(`/api/movements/${movementId}`, {
        method: "DELETE",
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || "å±¥æ­´ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }

      const result = await response.json();
      showToast(result.message || "å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "success");

      // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
      await loadMovements();
      await loadInventory();
    } catch (error) {
      console.error("å±¥æ­´å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
      showToast(error.message, "error");
    }
  }

  // ç›´æ¥ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ï¼‰
  function selectItemForMovement(itemId, type) {
    const item = inventoryItems.find((i) => i.id === itemId);
    if (!item) {
      showToast("ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error");
      return;
    }

    // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
    selectedItem = item;
    setMovementType(type);
    updateUnifiedSelectedItemDisplay();
    const mfItemId = document.querySelector(
      '#movementForm input[name="item_id"]'
    );
    if (mfItemId) mfItemId.value = item.id;
    showToast(
      `${type === "in" ? "æˆ»ã—" : "å‡ºåº«"}ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¾ã—ãŸ`,
      "success"
    );
  }

  // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ : é¸æŠè¡¨ç¤ºæ›´æ–°
  function updateUnifiedSelectedItemDisplay() {
    const summary = document.getElementById("selectedItemSummary");
    const itemIdInput = document.querySelector(
      '#movementForm input[name="item_id"]'
    );
    if (!summary) return;
    if (!selectedItem) {
      summary.textContent = "ã‚¢ã‚¤ãƒ†ãƒ ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“";
      if (itemIdInput) itemIdInput.value = "";
      return;
    }
    const shapeText = getShapeText(selectedItem.material.shape);
    summary.innerHTML = `
      <div class="text-gray-900 font-medium">${
        selectedItem.material.display_name || "-"
      }</div>
      <div class="text-gray-600 text-sm">${shapeText} Ï†${
      selectedItem.material.diameter_mm
    }mm Ã— ${selectedItem.lot.length_mm}mm</div>
      <div class="text-gray-600 text-sm">ãƒ­ãƒƒãƒˆ: ${
        selectedItem.lot.lot_number
      } ${
      selectedItem.lot.notes ? "(" + selectedItem.lot.notes + ")" : ""
    } / ç½®ãå ´: ${
      selectedItem.location ? selectedItem.location.name : "æœªé…ç½®"
    }</div>
      <div class="text-gray-600 text-sm">åœ¨åº«: ${
        selectedItem.current_quantity
      }æœ¬ / ${(selectedItem.total_weight_kg || 0).toFixed(3)}kg / 1æœ¬ã‚ãŸã‚Š ${(
      selectedItem.weight_per_piece_kg || 0
    ).toFixed(3)}kg</div>
    `;
    if (itemIdInput) itemIdInput.value = selectedItem.id;
  }

  // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ : é¸æŠã‚¯ãƒªã‚¢
  function clearUnifiedSelectedItem() {
    selectedItem = null;
    updateUnifiedSelectedItemDisplay();
    const q = document.getElementById("movementQuantity");
    const w = document.getElementById("movementWeight");
    if (q) q.value = "";
    if (w) w.value = "";
  }

  // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ : ç¨®åˆ¥åˆ‡æ›¿
  function setMovementType(type) {
    movementType = type;
    const typeInput = document.getElementById("movementTypeInput");
    const submitBtn = document.getElementById("movementSubmitBtn");
    const outBtn = document.getElementById("typeOutBtn");
    const inBtn = document.getElementById("typeInBtn");

    if (typeInput) typeInput.value = type;

    // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
    if (type === "out") {
      // å‡ºåº«ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      outBtn?.classList.remove(
        "bg-gradient-to-br",
        "from-gray-400",
        "to-gray-500"
      );
      outBtn?.classList.add("movement-out-gradient");
      // æˆ»ã—ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      inBtn?.classList.remove("movement-in-gradient");
      inBtn?.classList.add("bg-gradient-to-br", "from-gray-400", "to-gray-500");

      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’å‡ºåº«ç”¨ã«
      if (submitBtn) {
        submitBtn.classList.remove("movement-in-gradient");
        submitBtn.classList.add("movement-out-gradient");
        submitBtn.innerHTML =
          '<i class="fas fa-arrow-right text-2xl mr-3"></i>å‡ºåº«å®Ÿè¡Œ';
      }
    } else {
      // æˆ»ã—ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      inBtn?.classList.remove(
        "bg-gradient-to-br",
        "from-gray-400",
        "to-gray-500"
      );
      inBtn?.classList.add("movement-in-gradient");
      // å‡ºåº«ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      outBtn?.classList.remove("movement-out-gradient");
      outBtn?.classList.add(
        "bg-gradient-to-br",
        "from-gray-400",
        "to-gray-500"
      );

      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æˆ»ã—ç”¨ã«
      if (submitBtn) {
        submitBtn.classList.remove("movement-out-gradient");
        submitBtn.classList.add("movement-in-gradient");
        submitBtn.innerHTML =
          '<i class="fas fa-arrow-left text-2xl mr-3"></i>åœ¨åº«ã¸æˆ»ã™';
      }
    }
  }

  // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ : æ•°é‡â‡”é‡é‡ç›¸äº’æ›ç®—
  function setupUnifiedConverters() {
    const q = document.getElementById("movementQuantity");
    const w = document.getElementById("movementWeight");
    if (!q || !w) return;
    q.addEventListener("input", () => {
      if (!selectedItem || !selectedItem.weight_per_piece_kg) return;
      const quantity = parseInt(q.value || "0");
      if (!isNaN(quantity) && quantity > 0) {
        const weight = quantity * selectedItem.weight_per_piece_kg;
        w.value = Number(weight).toFixed(3);
      } else if (q.value === "") {
        w.value = "";
      }
    });
    w.addEventListener("input", () => {
      if (!selectedItem || !selectedItem.weight_per_piece_kg) return;
      const weight = parseFloat(w.value || "0");
      if (!isNaN(weight) && weight > 0) {
        const quantity = Math.round(weight / selectedItem.weight_per_piece_kg);
        q.value = String(quantity);
      } else if (w.value === "") {
        q.value = "";
      }
    });
  }

  // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ : é€ä¿¡å‡¦ç†
  async function handleSubmitMovement(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const itemId = parseInt(formData.get("item_id"));
    if (!itemId) {
      showToast("å¯¾è±¡ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„", "error");
      return;
    }
    const quantity = formData.get("quantity")
      ? parseInt(formData.get("quantity"))
      : null;
    const weight = formData.get("weight_kg")
      ? parseFloat(formData.get("weight_kg"))
      : null;
    if (!quantity && !weight) {
      showToast("æ•°é‡ã¾ãŸã¯é‡é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
      return;
    }
    const data = { notes: formData.get("notes") || null };
    if (quantity) data.quantity = quantity;
    if (weight) data.weight_kg = weight;

    try {
      const result =
        movementType === "out"
          ? await APIClient.outMovement(itemId, data)
          : await APIClient.inMovement(itemId, data);
      const msg =
        movementType === "out" ? "å‡ºåº«ãŒå®Œäº†ã—ã¾ã—ãŸ" : "å…¥åº«ãŒå®Œäº†ã—ã¾ã—ãŸ";
      showToast(
        `${msg} (${result.old_quantity}æœ¬ â†’ ${result.new_quantity}æœ¬)`,
        "success"
      );
      form.reset();
      clearUnifiedSelectedItem();
      await loadInventory();
      await loadMovements();
    } catch (error) {
      console.error("çµ±åˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
      showToast(error.message || "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }
  }

  // QRã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
  function openQRScanner() {
    if (window.qrScanner) {
      // QRScannerã‚¯ãƒ©ã‚¹ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      window.qrScanner.openScanModal();
      // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’è¨­å®š
      window.qrScanner.scanCallback = handleQRScan;
    } else {
      showToast("QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“", "error");
    }
  }

  // QRã‚¹ã‚­ãƒ£ãƒ³çµæœå‡¦ç†
  async function handleQRScan(code) {
    try {
      const result = await APIClient.searchByLotNumber(code);

      if (result) {
        // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼ˆå¯¾è±¡ã‚¢ã‚¤ãƒ†ãƒ ã«å…¥ã‚‹ã®ã¿ï¼‰
        selectedItem = result;
        updateUnifiedSelectedItemDisplay();
        const mfItemId = document.querySelector(
          '#movementForm input[name="item_id"]'
        );
        if (mfItemId) mfItemId.value = result.id;

        showToast("QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¾ã—ãŸ", "success");
      } else {
        showToast("è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ", "error");
      }
    } catch (error) {
      console.error("QRã‚¹ã‚­ãƒ£ãƒ³çµæœå‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
      showToast("QRã‚³ãƒ¼ãƒ‰ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }
  }

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†
  function filterInventory() {
    // TODO: å®Ÿè£…äºˆå®š
    console.log("åœ¨åº«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†");
  }

  function filterMovements() {
    const select = document.getElementById("typeFilter");
    const type = select ? select.value : "";
    movementsFilter.type = type;
    localStorage.setItem("movements.filter.type", type);
    currentMovementsPage = 1;
    renderMovementsTable();
  }

  // æ¤œç´¢ãƒªã‚»ãƒƒãƒˆ
  function resetItemSearch() {
    document.getElementById("itemSearchForm").reset();
    // åœ¨åº«åˆ‡ã‚Œã‚’å«ã‚€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã¿ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ï¼ˆä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãƒªã‚»ãƒƒãƒˆï¼‰
    document.querySelector('input[name="include_zero_stock"]').checked = false;
    // è‡ªå‹•æ¤œç´¢ã¯è¡Œã‚ãªã„ï¼ˆqueryå¿…é ˆã®ãŸã‚ï¼‰ã€‚çµæœã‚’ã‚¯ãƒªã‚¢ã—ã¦éè¡¨ç¤ºã¸ã€‚
    const tableBody = document.getElementById("searchResultsBody");
    const empty = document.getElementById("searchEmpty");
    const container = document.getElementById("searchResultsContainer");
    if (tableBody) tableBody.innerHTML = "";
    if (empty) empty.classList.add("hidden");
    if (container) container.classList.add("hidden");
    showToast("æ¤œç´¢æ¡ä»¶ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ", "success");
  }

  // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
  async function refreshData() {
    await Promise.all([loadInventory(), loadMovements()]);
    showToast("ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ", "success");
  }

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  function getShapeText(shape) {
    const shapeMap = {
      round: "ä¸¸æ£’",
      hexagon: "å…­è§’æ£’",
      square: "è§’æ£’",
    };
    return shapeMap[shape] || shape;
  }

  function copyToClipboard(text) {
    navigator.clipboard
      .writeText(text)
      .then(() => {
        showToast("ç®¡ç†ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ", "success");
      })
      .catch(() => {
        showToast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
      });
  }

  function showToast(message, type = "info") {
    // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã®å®Ÿè£…
    console.log(`${type.toUpperCase()}: ${message}`);

    // ç°¡æ˜“å®Ÿè£…
    const toast = document.createElement("div");
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
      type === "success"
        ? "bg-green-600"
        : type === "error"
        ? "bg-red-600"
        : "bg-blue-600"
    }`;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // ===== ç½®ãå ´å¤‰æ›´æ©Ÿèƒ½ =====

  /**
   * ç½®ãå ´å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
   */
  async function openRelocationModal(itemId) {
    const item = inventoryItems.find((i) => i.id === itemId);
    if (!item) {
      showToast("ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error");
      return;
    }

    // ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ±ã‚’è¡¨ç¤º
    const infoDiv = document.getElementById("relocationItemInfo");
    const shapeText = getShapeText(item.material.shape);
    infoDiv.innerHTML = `
      <div class="space-y-2">
        <div class="text-base font-bold text-gray-900">${
          item.material.display_name || "-"
        }</div>
        <div class="text-sm text-gray-700">
          <span class="font-semibold">å½¢çŠ¶:</span> ${shapeText} Ï†${
      item.material.diameter_mm
    }mm Ã— ${item.lot.length_mm}mm
        </div>
        <div class="text-sm text-gray-700">
          <span class="font-semibold">ãƒ­ãƒƒãƒˆ:</span> ${item.lot.lot_number}
        </div>
        <div class="text-sm text-gray-700">
          <span class="font-semibold">ç¾åœ¨ã®ç½®ãå ´:</span> ${
            item.location ? item.location.name : "æœªé…ç½®"
          }
        </div>
        <div class="text-sm text-gray-700">
          <span class="font-semibold">åœ¨åº«æ•°:</span> ${item.current_quantity}æœ¬
        </div>
      </div>
    `;

    // ãƒ•ã‚©ãƒ¼ãƒ ã« item_id ã‚’ã‚»ãƒƒãƒˆ
    document.getElementById("relocationItemId").value = itemId;

    // ç½®ãå ´ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    try {
      const locations = await APIClient.getLocations();
      const select = document.getElementById("relocationLocationSelect");
      select.innerHTML = '<option value="">ç½®ãå ´ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      locations.forEach((location) => {
        const option = document.createElement("option");
        option.value = location.id;
        option.textContent = location.name;
        // ç¾åœ¨ã®ç½®ãå ´ã‚’é¸æŠæ¸ˆã¿ã«ã™ã‚‹
        if (item.location && location.id === item.location.id) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    } catch (error) {
      console.error("ç½®ãå ´ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
      showToast("ç½®ãå ´ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById("relocationModal").classList.remove("hidden");
  }

  /**
   * ç½®ãå ´å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
   */
  function closeRelocationModal() {
    document.getElementById("relocationModal").classList.add("hidden");
    document.getElementById("relocationForm").reset();
    document.getElementById("relocationItemId").value = "";
  }

  /**
   * ç½®ãå ´å¤‰æ›´å‡¦ç†
   */
  async function handleRelocation(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const itemId = parseInt(formData.get("item_id"));
    const locationId = parseInt(formData.get("location_id"));
    const notes = formData.get("notes") || null;

    if (!itemId) {
      showToast("ã‚¢ã‚¤ãƒ†ãƒ ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“", "error");
      return;
    }

    if (!locationId) {
      showToast("ç½®ãå ´ã‚’é¸æŠã—ã¦ãã ã•ã„", "error");
      return;
    }

    try {
      const result = await APIClient.relocateItem(itemId, {
        location_id: locationId,
        notes: notes,
      });

      showToast(
        `${result.message}: ${result.old_location} â†’ ${result.new_location}`,
        "success"
      );

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      closeRelocationModal();

      // åœ¨åº«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
      await loadInventory();
    } catch (error) {
      console.error("ç½®ãå ´å¤‰æ›´ã‚¨ãƒ©ãƒ¼:", error);
      showToast(error.message || "ç½®ãå ´ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }
  }
</script>
{% endblock %}
