{% extends "base.html" %} {% block title %}入出庫管理 - 材料管理システム{%
endblock %} {% block content %}
<div class="min-h-screen bg-gray-50">
  <!-- ヘッダー -->
  <div class="bg-white shadow-sm border-b">
    <div class="px-4 py-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">持ち出し・戻し管理</h1>
          <p class="text-gray-600 mt-1">在庫としてストックしてある材料の持ち出し・戻しを管理します</p>
        </div>
        <div class="flex space-x-4">
          <button
            id="qrScanBtn"
            class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h2M4 4h4m4 0h2m0 0h.01M4 20h4m12 0h2m-6 0h2M4 8h2.5"
              ></path>
            </svg>
            QRスキャン
          </button>
          <button
            id="refreshBtn"
            class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors flex items-center"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
            更新
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- コンテンツエリア -->
  <div class="px-4 py-6">

    <!-- 統合ムーブメントフォーム -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <div class="flex items-center mb-4">
        <div class="p-2 bg-gray-100 rounded-lg mr-3">
          <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900">入出庫統合フォーム</h3>
      </div>

      <form id="movementForm" class="space-y-4">
        <input type="hidden" name="item_id" />

        <!-- 種別トグル -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">処理種別</label>
          <div class="flex space-x-2">
            <button type="button" id="typeOutBtn" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">出庫</button>
            <button type="button" id="typeInBtn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">戻し</button>
            <input type="hidden" id="movementTypeInput" name="movement_type" value="out" />
          </div>
        </div>

        <!-- アイテム選択 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">対象アイテム</label>
          <div class="space-y-2">
            <div id="selectedItemSummary" class="p-3 border border-dashed border-gray-300 rounded-lg bg-gray-50 text-sm text-gray-500">アイテムが選択されていません</div>
            <div class="flex space-x-2">
              <button type="button" id="selectItemBtn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                在庫一覧で検索
              </button>
              <button type="button" id="clearItemBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">クリア</button>
            </div>
          </div>
        </div>

        <!-- 数量・重量入力 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">数量（本）</label>
            <input type="number" id="movementQuantity" name="quantity" min="1" step="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="本数を入力" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">重量（kg）</label>
            <input type="number" id="movementWeight" name="weight_kg" min="0.001" step="0.001" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="重量を入力" />
          </div>
        </div>
        <p class="text-sm text-gray-500">※数量または重量のいずれかを入力してください（相互換算されます）</p>

        <!-- 指示番号（出庫のみ） -->
        <!-- 指示番号は不要のため削除 -->

        <!-- 備考 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">備考</label>
          <textarea name="notes" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="備考"></textarea>
        </div>

        <button type="submit" id="movementSubmitBtn" class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
          出庫実行
        </button>
      </form>
      <p class="text-xs text-gray-500 mt-4">※ 在庫一覧から直接「出庫」または「戻し」ボタンをクリックすることもできます</p>
    </div>

    <!-- 在庫アイテム一覧 -->
    <div id="inventorySection" class="bg-white rounded-lg shadow-sm mb-6">
      <div class="p-4 border-b">
        <div class="flex justify-between items-center">
          <h2 class="text-lg font-semibold text-gray-900">在庫アイテム一覧</h2>
          <div class="flex space-x-4">
            <input
              type="text"
              id="materialSearchInput"
              placeholder="材料名で検索"
              class="w-48 p-2 border border-gray-300 rounded-md"
            />
            <input
              type="text"
              id="lotSearchInput"
              placeholder="ロット番号で検索"
              class="w-48 p-2 border border-gray-300 rounded-md"
            />
            <select
              id="locationFilter"
              class="w-32 p-2 border border-gray-300 rounded-md"
            >
              <option value="">すべて</option>
              <!-- 動的に生成 -->
            </select>
            <label class="flex items-center space-x-2">
              <input
                type="checkbox"
                id="includeZeroStock"
                class="rounded border-gray-300"
              />
              <span class="text-sm text-gray-700">在庫切れを含む</span>
            </label>
          </div>
        </div>
      </div>

      <!-- ページネーション（上部） -->
      <div id="inventoryPaginationTop" class="mb-4"></div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">
                材料仕様
              </th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">
                形状
              </th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">
                径
              </th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">
                ロット番号
              </th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">
                ロット備考
              </th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">
                長さ
              </th>
              <th
                class="px-4 py-3 text-right text-sm font-medium text-gray-500"
              >
                現在庫
              </th>
              <th
                class="px-4 py-3 text-right text-sm font-medium text-gray-500"
              >
                重量
              </th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">
                置き場
              </th>
              <th
                class="px-4 py-3 text-center text-sm font-medium text-gray-500"
              >
                操作
              </th>
            </tr>
          </thead>
          <tbody id="inventoryTableBody" class="divide-y divide-gray-200">
            <!-- 動的に生成 -->
          </tbody>
        </table>
      </div>
      <div id="inventoryLoading" class="text-center py-8 hidden">
        <div
          class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
        ></div>
        <p class="mt-2 text-gray-600">読み込み中...</p>
      </div>
      <div id="inventoryEmpty" class="text-center py-8 hidden">
        <p class="text-gray-500">該当するアイテムがありません</p>
      </div>

      <!-- ページネーション（下部） -->
      <div id="inventoryPaginationBottom" class="mt-4"></div>
    </div>

    <!-- 入出庫履歴 -->
    <div class="bg-white rounded-lg shadow-sm">
      <div class="p-4 border-b">
        <div class="flex justify-between items-center">
          <h2 class="text-lg font-semibold text-gray-900">持ち出し・戻し履歴</h2>
          <div class="flex space-x-4">
            <select
              id="typeFilter"
              class="w-32 p-2 border border-gray-300 rounded-md"
            >
              <option value="">すべて</option>
              <option value="in">戻しのみ</option>
              <option value="out">出庫のみ</option>
            </select>
          </div>
        </div>
      </div>

      <!-- ページネーション（上部） -->
      <div id="movementsPaginationTop" class="mb-4"></div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">
                処理日時
              </th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">
                種別
              </th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">
                管理コード
              </th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">
                材料・ロット
              </th>
              <th
                class="px-4 py-3 text-right text-sm font-medium text-gray-500"
              >
                数量・重量
              </th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">
                備考
              </th>
            </tr>
          </thead>
          <tbody id="movementsTableBody" class="divide-y divide-gray-200">
            <!-- 動的に生成 -->
          </tbody>
        </table>
      </div>
      <div id="movementsLoading" class="text-center py-8 hidden">
        <div
          class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
        ></div>
        <p class="mt-2 text-gray-600">読み込み中...</p>
      </div>
      <div id="movementsEmpty" class="text-center py-8 hidden">
        <p class="text-gray-500">入出庫履歴がありません</p>
      </div>

      <!-- ページネーション（下部） -->
      <div id="movementsPaginationBottom" class="mt-4"></div>
    </div>
  </div>
</div>

<!-- アイテム検索モーダル -->
<div
  id="itemSearchModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"
>
  <div class="flex items-center justify-center min-h-screen p-4 modal-backdrop">
    <div
      class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-hidden"
      onclick="event.stopPropagation()"
    >
      <div class="p-6 border-b">
        <div class="flex justify-between items-center">
          <h2
            id="itemSearchModalTitle"
            class="text-xl font-semibold text-gray-900"
          >
            アイテムを検索
          </h2>
          <button
            id="closeItemSearchModal"
            class="text-gray-400 hover:text-gray-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
      </div>

      <div class="p-6">
        <!-- 検索フィルター -->
        <form
          id="itemSearchForm"
          class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"
        >
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >材料名</label
            >
            <input
              type="text"
              name="material_name"
              placeholder="材料名を入力"
              class="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >径（mm）</label
            >
            <input
              type="number"
              name="diameter_mm"
              placeholder="径を入力"
              class="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >ロット番号</label
            >
            <input
              type="text"
              name="lot_number"
              placeholder="ロット番号を入力"
              class="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div class="flex items-end">
            <label class="flex items-center space-x-2 mb-2">
              <input
                type="checkbox"
                name="include_zero_stock"
                class="rounded border-gray-300"
              />
              <span class="text-sm text-gray-700">在庫切れを含む</span>
            </label>
          </div>
          <div class="flex items-end space-x-2 md:col-span-4">
            <button
              type="submit"
              class="flex-1 bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition-colors"
            >
              検索
            </button>
            <button
              type="button"
              id="resetSearchBtn"
              class="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition-colors"
            >
              リセット
            </button>
          </div>
        </form>

        <!-- 検索結果 -->
        <div
          id="searchResultsContainer"
          class="border border-gray-200 rounded-lg max-h-96 overflow-y-auto"
        >
          <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th
                  class="px-4 py-3 text-left text-sm font-medium text-gray-500"
                >
                  材料情報
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-medium text-gray-500"
                >
                  ロット
                </th>
                <th
                  class="px-4 py-3 text-right text-sm font-medium text-gray-500"
                >
                  残数量
                </th>
                <th
                  class="px-4 py-3 text-right text-sm font-medium text-gray-500"
                >
                  重量
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-medium text-gray-500"
                >
                  置き場
                </th>
                <th
                  class="px-4 py-3 text-center text-sm font-medium text-gray-500"
                >
                  選択
                </th>
              </tr>
            </thead>
            <tbody id="searchResultsBody" class="divide-y divide-gray-200">
              <!-- 動的に生成 -->
            </tbody>
          </table>
        </div>
        <div id="searchLoading" class="text-center py-8 hidden">
          <div
            class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
          ></div>
          <p class="mt-2 text-gray-600">検索中...</p>
        </div>
        <div id="searchEmpty" class="text-center py-8 hidden">
          <p class="text-gray-500">
            条件に合致するアイテムが見つかりませんでした
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- QRスキャンモーダルは qr-scanner.js で動的に作成されます -->

<script src="{{ url_for('static', path='js/pagination.js') }}"></script>
<script>
  // グローバル変数
  let inventoryItems = [];
  let movementHistory = [];
  let currentItemTarget = null;
  let selectedItem = null;
  let movementType = "out";
  // QRScannerはqr-scanner.jsで既に定義されているので削除

  // ページネーション用変数
  let currentInventoryPage = 1;
  let currentMovementsPage = 1;
  const pageSize = 25;

  // ページ読み込み時の初期化
  document.addEventListener("DOMContentLoaded", function () {
    initializePage();
    setupEventListeners();
  });

  // ページ初期化
  async function initializePage() {
    try {
      await loadInventory();
      await loadMovements();
      await loadLocations();
    } catch (error) {
      console.error("初期化エラー:", error);
      showToast("ページの初期化に失敗しました", "error");
    }
  }

  // 在庫データ読み込み
  async function loadInventory() {
    const loading = document.getElementById("inventoryLoading");
    const empty = document.getElementById("inventoryEmpty");
    const tableBody = document.getElementById("inventoryTableBody");

    loading.classList.remove("hidden");
    empty.classList.add("hidden");

    try {
      // チェックボックスの状態に基づいてフィルタリング
      const includeZeroStock =
        document.getElementById("includeZeroStock").checked;
      inventoryItems = await APIClient.getInventory({
        include_zero_stock: includeZeroStock,
      });
      renderInventoryTable();

      if (inventoryItems.length === 0) {
        empty.classList.remove("hidden");
      }
    } catch (error) {
      console.error("在庫読み込みエラー:", error);
      showToast("在庫データの読み込みに失敗しました", "error");
    } finally {
      loading.classList.add("hidden");
    }
  }

  // 在庫テーブルの描画
  function renderInventoryTable() {
    const tableBody = document.getElementById("inventoryTableBody");

    if (inventoryItems.length === 0) {
      tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                    在庫アイテムがありません
                </td>
            </tr>
        `;
      // ページネーションを非表示
      const topContainer = document.getElementById('inventoryPaginationTop');
      const bottomContainer = document.getElementById('inventoryPaginationBottom');
      if (topContainer) topContainer.innerHTML = '';
      if (bottomContainer) bottomContainer.innerHTML = '';
      return;
    }

    // ページネーション処理
    const totalPages = Math.ceil(inventoryItems.length / pageSize);
    currentInventoryPage = Math.min(currentInventoryPage, totalPages);
    const startIndex = (currentInventoryPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageItems = inventoryItems.slice(startIndex, endIndex);

    tableBody.innerHTML = pageItems
      .map((item) => {
        const shapeText = getShapeText(item.material.shape);
        const isOutOfStock = item.current_quantity === 0;
        const stockClass = isOutOfStock
          ? "text-red-600"
          : item.current_quantity <= 5
          ? "text-yellow-600"
          : "text-gray-900";
        const rowClass = isOutOfStock
          ? "bg-gray-50 opacity-75"
          : "hover:bg-gray-50";

        return `
            <tr class="${rowClass}">
                <td class="px-4 py-3 text-sm text-gray-900">${
                  item.material.display_name || "-"
                }</td>
                <td class="px-4 py-3 text-sm text-gray-600">${shapeText}</td>
                <td class="px-4 py-3 text-sm text-gray-600">${
                  item.material.diameter_mm
                }</td>
                <td class="px-4 py-3 text-sm text-gray-900">${
                  item.lot.lot_number
                }</td>
                <td class="px-4 py-3 text-sm text-gray-500">${
                  item.lot.notes || "-"
                }</td>
                <td class="px-4 py-3 text-sm text-gray-600">${
                  item.lot.length_mm
                }mm</td>
                <td class="px-4 py-3 text-right text-sm font-medium ${stockClass}">
                    ${item.current_quantity}本
                    ${
                      isOutOfStock
                        ? '<span class="text-xs text-red-500 ml-1">(在庫切れ)</span>'
                        : ""
                    }
                </td>
                <td class="px-4 py-3 text-right text-sm text-gray-600">${(
                  item.total_weight_kg || 0
                ).toFixed(3)}kg</td>
                <td class="px-4 py-3 text-sm text-gray-600">${
                  item.location ? item.location.name : "未配置"
                }</td>
                <td class="px-4 py-3 text-center">
                    <div class="flex justify-center space-x-1">
                        <button onclick="selectItemForMovement(${item.id}, 'in')"
                                class="bg-green-600 text-white text-xs px-2 py-1 rounded hover:bg-green-700 transition-colors"
                                title="在庫へ戻す">
                            戻し
                        </button>
                        <button onclick="selectItemForMovement(${
                          item.id
                        }, 'out')"
                                class="${
                                  isOutOfStock
                                    ? "bg-gray-400 cursor-not-allowed"
                                    : "bg-red-600 hover:bg-red-700"
                                } text-white text-xs px-2 py-1 rounded transition-colors"
                                ${isOutOfStock ? "disabled" : ""}>
                            出庫
                        </button>
                    </div>
                </td>
            </tr>
        `;
      })
      .join("");

    // ページネーション表示
    renderPagination('inventory', currentInventoryPage, totalPages, loadInventoryPage);
  }

  // 在庫一覧のページ切り替え
  function loadInventoryPage(page) {
    currentInventoryPage = page;
    renderInventoryTable();
  }

  // 入出庫履歴読み込み
  async function loadMovements() {
    const loading = document.getElementById("movementsLoading");
    const empty = document.getElementById("movementsEmpty");
    const tableBody = document.getElementById("movementsTableBody");

    loading.classList.remove("hidden");
    empty.classList.add("hidden");

    try {
      movementHistory = await APIClient.getMovements();
      renderMovementsTable();

      if (movementHistory.length === 0) {
        empty.classList.remove("hidden");
      }
    } catch (error) {
      console.error("履歴読み込みエラー:", error);
      showToast("履歴データの読み込みに失敗しました", "error");
    } finally {
      loading.classList.add("hidden");
    }
  }

  // 履歴テーブルの描画
  function renderMovementsTable() {
    const tableBody = document.getElementById("movementsTableBody");

    if (movementHistory.length === 0) {
      tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                    入出庫履歴がありません
                </td>
            </tr>
        `;
      // ページネーションを非表示
      const topContainer = document.getElementById('movementsPaginationTop');
      const bottomContainer = document.getElementById('movementsPaginationBottom');
      if (topContainer) topContainer.innerHTML = '';
      if (bottomContainer) bottomContainer.innerHTML = '';
      return;
    }

    // ページネーション処理
    const totalPages = Math.ceil(movementHistory.length / pageSize);
    currentMovementsPage = Math.min(currentMovementsPage, totalPages);
    const startIndex = (currentMovementsPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageItems = movementHistory.slice(startIndex, endIndex);

    tableBody.innerHTML = pageItems
      .map((movement) => {
        const typeClass =
          movement.movement_type === "in" ? "text-green-600" : "text-red-600";
        const typeText = movement.movement_type === "in" ? "入庫" : "出庫";
        const typeIcon = movement.movement_type === "in" ? "+" : "-";

        return `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-gray-900">
                    ${new Date(movement.processed_at).toLocaleString("ja-JP")}
                </td>
                <td class="px-4 py-3">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${typeClass} bg-${
          movement.movement_type === "in" ? "green" : "red"
        }-50">
                        ${typeText}
                    </span>
                </td>
                <td class="px-4 py-3 font-mono text-xs text-gray-900">
                    ${movement.lot_number || "-"}
                </td>
                <td class="px-4 py-3 text-sm">
                    <div class="text-gray-900">${
                      movement.material_name || "-"
                    }</div>
                    <div class="text-gray-500 text-xs">${
                      movement.lot_number || "-"
                    }</div>
                </td>
                <td class="px-4 py-3 text-right text-sm font-medium ${typeClass}">
                    <div>${typeIcon}${movement.quantity}本</div>
                    <div class="text-xs text-gray-500">${
                      movement.weight_kg
                        ? movement.weight_kg.toFixed(3) + "kg"
                        : "-"
                    }</div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">${
                  movement.notes || "-"
                }</td>
            </tr>
        `;
      })
      .join("");

    // ページネーション表示
    renderPagination('movements', currentMovementsPage, totalPages, loadMovementsPage);
  }

  // 履歴のページ切り替え
  function loadMovementsPage(page) {
    currentMovementsPage = page;
    renderMovementsTable();
  }

  // 置き場一覧読み込み
  async function loadLocations() {
    try {
      const locations = await APIClient.getLocations();
      const select = document.getElementById("locationFilter");

      select.innerHTML = '<option value="">すべて</option>';
      locations.forEach((location) => {
        const option = document.createElement("option");
        option.value = location.id;
        option.textContent = location.name;
        select.appendChild(option);
      });
    } catch (error) {
      console.error("置き場読み込みエラー:", error);
    }
  }

  // イベントリスナー設定
  function setupEventListeners() {
    // 統合フォーム
    const movementForm = document.getElementById("movementForm");
    if (movementForm) {
      movementForm.addEventListener("submit", handleSubmitMovement);
      const outBtn = document.getElementById("typeOutBtn");
      const inBtn = document.getElementById("typeInBtn");
      if (outBtn) outBtn.addEventListener("click", () => setMovementType("out"));
      if (inBtn) inBtn.addEventListener("click", () => setMovementType("in"));
      const selectBtn = document.getElementById("selectItemBtn");
      const clearBtn = document.getElementById("clearItemBtn");
      if (selectBtn) selectBtn.addEventListener("click", focusInventorySearch);
      if (clearBtn) clearBtn.addEventListener("click", clearUnifiedSelectedItem);
      setupUnifiedConverters();
      setMovementType("out");
    }

    // モーダル
    document
      .getElementById("closeItemSearchModal")
      .addEventListener("click", closeItemSearchModal);
    document
      .getElementById("itemSearchForm")
      .addEventListener("submit", handleItemSearch);
    document
      .getElementById("resetSearchBtn")
      .addEventListener("click", resetItemSearch);

    // アイテム検索モーダルの背景クリック時の処理
    document
      .getElementById("itemSearchModal")
      .addEventListener("click", (e) => {
        // モーダルの背景部分（itemSearchModal自体）またはflexコンテナ部分をクリックした場合に閉じる
        if (
          e.target.id === "itemSearchModal" ||
          e.target.classList.contains("modal-backdrop")
        ) {
          closeItemSearchModal();
        }
      });

    // ESCキーでモーダルを閉じる処理
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const itemSearchModal = document.getElementById("itemSearchModal");
        if (itemSearchModal && !itemSearchModal.classList.contains("hidden")) {
          closeItemSearchModal();
        }
      }
    });

    // QRスキャン
    document
      .getElementById("qrScanBtn")
      .addEventListener("click", openQRScanner);

    // フィルター
    document
      .getElementById("materialSearchInput")
      .addEventListener("input", debounce(filterInventory, 300));
    document
      .getElementById("lotSearchInput")
      .addEventListener("input", debounce(filterInventory, 300));
    document
      .getElementById("locationFilter")
      .addEventListener("change", filterInventory);
    document
      .getElementById("typeFilter")
      .addEventListener("change", filterMovements);

    // 更新ボタン
    document
      .getElementById("refreshBtn")
      .addEventListener("click", refreshData);

    // 在庫切れ表示フィルター
    document
      .getElementById("includeZeroStock")
      .addEventListener("change", loadInventory);
  }

  // 在庫一覧検索へ誘導
  function focusInventorySearch() {
    const section = document.getElementById("inventorySection");
    const input = document.getElementById("materialSearchInput");
    if (section) section.scrollIntoView({ behavior: "smooth", block: "start" });
    if (input) {
      input.focus();
      input.classList.add("ring-2", "ring-blue-500");
      setTimeout(() => input.classList.remove("ring-2", "ring-blue-500"), 1500);
    }
    showToast("下の在庫一覧で検索してください", "success");
  }

  // アイテム検索モーダルを開く
  function openItemSearchModal(target) {
    currentItemTarget = target;
    document.getElementById("itemSearchModalTitle").textContent = "アイテムを検索";
    document.getElementById("itemSearchModal").classList.remove("hidden");

    // 初期検索実行
    handleItemSearch({ preventDefault: () => {} });
  }

  // アイテム検索モーダルを閉じる
  function closeItemSearchModal() {
    document.getElementById("itemSearchModal").classList.add("hidden");
    currentItemTarget = null;
  }

  // アイテム検索処理
  async function handleItemSearch(event) {
    event.preventDefault();

    const loading = document.getElementById("searchLoading");
    const empty = document.getElementById("searchEmpty");
    const container = document.getElementById("searchResultsContainer");

    loading.classList.remove("hidden");
    container.classList.add("hidden");
    empty.classList.add("hidden");

    try {
      const form = document.getElementById("itemSearchForm");
      const formData = new FormData(form);

      // 個別フィールドからAPIが要求する単一の 'query' を組み立て
      const materialName = (formData.get("material_name") || "").trim();
      const diameter = ((formData.get("diameter_mm") || "") + "").trim();
      const lotNumber = (formData.get("lot_number") || "").trim();
      const includeZeroStock = !!formData.get("include_zero_stock");

      const queryParts = [materialName, diameter, lotNumber].filter(Boolean);
      const query = queryParts.join(" ");

      // クエリ必須（バックエンド /api/inventory/search は query を必須）
      if (!query || query.trim().length === 0) {
        loading.classList.add("hidden");
        showToast("検索条件を入力してください", "error");
        return;
      }

      const results = await APIClient.searchMovementItems({
        query,
        include_zero_stock: includeZeroStock,
      });
      renderSearchResults(results);

      if (results.length === 0) {
        empty.classList.remove("hidden");
      } else {
        container.classList.remove("hidden");
      }
    } catch (error) {
      console.error("検索エラー:", error);
      showToast(error.message || "検索に失敗しました", "error");
    } finally {
      loading.classList.add("hidden");
    }
  }

  // 検索結果の描画
  function renderSearchResults(results) {
    const tableBody = document.getElementById("searchResultsBody");

    if (results.length === 0) {
      tableBody.innerHTML = "";
      return;
    }

    tableBody.innerHTML = results
      .map((item) => {
        const shapeText = getShapeText(item.material.shape);
        const isSelected = selectedItem && selectedItem.id === item.id;
        const isOutOfStock = item.current_quantity === 0;
        const rowClass = isOutOfStock
          ? isSelected
            ? "bg-blue-50 opacity-75"
            : "bg-gray-50 opacity-75"
          : isSelected
          ? "bg-blue-50"
          : "hover:bg-gray-50";
        const stockText = isOutOfStock
          ? `${item.current_quantity}本 (在庫切れ)`
          : `${item.current_quantity}本`;

        return `
            <tr class="${rowClass}">
                <td class="px-4 py-3 text-sm">
                    <div class="text-gray-900">${item.material.display_name || "-"}</div>
                    <div class="text-gray-500 text-xs">${shapeText} φ${
          item.material.diameter_mm
        }mm × ${item.lot.length_mm}mm</div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">${
                  item.lot.lot_number
                }</td>
                <td class="px-4 py-3 text-right text-sm ${
                  isOutOfStock ? "text-red-600" : "text-gray-900"
                }">${stockText}</td>
                <td class="px-4 py-3 text-right text-sm text-gray-600">${(
                  item.total_weight_kg || 0
                ).toFixed(3)}kg</td>
                <td class="px-4 py-3 text-sm text-gray-600">${
                  item.location ? item.location.name : "未配置"
                }</td>
                <td class="px-4 py-3 text-center">
                    <button onclick="selectSearchResult(${item.id})"
                            class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">
                        選択
                    </button>
                </td>
            </tr>
        `;
      })
      .join("");
  }

  // 検索結果からアイテムを選択
  function selectSearchResult(itemId) {
    const item = inventoryItems.find((i) => i.id === itemId);
    if (!item) {
      showToast("アイテムが見つかりません", "error");
      return;
    }

    // 統合フォームに反映
    selectedItem = item;
    updateUnifiedSelectedItemDisplay();
    const mfItemId = document.querySelector('#movementForm input[name="item_id"]');
    if (mfItemId) mfItemId.value = item.id;
    closeItemSearchModal();
    showToast("アイテムを選択しました", "success");
  }

  // 直接アイテムを選択（テーブルから）
  function selectItemForMovement(itemId, type) {
    const item = inventoryItems.find((i) => i.id === itemId);
    if (!item) {
      showToast("アイテムが見つかりません", "error");
      return;
    }

    // 統合フォームに反映
    selectedItem = item;
    setMovementType(type);
    updateUnifiedSelectedItemDisplay();
    const mfItemId = document.querySelector('#movementForm input[name="item_id"]');
    if (mfItemId) mfItemId.value = item.id;
    showToast(
      `${type === "in" ? "戻し" : "出庫"}アイテムを選択しました`,
      "success"
    );
  }


  // 統合フォーム: 選択表示更新
  function updateUnifiedSelectedItemDisplay() {
    const summary = document.getElementById("selectedItemSummary");
    const itemIdInput = document.querySelector('#movementForm input[name="item_id"]');
    if (!summary) return;
    if (!selectedItem) {
      summary.textContent = "アイテムが選択されていません";
      if (itemIdInput) itemIdInput.value = "";
      return;
    }
    const shapeText = getShapeText(selectedItem.material.shape);
    summary.innerHTML = `
      <div class="text-gray-900 font-medium">${selectedItem.material.display_name || "-"}</div>
      <div class="text-gray-600 text-sm">${shapeText} φ${selectedItem.material.diameter_mm}mm × ${selectedItem.lot.length_mm}mm</div>
      <div class="text-gray-600 text-sm">ロット: ${selectedItem.lot.lot_number} ${selectedItem.lot.notes ? "(" + selectedItem.lot.notes + ")" : ""} / 置き場: ${selectedItem.location ? selectedItem.location.name : "未配置"}</div>
      <div class="text-gray-600 text-sm">在庫: ${selectedItem.current_quantity}本 / ${(selectedItem.total_weight_kg || 0).toFixed(3)}kg / 1本あたり ${(selectedItem.weight_per_piece_kg || 0).toFixed(3)}kg</div>
    `;
    if (itemIdInput) itemIdInput.value = selectedItem.id;
  }

  // 統合フォーム: 選択クリア
  function clearUnifiedSelectedItem() {
    selectedItem = null;
    updateUnifiedSelectedItemDisplay();
    const q = document.getElementById("movementQuantity");
    const w = document.getElementById("movementWeight");
    if (q) q.value = "";
    if (w) w.value = "";
  }

  // 統合フォーム: 種別切替
  function setMovementType(type) {
    movementType = type;
    const typeInput = document.getElementById("movementTypeInput");
    const submitBtn = document.getElementById("movementSubmitBtn");
    if (typeInput) typeInput.value = type;
    if (submitBtn) {
      if (type === "out") {
        submitBtn.classList.remove("bg-indigo-600","hover:bg-indigo-700");
        submitBtn.classList.add("bg-red-600","hover:bg-red-700");
        submitBtn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>出庫実行';
      } else {
        submitBtn.classList.remove("bg-red-600","hover:bg-red-700");
        submitBtn.classList.add("bg-indigo-600","hover:bg-indigo-700");
        submitBtn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>在庫へ戻す';
      }
    }
  }

  // 統合フォーム: 数量⇔重量相互換算
  function setupUnifiedConverters() {
    const q = document.getElementById("movementQuantity");
    const w = document.getElementById("movementWeight");
    if (!q || !w) return;
    q.addEventListener("input", () => {
      if (!selectedItem || !selectedItem.weight_per_piece_kg) return;
      const quantity = parseInt(q.value || "0");
      if (!isNaN(quantity) && quantity > 0) {
        const weight = quantity * selectedItem.weight_per_piece_kg;
        w.value = Number(weight).toFixed(3);
      } else if (q.value === "") {
        w.value = "";
      }
    });
    w.addEventListener("input", () => {
      if (!selectedItem || !selectedItem.weight_per_piece_kg) return;
      const weight = parseFloat(w.value || "0");
      if (!isNaN(weight) && weight > 0) {
        const quantity = Math.round(weight / selectedItem.weight_per_piece_kg);
        q.value = String(quantity);
      } else if (w.value === "") {
        q.value = "";
      }
    });
  }

  // 統合フォーム: 送信処理
  async function handleSubmitMovement(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const itemId = parseInt(formData.get("item_id"));
    if (!itemId) {
      showToast("対象アイテムを選択してください", "error");
      return;
    }
    const quantity = formData.get("quantity") ? parseInt(formData.get("quantity")) : null;
    const weight = formData.get("weight_kg") ? parseFloat(formData.get("weight_kg")) : null;
    if (!quantity && !weight) {
      showToast("数量または重量を入力してください", "error");
      return;
    }
    const data = { notes: formData.get("notes") || null };
    if (quantity) data.quantity = quantity;
    if (weight) data.weight_kg = weight;

    try {
      const result = movementType === "out"
        ? await APIClient.outMovement(itemId, data)
        : await APIClient.inMovement(itemId, data);
      const msg = movementType === "out" ? "出庫が完了しました" : "入庫が完了しました";
      showToast(`${msg} (${result.old_quantity}本 → ${result.new_quantity}本)`, "success");
      form.reset();
      clearUnifiedSelectedItem();
      await loadInventory();
      await loadMovements();
    } catch (error) {
      console.error("統合フォーム送信エラー:", error);
      showToast(error.message || "処理に失敗しました", "error");
    }
  }

  // QRスキャン開始
  function openQRScanner() {
    if (window.qrScanner) {
      // QRScannerクラスのモーダルを開く
      window.qrScanner.openScanModal();
      // コールバック関数を設定
      window.qrScanner.scanCallback = handleQRScan;
    } else {
      showToast("QRスキャナーが利用できません", "error");
    }
  }

  // QRスキャン結果処理
  async function handleQRScan(code) {
    try {
      const result = await APIClient.searchByLotNumber(code);

      if (result) {
        // 統合フォームに反映（対象アイテムに入るのみ）
        selectedItem = result;
        updateUnifiedSelectedItemDisplay();
        const mfItemId = document.querySelector('#movementForm input[name="item_id"]');
        if (mfItemId) mfItemId.value = result.id;

        showToast("QRコードからアイテムを選択しました", "success");
      } else {
        showToast("該当するアイテムが見つかりませんでした", "error");
      }
    } catch (error) {
      console.error("QRスキャン結果処理エラー:", error);
      showToast("QRコードの処理に失敗しました", "error");
    }
  }

  // フィルター処理
  function filterInventory() {
    // TODO: 実装予定
    console.log("在庫フィルター処理");
  }

  function filterMovements() {
    // TODO: 実装予定
    console.log("履歴フィルター処理");
  }

  // 検索リセット
  function resetItemSearch() {
    document.getElementById("itemSearchForm").reset();
    // 在庫切れを含むチェックボックスのみチェックを外す（他のフィールドはリセット）
    document.querySelector('input[name="include_zero_stock"]').checked = false;
    // 自動検索は行わない（query必須のため）。結果をクリアして非表示へ。
    const tableBody = document.getElementById("searchResultsBody");
    const empty = document.getElementById("searchEmpty");
    const container = document.getElementById("searchResultsContainer");
    if (tableBody) tableBody.innerHTML = "";
    if (empty) empty.classList.add("hidden");
    if (container) container.classList.add("hidden");
    showToast("検索条件をリセットしました", "success");
  }

  // データ更新
  async function refreshData() {
    await Promise.all([loadInventory(), loadMovements()]);
    showToast("データを更新しました", "success");
  }

  // ユーティリティ関数
  function getShapeText(shape) {
    const shapeMap = {
      round: "丸棒",
      hexagon: "六角棒",
      square: "角棒",
    };
    return shapeMap[shape] || shape;
  }

  function copyToClipboard(text) {
    navigator.clipboard
      .writeText(text)
      .then(() => {
        showToast("管理コードをコピーしました", "success");
      })
      .catch(() => {
        showToast("コピーに失敗しました", "error");
      });
  }

  function showToast(message, type = "info") {
    // トースト通知の実装
    console.log(`${type.toUpperCase()}: ${message}`);

    // 簡易実装
    const toast = document.createElement("div");
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
      type === "success"
        ? "bg-green-600"
        : type === "error"
        ? "bg-red-600"
        : "bg-blue-600"
    }`;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
</script>
{% endblock %}
