{% extends "base.html" %} {% block title %}材料管理 - 生産管理システム{%
endblock %} {% block content %}
<div class="min-h-screen bg-gray-50">
  <div class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
      <div
        class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
      >
        <div>
          <h1 class="text-2xl font-bold text-gray-900">
            材料管理（未来使用量）
          </h1>
          <p class="text-gray-600 mt-1">
            セット予定表.xlsx
            の「生産中」シートを参照し、材質ごとの日別使用本数を算出します。取り数（W列）を基に一日の使用本数を算出し、複数台稼働時も機械NO昇順で振り分けています。
          </p>
        </div>
        <div class="flex items-center gap-3">
          <label class="inline-flex items-center text-sm text-gray-700">
            <input
              id="futureOnly"
              type="checkbox"
              class="h-4 w-4 text-blue-600 border-gray-300 rounded"
              checked
            />
            <span class="ml-2">本日のみ表示</span>
          </label>
          <button
            id="reloadBtn"
            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm hover:bg-blue-700 transition"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v6h6M20 20v-6h-6M5 19a9 9 0 0014-7V5M19 5a9 9 0 00-14 7v7"
              />
            </svg>
            再読み込み
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
    <div id="stats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-5">
        <h2 class="text-sm font-medium text-gray-500">対象日数</h2>
        <p id="summaryCount" class="mt-2 text-2xl font-bold text-gray-900">0</p>
      </div>
      <div class="bg-white rounded-lg shadow p-5">
        <h2 class="text-sm font-medium text-gray-500">合計使用本数</h2>
        <p id="totalBars" class="mt-2 text-2xl font-bold text-blue-600">0</p>
      </div>
      <div class="bg-white rounded-lg shadow p-5">
        <h2 class="text-sm font-medium text-gray-500">最終更新</h2>
        <p id="lastUpdated" class="mt-2 text-2xl font-bold text-gray-900">--</p>
      </div>
    </div>

    <div class="bg-white shadow rounded-lg overflow-hidden">
      <div
        class="px-4 py-3 border-b border-gray-200 flex items-center justify-between"
      >
        <h2 class="text-sm font-semibold text-gray-700">
          材料別・日別使用計画
        </h2>
        <div class="flex items-center gap-4 text-xs text-gray-500">
          <span>行をクリックすると詳細が展開します</span>
          <div id="filterInfo" class="hidden">
            <span class="text-blue-600 font-medium">フィルター中:</span>
            <span id="filterMaterial" class="text-blue-600"></span>
            <button
              id="clearFilter"
              class="ml-2 text-red-600 hover:text-red-800 underline"
            >
              解除
            </button>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer"
                data-sort="material_spec"
              >
                <div class="flex items-center">
                  材質＆材料径
                  <svg
                    class="w-4 h-4 ml-1 opacity-50"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"
                    ></path>
                  </svg>
                </div>
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer"
                data-sort="machine_no"
              >
                <div class="flex items-center">
                  機番
                  <svg
                    class="w-4 h-4 ml-1 opacity-50"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"
                    ></path>
                  </svg>
                </div>
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer"
                data-sort="item_code"
              >
                <div class="flex items-center">
                  品番
                  <svg
                    class="w-4 h-4 ml-1 opacity-50"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"
                    ></path>
                  </svg>
                </div>
              </th>
              <th
                class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                使用本数
              </th>
              <th
                class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                累計本数
              </th>
              <th
                class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                数量合計
              </th>
              <th
                class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                詳細
              </th>
            </tr>
          </thead>
          <tbody id="materialTbody" class="bg-white divide-y divide-gray-100">
            <tr id="loadingRow">
              <td colspan="7" class="px-4 py-10 text-center">
                <div class="flex flex-col items-center space-y-2 text-gray-500">
                  <svg
                    class="animate-spin h-6 w-6 text-blue-600"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <circle
                      class="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      stroke-width="4"
                    ></circle>
                    <path
                      class="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
                    ></path>
                  </svg>
                  <span>集計データを読み込み中です...</span>
                </div>
              </td>
            </tr>
            <tr id="emptyRow" class="hidden">
              <td colspan="7" class="px-4 py-10 text-center text-gray-500">
                条件に一致するデータがありません。
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  class MaterialManagementPage {
    constructor() {
      this.data = [];
      this.filtered = [];
      this.tbody = document.getElementById("materialTbody");
      this.loadingRow = document.getElementById("loadingRow");
      this.emptyRow = document.getElementById("emptyRow");
      this.summaryCount = document.getElementById("summaryCount");
      this.totalBars = document.getElementById("totalBars");
      this.lastUpdated = document.getElementById("lastUpdated");
      this.futureOnly = document.getElementById("futureOnly");
      this.reloadBtn = document.getElementById("reloadBtn");
      this.currentSort = { field: "machine_no", direction: "asc" };
      this.activeFilter = null; // { material: "材質名", machineNos: ["機番1", "機番2"] }

      this.bindEvents();
      this.updateSortIndicators();
      this.load();
    }

    bindEvents() {
      this.futureOnly.addEventListener("change", () => this.applyFilter());
      this.reloadBtn.addEventListener("click", () => this.load());

      // ソートヘッダーのクリックイベント
      document.querySelectorAll("[data-sort]").forEach((header) => {
        header.addEventListener("click", () => {
          const field = header.dataset.sort;
          this.sortData(field);
        });
      });

      // 材料フィルターのクリックイベント
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("material-filter")) {
          const material = e.target.dataset.material;
          this.applyMaterialFilter(material);
        }
      });

      // フィルター解除ボタンのクリックイベント
      const clearFilterBtn = document.getElementById("clearFilter");
      if (clearFilterBtn) {
        clearFilterBtn.addEventListener("click", () => {
          this.clearMaterialFilter();
        });
      }
    }

    async load() {
      this.showLoading(true);
      this.emptyRow.classList.add("hidden");

      try {
        const response = await fetch("/api/material-management/usage");
        if (!response.ok) {
          throw new Error("材料使用量の取得に失敗しました");
        }
        this.data = await response.json();
        this.updateHeader();
        this.updateFilterDisplay();
        this.applyFilter();
        Utils.showToast("材料使用量を更新しました", "success");
      } catch (error) {
        console.error("load error:", error);
        this.data = [];
        this.renderRows();
        Utils.showToast(
          error.message || "材料使用量の取得に失敗しました",
          "error"
        );
      } finally {
        this.showLoading(false);
      }
    }

    updateHeader() {
      const now = new Date();
      const displayCount = this.activeFilter
        ? this.filtered.length
        : this.data.length;
      const totalBars = this.activeFilter
        ? this.filtered.reduce((acc, cur) => acc + (cur.total_bars || 0), 0)
        : this.data.reduce((acc, cur) => acc + (cur.total_bars || 0), 0);

      this.summaryCount.textContent = displayCount.toString();
      this.totalBars.textContent = new Intl.NumberFormat("ja-JP").format(
        totalBars
      );
      this.lastUpdated.textContent = `最終更新: ${now.toLocaleString()}`;
    }

    applyFilter() {
      if (!this.data.length) {
        this.filtered = [];
        this.renderRows();
        return;
      }

      const onlyFuture = this.futureOnly.checked;
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      this.filtered = this.data.filter((summary) => {
        if (!onlyFuture) {
          return true;
        }
        if (!summary.usage_date) {
          return false;
        }
        const usage = new Date(summary.usage_date);
        usage.setHours(0, 0, 0, 0);
        return usage >= today;
      });

      // 材料フィルターを適用
      if (this.activeFilter) {
        this.filtered = this.filtered.filter((summary) => {
          return summary.machines.some((machine) =>
            this.activeFilter.machineNos.includes(machine.machine_no)
          );
        });
      }

      this.sortFilteredData();
      this.renderRows();
    }

    applyMaterialFilter(material) {
      // 選択された材料を使用している機番を取得
      const machineNos = new Set();
      this.data.forEach((summary) => {
        if (summary.material_spec === material) {
          summary.machines.forEach((machine) => {
            if (machine.machine_no) {
              machineNos.add(machine.machine_no);
            }
          });
        }
      });

      this.activeFilter = {
        material: material,
        machineNos: Array.from(machineNos),
      };

      this.updateFilterDisplay();
      this.applyFilter();
      Utils.showToast(
        `「${material}」を使用している機番でフィルター中`,
        "info"
      );
    }

    clearMaterialFilter() {
      this.activeFilter = null;
      this.updateFilterDisplay();
      this.applyFilter();
      Utils.showToast("フィルターを解除しました", "info");
    }

    updateFilterDisplay() {
      const filterInfo = document.getElementById("filterInfo");
      const filterMaterial = document.getElementById("filterMaterial");

      if (this.activeFilter) {
        filterMaterial.textContent = this.activeFilter.material;
        filterInfo.classList.remove("hidden");
      } else {
        filterInfo.classList.add("hidden");
      }
    }

    sortFilteredData() {
      this.filtered.sort((a, b) => {
        let valueA, valueB;

        switch (this.currentSort.field) {
          case "material_spec":
            valueA = a.material_spec || "";
            valueB = b.material_spec || "";
            break;
          case "machine_no":
            // 最初の機械NOでソート
            const machineA =
              a.machines && a.machines.length > 0
                ? a.machines[0].machine_no || ""
                : "";
            const machineB =
              b.machines && b.machines.length > 0
                ? b.machines[0].machine_no || ""
                : "";
            valueA = machineA;
            valueB = machineB;
            break;
          case "item_code":
            // 最初の品番でソート
            const itemA =
              a.machines && a.machines.length > 0
                ? a.machines[0].item_code || ""
                : "";
            const itemB =
              b.machines && b.machines.length > 0
                ? b.machines[0].item_code || ""
                : "";
            valueA = itemA;
            valueB = itemB;
            break;
          default:
            return 0;
        }

        if (valueA < valueB) {
          return this.currentSort.direction === "asc" ? -1 : 1;
        }
        if (valueA > valueB) {
          return this.currentSort.direction === "asc" ? 1 : -1;
        }
        return 0;
      });
    }

    sortData(field) {
      if (this.currentSort.field === field) {
        this.currentSort.direction =
          this.currentSort.direction === "asc" ? "desc" : "asc";
      } else {
        this.currentSort.field = field;
        this.currentSort.direction = "asc";
      }

      this.updateSortIndicators();
      this.sortFilteredData();
      this.renderRows();
    }

    updateSortIndicators() {
      document.querySelectorAll("[data-sort]").forEach((header) => {
        const field = header.dataset.sort;
        const indicator = header.querySelector("svg");

        if (field === this.currentSort.field) {
          indicator.classList.remove("opacity-50");
          indicator.classList.toggle(
            "rotate-180",
            this.currentSort.direction === "desc"
          );
        } else {
          indicator.classList.add("opacity-50");
          indicator.classList.remove("rotate-180");
        }
      });
    }

    renderRows() {
      this.tbody
        .querySelectorAll("tr.data-row, tr.detail-row")
        .forEach((row) => row.remove());

      if (!this.filtered.length) {
        this.emptyRow.classList.remove("hidden");
        // フィルター中は空のメッセージを変更
        const emptyMessage = this.activeFilter
          ? "選択された材料を使用している機番のデータがありません。"
          : "条件に一致するデータがありません。";
        this.emptyRow.querySelector("td").textContent = emptyMessage;
        return;
      }

      this.emptyRow.classList.add("hidden");
      const fragment = document.createDocumentFragment();

      this.filtered.forEach((summary) => {
        const summaryRow = document.createElement("tr");
        summaryRow.className = "data-row hover:bg-gray-50 cursor-pointer";
        summaryRow.innerHTML = this.buildSummaryHtml(summary);

        const detailRow = document.createElement("tr");
        detailRow.className = "detail-row hidden bg-gray-50";
        detailRow.innerHTML = `
          <td colspan="7" class="px-6 py-4">
            ${this.renderDetails(summary)}
          </td>
        `;

        summaryRow.addEventListener("click", () => {
          detailRow.classList.toggle("hidden");
        });

        fragment.appendChild(summaryRow);
        fragment.appendChild(detailRow);
      });

      this.tbody.insertBefore(fragment, this.loadingRow);
    }

    buildSummaryHtml(summary) {
      // 機番と品番の表示（複数の場合は最初のものを代表表示）
      const firstMachine =
        summary.machines && summary.machines.length > 0
          ? summary.machines[0]
          : null;
      const machineNos = summary.machines
        ? summary.machines.map((m) => m.machine_no).filter((m) => m)
        : [];
      const itemCodes = summary.machines
        ? summary.machines.map((m) => m.item_code).filter((m) => m)
        : [];

      const displayMachineNo = machineNos.length > 0 ? machineNos[0] : "―";
      const displayItemCode = itemCodes.length > 0 ? itemCodes[0] : "―";

      return `
        <td class="px-4 py-3 text-sm text-gray-900">
          <div class="font-medium cursor-pointer hover:text-blue-600 transition-colors material-filter"
               data-material="${this.escape(summary.material_spec || "")}"
               title="この材料を使用している機番のみを表示">
            ${summary.material_spec ? this.escape(summary.material_spec) : "―"}
          </div>
        </td>
        <td class="px-4 py-3 text-sm text-gray-700">${this.escape(
          displayMachineNo
        )}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${this.escape(
          displayItemCode
        )}</td>
        <td class="px-4 py-3 text-right text-sm text-gray-900 font-semibold">${this.formatNumber(
          summary.total_bars
        )}</td>
        <td class="px-4 py-3 text-right text-sm text-gray-700">${this.formatNumber(
          summary.cumulative_bars
        )}</td>
        <td class="px-4 py-3 text-right text-sm text-gray-700">${this.formatNumber(
          summary.total_quantity,
          1
        )}</td>
        <td class="px-4 py-3 text-sm text-blue-600">詳細表示</td>
      `;
    }

    renderDetails(summary) {
      if (!summary.machines || !summary.machines.length) {
        return '<div class="text-sm text-gray-500">詳細データがありません。</div>';
      }

      const rows = summary.machines
        .map(
          (machine) => `
        <tr>
          <td class="px-4 py-2 text-sm text-gray-700">${
            this.escape(machine.machine_no) || "―"
          }</td>
          <td class="px-4 py-2 text-sm text-gray-700">${
            this.escape(machine.item_code) || "―"
          }</td>
          <td class="px-4 py-2 text-sm text-gray-700">${
            machine.product_name ? this.escape(machine.product_name) : "―"
          }</td>
          <td class="px-4 py-2 text-sm text-gray-700 text-right">${this.formatNumber(
            machine.quantity
          )}</td>
          <td class="px-4 py-2 text-sm text-gray-700 text-right">${this.formatNumber(
            machine.take_count,
            2
          )}</td>
          <td class="px-4 py-2 text-sm text-gray-900 text-right font-semibold">${this.formatNumber(
            machine.bars_needed
          )}</td>
        </tr>
      `
        )
        .join("");

      return `
        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold text-gray-700">詳細内訳（機械NO昇順）</div>
            <div class="text-xs text-gray-500">取り数(W列)をもとに一日の使用本数を算出</div>
          </div>
          <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">機械NO</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">品番</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">製品名</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">数量</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">取り数</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">使用本数</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                ${rows}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    showLoading(isLoading) {
      this.loadingRow.classList.toggle("hidden", !isLoading);
    }

    formatNumber(value, digits = 0) {
      const num = Number(value);
      if (Number.isNaN(num)) {
        return "0";
      }
      return new Intl.NumberFormat("ja-JP", {
        minimumFractionDigits: digits,
        maximumFractionDigits: digits,
      }).format(num);
    }

    escape(value) {
      if (value === null || value === undefined) {
        return null;
      }
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    new MaterialManagementPage();
  });
</script>
{% endblock %}
