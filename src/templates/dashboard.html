{% extends "base.html" %}

{% block title %}ダッシュボード - 材料管理システム{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- ページヘッダー -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        ダッシュボード
                    </h1>
                    <p class="mt-2 text-gray-600">在庫状況と最新の活動を確認</p>
                </div>
                <div class="hidden md:flex items-center space-x-3">
                    <div class="flex items-center px-3 py-2 bg-white rounded-lg border border-gray-200 shadow-sm">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-sm text-gray-700">更新済み</span>
                    </div>
                    <button class="p-2 bg-white rounded-lg border border-gray-200 shadow-sm hover:bg-gray-50 transition-colors duration-200">
                        <i class="fas fa-sync-alt text-gray-600"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 統計カード -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
            <!-- 総在庫数 -->
            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-2 bg-blue-50 rounded-lg">
                        <i class="fas fa-boxes text-xl text-blue-600"></i>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">総在庫数</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="total-inventory">0</div>
                        <div class="text-sm text-gray-500">本</div>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-700">
                        前月比 +12%
                    </span>
                </div>
            </div>

            <!-- 材料種類数 -->
            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-2 bg-green-50 rounded-lg">
                        <i class="fas fa-cogs text-xl text-green-600"></i>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">材料種類数</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="material-types">0</div>
                        <div class="text-sm text-gray-500">種類</div>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-700">
                        管理中
                    </span>
                </div>
            </div>

            <!-- 今日の入庫 -->
            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-2 bg-yellow-50 rounded-lg">
                        <i class="fas fa-arrow-down text-xl text-yellow-600"></i>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">今日の入庫</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="today-in">0</div>
                        <div class="text-sm text-gray-500">本</div>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-700">
                        入庫済み
                    </span>
                </div>
            </div>

            <!-- 今日の出庫 -->
            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-2 bg-red-50 rounded-lg">
                        <i class="fas fa-arrow-up text-xl text-red-600"></i>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">今日の出庫</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="today-out">0</div>
                        <div class="text-sm text-gray-500">本</div>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-700">
                        出庫完了
                    </span>
                </div>
            </div>
        </div>

        <!-- メインアクション -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
            <!-- クイックアクション -->
            <div class="xl:col-span-2">
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <div class="flex items-center mb-6">
                        <div class="p-2 bg-blue-50 rounded-lg mr-3">
                            <i class="fas fa-bolt text-lg text-blue-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">クイックアクション</h3>
                    </div>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- QRスキャン -->
                        <a href="/scan" class="flex flex-col items-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors duration-200 text-center border border-blue-200">
                            <i class="fas fa-qrcode text-2xl text-blue-600 mb-2"></i>
                            <div class="text-sm font-medium text-blue-800">QRスキャン</div>
                        </a>

                        <!-- 新規入庫 -->
                        <a href="/movements" class="flex flex-col items-center p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors duration-200 text-center border border-green-200">
                            <i class="fas fa-plus text-2xl text-green-600 mb-2"></i>
                            <div class="text-sm font-medium text-green-800">新規入庫</div>
                        </a>

                        <!-- 在庫検索 -->
                        <a href="/inventory" class="flex flex-col items-center p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors duration-200 text-center border border-yellow-200">
                            <i class="fas fa-search text-2xl text-yellow-600 mb-2"></i>
                            <div class="text-sm font-medium text-yellow-800">在庫検索</div>
                        </a>

                        <!-- 材料登録 -->
                        <a href="/materials" class="flex flex-col items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors duration-200 text-center border border-gray-200">
                            <i class="fas fa-cog text-2xl text-gray-600 mb-2"></i>
                            <div class="text-sm font-medium text-gray-800">材料登録</div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- 在庫アラート -->
            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <div class="flex items-center mb-6">
                    <div class="p-2 bg-yellow-50 rounded-lg mr-3">
                        <i class="fas fa-exclamation-triangle text-lg text-yellow-600"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">在庫アラート</h3>
                </div>

                <div id="stock-alerts" class="space-y-3">
                    <div class="text-center py-8">
                        <div class="inline-flex items-center justify-center w-12 h-12 bg-green-50 rounded-full mb-4">
                            <i class="fas fa-check-circle text-2xl text-green-600"></i>
                        </div>
                        <p class="text-gray-700 font-medium">すべて正常です</p>
                        <p class="text-sm text-gray-500 mt-1">アラートはありません</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 最近の活動とチャート -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- 最近の活動 -->
            <div class="xl:col-span-2">
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-50 rounded-lg mr-3">
                                <i class="fas fa-history text-lg text-blue-600"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900">最近の活動</h3>
                        </div>
                        <button class="text-sm text-blue-600 hover:text-blue-700 font-medium">すべて表示</button>
                    </div>

                    <div id="recent-activities" class="space-y-4">
                        <div class="text-center py-12">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-50 rounded-full mb-4">
                                <i class="fas fa-clock text-2xl text-gray-400"></i>
                            </div>
                            <p class="text-gray-600 font-medium">活動履歴を取得中...</p>
                            <p class="text-sm text-gray-500 mt-1">データが読み込まれるまでお待ちください</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- サマリーチャート -->
            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <div class="flex items-center mb-6">
                    <div class="p-2 bg-purple-50 rounded-lg mr-3">
                        <i class="fas fa-chart-pie text-lg text-purple-600"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">在庫分析</h3>
                </div>

                <div class="space-y-4">
                    <!-- 材質別分布 -->
                    <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-blue-800">SS400</span>
                            <span class="text-sm font-bold text-blue-900">45%</span>
                        </div>
                        <div class="w-full bg-blue-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: 45%"></div>
                        </div>
                    </div>

                    <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-green-800">S45C</span>
                            <span class="text-sm font-bold text-green-900">30%</span>
                        </div>
                        <div class="w-full bg-green-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: 30%"></div>
                        </div>
                    </div>

                    <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-yellow-800">SUS304</span>
                            <span class="text-sm font-bold text-yellow-900">25%</span>
                        </div>
                        <div class="w-full bg-yellow-200 rounded-full h-2">
                            <div class="bg-yellow-500 h-2 rounded-full" style="width: 25%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // アニメーション用の値を管理
    let animationValues = {
        totalInventory: { current: 0, target: 250 },
        materialTypes: { current: 0, target: 12 },
        todayIn: { current: 0, target: 18 },
        todayOut: { current: 0, target: 15 }
    };

    // ダッシュボードデータの読み込み
    async function loadDashboardData() {
        try {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            // TODO: APIからダッシュボードデータを取得
            // 現在はデモデータを表示してアニメーション効果を確認
            animateStats();

            // デモデータで最近の活動を表示
            updateRecentActivities([
                {
                    icon: 'fa-arrow-down',
                    color: 'emerald',
                    title: 'SS400 Φ20×3000 新規入庫',
                    description: 'ロットID: LOT-2024-0001 (50本)',
                    time: '10分前'
                },
                {
                    icon: 'fa-arrow-up',
                    color: 'rose',
                    title: 'S45C Φ15×2500 出庫',
                    description: '指示書: IS-2024-0123 (10本)',
                    time: '25分前'
                },
                {
                    icon: 'fa-qrcode',
                    color: 'blue',
                    title: 'QRスキャン実行',
                    description: 'アイテムID: ITM-2024-0456',
                    time: '1時間前'
                }
            ]);

            updateStockAlerts([]);

        } catch (error) {
            console.error('ダッシュボードデータの読み込みエラー:', error);
            showToast('データの読み込みに失敗しました', 'error');
        }
    }

    // 統計値のアニメーション
    function animateStats() {
        const duration = 2000; // 2秒
        const startTime = Date.now();

        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // イージング関数（ease-out）
            const easeOut = 1 - Math.pow(1 - progress, 3);

            for (const [key, value] of Object.entries(animationValues)) {
                const current = Math.floor(value.target * easeOut);
                animationValues[key].current = current;

                const element = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                if (element) {
                    element.textContent = current;
                }
            }

            if (progress < 1) {
                requestAnimationFrame(animate);
            }
        }

        animate();
    }

    // 統計データの更新（レガシー関数、新しいアニメーションで置き換え）
    function updateStats(stats) {
        // この関数は後方互換性のために残す
        animationValues.totalInventory.target = stats.totalInventory || 0;
        animationValues.materialTypes.target = stats.materialTypes || 0;
        animationValues.todayIn.target = stats.todayIn || 0;
        animationValues.todayOut.target = stats.todayOut || 0;
        animateStats();
    }

    // 最近の活動の更新（改良版）
    function updateRecentActivities(activities) {
        const container = document.getElementById('recent-activities');

        if (activities.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-slate-100 to-slate-200 rounded-full mb-4">
                        <i class="fas fa-clock text-3xl text-slate-400"></i>
                    </div>
                    <p class="text-slate-600 font-medium">活動履歴を取得中...</p>
                    <p class="text-sm text-slate-500 mt-1">データが読み込まれるまでお待ちください</p>
                </div>
            `;
            return;
        }

        container.innerHTML = activities.map(activity => `
            <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                <div class="flex-shrink-0">
                    <div class="p-2 bg-${activity.color}-50 rounded-lg">
                        <i class="fas ${activity.icon} text-${activity.color}-600"></i>
                    </div>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-sm font-medium text-gray-900">${activity.title}</p>
                    <p class="text-sm text-gray-500">${activity.description}</p>
                </div>
                <div class="text-xs text-gray-400">
                    ${activity.time}
                </div>
            </div>
        `).join('');
    }

    // 在庫アラートの更新（改良版）
    function updateStockAlerts(alerts) {
        const container = document.getElementById('stock-alerts');

        if (alerts.length === 0) {
            // 既存の「すべて正常」表示をそのまま使用
            return;
        }

        container.innerHTML = alerts.map((alert, index) => `
            <div class="p-4 border border-${alert.color}-200 bg-gradient-to-r from-${alert.color}-50 to-white rounded-xl shadow-sm" style="animation: slideInRight 0.5s ease-out ${index * 0.1}s both;">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="p-2 bg-${alert.color}-100 rounded-lg">
                            <i class="fas ${alert.icon} text-${alert.color}-600"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-semibold text-${alert.color}-900">${alert.title}</p>
                        <p class="text-sm text-${alert.color}-700 mt-1">${alert.description}</p>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // カードのスタガードアニメーション
    function initializeCardAnimations() {
        const cards = document.querySelectorAll('.group');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            card.classList.add('animate-fade-in-up');
        });
    }

    // ページ読み込み時の処理
    document.addEventListener('DOMContentLoaded', function() {
        // カードアニメーションを初期化
        initializeCardAnimations();

        // データ読み込み（少し遅延を入れてアニメーション効果を確認）
        setTimeout(() => {
            loadDashboardData();
        }, 500);

        // 定期的にデータを更新（5分間隔）
        setInterval(loadDashboardData, 5 * 60 * 1000);

        // リフレッシュボタンのクリックイベント
        const refreshButton = document.querySelector('button[title="更新"]');
        if (refreshButton) {
            refreshButton.addEventListener('click', () => {
                loadDashboardData();
                showToast('データを更新しました', 'success');
            });
        }
    });
</script>

<style>
    /* カスタムアニメーション */
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.6s ease-out both;
    }

    /* スクロールバーのカスタマイズ */
    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, #64748b, #475569);
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(to bottom, #475569, #334155);
    }

    /* ローディング状態のパルス効果 */
    .pulse-loading {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: .5;
        }
    }
</style>
{% endblock %}