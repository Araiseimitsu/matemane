{% extends "base.html" %}

{% block title %}集計・分析 - 材料管理システム{% endblock %}

{% block extra_head %}
<!-- Chart.js v4 CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- ヘッダー -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">
      <i class="fas fa-chart-line mr-3 text-blue-600"></i>集計・分析
    </h1>
    <p class="mt-2 text-gray-600">入出庫履歴、在庫、金額を多角的に分析します</p>
  </div>

  <!-- 検索フォーム -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-bold text-gray-900 mb-4">
      <i class="fas fa-filter mr-2"></i>検索条件
    </h2>
    <form id="search-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- 開始日 -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">開始日</label>
        <input type="date" id="start-date" name="start_date"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
      </div>

      <!-- 終了日 -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">終了日</label>
        <input type="date" id="end-date" name="end_date"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
      </div>

      <!-- 材料名 -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">材料名</label>
        <input type="text" id="material-name" name="material_name" placeholder="部分一致"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
      </div>

      <!-- 購入月 -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">購入月（YYMM）</label>
        <input type="text" id="purchase-month" name="purchase_month" placeholder="例: 2501"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          maxlength="4" />
      </div>

      <!-- 仕入先 -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">仕入先</label>
        <input type="text" id="supplier" name="supplier" placeholder="部分一致"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
      </div>

      <!-- 入出庫種別 -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">入出庫種別</label>
        <select id="movement-type" name="movement_type"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
          <option value="">全て</option>
          <option value="in">入庫のみ</option>
          <option value="out">出庫のみ</option>
        </select>
      </div>

      <!-- ボタン -->
      <div class="md:col-span-2 lg:col-span-3 flex gap-3">
        <button type="button" id="search-btn"
          class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-search mr-2"></i>検索
        </button>
        <button type="button" id="reset-btn"
          class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:ring-2 focus:ring-gray-400">
          <i class="fas fa-redo mr-2"></i>リセット
        </button>
        <button type="button" id="export-csv-btn"
          class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:ring-2 focus:ring-green-500">
          <i class="fas fa-file-csv mr-2"></i>CSV出力
        </button>
        <button type="button" id="export-excel-btn"
          class="px-6 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 focus:ring-2 focus:ring-emerald-500">
          <i class="fas fa-file-excel mr-2"></i>Excel出力
        </button>
      </div>
    </form>
  </div>

  <!-- 集計サマリー -->
  <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 hidden">
    <!-- 現在在庫 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">現在在庫</p>
          <p class="text-2xl font-bold text-gray-900" id="total-stock-qty">0</p>
          <p class="text-xs text-gray-500" id="total-stock-weight">0.000 kg</p>
        </div>
        <div class="p-3 bg-blue-100 rounded-full">
          <i class="fas fa-boxes text-blue-600 text-xl"></i>
        </div>
      </div>
    </div>

    <!-- 入庫数 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">入庫数</p>
          <p class="text-2xl font-bold text-green-600" id="total-in-qty">0</p>
          <p class="text-xs text-gray-500" id="total-in-weight">0.000 kg</p>
        </div>
        <div class="p-3 bg-green-100 rounded-full">
          <i class="fas fa-arrow-down text-green-600 text-xl"></i>
        </div>
      </div>
    </div>

    <!-- 出庫数 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">出庫数</p>
          <p class="text-2xl font-bold text-red-600" id="total-out-qty">0</p>
          <p class="text-xs text-gray-500" id="total-out-weight">0.000 kg</p>
        </div>
        <div class="p-3 bg-red-100 rounded-full">
          <i class="fas fa-arrow-up text-red-600 text-xl"></i>
        </div>
      </div>
    </div>

    <!-- 合計金額 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">合計金額</p>
          <p class="text-2xl font-bold text-gray-900" id="total-amount">¥0</p>
          <p class="text-xs text-gray-500">入庫時金額</p>
        </div>
        <div class="p-3 bg-yellow-100 rounded-full">
          <i class="fas fa-yen-sign text-yellow-600 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- グラフエリア -->
  <div id="graph-area" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 hidden">
    <!-- 時系列推移 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="text-lg font-bold text-gray-900 mb-4">
        <i class="fas fa-chart-area mr-2"></i>入出庫推移
      </h3>
      <canvas id="timeline-chart"></canvas>
    </div>

    <!-- 材料別構成比 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="text-lg font-bold text-gray-900 mb-4">
        <i class="fas fa-chart-pie mr-2"></i>材料別在庫構成
      </h3>
      <canvas id="composition-chart"></canvas>
    </div>

    <!-- 仕入先別金額 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 lg:col-span-2">
      <h3 class="text-lg font-bold text-gray-900 mb-4">
        <i class="fas fa-chart-bar mr-2"></i>仕入先別金額
      </h3>
      <canvas id="supplier-chart"></canvas>
    </div>
  </div>

  <!-- 集計結果テーブル -->
  <div id="result-table-container" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hidden">
    <h2 class="text-lg font-bold text-gray-900 mb-4">
      <i class="fas fa-table mr-2"></i>材料別集計結果
    </h2>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">材料名</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">在庫本数</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">在庫重量(kg)</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">入庫本数</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">入庫重量(kg)</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">出庫本数</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">出庫重量(kg)</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">金額（円）</th>
          </tr>
        </thead>
        <tbody id="result-tbody" class="bg-white divide-y divide-gray-200">
          <!-- JavaScriptで動的生成 -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // グラフインスタンス
  let timelineChart = null;
  let compositionChart = null;
  let supplierChart = null;

  // 検索実行
  async function performSearch() {
    const formData = new FormData(document.getElementById('search-form'));
    const params = new URLSearchParams();

    for (const [key, value] of formData.entries()) {
      if (value) params.append(key, value);
    }

    try {
      // サマリーデータ取得
      const summaryRes = await fetch(`/api/analytics/summary/?${params.toString()}`);
      if (!summaryRes.ok) throw new Error('集計データの取得に失敗しました');
      const summary = await summaryRes.json();

      // サマリーカード表示
      document.getElementById('summary-cards').classList.remove('hidden');
      document.getElementById('total-stock-qty').textContent = summary.total_stock_quantity.toLocaleString();
      document.getElementById('total-stock-weight').textContent = `${summary.total_stock_weight_kg.toFixed(3)} kg`;
      document.getElementById('total-in-qty').textContent = summary.total_in_quantity.toLocaleString();
      document.getElementById('total-in-weight').textContent = `${summary.total_in_weight_kg.toFixed(3)} kg`;
      document.getElementById('total-out-qty').textContent = summary.total_out_quantity.toLocaleString();
      document.getElementById('total-out-weight').textContent = `${summary.total_out_weight_kg.toFixed(3)} kg`;
      document.getElementById('total-amount').textContent = `¥${summary.total_amount.toLocaleString()}`;

      // テーブル表示
      const tbody = document.getElementById('result-tbody');
      tbody.innerHTML = '';
      summary.materials.forEach(m => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td class="px-4 py-3 text-sm text-gray-900">${m.material_name}</td>
          <td class="px-4 py-3 text-sm text-gray-900 text-right">${m.current_stock_quantity.toLocaleString()}</td>
          <td class="px-4 py-3 text-sm text-gray-900 text-right">${m.current_stock_weight_kg.toFixed(3)}</td>
          <td class="px-4 py-3 text-sm text-green-600 text-right">${m.total_in_quantity.toLocaleString()}</td>
          <td class="px-4 py-3 text-sm text-green-600 text-right">${m.total_in_weight_kg.toFixed(3)}</td>
          <td class="px-4 py-3 text-sm text-red-600 text-right">${m.total_out_quantity.toLocaleString()}</td>
          <td class="px-4 py-3 text-sm text-red-600 text-right">${m.total_out_weight_kg.toFixed(3)}</td>
          <td class="px-4 py-3 text-sm text-gray-900 text-right">¥${m.total_amount.toLocaleString()}</td>
        `;
      });
      document.getElementById('result-table-container').classList.remove('hidden');

      // グラフデータ取得
      await loadGraphs(params);

      showToast('集計が完了しました', 'success');
    } catch (error) {
      console.error('検索エラー:', error);
      showToast('集計処理中にエラーが発生しました', 'error');
    }
  }

  // グラフ読み込み
  async function loadGraphs(params) {
    document.getElementById('graph-area').classList.remove('hidden');

    // 時系列推移
    try {
      const timelineRes = await fetch(`/api/analytics/graph/timeline/?${params.toString()}`);
      const timelineData = await timelineRes.json();

      if (timelineChart) timelineChart.destroy();
      const ctx1 = document.getElementById('timeline-chart').getContext('2d');
      timelineChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: timelineData.labels,
          datasets: timelineData.datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' }
          }
        }
      });
    } catch (error) {
      console.error('時系列グラフエラー:', error);
    }

    // 材料別構成比
    try {
      const compositionRes = await fetch('/api/analytics/graph/material-composition/');
      const compositionData = await compositionRes.json();

      if (compositionChart) compositionChart.destroy();
      const ctx2 = document.getElementById('composition-chart').getContext('2d');
      compositionChart = new Chart(ctx2, {
        type: 'pie',
        data: {
          labels: compositionData.labels,
          datasets: compositionData.datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right' }
          }
        }
      });
    } catch (error) {
      console.error('構成比グラフエラー:', error);
    }

    // 仕入先別金額
    try {
      const supplierRes = await fetch(`/api/analytics/graph/supplier-amount/?${params.toString()}`);
      const supplierData = await supplierRes.json();

      if (supplierChart) supplierChart.destroy();
      const ctx3 = document.getElementById('supplier-chart').getContext('2d');
      supplierChart = new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: supplierData.labels,
          datasets: supplierData.datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          }
        }
      });
    } catch (error) {
      console.error('仕入先グラフエラー:', error);
    }
  }

  // リセット
  function resetForm() {
    document.getElementById('search-form').reset();
    document.getElementById('summary-cards').classList.add('hidden');
    document.getElementById('graph-area').classList.add('hidden');
    document.getElementById('result-table-container').classList.add('hidden');
  }

  // CSV出力
  async function exportCSV() {
    const formData = new FormData(document.getElementById('search-form'));
    const params = new URLSearchParams();
    for (const [key, value] of formData.entries()) {
      if (value) params.append(key, value);
    }

    window.location.href = `/api/analytics/export/csv/?${params.toString()}`;
  }

  // Excel出力
  async function exportExcel() {
    const formData = new FormData(document.getElementById('search-form'));
    const params = new URLSearchParams();
    for (const [key, value] of formData.entries()) {
      if (value) params.append(key, value);
    }

    window.location.href = `/api/analytics/export/excel/?${params.toString()}`;
  }

  // イベントリスナー
  document.getElementById('search-btn').addEventListener('click', performSearch);
  document.getElementById('reset-btn').addEventListener('click', resetForm);
  document.getElementById('export-csv-btn').addEventListener('click', exportCSV);
  document.getElementById('export-excel-btn').addEventListener('click', exportExcel);

  // Enterキーで検索
  document.getElementById('search-form').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      performSearch();
    }
  });

  // 初期表示（全データ）
  document.addEventListener('DOMContentLoaded', () => {
    performSearch();
  });
</script>
{% endblock %}
