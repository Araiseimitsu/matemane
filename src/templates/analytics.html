{% extends "base.html" %} {% block title %}集計・分析 - 材料管理システム{%
endblock %} {% block extra_head %}
<!-- Chart.js v4 CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root {
    --primary-navy: #1e3a5f;
    --primary-blue: #2563eb;
    --accent-blue: #3b82f6;
    --success-green: #10b981;
    --warning-amber: #f59e0b;
    --danger-red: #ef4444;
    --neutral-50: #f8fafc;
    --neutral-100: #f1f5f9;
    --neutral-200: #e2e8f0;
    --neutral-700: #334155;
    --neutral-800: #1e293b;
  }

  /* チャートコンテナ */
  .chart-container {
    position: relative;
    height: 300px;
  }
</style>
{% endblock %} {% block content %}
<div class="min-h-screen bg-neutral-50">
  <div class="max-w-[1600px] mx-auto py-4 px-4 sm:px-6 lg:px-8">
    <!-- ヘッダー -->
    <div class="mb-4">
      <div class="flex items-center justify-between">
        <div class="space-y-2">
          <h1 class="text-2xl font-bold text-neutral-800">
            集計・分析
          </h1>
          <p class="text-sm text-neutral-600">
            入出庫履歴、在庫、金額を多角的に分析
          </p>
        </div>
        <div class="hidden md:flex items-center space-x-4">
          <button
            id="quick-search-today"
            class="bg-white border border-neutral-200 px-4 py-2 rounded-lg font-semibold hover:bg-neutral-50 transition-all duration-200"
            title="今日のデータを表示"
          >
            <i class="fas fa-calendar-day mr-2 text-primary-blue"></i>
            <span class="text-sm">今日</span>
          </button>
          <button
            id="quick-search-week"
            class="bg-white border border-neutral-200 px-4 py-2 rounded-lg font-semibold hover:bg-neutral-50 transition-all duration-200"
            title="今週のデータを表示"
          >
            <i class="fas fa-calendar-week mr-2 text-success-green"></i>
            <span class="text-sm">今週</span>
          </button>
          <button
            id="quick-search-month"
            class="bg-white border border-neutral-200 px-4 py-2 rounded-lg font-semibold hover:bg-neutral-50 transition-all duration-200"
            title="今月のデータを表示"
          >
            <i class="fas fa-calendar-alt mr-2 text-warning-amber"></i>
            <span class="text-sm">今月</span>
          </button>
        </div>
      </div>
    </div>

    <!-- 検索フォーム -->
    <div class="bg-white rounded-lg p-4 border border-neutral-200 shadow-sm mb-4">
      <div class="flex items-center mb-4">
        <div class="p-3 bg-primary-blue bg-opacity-10 rounded-lg mr-4">
          <i class="fas fa-filter text-primary-blue text-xl"></i>
        </div>
        <h2 class="text-xl font-bold text-neutral-800">検索条件</h2>
      </div>
      <form
        id="search-form"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
      >
        <!-- 開始日 -->
        <div>
          <label class="block text-sm font-semibold text-neutral-700 mb-2">
            <i class="fas fa-calendar-alt mr-1 text-primary-blue"></i>開始日
          </label>
          <input
            type="date"
            id="start-date"
            name="start_date"
            class="w-full px-3 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 focus:border-primary-blue"
          />
        </div>

        <!-- 終了日 -->
        <div>
          <label class="block text-sm font-semibold text-neutral-700 mb-2">
            <i class="fas fa-calendar-check mr-1 text-primary-blue"></i>終了日
          </label>
          <input
            type="date"
            id="end-date"
            name="end_date"
            class="w-full px-3 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 focus:border-primary-blue"
          />
        </div>

        <!-- 材料名 -->
        <div>
          <label class="block text-sm font-semibold text-neutral-700 mb-2">
            <i class="fas fa-cubes mr-1 text-success-green"></i>材料名
          </label>
          <input
            type="text"
            id="material-name"
            name="material_name"
            placeholder="部分一致で検索"
            class="w-full px-3 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 focus:border-primary-blue"
          />
        </div>

        <!-- 購入月 -->
        <div>
          <label class="block text-sm font-semibold text-neutral-700 mb-2">
            <i class="fas fa-calendar mr-1 text-warning-amber"></i>購入月（YYMM）
          </label>
          <input
            type="text"
            id="purchase-month"
            name="purchase_month"
            placeholder="例: 2501"
            class="w-full px-3 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 focus:border-primary-blue"
            maxlength="4"
          />
        </div>

        <!-- 購入月（開始/終了） -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-neutral-700 mb-2">
              <i class="fas fa-calendar-alt mr-1 text-warning-amber"></i>購入月開始（YYMM）
            </label>
            <input
              type="text"
              id="purchase-month-start"
              name="purchase_month_start"
              placeholder="例: 2501"
              class="w-full px-3 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 focus:border-primary-blue"
              maxlength="4"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-neutral-700 mb-2">
              <i class="fas fa-calendar-check mr-1 text-warning-amber"></i>購入月終了（YYMM）
            </label>
            <input
              type="text"
              id="purchase-month-end"
              name="purchase_month_end"
              placeholder="例: 2512"
              class="w-full px-3 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 focus:border-primary-blue"
              maxlength="4"
            />
          </div>
        </div>

        <!-- 仕入先 -->
        <div>
          <label class="block text-sm font-semibold text-neutral-700 mb-2">
            <i class="fas fa-truck mr-1 text-warning-amber"></i>仕入先
          </label>
          <input
            type="text"
            id="supplier"
            name="supplier"
            placeholder="部分一致で検索"
            class="w-full px-3 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 focus:border-primary-blue"
          />
        </div>

        <!-- 入出庫種別 -->
        <div>
          <label class="block text-sm font-semibold text-neutral-700 mb-2">
            <i class="fas fa-exchange-alt mr-1 text-danger-red"></i>入出庫種別
          </label>
          <select
            id="movement-type"
            name="movement_type"
            class="w-full px-3 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary-blue focus:ring-opacity-20 focus:border-primary-blue"
          >
            <option value="">全て</option>
            <option value="in">入庫のみ</option>
            <option value="out">出庫のみ</option>
          </select>
        </div>

        <!-- ボタン -->
        <div class="md:col-span-2 lg:col-span-3 flex flex-wrap gap-3 pt-4">
          <button
            type="button"
            id="search-btn"
            class="bg-primary-blue text-white px-6 py-2 rounded-lg font-semibold hover:bg-opacity-90 transition-all duration-200"
          >
            <i class="fas fa-search mr-2"></i>検索
          </button>
          <button
            type="button"
            id="reset-btn"
            class="bg-white border border-neutral-200 px-6 py-2 rounded-lg font-semibold hover:bg-neutral-50 transition-all duration-200"
          >
            <i class="fas fa-redo mr-2"></i>リセット
          </button>
          <button
            type="button"
            id="export-csv-btn"
            class="bg-success-green text-white px-6 py-2 rounded-lg font-semibold hover:bg-opacity-90 transition-all duration-200"
          >
            <i class="fas fa-file-csv mr-2"></i>CSV出力
          </button>
          <button
            type="button"
            id="export-excel-btn"
            class="bg-success-green text-white px-6 py-2 rounded-lg font-semibold hover:bg-opacity-90 transition-all duration-200"
          >
            <i class="fas fa-file-excel mr-2"></i>Excel出力
          </button>
        </div>
      </form>
    </div>

    <!-- 集計サマリー -->
    <div
      id="summary-cards"
      class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-8 mb-10 hidden"
    >
      <!-- 現在在庫 -->
      <div
        class="glass-card rounded-3xl p-8 shadow-xl transition-all duration-300 hover:scale-105 hover:shadow-2xl"
      >
        <div class="flex items-start justify-between mb-6">
          <div
            class="p-4 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg"
          >
            <i class="fas fa-boxes text-3xl text-white"></i>
          </div>
          <div class="text-right flex-1 ml-4">
            <div
              class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
            >
              現在在庫
            </div>
            <div
              class="text-4xl font-black bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent mb-1"
              id="total-stock-qty"
            >
              0
            </div>
            <div class="text-sm font-semibold text-blue-600">本</div>
          </div>
        </div>
        <div
          class="h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full mb-4"
        ></div>
        <div class="text-sm font-bold text-gray-600" id="total-stock-weight">
          0.000 kg
        </div>
      </div>

      <!-- 入庫数 -->
      <div
        class="glass-card rounded-3xl p-8 shadow-xl transition-all duration-300 hover:scale-105 hover:shadow-2xl"
      >
        <div class="flex items-start justify-between mb-6">
          <div
            class="p-4 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-lg"
          >
            <i class="fas fa-arrow-down text-3xl text-white"></i>
          </div>
          <div class="text-right flex-1 ml-4">
            <div
              class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
            >
              入庫数
            </div>
            <div
              class="text-4xl font-black bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent mb-1"
              id="total-in-qty"
            >
              0
            </div>
            <div class="text-sm font-semibold text-green-600">本</div>
          </div>
        </div>
        <div
          class="h-1 bg-gradient-to-r from-green-400 to-emerald-600 rounded-full mb-4"
        ></div>
        <div class="text-sm font-bold text-gray-600" id="total-in-weight">
          0.000 kg
        </div>
      </div>

      <!-- 出庫数 -->
      <div
        class="glass-card rounded-3xl p-8 shadow-xl transition-all duration-300 hover:scale-105 hover:shadow-2xl"
      >
        <div class="flex items-start justify-between mb-6">
          <div
            class="p-4 bg-gradient-to-br from-red-500 to-rose-600 rounded-2xl shadow-lg"
          >
            <i class="fas fa-arrow-up text-3xl text-white"></i>
          </div>
          <div class="text-right flex-1 ml-4">
            <div
              class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
            >
              出庫数
            </div>
            <div
              class="text-4xl font-black bg-gradient-to-r from-red-600 to-rose-600 bg-clip-text text-transparent mb-1"
              id="total-out-qty"
            >
              0
            </div>
            <div class="text-sm font-semibold text-red-600">本</div>
          </div>
        </div>
        <div
          class="h-1 bg-gradient-to-r from-red-400 to-rose-600 rounded-full mb-4"
        ></div>
        <div class="text-sm font-bold text-gray-600" id="total-out-weight">
          0.000 kg
        </div>
      </div>

      <!-- 合計金額 -->
      <div
        class="glass-card rounded-3xl p-8 shadow-xl transition-all duration-300 hover:scale-105 hover:shadow-2xl"
      >
        <div class="flex items-start justify-between mb-6">
          <div
            class="p-4 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl shadow-lg"
          >
            <i class="fas fa-yen-sign text-3xl text-white"></i>
          </div>
          <div class="text-right flex-1 ml-4">
            <div
              class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
            >
              合計金額
            </div>
            <div
              class="text-3xl font-black bg-gradient-to-r from-amber-600 to-orange-600 bg-clip-text text-transparent mb-1"
              id="total-amount"
            >
              ¥0
            </div>
            <div class="text-sm font-semibold text-amber-600">入庫時</div>
          </div>
        </div>
        <div
          class="h-1 bg-gradient-to-r from-amber-400 to-orange-600 rounded-full mb-4"
        ></div>
        <div class="text-sm font-bold text-gray-600">購入費（期間合計）</div>
      </div>
    </div>

    <!-- グラフエリア -->
    <div
      id="graph-area"
      class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10 hidden"
    >
      <!-- 時系列推移 -->
      <div class="glass-card rounded-3xl p-8 shadow-xl">
        <div class="flex items-center mb-6">
          <div
            class="p-3 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-2xl shadow-lg mr-4"
          >
            <i class="fas fa-chart-area text-2xl text-white"></i>
          </div>
          <h3 class="text-2xl font-black text-gray-900">入出庫推移</h3>
        </div>
        <div class="chart-container">
          <canvas id="timeline-chart"></canvas>
        </div>
      </div>

      <!-- 材料別構成比 -->
      <div class="glass-card rounded-3xl p-8 shadow-xl">
        <div class="flex items-center mb-6">
          <div
            class="p-3 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl shadow-lg mr-4"
          >
            <i class="fas fa-chart-pie text-2xl text-white"></i>
          </div>
          <h3 class="text-2xl font-black text-gray-900">材料別在庫構成</h3>
        </div>
        <div class="chart-container">
          <canvas id="composition-chart"></canvas>
        </div>
      </div>

      <!-- 仕入先別金額 -->
      <div class="glass-card rounded-3xl p-8 shadow-xl lg:col-span-2">
        <div class="flex items-center mb-6">
          <div
            class="p-3 bg-gradient-to-br from-green-500 to-teal-600 rounded-2xl shadow-lg mr-4"
          >
            <i class="fas fa-chart-bar text-2xl text-white"></i>
          </div>
          <h3 class="text-2xl font-black text-gray-900">仕入先別金額</h3>
        </div>
        <div class="chart-container">
          <canvas id="supplier-chart"></canvas>
        </div>
      </div>

      <!-- 購入月別購入費 -->
      <div class="glass-card rounded-3xl p-8 shadow-xl">
        <div class="flex items-center mb-6">
          <div
            class="p-3 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl shadow-lg mr-4"
          >
            <i class="fas fa-calendar-alt text-2xl text-white"></i>
          </div>
          <h3 class="text-2xl font-black text-gray-900">購入月別購入費</h3>
        </div>
        <div class="chart-container">
          <canvas id="purchase-month-chart"></canvas>
        </div>
      </div>

      <!-- 在庫金額 -->
      <div class="glass-card rounded-3xl p-8 shadow-xl">
        <div class="flex items-center mb-6">
          <div
            class="p-3 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-2xl shadow-lg mr-4"
          >
            <i class="fas fa-coins text-2xl text-white"></i>
          </div>
          <h3 class="text-2xl font-black text-gray-900">在庫金額</h3>
        </div>
        <div class="chart-container">
          <canvas id="inventory-amount-chart"></canvas>
        </div>
      </div>

      <!-- 持ち出し量金額 -->
      <div class="glass-card rounded-3xl p-8 shadow-xl">
        <div class="flex items-center mb-6">
          <div
            class="p-3 bg-gradient-to-br from-teal-500 to-emerald-600 rounded-2xl shadow-lg mr-4"
          >
            <i class="fas fa-truck text-2xl text-white"></i>
          </div>
          <h3 class="text-2xl font-black text-gray-900">持ち出し量金額</h3>
        </div>
        <div class="chart-container">
          <canvas id="outgoing-amount-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- 集計結果テーブル -->
    <div
      id="result-table-container"
      class="glass-card rounded-3xl p-8 shadow-xl hidden"
    >
      <div class="flex items-center mb-6">
        <div
          class="p-3 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-lg mr-4"
        >
          <i class="fas fa-table text-2xl text-white"></i>
        </div>
        <h2 class="text-2xl font-black text-gray-900">材料別集計結果</h2>
      </div>
      <div class="overflow-x-auto rounded-2xl border-2 border-gray-100">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gradient-to-r from-gray-50 to-blue-50">
            <tr>
              <th
                class="px-6 py-4 text-left text-xs font-black text-gray-700 uppercase tracking-wider"
              >
                材料名
              </th>
              <th
                class="px-6 py-4 text-right text-xs font-black text-gray-700 uppercase tracking-wider"
              >
                在庫本数
              </th>
              <th
                class="px-6 py-4 text-right text-xs font-black text-gray-700 uppercase tracking-wider"
              >
                在庫重量(kg)
              </th>
              <th
                class="px-6 py-4 text-right text-xs font-black text-gray-700 uppercase tracking-wider"
              >
                入庫本数
              </th>
              <th
                class="px-6 py-4 text-right text-xs font-black text-gray-700 uppercase tracking-wider"
              >
                入庫重量(kg)
              </th>
              <th
                class="px-6 py-4 text-right text-xs font-black text-gray-700 uppercase tracking-wider"
              >
                出庫本数
              </th>
              <th
                class="px-6 py-4 text-right text-xs font-black text-gray-700 uppercase tracking-wider"
              >
                出庫重量(kg)
              </th>
              <th
                class="px-6 py-4 text-right text-xs font-black text-gray-700 uppercase tracking-wider"
              >
                金額（円）
              </th>
            </tr>
          </thead>
          <tbody id="result-tbody" class="bg-white divide-y divide-gray-100">
            <!-- JavaScriptで動的生成 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- エンプティステート（初期表示用） -->
    <div
      id="empty-state"
      class="glass-card rounded-3xl p-16 shadow-xl text-center mb-10"
    >
      <div
        class="empty-state inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full mb-8 shadow-lg"
      >
        <i class="fas fa-chart-line text-5xl text-white"></i>
      </div>
      <h3 class="text-2xl font-black text-gray-900 mb-4">
        集計データを取得できます
      </h3>
      <p class="text-gray-600 font-medium mb-6">
        上記の検索条件を入力して「検索」ボタンをクリックしてください
      </p>
      <div class="flex justify-center gap-4">
        <div class="flex items-center px-6 py-3 bg-blue-50 rounded-xl">
          <i class="fas fa-calendar-alt mr-2 text-blue-600"></i>
          <span class="text-sm font-bold text-gray-700"
            >日付範囲で絞り込み</span
          >
        </div>
        <div class="flex items-center px-6 py-3 bg-green-50 rounded-xl">
          <i class="fas fa-cubes mr-2 text-green-600"></i>
          <span class="text-sm font-bold text-gray-700">材料名で検索</span>
        </div>
        <div class="flex items-center px-6 py-3 bg-purple-50 rounded-xl">
          <i class="fas fa-truck mr-2 text-purple-600"></i>
          <span class="text-sm font-bold text-gray-700">仕入先で絞り込み</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // グラフインスタンス
  let timelineChart = null;
  let compositionChart = null;
  let supplierChart = null;
  // 新規: 購入月別購入費
  let purchaseMonthChart = null;
  // 新規: 在庫金額・持ち出し金額
  let inventoryAmountChart = null;
  let outgoingAmountChart = null;

  // 検索実行
  async function performSearch() {
    // エンプティステートを非表示
    const emptyState = document.getElementById("empty-state");
    if (emptyState) emptyState.classList.add("hidden");

    const formData = new FormData(document.getElementById("search-form"));
    const params = new URLSearchParams();

    for (const [key, value] of formData.entries()) {
      if (value) params.append(key, value);
    }

    try {
      // サマリーデータ取得
      const summaryRes = await fetch(
        `/api/analytics/summary/?${params.toString()}`
      );
      if (!summaryRes.ok) throw new Error("集計データの取得に失敗しました");
      const summary = await summaryRes.json();

      // サマリーカード表示
      document.getElementById("summary-cards").classList.remove("hidden");
      document.getElementById("total-stock-qty").textContent =
        summary.total_stock_quantity.toLocaleString();
      document.getElementById(
        "total-stock-weight"
      ).textContent = `${summary.total_stock_weight_kg.toFixed(3)} kg`;
      document.getElementById("total-in-qty").textContent =
        summary.total_in_quantity.toLocaleString();
      document.getElementById(
        "total-in-weight"
      ).textContent = `${summary.total_in_weight_kg.toFixed(3)} kg`;
      document.getElementById("total-out-qty").textContent =
        summary.total_out_quantity.toLocaleString();
      document.getElementById(
        "total-out-weight"
      ).textContent = `${summary.total_out_weight_kg.toFixed(3)} kg`;
      document.getElementById(
        "total-amount"
      ).textContent = `¥${summary.total_amount.toLocaleString()}`;

      // テーブル表示
      const tbody = document.getElementById("result-tbody");
      tbody.innerHTML = "";
      summary.materials.forEach((m) => {
        const row = tbody.insertRow();
        row.className = "hover:bg-blue-50 transition-colors duration-200";
        row.innerHTML = `
          <td class="px-6 py-4 text-sm font-bold text-gray-900">${
            m.material_name
          }</td>
          <td class="px-6 py-4 text-sm font-semibold text-gray-900 text-right">${m.current_stock_quantity.toLocaleString()}</td>
          <td class="px-6 py-4 text-sm font-semibold text-gray-900 text-right">${m.current_stock_weight_kg.toFixed(
            3
          )}</td>
          <td class="px-6 py-4 text-sm font-semibold text-green-600 text-right">${m.total_in_quantity.toLocaleString()}</td>
          <td class="px-6 py-4 text-sm font-semibold text-green-600 text-right">${m.total_in_weight_kg.toFixed(
            3
          )}</td>
          <td class="px-6 py-4 text-sm font-semibold text-red-600 text-right">${m.total_out_quantity.toLocaleString()}</td>
          <td class="px-6 py-4 text-sm font-semibold text-red-600 text-right">${m.total_out_weight_kg.toFixed(
            3
          )}</td>
          <td class="px-6 py-4 text-sm font-bold text-gray-900 text-right">¥${m.total_amount.toLocaleString()}</td>
        `;
      });
      document
        .getElementById("result-table-container")
        .classList.remove("hidden");

      // グラフデータ取得
      await loadGraphs(params);

      showToast("集計が完了しました", "success");
    } catch (error) {
      console.error("検索エラー:", error);
      showToast("集計処理中にエラーが発生しました", "error");
    }
  }

  // グラフ読み込み
  async function loadGraphs(params) {
    document.getElementById("graph-area").classList.remove("hidden");

    // 時系列推移
    try {
      const timelineRes = await fetch(
        `/api/analytics/graph/timeline/?${params.toString()}`
      );
      const timelineData = await timelineRes.json();

      if (timelineChart) timelineChart.destroy();
      const ctx1 = document.getElementById("timeline-chart").getContext("2d");
      timelineChart = new Chart(ctx1, {
        type: "line",
        data: {
          labels: timelineData.labels,
          datasets: timelineData.datasets,
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
          },
        },
      });
    } catch (error) {
      console.error("時系列グラフエラー:", error);
    }

    // 材料別構成比
    try {
      const compositionRes = await fetch(
        "/api/analytics/graph/material-composition/"
      );
      const compositionData = await compositionRes.json();

      if (compositionChart) compositionChart.destroy();
      const ctx2 = document
        .getElementById("composition-chart")
        .getContext("2d");
      compositionChart = new Chart(ctx2, {
        type: "pie",
        data: {
          labels: compositionData.labels,
          datasets: compositionData.datasets,
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "right" },
          },
        },
      });
    } catch (error) {
      console.error("構成比グラフエラー:", error);
    }

    // 仕入先別金額
    try {
      const supplierRes = await fetch(
        `/api/analytics/graph/supplier-amount/?${params.toString()}`
      );
      const supplierData = await supplierRes.json();

      if (supplierChart) supplierChart.destroy();
      const ctx3 = document.getElementById("supplier-chart").getContext("2d");
      supplierChart = new Chart(ctx3, {
        type: "bar",
        data: {
          labels: supplierData.labels,
          datasets: supplierData.datasets,
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
          },
        },
      });
    } catch (error) {
      console.error("仕入先グラフエラー:", error);
    }

    // 購入月別購入費
    try {
      const pmRes = await fetch(
        `/api/analytics/graph/purchase-month-amount/?${params.toString()}`
      );
      const pmData = await pmRes.json();

      if (purchaseMonthChart) purchaseMonthChart.destroy();
      const ctx4 = document
        .getElementById("purchase-month-chart")
        .getContext("2d");
      purchaseMonthChart = new Chart(ctx4, {
        type: "bar",
        data: {
          labels: pmData.labels,
          datasets: pmData.datasets,
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
          },
        },
      });
    } catch (error) {
      console.error("購入月グラフエラー:", error);
    }

    // 在庫金額
    try {
      const invRes = await fetch(
        `/api/analytics/graph/inventory-amount/?${params.toString()}`
      );
      const invData = await invRes.json();

      if (inventoryAmountChart) inventoryAmountChart.destroy();
      const ctx5 = document
        .getElementById("inventory-amount-chart")
        .getContext("2d");
      inventoryAmountChart = new Chart(ctx5, {
        type: "bar",
        data: {
          labels: invData.labels,
          datasets: invData.datasets,
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
          },
        },
      });
    } catch (error) {
      console.error("在庫金額グラフエラー:", error);
    }

    // 持ち出し量金額
    try {
      const outRes = await fetch(
        `/api/analytics/graph/outgoing-amount/?${params.toString()}`
      );
      const outData = await outRes.json();

      if (outgoingAmountChart) outgoingAmountChart.destroy();
      const ctx6 = document
        .getElementById("outgoing-amount-chart")
        .getContext("2d");
      outgoingAmountChart = new Chart(ctx6, {
        type: "bar",
        data: {
          labels: outData.labels,
          datasets: outData.datasets,
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
          },
        },
      });
    } catch (error) {
      console.error("持ち出し金額グラフエラー:", error);
    }
  }

  // リセット
  function resetForm() {
    document.getElementById("search-form").reset();
    document.getElementById("summary-cards").classList.add("hidden");
    document.getElementById("graph-area").classList.add("hidden");
    document.getElementById("result-table-container").classList.add("hidden");
    // エンプティステートを再表示
    const emptyState = document.getElementById("empty-state");
    if (emptyState) emptyState.classList.remove("hidden");
    showToast("検索条件をリセットしました", "info");
  }

  // クイック検索：今日
  function quickSearchToday() {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("start-date").value = today;
    document.getElementById("end-date").value = today;
    performSearch();
  }

  // クイック検索：今週
  function quickSearchWeek() {
    const today = new Date();
    const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
    const lastDay = new Date(
      today.setDate(today.getDate() - today.getDay() + 6)
    );
    document.getElementById("start-date").value = firstDay
      .toISOString()
      .split("T")[0];
    document.getElementById("end-date").value = lastDay
      .toISOString()
      .split("T")[0];
    performSearch();
  }

  // クイック検索：今月
  function quickSearchMonth() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    document.getElementById("start-date").value = firstDay
      .toISOString()
      .split("T")[0];
    document.getElementById("end-date").value = lastDay
      .toISOString()
      .split("T")[0];
    performSearch();
  }

  // CSV出力
  async function exportCSV() {
    const formData = new FormData(document.getElementById("search-form"));
    const params = new URLSearchParams();
    for (const [key, value] of formData.entries()) {
      if (value) params.append(key, value);
    }

    window.location.href = `/api/analytics/export/csv/?${params.toString()}`;
  }

  // Excel出力
  async function exportExcel() {
    const formData = new FormData(document.getElementById("search-form"));
    const params = new URLSearchParams();
    for (const [key, value] of formData.entries()) {
      if (value) params.append(key, value);
    }

    window.location.href = `/api/analytics/export/excel/?${params.toString()}`;
  }

  // イベントリスナー
  document
    .getElementById("search-btn")
    .addEventListener("click", performSearch);
  document.getElementById("reset-btn").addEventListener("click", resetForm);
  document
    .getElementById("export-csv-btn")
    .addEventListener("click", exportCSV);
  document
    .getElementById("export-excel-btn")
    .addEventListener("click", exportExcel);

  // クイック検索ボタン
  const quickTodayBtn = document.getElementById("quick-search-today");
  const quickWeekBtn = document.getElementById("quick-search-week");
  const quickMonthBtn = document.getElementById("quick-search-month");

  if (quickTodayBtn) quickTodayBtn.addEventListener("click", quickSearchToday);
  if (quickWeekBtn) quickWeekBtn.addEventListener("click", quickSearchWeek);
  if (quickMonthBtn) quickMonthBtn.addEventListener("click", quickSearchMonth);

  // Enterキーで検索
  document.getElementById("search-form").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      performSearch();
    }
  });

  // 初期表示（エンプティステートを表示）
  document.addEventListener("DOMContentLoaded", () => {
    // 初期表示時はエンプティステートを表示
    const emptyState = document.getElementById("empty-state");
    if (emptyState) emptyState.classList.remove("hidden");

    // サマリーカード、グラフ、テーブルは非表示
    document.getElementById("summary-cards").classList.add("hidden");
    document.getElementById("graph-area").classList.add("hidden");
    document.getElementById("result-table-container").classList.add("hidden");
  });
</script>
{% endblock %}
