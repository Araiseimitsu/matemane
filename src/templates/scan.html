{% extends "base.html" %}

{% block title %}QRスキャン - 材料管理システム{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- ヘッダー -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <h1 class="text-2xl font-bold text-gray-900">QRスキャン</h1>
                <button onclick="toggleTorch()" id="torchBtn"
                    class="bg-white hover:bg-gray-50 text-gray-700 font-medium py-2.5 px-6 rounded-lg border border-gray-300 transition-all duration-200 shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1 hidden">
                    <i class="fas fa-flashlight mr-2"></i>
                    <span id="torchText">ライト ON</span>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- カメラプレビュー -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
            <div class="p-6">
                <div class="relative">
                    <!-- カメラ表示エリア -->
                    <div id="camera-container"
                        class="relative bg-black rounded-lg overflow-hidden aspect-square max-w-md mx-auto">
                        <video id="camera" autoplay playsinline class="w-full h-full object-cover"></video>

                        <!-- スキャンフレーム -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="scan-frame border-2 border-blue-500 w-64 h-64 relative">
                                <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-blue-500"></div>
                                <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-blue-500"></div>
                                <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-blue-500">
                                </div>
                                <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-blue-500">
                                </div>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div id="scan-line" class="w-full h-0.5 bg-blue-500 opacity-75 animate-pulse"></div>
                                </div>
                            </div>
                        </div>

                        <!-- カメラ未起動時のプレースホルダー -->
                        <div id="camera-placeholder"
                            class="absolute inset-0 flex flex-col items-center justify-center text-white">
                            <i class="fas fa-camera text-6xl mb-4 opacity-50"></i>
                            <p class="text-lg mb-2">カメラを起動してください</p>
                            <p class="text-sm opacity-75">QRコードをスキャンできます</p>
                        </div>
                    </div>

                    <!-- コントロールボタン -->
                    <div class="flex justify-center mt-6 space-x-4">
                        <button onclick="startCamera()" id="startBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                            <i class="fas fa-play mr-2"></i>
                            カメラ開始
                        </button>
                        <button onclick="stopCamera()" id="stopBtn"
                            class="bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 px-6 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1 hidden">
                            <i class="fas fa-stop mr-2"></i>
                            カメラ停止
                        </button>
                        <button onclick="switchCamera()" id="switchBtn"
                            class="bg-white hover:bg-gray-50 text-gray-700 font-medium py-2.5 px-6 rounded-lg border border-gray-300 transition-all duration-200 shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1 hidden">
                            <i class="fas fa-sync-alt mr-2"></i>
                            カメラ切替
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- スキャン結果エリア -->
        <div id="scan-result" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-xl font-bold text-gray-900 mb-4">スキャン結果</h2>
            <div id="result-content" class="space-y-4">
                <!-- スキャン結果がここに表示されます -->
            </div>
        </div>

        <!-- 手動入力エリア -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">手動入力</h2>
            <p class="text-gray-600 mb-4">QRコードをスキャンできない場合は、管理コードを直接入力してください。</p>

            <div class="flex space-x-4">
                <div class="flex-1">
                    <label for="manual-code" class="block text-sm font-medium text-gray-700 mb-2">管理コード</label>
                    <input type="text" id="manual-code" placeholder="UUID管理コードを入力"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hover:border-gray-400">
                </div>
                <div class="flex items-end">
                    <button onclick="searchManualCode()"
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-6 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-1">
                        <i class="fas fa-search mr-2"></i>
                        検索
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- アイテム詳細モーダル -->
<div id="item-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">アイテム詳細</h2>
                    <button onclick="closeItemModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div id="item-details" class="space-y-6">
                    <!-- アイテム詳細情報がここに表示されます -->
                </div>

                <!-- 操作ボタン -->
                <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-200">
                    <button onclick="closeItemModal()" class="bg-white hover:bg-gray-50 text-gray-700 font-medium py-2.5 px-6 rounded-lg border border-gray-300 transition-all duration-200 shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1">
                        閉じる
                    </button>
                    <button onclick="openMovementModal()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                        入出庫処理
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 入出庫処理モーダル -->
<div id="movement-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">入出庫処理</h2>
                    <button onclick="closeMovementModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- 処理タイプ選択 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">処理タイプ</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="movement-type" value="in" class="mr-2" checked>
                            <span class="text-green-600 font-medium">入庫</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="movement-type" value="out" class="mr-2">
                            <span class="text-red-600 font-medium">出庫</span>
                        </label>
                    </div>
                </div>

                <form id="movement-form" class="space-y-4">
                    <input type="hidden" id="movement-item-id" value="">

                    <div>
                        <label for="movement-quantity" class="block text-sm font-medium text-gray-700 mb-2">本数 *</label>
                        <input type="number" id="movement-quantity" min="1" required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hover:border-gray-400">
                    </div>

                    <div id="instruction-number-field" class="hidden">
                        <label for="movement-instruction" class="block text-sm font-medium text-gray-700 mb-2">指示書番号
                            *</label>
                        <input type="text" id="movement-instruction" placeholder="IS-YYYY-NNNN"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hover:border-gray-400">
                        <p class="text-sm text-gray-500 mt-1">形式: IS-YYYY-NNNN</p>
                    </div>

                    <div>
                        <label for="movement-notes" class="block text-sm font-medium text-gray-700 mb-2">備考</label>
                        <textarea id="movement-notes" rows="3" placeholder="任意の備考を入力"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hover:border-gray-400"></textarea>
                    </div>

                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" onclick="closeMovementModal()"
                            class="bg-white hover:bg-gray-50 text-gray-700 font-medium py-2.5 px-6 rounded-lg border border-gray-300 transition-all duration-200 shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1">
                            キャンセル
                        </button>
                        <button type="submit"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                            実行
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
    let currentStream = null;
    let currentFacingMode = 'environment'; // 背面カメラから開始
    let torchEnabled = false;
    let scanActive = false;
    let currentItemId = null;
    let loadingOverlay = null;

    // ローディング表示
    function showLoading(message = '処理中です...') {
        if (!loadingOverlay) {
            loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loading-overlay';
            loadingOverlay.className = 'loading-overlay fixed inset-0 flex items-center justify-center z-50 bg-gray-900 bg-opacity-60';
            loadingOverlay.innerHTML = `
            <div class="loading-panel bg-white rounded-lg shadow-xl px-6 py-5 flex items-center space-x-4">
                <div class="loading-spinner w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                <div class="loading-message text-gray-700 font-medium"></div>
            </div>
        `;
            document.body.appendChild(loadingOverlay);
        }

        const messageElement = loadingOverlay.querySelector('.loading-message');
        messageElement.textContent = message;
        loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
        if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
        }
    }

    function clearScanResult() {
        const resultSection = document.getElementById('scan-result');
        const content = document.getElementById('result-content');
        if (content) {
            content.innerHTML = '';
        }
        if (resultSection && !resultSection.classList.contains('hidden')) {
            resultSection.classList.add('hidden');
        }
    }

    function updateScanResult(item) {
        const resultSection = document.getElementById('scan-result');
        const content = document.getElementById('result-content');
        if (!resultSection || !content) {
            return;
        }

        const receivedDate = item.received_date ? new Date(item.received_date).toLocaleDateString('ja-JP') : '未設定';

        content.innerHTML = `
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">管理コード</p>
                    <p class="text-lg font-semibold text-gray-900">${item.management_code}</p>
                </div>
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${item.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                    ${item.is_active ? '有効' : '無効'}
                </span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">材質 / 形状</p>
                    <p class="text-sm font-medium text-gray-900">${item.material_name}｜${getShapeText(item.shape)}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">現在本数</p>
                    <p class="text-sm font-semibold text-blue-600">${item.current_quantity} 本</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">現在総重量</p>
                    <p class="text-sm font-semibold text-green-600">${item.total_weight_kg.toFixed(3)} kg</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">置き場</p>
                    <p class="text-sm text-gray-900">${item.location_name || '未設定'}</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">ロット番号</p>
                    <p class="text-sm text-gray-900">${item.lot_number}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">入荷日</p>
                    <p class="text-sm text-gray-900">${receivedDate}</p>
                </div>
            </div>

            <div class="flex justify-end">
                <button type="button" onclick="closeItemModal(); displayItemDetails(lastScannedItem);" class="hidden"></button>
                <button type="button" onclick="openMovementModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 text-sm">
                    入出庫処理を続ける
                </button>
            </div>
        </div>
    `;

        resultSection.classList.remove('hidden');
    }

    let lastScannedItem = null;

    // QRスキャナー関連
    async function startCamera() {
        try {
            const constraints = {
                video: {
                    facingMode: currentFacingMode,
                    width: { ideal: 640 },
                    height: { ideal: 640 }
                }
            };

            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            const video = document.getElementById('camera');
            video.srcObject = currentStream;

            // UI更新
            document.getElementById('camera-placeholder').style.display = 'none';
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('stopBtn').classList.remove('hidden');
            document.getElementById('switchBtn').classList.remove('hidden');

            // トーチボタンの表示/非表示判定
            checkTorchSupport();

            scanActive = true;
            startQRScanning();

            showToast('カメラが開始されました', 'success');
        } catch (error) {
            console.error('カメラの開始に失敗しました:', error);
            showToast('カメラの開始に失敗しました。カメラの権限を確認してください。', 'error');
        }
    }

    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }

        scanActive = false;

        // UI更新
        document.getElementById('camera-placeholder').style.display = 'flex';
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('switchBtn').classList.add('hidden');
        document.getElementById('torchBtn').classList.add('hidden');

        showToast('カメラが停止されました', 'info');
    }

    async function switchCamera() {
        currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
        stopCamera();
        await new Promise(resolve => setTimeout(resolve, 100)); // 少し待機
        startCamera();
    }

    async function checkTorchSupport() {
        try {
            const track = currentStream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();

            if (capabilities.torch) {
                document.getElementById('torchBtn').classList.remove('hidden');
            }
        } catch (error) {
            console.log('トーチ機能は利用できません');
        }
    }

    async function toggleTorch() {
        try {
            const track = currentStream.getVideoTracks()[0];
            await track.applyConstraints({
                advanced: [{ torch: !torchEnabled }]
            });

            torchEnabled = !torchEnabled;
            const torchText = document.getElementById('torchText');
            torchText.textContent = torchEnabled ? 'ライト OFF' : 'ライト ON';

            showToast(torchEnabled ? 'ライトをONにしました' : 'ライトをOFFにしました', 'info');
        } catch (error) {
            console.error('ライトの切り替えに失敗しました:', error);
            showToast('ライトの切り替えに失敗しました', 'error');
        }
    }

    function startQRScanning() {
        const video = document.getElementById('camera');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        function scan() {
            if (!scanActive || video.readyState !== video.HAVE_ENOUGH_DATA) {
                if (scanActive) {
                    requestAnimationFrame(scan);
                }
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, canvas.width, canvas.height);

            if (code) {
                handleQRCode(code.data);
            }

            requestAnimationFrame(scan);
        }

        scan();
    }

    function handleQRCode(data) {
        console.log('QRコードを検出:', data);
        scanActive = false; // 一時的にスキャンを停止

        // QRコードの形式を判定
        if (isUUID(data)) {
            searchItemByCode(data);
        } else {
            showToast('無効なQRコード形式です', 'error');
            // 3秒後にスキャンを再開
            setTimeout(() => {
                scanActive = true;
            }, 3000);
        }
    }

    function isUUID(str) {
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        return uuidRegex.test(str);
    }

    // 手動コード検索
    function searchManualCode() {
        const code = document.getElementById('manual-code').value.trim();
        if (!code) {
            showToast('管理コードを入力してください', 'error');
            return;
        }

        if (!isUUID(code)) {
            showToast('有効なUUID形式で入力してください', 'error');
            return;
        }

        searchItemByCode(code);
    }

    // アイテム検索
    async function searchItemByCode(managementCode) {
        try {
            showLoading('アイテムを検索中...');

            const response = await fetch(`/api/inventory/by-code/${encodeURIComponent(managementCode)}`);

            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('指定された管理コードのアイテムが見つかりません');
                }
                throw new Error('アイテムの検索に失敗しました');
            }

            const item = await response.json();
            displayItemDetails(item);

            hideLoading();
            showToast('アイテムが見つかりました', 'success');

        } catch (error) {
            console.error('アイテム検索エラー:', error);
            hideLoading();
            showToast(error.message, 'error');

            // エラー時は3秒後にスキャンを再開
            setTimeout(() => {
                scanActive = true;
            }, 3000);
        }
    }

    // アイテム詳細表示
    function displayItemDetails(item) {
        currentItemId = item.id;
        lastScannedItem = item;
        updateScanResult(item);

        const detailsHtml = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">基本情報</h3>
                    <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                        <div><span class="font-medium">管理コード:</span> ${item.management_code}</div>
                        <div><span class="font-medium">現在本数:</span> <span class="text-xl font-bold text-blue-600">${item.current_quantity}本</span></div>
                        <div><span class="font-medium">置き場:</span> ${item.location_name || '未設定'}</div>
                        <div><span class="font-medium">状態:</span>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${item.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${item.is_active ? '有効' : '無効'}
                            </span>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">ロット情報</h3>
                    <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                        <div><span class="font-medium">ロット番号:</span> ${item.lot_number}</div>
                        <div><span class="font-medium">長さ:</span> ${item.length_mm}mm</div>
                        <div><span class="font-medium">初期本数:</span> ${item.initial_quantity}本</div>
                        <div><span class="font-medium">仕入先:</span> ${item.supplier || '未設定'}</div>
                        <div><span class="font-medium">入荷日:</span> ${item.received_date ? new Date(item.received_date).toLocaleDateString('ja-JP') : '未設定'}</div>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">材料情報</h3>
                    <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                        <div><span class="font-medium">材質:</span> ${item.material_name}</div>
                        <div><span class="font-medium">形状:</span>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                ${getShapeText(item.shape)}
                            </span>
                        </div>
                        <div><span class="font-medium">直径:</span> ${item.diameter_mm}mm</div>
                        <div><span class="font-medium">比重:</span> ${item.current_density}g/cm³</div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">重量情報</h3>
                    <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                        <div><span class="font-medium">1本あたり重量:</span> ${item.weight_per_piece_kg.toFixed(3)}kg</div>
                        <div><span class="font-medium">現在総重量:</span> <span class="text-xl font-bold text-green-600">${item.total_weight_kg.toFixed(3)}kg</span></div>
                    </div>
                </div>

                ${item.lot_notes ? `
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">備考</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-700">${item.lot_notes}</p>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;

        document.getElementById('item-details').innerHTML = detailsHtml;
        Utils.modal.open('item-modal');
    }

    // 形状テキスト変換
    function getShapeText(shape) {
        const shapeMap = {
            'round': '丸棒',
            'hexagon': '六角棒',
            'square': '角棒'
        };
        return shapeMap[shape] || shape;
    }

    // モーダル制御
    function closeItemModal() {
        Utils.modal.close('item-modal');
        currentItemId = null;

        // スキャンを再開
        setTimeout(() => {
            scanActive = true;
        }, 1000);

        clearScanResult();
    }

    function openMovementModal() {
        document.getElementById('movement-item-id').value = currentItemId;
        Utils.modal.open('movement-modal');
        setTimeout(() => {
            const quantityInput = document.getElementById('movement-quantity');
            if (quantityInput) {
                quantityInput.focus();
            }
        }, 100);
    }

    function closeMovementModal() {
        Utils.modal.close('movement-modal');
        document.getElementById('movement-form').reset();
    }

    // 入出庫処理タイプ変更
    document.addEventListener('DOMContentLoaded', function () {
        // モーダル共通処理設定
        Utils.modal.setupEventListeners(['item-modal', 'movement-modal']);

        const movementTypeRadios = document.querySelectorAll('input[name="movement-type"]');
        const instructionField = document.getElementById('instruction-number-field');

        movementTypeRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'out') {
                    instructionField.classList.remove('hidden');
                    document.getElementById('movement-instruction').required = true;
                } else {
                    instructionField.classList.add('hidden');
                    document.getElementById('movement-instruction').required = false;
                }
            });
        });
    });

    // 入出庫処理フォーム送信
    document.getElementById('movement-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const itemId = document.getElementById('movement-item-id').value;
        const movementType = document.querySelector('input[name="movement-type"]:checked').value;
        const quantity = parseInt(document.getElementById('movement-quantity').value);
        const instruction = document.getElementById('movement-instruction').value.trim();
        const notes = document.getElementById('movement-notes').value.trim();

        // バリデーション
        if (!itemId || !quantity || quantity <= 0) {
            showToast('必須項目を正しく入力してください', 'error');
            return;
        }

        if (movementType === 'out' && !instruction) {
            showToast('出庫処理には指示書番号が必要です', 'error');
            return;
        }

        if (movementType === 'out' && !/^IS-\d{4}-\d{4}$/.test(instruction)) {
            showToast('指示書番号はIS-YYYY-NNNN形式で入力してください', 'error');
            return;
        }

        try {
            showLoading('処理中...');

            const endpoint = `/api/movements/${movementType}/${itemId}`;
            const requestData = {
                quantity: quantity,
                notes: notes || null
            };

            if (movementType === 'out') {
                requestData.instruction_number = instruction;
            } else if (instruction) {
                requestData.instruction_number = instruction;
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '処理に失敗しました');
            }

            const result = await response.json();

            hideLoading();
            showToast(result.message, 'success');

            // モーダルを閉じて、アイテム詳細を更新
            closeMovementModal();
            if (lastScannedItem) {
                searchItemByCode(lastScannedItem.management_code);
            } else {
                clearScanResult();
            }

        } catch (error) {
            console.error('入出庫処理エラー:', error);
            hideLoading();
            showToast(error.message, 'error');
        }
    });

    // ページ読み込み時の初期設定
    document.addEventListener('DOMContentLoaded', function () {
        // カメラの使用許可をチェック
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showToast('このブラウザではカメラ機能を使用できません', 'error');
            return;
        }

        // Enterキーで手動検索
        document.getElementById('manual-code').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                searchManualCode();
            }
        });
    });

    // ページを離れる時にカメラを停止
    window.addEventListener('beforeunload', function () {
        if (currentStream) {
            stopCamera();
        }
    });
</script>

<style>
    .scan-frame {
        animation: scan-pulse 2s infinite;
    }

    @keyframes scan-pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.6;
        }
    }

    #scan-line {
        animation: scan-move 2s linear infinite;
    }

    @keyframes scan-move {
        0% {
            transform: translateY(-100%);
        }

        100% {
            transform: translateY(100%);
        }
    }
</style>
{% endblock %}