{% extends "base.html" %}
{% block title %}グループ管理 | 材料管理システム{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold text-gray-800">
      <i class="fas fa-object-group mr-2"></i>材料グループ管理
    </h1>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- グループ一覧 -->
    <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-4 lg:col-span-1">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-700">グループ一覧</h2>
      </div>

      <div id="group-list" class="space-y-2"></div>

      <hr class="my-4" />

      <div>
        <h3 class="text-sm font-medium text-gray-600 mb-2">新規グループ作成</h3>
        <form id="create-group-form" class="space-y-2">
          <input type="text" id="group-name" class="w-full border rounded px-3 py-2" placeholder="グループ名" required />
          <input type="text" id="group-desc" class="w-full border rounded px-3 py-2" placeholder="説明 (任意)" />
          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded">
            作成する
          </button>
        </form>
      </div>
    </div>

    <!-- グループ詳細 / メンバー管理 -->
    <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-4 lg:col-span-2">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-700" id="selected-group-title">グループ詳細</h2>
        <div id="selected-group-actions" class="hidden space-x-2">
          <button id="delete-group-btn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
            グループを削除
          </button>
        </div>
      </div>

      <div id="group-detail" class="text-sm text-gray-700 mb-4"></div>

      <div class="mb-4">
        <h3 class="text-sm font-medium text-gray-600 mb-2">同等品管理</h3>
        <div class="flex items-center space-x-2 mb-3">
          <input type="text" id="material-search" class="flex-1 border rounded px-3 py-2" placeholder="材料名・品番・寸法(径)で検索" />
          <button id="search-btn" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded">検索</button>
        </div>
        <div id="search-results" class="space-y-2 mb-4"></div>

        <h4 class="text-sm font-medium text-gray-600 mb-2">同等品一覧</h4>
        <div id="member-list" class="space-y-2"></div>
      </div>
    </div>
  </div>
</div>

<script>
  let selectedGroup = null;

  async function loadGroups() {
    try {
      const groups = await APIClient.get("/material-groups/");
      const listEl = document.getElementById("group-list");
      listEl.innerHTML = "";

      if (!groups.length) {
        listEl.innerHTML = `<div class="text-gray-500 text-sm">グループがまだありません。左のフォームから作成してください。</div>`;
        return;
      }

      groups.forEach((g) => {
        const btn = document.createElement("button");
        btn.className = `w-full text-left px-3 py-2 border rounded hover:bg-gray-50 ${selectedGroup && selectedGroup.id === g.id ? 'bg-blue-50 border-blue-300' : ''}`;
        btn.innerHTML = `<div class="flex justify-between">
            <span class="font-medium">${escapeHtml(g.group_name)}</span>
            <span class="text-xs text-gray-500">${g.is_active ? '有効' : '無効'}</span>
          </div>
          <div class="text-xs text-gray-600">${escapeHtml(g.description || '')}</div>`;
        btn.onclick = () => selectGroup(g);
        listEl.appendChild(btn);
      });
    } catch (e) {
      showToast(e.message || "グループ一覧の取得に失敗しました", "error");
    }
  }

  async function selectGroup(group) {
    selectedGroup = group;
    document.getElementById("selected-group-title").textContent = `グループ詳細: ${group.group_name}`;
    document.getElementById("selected-group-actions").classList.remove("hidden");
    const summary = await fetchGroupSummary(group.id);
    document.getElementById("group-detail").innerHTML = `
      <div>説明: ${escapeHtml(group.description || '')}</div>
      <div>状態: ${group.is_active ? '有効' : '無効'}</div>
      <div>合計本数: ${summary ? summary.total_stock : 0}</div>
      <div>ロット数: ${summary ? summary.lot_count : 0}</div>
      <div class="text-xs text-gray-500">ID: ${group.id}</div>
    `;
    await loadMembers(group.id);
  }

  async function fetchGroupSummary(groupId) {
    try {
      const summaries = await APIClient.get("/inventory/groups");
      return summaries.find(s => s.group_id === groupId) || null;
    } catch (e) {
      return null;
    }
  }

  async function loadMembers(groupId) {
    try {
      const members = await APIClient.get(`/material-groups/${groupId}/members`);
      const listEl = document.getElementById("member-list");
      listEl.innerHTML = "";
      if (!members.length) {
        listEl.innerHTML = `<div class="text-gray-500 text-sm">所属メンバーがありません。</div>`;
        return;
      }
      for (const m of members) {
        // 材料詳細を取得（簡易表示用）
        let materialText = `材料ID: ${m.material_id}`;
        try {
          const mat = await APIClient.get(`/materials/${m.material_id}`);
          materialText = `${escapeHtml(mat.name)} / ${mat.shape} / φ${mat.diameter_mm} / 品番:${escapeHtml(mat.part_number || '-')}`;
        } catch {}

        const row = document.createElement("div");
        row.className = "flex items-center justify-between border rounded px-3 py-2";
        row.innerHTML = `<div class="text-sm text-gray-700">${materialText}</div>`;
        const delBtn = document.createElement("button");
        delBtn.className = "bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs";
        delBtn.textContent = "除外";
        delBtn.onclick = async () => {
          try {
            await APIClient.delete(`/material-groups/${groupId}/members/${m.id}`);
            showToast("所属を削除しました", "success");
            await loadMembers(groupId);
          } catch (e) {
            showToast(e.message || "削除に失敗しました", "error");
          }
        };
        row.appendChild(delBtn);
        listEl.appendChild(row);
      }
    } catch (e) {
      showToast(e.message || "メンバー一覧の取得に失敗しました", "error");
    }
  }

  async function handleCreateGroup(event) {
    event.preventDefault();
    const name = document.getElementById("group-name").value.trim();
    const desc = document.getElementById("group-desc").value.trim();
    if (!name) return;
    try {
      await APIClient.post("/material-groups/", { group_name: name, description: desc || null, is_active: true });
      showToast("グループを作成しました", "success");
      document.getElementById("create-group-form").reset();
      await loadGroups();
    } catch (e) {
      showToast(e.message || "グループ作成に失敗しました", "error");
    }
  }

  async function handleSearch() {
    const q = document.getElementById("material-search").value.trim();
    const resultsEl = document.getElementById("search-results");
    resultsEl.innerHTML = "";
    if (!selectedGroup) {
      showToast("先にグループを選択してください", "warning");
      return;
    }
    if (!q) return;
    try {
      const results = await APIClient.get("/materials/search/", { query_text: q, in_stock_only: true });
      if (!results.length) {
        resultsEl.innerHTML = `<div class="text-gray-500 text-sm">該当する材料がありません。</div>`;
        return;
      }
      results.forEach((r) => {
        const row = document.createElement("div");
        row.className = "flex items-center justify-between border rounded px-3 py-2";
        const left = document.createElement("div");
        left.className = "text-sm text-gray-700";
        left.textContent = `${r.name} / ${r.shape} / φ${r.diameter_mm} / 品番:${r.part_number || '-'}`;
        const addBtn = document.createElement("button");
        addBtn.className = "bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs";
        addBtn.textContent = "同等品に追加";
        addBtn.onclick = async () => {
          try {
            await APIClient.post(`/material-groups/${selectedGroup.id}/members`, { material_id: r.material_id });
            showToast("グループに追加しました", "success");
            await loadMembers(selectedGroup.id);
          } catch (e) {
            showToast(e.message || "追加に失敗しました", "error");
          }
        };
        row.appendChild(left);
        row.appendChild(addBtn);
        resultsEl.appendChild(row);
      });
    } catch (e) {
      showToast(e.message || "検索に失敗しました", "error");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadGroups();
    document.getElementById("create-group-form").addEventListener("submit", handleCreateGroup);
    document.getElementById("search-btn").addEventListener("click", handleSearch);
    document.getElementById("delete-group-btn").addEventListener("click", async () => {
      if (!selectedGroup) return;
      if (!confirm(`グループ「${selectedGroup.group_name}」を削除しますか？`)) return;
      try {
        await APIClient.delete(`/material-groups/${selectedGroup.id}`);
        showToast("グループを削除しました", "success");
        selectedGroup = null;
        document.getElementById("selected-group-actions").classList.add("hidden");
        document.getElementById("group-detail").innerHTML = "";
        document.getElementById("member-list").innerHTML = "";
        await loadGroups();
      } catch (e) {
        showToast(e.message || "削除に失敗しました", "error");
      }
    });
  });

  // 文字列エスケープ（簡易）
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }
</script>
{% endblock %}