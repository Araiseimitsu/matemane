# 2025-10-09 変更ログ

## 入庫確認ロット再編集の改善
- **削除済みロットが復活する不具合を解消**
  - 再編集フォームでロットを削除した場合、バックエンドのDELETE APIを追加し、削除を確実に反映
  - 入庫済みロットを削除する際、入出庫履歴が存在する場合は削除できないようチェック
  - 残存ロットから入庫数量と重量を再集計し、発注アイテムと発注全体のステータスを再評価
- **フロントエンドの差分送信ロジックを改良**
  - 既存ロットとフォーム入力の差分を判定し、新規ロットはPOST、既存ロットはPUT、削除ロットはDELETEを呼び分け
  - 削除失敗時の警告表示を追加し、ユーザーへフィードバック
  - 入力欄をより柔軟に取得（`select`/`input`どちらにも対応）

### 変更ファイル
- `src/api/purchase_orders.py`
  - `DELETE /api/purchase-orders/items/{item_id}/receive/{lot_number}/` を追加
  - 適用後に数量・重量の再集計と発注ステータス更新
- `src/static/js/order_flow.js`
  - ロット差分判定と削除APIコールを実装
  - 成功・警告メッセージの改善、置き場入力の取得方式を拡張

---

# 2025-10-07 変更ログ

## 入庫確認機能の改善
- **材料仕様の表示形式変更**: 入庫確認モーダル内の材料仕様部分を、選択可能なテキストエリアからラベル表示のみに変更。他の項目（発注番号、仕入先など）と同じ表示スタイルに統一。
- **単価・金額の入力機能追加**: 入庫確認モーダルに「単価・金額」セクションを追加。
  - 単価（円）と合計金額（円）の入力欄を用意
  - 単価入力時、発注数量または発注重量を基に合計金額を自動計算
  - 手動での上書きも可能
  - データは `PurchaseOrderItem` テーブルの `unit_price` と `amount` フィールドに保存
  - Lotテーブルの `received_unit_price` と `received_amount` にも保存（ロット単位の履歴管理）

### 追加メモ（2025-10-09）
- 再編集PUT `/api/purchase-orders/items/{item_id}/receive/` のレスポンスから存在しない `management_code` フィールドを削除。`Item` モデルに当該カラムがないため、ロット削除後の再編集で500エラーが発生していた。
  - 影響範囲: `src/api/purchase_orders.py`
  - 変更効果: 再編集時に残存ロットのみ更新するケースでも正しく200レスポンスを返す。
- 再編集フォームでロットを削除した場合に保持されていた古いロット番号リストをリセットするよう修正。
  - 影響範囲: `src/static/js/order_flow.js`
  - 変更効果: フォームから削除したロットがPUTで再登録されることを防止。

### 変更ファイル
- `src/templates/order_flow.html`: 入庫確認モーダルに単価・金額入力欄を追加、材料仕様の表示を簡素化
- `src/static/js/order_flow.js`: 
  - 単価・金額の初期値設定
  - 単価入力時の自動計算ロジック（数量/重量対応）
  - フォーム送信時に単価・金額をAPIに送信
- `src/api/purchase_orders.py`: 
  - POST/PUT `/items/{item_id}/receive/` で単価・金額を受け取り、`PurchaseOrderItem` に保存
  - 既に `ReceivingConfirmation` スキーマに `unit_price` と `amount` フィールドは定義済み

---

# 2025-10-06 変更ログ

- `src/scripts/excel_po_import.py` の既定Excelパスを `\\192.168.1.200\共有\生産管理課\材料管理.xlsx` に更新。
  - 実運用の共有フォルダを指すよう調整。
  - CLI利用例を最新パスに合わせて修正。

## メモ
- ネットワーク共有パスをデフォルトにする際は、PowerShellでエスケープが必要な点に留意。

